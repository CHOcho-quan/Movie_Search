
<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 9]><!--><html class="no-js" lang="en"><!--<![endif]--><head>
<meta content='IE=edge' http-equiv='X-UA-Compatible'>
<meta charset='utf-8'>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<meta content='en' name='Content-Language'>
<link rel="apple-touch-icon-precomposed" type="image/png" href="/assets/favicons/apple-touch-icon-57x57-23db54db1a9ab14675fa9cf173fe7379.png" sizes="57x57" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/assets/favicons/apple-touch-icon-60x60-51c3ece0f58d4ab82a1ee4dc5f60eb60.png" sizes="60x60" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/assets/favicons/apple-touch-icon-72x72-85e546338a8f2f81c59ef99ca7042927.png" sizes="72x72" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/assets/favicons/apple-touch-icon-76x76-ad73b285951d1ce2cd86b5bc39885430.png" sizes="76x76" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/assets/favicons/apple-touch-icon-114x114-cc1ce9811fc1f8d861a850f8605ef548.png" sizes="114x114" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/assets/favicons/apple-touch-icon-120x120-7cb890a3f21ca81bceffa3e66c7a52fd.png" sizes="120x120" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/assets/favicons/apple-touch-icon-144x144-c5ba7d3c7a1ba46a51a440d04fb092ec.png" sizes="144x144" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/assets/favicons/apple-touch-icon-152x152-b51fc9c84556fb7368410c32b219b77e.png" sizes="152x152" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-16x16-e1024b77b1263313faca7200bbfefb72.png" sizes="16x16" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-32x32-4ae9cef5f02ec70ed6969b20404f8f4d.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-96x96-3c69042b034e11724230a88628cc270a.png" sizes="96x96" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-128x128-7ca808dbf5cc86cdf76b1ab7af7ad61a.png" sizes="128x128" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-196x196-09133a3549349d48538fd663119c4de1.png" sizes="196x196" />
<meta content='Leanpub' name='application-name'>
<meta content='#ffffff' name='msapplication-TileColor'>
<meta content='favicons/mstile-144x144.png' name='msapplication-TileImage'>
<meta content='favicons/mstile-150x150.png' name='msapplication-square150x150logo'>
<meta content='favicons/mstile-310x150.png' name='msapplication-wide310x150logo'>
<meta content='favicons/mstile-310x310.png' name='msapplication-square310x310logo'>
<meta content='favicons/mstile-70x70.png' name='msapplication-square70x70logo'>

<title>Read D3 Tips and Tricks v4.x | Leanpub</title>
<link href='//fonts.googleapis.com/' rel='dns-prefetch'>
<script src='https://use.fontawesome.com/7d43d23755.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js'></script>
<script>
  if (typeof WebFont !== 'undefined') {
    WebFont.load({
      google: {
        families: [
          'Noto Sans:400,700,400i,700i',
          'Noto Serif:400,700,400i,700i',
        ]
      }
    });
  }
</script>

<link rel="stylesheet" media="all" href="/assets/application-feed8c6bd9088368d49931bdbf2b2346.css" />

<script>
  var _rollbarConfig = {
      accessToken: "3d279f41d3804636adbbba833c2c0d2d",
      captureUncaught: true,
      payload: {
        environment: "production"
      }
  };
  !function(r){function o(e){if(t[e])return t[e].exports;var n=t[e]={exports:{},id:e,loaded:!1};return r[e].call(n.exports,n,n.exports,o),n.loaded=!0,n.exports}var t={};return o.m=r,o.c=t,o.p="",o(0)}([function(r,o,t){"use strict";var e=t(1).Rollbar,n=t(2);_rollbarConfig.rollbarJsUrl=_rollbarConfig.rollbarJsUrl||"https://d37gvrvc0wt4s1.cloudfront.net/js/v1.8/rollbar.min.js";var a=e.init(window,_rollbarConfig),i=n(a,_rollbarConfig);a.loadFull(window,document,!_rollbarConfig.async,_rollbarConfig,i)},function(r,o){"use strict";function t(r){return function(){try{return r.apply(this,arguments)}catch(o){try{console.error("[Rollbar]: Internal error",o)}catch(t){}}}}function e(r,o,t){window._rollbarWrappedError&&(t[4]||(t[4]=window._rollbarWrappedError),t[5]||(t[5]=window._rollbarWrappedError._rollbarContext),window._rollbarWrappedError=null),r.uncaughtError.apply(r,t),o&&o.apply(window,t)}function n(r){var o=function(){var o=Array.prototype.slice.call(arguments,0);e(r,r._rollbarOldOnError,o)};return o.belongsToShim=!0,o}function a(r){this.shimId=++s,this.notifier=null,this.parentShim=r,this._rollbarOldOnError=null}function i(r){var o=a;return t(function(){if(this.notifier)return this.notifier[r].apply(this.notifier,arguments);var t=this,e="scope"===r;e&&(t=new o(this));var n=Array.prototype.slice.call(arguments,0),a={shim:t,method:r,args:n,ts:new Date};return window._rollbarShimQueue.push(a),e?t:void 0})}function l(r,o){if(o.hasOwnProperty&&o.hasOwnProperty("addEventListener")){var t=o.addEventListener;o.addEventListener=function(o,e,n){t.call(this,o,r.wrap(e),n)};var e=o.removeEventListener;o.removeEventListener=function(r,o,t){e.call(this,r,o&&o._wrapped?o._wrapped:o,t)}}}var s=0;a.init=function(r,o){var e=o.globalAlias||"Rollbar";if("object"==typeof r[e])return r[e];r._rollbarShimQueue=[],r._rollbarWrappedError=null,o=o||{};var i=new a;return t(function(){if(i.configure(o),o.captureUncaught){i._rollbarOldOnError=r.onerror,r.onerror=n(i);var t,a,s="EventTarget,Window,Node,ApplicationCache,AudioTrackList,ChannelMergerNode,CryptoOperation,EventSource,FileReader,HTMLUnknownElement,IDBDatabase,IDBRequest,IDBTransaction,KeyOperation,MediaController,MessagePort,ModalWindow,Notification,SVGElementInstance,Screen,TextTrack,TextTrackCue,TextTrackList,WebSocket,WebSocketWorker,Worker,XMLHttpRequest,XMLHttpRequestEventTarget,XMLHttpRequestUpload".split(",");for(t=0;t<s.length;++t)a=s[t],r[a]&&r[a].prototype&&l(i,r[a].prototype)}return r[e]=i,i})()},a.prototype.loadFull=function(r,o,e,n,a){var i=function(){var o;if(void 0===r._rollbarPayloadQueue){var t,e,n,i;for(o=new Error("rollbar.js did not load");t=r._rollbarShimQueue.shift();)for(n=t.args,i=0;i<n.length;++i)if(e=n[i],"function"==typeof e){e(o);break}}"function"==typeof a&&a(o)},l=!1,s=o.createElement("script"),u=o.getElementsByTagName("script")[0],p=u.parentNode;s.crossOrigin="",s.src=n.rollbarJsUrl,s.async=!e,s.onload=s.onreadystatechange=t(function(){if(!(l||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState)){s.onload=s.onreadystatechange=null;try{p.removeChild(s)}catch(r){}l=!0,i()}}),p.insertBefore(s,u)},a.prototype.wrap=function(r,o){try{var t;if(t="function"==typeof o?o:function(){return o||{}},"function"!=typeof r)return r;if(r._isWrap)return r;if(!r._wrapped){r._wrapped=function(){try{return r.apply(this,arguments)}catch(o){throw o._rollbarContext=t()||{},o._rollbarContext._wrappedSource=r.toString(),window._rollbarWrappedError=o,o}},r._wrapped._isWrap=!0;for(var e in r)r.hasOwnProperty(e)&&(r._wrapped[e]=r[e])}return r._wrapped}catch(n){return r}};for(var u="log,debug,info,warn,warning,error,critical,global,configure,scope,uncaughtError".split(","),p=0;p<u.length;++p)a.prototype[u[p]]=i(u[p]);r.exports={Rollbar:a,_rollbarWindowOnError:e}},function(r,o){"use strict";r.exports=function(r,o){return function(t){if(!t&&!window._rollbarInitialized){var e=window.RollbarNotifier,n=o||{},a=n.globalAlias||"Rollbar",i=window.Rollbar.init(n,r);i._processShimQueue(window._rollbarShimQueue||[]),window[a]=i,window._rollbarInitialized=!0,e.processPayloads()}}}}]);
</script>
<script src="/assets/modernizr-98e441f02005e1fe01984ab3a59422d2.js"></script>
<script src="//www.google.com/jsapi"></script>
<script src="/assets/chartkick-53dc56907b4f1987aeb2b5a400252337.js"></script>
<script src="/mathjax/MathJax.js?config=TeX-AMS_HTML-full.js" type="text/javascript"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-911230-9', 'auto');  // Replace with your property ID.
  
  // Visitor type parameters (only settable from non cached)
  
  
  
  
  ga('send', 'pageview');
</script>

</head>
<body id='reads-show'>

<div class='flash' id='js-flash-prototype'>
<div class='flash__progress-bar'></div>
<div class='container--large'>
<div class='flash__message'></div>
<div class='flash__close-icon'>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="25px" id="Layer_1" style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="25px" xml:space="preserve"><path d="M437.5,386.6L306.9,256l130.6-130.6c14.1-14.1,14.1-36.8,0-50.9c-14.1-14.1-36.8-14.1-50.9,0L256,205.1L125.4,74.5  c-14.1-14.1-36.8-14.1-50.9,0c-14.1,14.1-14.1,36.8,0,50.9L205.1,256L74.5,386.6c-14.1,14.1-14.1,36.8,0,50.9  c14.1,14.1,36.8,14.1,50.9,0L256,306.9l130.6,130.6c14.1,14.1,36.8,14.1,50.9,0C451.5,423.4,451.5,400.6,437.5,386.6z"></path></svg>

</div>
</div>
</div>


<div id='react-header-root'></div>
<script>
  window.__BASE_URL__ = "https://leanpub.com/"
</script>
<script src="/assets/polyfill-bundle-4bd27bc6c66bf3edd5bf.js"></script>
<script src="/assets/header-bundle-6e6d9ea27e3e6c389ef3.js"></script>


<div class='main'>


<div class='container--large' id='read-online' lang='en'>
<header>
<h1>D3 Tips and Tricks v4.x</h1>
<div class='read-upsell'>
<a href="/d3-t-and-t-v4"><img alt="D3 Tips and Tricks v4.x" src="https://s3.amazonaws.com/titlepages.leanpub.com/d3-t-and-t-v4/small?1491955690" /></a>
<div>
<div class='book-title'>D3 Tips and Tricks v4.x</div>
<a class="btn--solid" href="/d3-t-and-t-v4">Buy on Leanpub</a>
</div>
</div>
</header>
<section class='read'>
<div id="leanpub-toc">
<h2>Table of Contents</h2>
<ol class="toc">
<ul class="toc no-parts">
  <li>
    <a href="#leanpub-auto-acknowledgements">Acknowledgements</a>
    <ul>
      <li>
        <a href="#leanpub-auto-mike">Mike</a>
      </li>
      <li>
        <a href="#leanpub-auto-partners-supporters-and-contributors">Partners, Supporters and Contributors.</a>
      </li>
      <li>
        <a href="#leanpub-auto-proof-reading">Proof Reading</a>
      </li>
      <li>
        <a href="#leanpub-auto-the-d3js-community">The d3.js Community</a>
      </li>
      <li>
        <a href="#leanpub-auto-cover-art">Cover art</a>
      </li>
      <li>
        <a href="#leanpub-auto-leanpub">Leanpub</a>
      </li>
      <li>
        <a href="#leanpub-auto-make-sure-you-get-the-most-up-to-date-copy-of-d3-tips-and-tricks">Make sure you get the most up to date copy of D3 Tips and Tricks</a>
      </li>
    </ul>
  </li>
  <li>
    <a href="#leanpub-auto-what-is-d3js">What is d3.js?</a>
  </li>
  <li>
    <a href="#leanpub-auto-introduction">Introduction</a>
  </li>
  <li>
    <a href="#leanpub-auto-what-do-we-need-to-get-started">What do we need to get started?</a>
    <ul>
      <li>
        <a href="#leanpub-auto-html">HTML</a>
      </li>
      <li>
        <a href="#leanpub-auto-javascript">JavaScript</a>
      </li>
      <li>
        <a href="#leanpub-auto-cascading-style-sheets-css">Cascading Style Sheets (CSS)</a>
      </li>
      <li>
        <a href="#leanpub-auto-web-servers">Web Servers</a>
      </li>
      <li>
        <a href="#leanpub-auto-php">PHP</a>
      </li>
      <li>
        <a href="#leanpub-auto-other-useful-stuff">Other Useful Stuff</a>
        <ul>
          <li>
            <a href="#leanpub-auto-text-editor">Text Editor</a>
          </li>
          <li>
            <a href="#leanpub-auto-getting-d3">Getting D3</a>
            <ul>
              <li>
                <a href="#leanpub-auto-host-d3js-locally">Host d3.js locally</a>
              </li>
              <li>
                <a href="#leanpub-auto-use-a-remote-cdn-to-always-use-the-latest-version-of-d3js">Use a remote CDN to always use the latest version of d3.js</a>
              </li>
              <li>
                <a href="#leanpub-auto-potential-directory-structure">Potential directory structure</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#leanpub-auto-where-to-get-information-on-d3js">Where to get information on d3.js</a>
            <ul>
              <li>
                <a href="#leanpub-auto-d3jsorg">d3js.org</a>
              </li>
              <li>
                <a href="#leanpub-auto-google-groups">Google Groups</a>
              </li>
              <li>
                <a href="#leanpub-auto-stack-overflow">Stack Overflow</a>
              </li>
              <li>
                <a href="#leanpub-auto-github">Github</a>
              </li>
              <li>
                <a href="#leanpub-auto-blocksorg">bl.ocks.org</a>
              </li>
              <li>
                <a href="#leanpub-auto-twitter">Twitter</a>
              </li>
              <li>
                <a href="#leanpub-auto-books">Books</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="#simplegraph">Starting with a simple graph</a>
    <ul>
      <li>
        <a href="#html">HTML</a>
      </li>
      <li>
        <a href="#css">Cascading Style Sheets (CSS)</a>
      </li>
      <li>
        <a href="#javascript">D3 JavaScript</a>
        <ul>
          <li>
            <a href="#leanpub-auto-setting-up-the-margins-and-the-graph-area">Setting up the margins and the graph area.</a>
          </li>
          <li>
            <a href="#leanpub-auto-getting-the-data">Getting the Data</a>
          </li>
          <li>
            <a href="#leanpub-auto-formatting-the-date--time">Formatting the Date / Time.</a>
          </li>
          <li>
            <a href="#leanpub-auto-setting-scales-domains-and-ranges">Setting Scales Domains and Ranges</a>
          </li>
          <li>
            <a href="#leanpub-auto-adding-data-to-the-line-function">Adding data to the line function</a>
          </li>
          <li>
            <a href="#leanpub-auto-adding-the-svg-element">Adding the SVG element.</a>
          </li>
          <li>
            <a href="#leanpub-auto-actually-drawing-something">Actually Drawing Something!</a>
            <ul>
              <li>
                <a href="#leanpub-auto-drawing-the-line">Drawing the line</a>
              </li>
              <li>
                <a href="#leanpub-auto-drawing-the-axes">Drawing the Axes</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-wrap-up">Wrap Up</a>
      </li>
    </ul>
  </li>
  <li>
    <a href="#leanpub-auto-things-we-can-do-with-the-simple-graph">Things we can do with the simple graph</a>
    <ul>
      <li>
        <a href="#axes">Setting up and configuring the Axes</a>
        <ul>
          <li>
            <a href="#leanpub-auto-change-the-text-size">Change the text size</a>
          </li>
          <li>
            <a href="#leanpub-auto-changing-the-number-of-ticks-on-an-axis">Changing the number of ticks on an axis</a>
          </li>
          <li>
            <a href="#leanpub-auto-rotating-text-labels-for-a-graph-axis">Rotating text labels for a graph axis</a>
          </li>
          <li>
            <a href="#leanpub-auto-formatting-a-date--time-axis-with-specified-values">Formatting a date / time axis with specified values</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#axislabels">Adding Axis Labels</a>
        <ul>
          <li>
            <a href="#leanpub-auto-the-x-axis-label">The x axis label</a>
          </li>
          <li>
            <a href="#leanpub-auto-the-y-axis-label">The y axis label</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#title">How to add a title to your graph</a>
      </li>
      <li>
        <a href="#leanpub-auto-change-a-line-chart-into-a-scatter-plot">Change a line chart into a scatter plot</a>
      </li>
      <li>
        <a href="#smoothing">Smoothing out graph lines</a>
      </li>
      <li>
        <a href="#leanpub-auto-make-a-dashed-line">Make a dashed line</a>
      </li>
      <li>
        <a href="#leanpub-auto-filling-an-area-under-the-graph">Filling an area under the graph</a>
        <ul>
          <li>
            <a href="#leanpub-auto-css-for-an-area-fill">CSS for an area fill</a>
          </li>
          <li>
            <a href="#leanpub-auto-define-the-area-function">Define the area function</a>
          </li>
          <li>
            <a href="#leanpub-auto-draw-the-area">Draw the area</a>
          </li>
          <li>
            <a href="#leanpub-auto-filling-an-area-above-the-line">Filling an area above the line</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-adding-a-drop-shadow-to-allow-text-to-stand-out-on-graphics">Adding a drop shadow to allow text to stand out on graphics.</a>
        <ul>
          <li>
            <a href="#leanpub-auto-css-for-white-shadowy-background">CSS for white shadowy background</a>
          </li>
          <li>
            <a href="#leanpub-auto-drawing-the-white-shadowy-background">Drawing the white shadowy background.</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-adding-grid-lines-to-a-graph">Adding grid lines to a graph</a>
        <ul>
          <li>
            <a href="#leanpub-auto-the-grid-line-css">The grid line CSS</a>
          </li>
          <li>
            <a href="#leanpub-auto-define-the-grid-line-functions">Define the grid line functions</a>
          </li>
          <li>
            <a href="#leanpub-auto-draw-the-lines">Draw the lines</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-adding-more-than-one-line-to-a-graph">Adding more than one line to a graph</a>
      </li>
      <li>
        <a href="#leanpub-auto-labelling-multiple-lines-on-a-graph">Labelling multiple lines on a graph</a>
      </li>
      <li>
        <a href="#leanpub-auto-multiple-axes-for-a-graph">Multiple axes for a graph</a>
      </li>
    </ul>
  </li>
  <li>
    <a href="#leanpub-auto-elements-attributes-and-styles">Elements, Attributes and Styles</a>
    <ul>
      <li>
        <a href="#EASframework">The Framework</a>
      </li>
      <li>
        <a href="#elements">Elements</a>
        <ul>
          <li>
            <a href="#circle">Circle</a>
          </li>
          <li>
            <a href="#leanpub-auto-ellipse">Ellipse</a>
          </li>
          <li>
            <a href="#leanpub-auto-rectangle">Rectangle</a>
          </li>
          <li>
            <a href="#leanpub-auto-line">Line</a>
          </li>
          <li>
            <a href="#leanpub-auto-polyline">Polyline</a>
          </li>
          <li>
            <a href="#leanpub-auto-polygon">Polygon</a>
          </li>
          <li>
            <a href="#leanpub-auto-path">Path</a>
          </li>
          <li>
            <a href="#clipPath">Clipped Path (AKA clipPath)</a>
          </li>
          <li>
            <a href="#leanpub-auto-text">Text</a>
            <ul>
              <li>
                <a href="#leanpub-auto-anchor-at-the-bottom-middle-of-the-text">Anchor at the bottom, middle of the text:</a>
              </li>
              <li>
                <a href="#leanpub-auto-anchor-at-the-bottom-right-of-the-text">Anchor at the bottom, right of the text:</a>
              </li>
              <li>
                <a href="#leanpub-auto-anchor-at-the-middle-left-of-the-text">Anchor at the middle, left of the text:</a>
              </li>
              <li>
                <a href="#leanpub-auto-anchor-in-the-middle-centre-of-the-text">Anchor in the middle, centre of the text:</a>
              </li>
              <li>
                <a href="#leanpub-auto-anchor-in-the-middle-right-of-the-text">Anchor in the middle, right of the text:</a>
              </li>
              <li>
                <a href="#leanpub-auto-anchor-at-the-top-left-of-the-text">Anchor at the top, left of the text:</a>
              </li>
              <li>
                <a href="#leanpub-auto-anchor-at-the-top-middle-of-the-text">Anchor at the top, middle of the text:</a>
              </li>
              <li>
                <a href="#leanpub-auto-anchor-at-the-top-right-of-the-text">Anchor at the top, right of the text:</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-attributes">Attributes</a>
        <ul>
          <li>
            <a href="#leanpub-auto-x-y"><code>x</code>, <code>y</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-x1-x2-y1-y2"><code>x1</code>, <code>x2</code>, <code>y1</code>, <code>y2</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-points">points</a>
          </li>
          <li>
            <a href="#leanpub-auto-cx-cy"><code>cx</code>, <code>cy</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-r"><code>r</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-rx-ry"><code>rx</code>, <code>ry</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-transform-translatexy-scalek-rotatea"><code>transform (translate(x,y), scale(k), rotate(a))</code></a>
            <ul>
              <li>
                <a href="#leanpub-auto-transform-translatexy"><code>transform (translate(x,y))</code></a>
              </li>
              <li>
                <a href="#leanpub-auto-transform-scalek"><code>transform (scale(k))</code></a>
              </li>
              <li>
                <a href="#leanpub-auto-transform-rotatea"><code>transform (rotate(a))</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#leanpub-auto-width-height"><code>width</code>, <code>height</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-text-anchor"><code>text-anchor</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-dx-dy"><code>dx</code>, <code>dy</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-textlength"><code>textLength</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-lengthadjust"><code>lengthAdjust</code></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-styles">Styles</a>
        <ul>
          <li>
            <a href="#leanpub-auto-fill"><code>fill</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-stroke"><code>stroke</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-opacity"><code>opacity</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-fill-opacity"><code>fill-opacity</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-stroke-opacity"><code>stroke-opacity</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-stroke-width"><code>stroke-width</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-stroke-dasharray"><code>stroke-dasharray</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-stroke-linecap"><code>stroke-linecap</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-stroke-linejoin"><code>stroke-linejoin</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-writing-mode"><code>writing-mode</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-glyph-orientation-vertical"><code>glyph-orientation-vertical</code></a>
          </li>
          <li>
            <a href="#leanpub-auto-using-styles-in-cascading-style-sheets">Using styles in Cascading Style Sheets</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="#leanpub-auto-manipulating-data">Manipulating data</a>
    <ul>
      <li>
        <a href="#leanpub-auto-how-to-use-data-imported-from-a-csv-file-with-spaces-in-the-header">How to use data imported from a csv file with spaces in the header.</a>
      </li>
      <li>
        <a href="#leanpub-auto-extracting-data-from-a-portion-of-a-string">Extracting data from a portion of a string.</a>
      </li>
      <li>
        <a href="#nest">Grouping and summing data (d3.nest)</a>
      </li>
      <li>
        <a href="#leanpub-auto-selecting-a-random-string-from-an-array">Selecting a random string from an array.</a>
      </li>
    </ul>
  </li>
  <li>
    <a href="#leanpub-auto-bar-charts-and-histograms">Bar Charts and Histograms</a>
    <ul>
      <li>
        <a href="#leanpub-auto-bar-chart">Bar Chart</a>
        <ul>
          <li>
            <a href="#leanpub-auto-histogram">Histogram</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-bar-charts">Bar Charts</a>
        <ul>
          <li>
            <a href="#leanpub-auto-the-data">The data</a>
          </li>
          <li>
            <a href="#leanpub-auto-the-code">The code</a>
          </li>
          <li>
            <a href="#leanpub-auto-the-bar-chart-explained">The bar chart explained</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-histograms">Histograms</a>
        <ul>
          <li>
            <a href="#leanpub-auto-the-data-1">The data</a>
          </li>
          <li>
            <a href="#leanpub-auto-the-code-1">The code</a>
          </li>
          <li>
            <a href="#leanpub-auto-the-histogram-explained">The histogram explained</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="#leanpub-auto-tree-diagrams">Tree Diagrams</a>
    <ul>
      <li>
        <a href="#leanpub-auto-what-is-a-tree-diagram">What is a Tree Diagram?</a>
      </li>
      <li>
        <a href="#leanpub-auto-a-simple-tree-diagram-explained">A simple Tree Diagram explained</a>
      </li>
      <li>
        <a href="#leanpub-auto-a-horizontal-tree-diagram-explained">A horizontal tree diagram explained</a>
      </li>
      <li>
        <a href="#leanpub-auto-styling-nodes-in-a-tree-diagram">Styling nodes in a tree diagram</a>
        <ul>
          <li>
            <a href="#tree-styling">Changing node and link colours</a>
          </li>
          <li>
            <a href="#leanpub-auto-changing-the-nodes-to-different-shapes">Changing the nodes to different shapes</a>
          </li>
          <li>
            <a href="#leanpub-auto-using-images-as-nodes">Using images as nodes</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#treeFromExternal">Generating a tree diagram from external data</a>
      </li>
      <li>
        <a href="#treeFromFlat">Generating a tree diagram from ‘flat’ data</a>
      </li>
      <li>
        <a href="#leanpub-auto-generating-a-tree-diagram-from-a-csv-file">Generating a tree diagram from a CSV file.</a>
      </li>
      <li>
        <a href="#leanpub-auto-an-interactive-tree-diagram">An interactive tree diagram</a>
      </li>
    </ul>
  </li>
  <li>
    <a href="#leanpub-auto-sankey-diagrams">Sankey Diagrams</a>
    <ul>
      <li>
        <a href="#leanpub-auto-what-is-a-sankey-diagram">What is a Sankey Diagram?</a>
      </li>
      <li>
        <a href="#leanpub-auto-which-sankey-plugin-should-we-use">Which Sankey plugin should we use?</a>
      </li>
      <li>
        <a href="#sankeydata">How d3.js Sankey Diagrams want their data formatted</a>
      </li>
      <li>
        <a href="#leanpub-auto-description-of-the-code">Description of the code</a>
      </li>
      <li>
        <a href="#leanpub-auto-formatting-data-for-sankey-diagrams">Formatting data for Sankey diagrams</a>
        <ul>
          <li>
            <a href="#leanpub-auto-from-a-json-file-with-numeric-link-values">From a JSON file with numeric link values</a>
          </li>
          <li>
            <a href="#leanpub-auto-from-a-json-file-with-links-as-names">From a JSON file with links as names</a>
          </li>
          <li>
            <a href="#leanpub-auto-from-a-csv-with-source-target-and-value-info-only">From a CSV with ‘source’, ‘target’ and ‘value’ info only.</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="#leanpub-auto-assorted-tips-and-tricks">Assorted Tips and Tricks</a>
    <ul>
      <li>
        <a href="#scatterplot">Change a line chart into a scatter plot</a>
      </li>
      <li>
        <a href="#leanpub-auto-adding-tooltips">Adding tooltips.</a>
        <ul>
          <li>
            <a href="#leanpub-auto-transitions">Transitions</a>
          </li>
          <li>
            <a href="#leanpub-auto-events">Events</a>
          </li>
          <li>
            <a href="#leanpub-auto-get-tipping">Get tipping</a>
          </li>
          <li>
            <a href="#leanpub-auto-onmouseover">on.mouseover</a>
          </li>
          <li>
            <a href="#leanpub-auto-onmouseout">on.mouseout</a>
          </li>
          <li>
            <a href="#leanpub-auto-including-an-html-link-in-a-tool-tip">Including an HTML link in a tool tip</a>
            <ul>
              <li>
                <a href="#leanpub-auto-moar-links">Moar Links!</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-what-are-the-predefined-named-colours">What are the predefined, named colours?</a>
      </li>
      <li>
        <a href="#filtering">Selecting / filtering a subset of objects</a>
      </li>
      <li>
        <a href="#leanpub-auto-select-items-with-an-if-statement">Select items with an IF statement.</a>
      </li>
      <li>
        <a href="#leanpub-auto-applying-a-colour-gradient-to-a-line-based-on-value">Applying a colour gradient to a line based on value.</a>
      </li>
      <li>
        <a href="#leanpub-auto-applying-a-colour-gradient-to-an-area-fill">Applying a colour gradient to an area fill.</a>
      </li>
      <li>
        <a href="#leanpub-auto-transitions-1">Transitions</a>
        <ul>
          <li>
            <a href="#chaining">Transitioning Chaining</a>
          </li>
          <li>
            <a href="#leanpub-auto-transition-easing">Transition Easing</a>
          </li>
          <li>
            <a href="#leanpub-auto-looping-a-transition">Looping a Transition</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-show--hide-an-element-by-clicking-on-another-element">Show / hide an element by clicking on another element</a>
        <ul>
          <li>
            <span> </span>
            <ul>
              <li>
                <a href="#leanpub-auto-the-code-2">The code</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-using-html-inputs-with-d3js">Using HTML inputs with d3.js</a>
        <ul>
          <li>
            <a href="#leanpub-auto-what-is-an-html-input">What is an HTML input?</a>
          </li>
          <li>
            <a href="#leanpub-auto-using-a-range-input-with-d3js">Using a <code>range</code> input with d3.js</a>
            <ul>
              <li>
                <a href="#leanpub-auto-the-code-3">The code</a>
              </li>
              <li>
                <a href="#leanpub-auto-the-explanation">The explanation</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#leanpub-auto-using-more-than-one-input">Using more than one input</a>
            <ul>
              <li>
                <a href="#leanpub-auto-the-code-4">The code</a>
              </li>
              <li>
                <a href="#leanpub-auto-the-explanation-1">The explanation</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#leanpub-auto-rotate-text-with-an-input">Rotate text with an input</a>
            <ul>
              <li>
                <a href="#leanpub-auto-the-explanation-2">The explanation</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#leanpub-auto-use-a-number-input-with-d3js">Use a <code>number</code> input with d3.js</a>
          </li>
          <li>
            <a href="#leanpub-auto-change-more-than-one-element-with-an-input">Change more than one element with an input</a>
            <ul>
              <li>
                <a href="#leanpub-auto-the-code-5">The code</a>
              </li>
              <li>
                <a href="#leanpub-auto-the-explanation-3">The explanation</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href="#tables">Add an HTML table to your graph</a>
        <ul>
          <li>
            <a href="#leanpub-auto-html-tables">HTML Tables</a>
          </li>
          <li>
            <a href="#leanpub-auto-first-the-css">First the CSS</a>
          </li>
          <li>
            <a href="#leanpub-auto-now-the-d3js-code">Now the d3.js code</a>
          </li>
          <li>
            <a href="#leanpub-auto-a-small-but-cunning-change">A small but cunning change…</a>
          </li>
          <li>
            <a href="#leanpub-auto-explaining-the-d3js-code-reloaded">Explaining the d3.js code (reloaded).</a>
          </li>
          <li>
            <a href="#leanpub-auto-wrap-up-1">Wrap up</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-more-table-madness-sorting-prettifying-and-adding-columns">More table madness: sorting, prettifying and adding columns</a>
        <ul>
          <li>
            <a href="#leanpub-auto-add-another-column-of-information">Add another column of information:</a>
          </li>
          <li>
            <a href="#leanpub-auto-sorting-on-a-column">Sorting on a column</a>
          </li>
          <li>
            <a href="#leanpub-auto-prettifying-actually-just-capitalising-the-header-for-each-column">Prettifying (actually just capitalising the header for each column)</a>
          </li>
          <li>
            <a href="#leanpub-auto-add-borders">Add borders</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-adding-web-links-to-d3js-objects">Adding web links to d3.js objects</a>
        <ul>
          <li>
            <a href="#leanpub-auto-its-all-about-the-a-and-the-xlink">It’s all about the ‘a’ and the ‘xlink’</a>
          </li>
          <li>
            <a href="#leanpub-auto-adding-in-the-links">Adding in the links</a>
          </li>
          <li>
            <a href="#leanpub-auto-making-the-mouse-pointer-ignore-an-object">Making the mouse pointer ignore an object</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-using-the-yahoo-query-language-yql-to-get-data">Using the Yahoo Query Language (YQL) to get data.</a>
        <ul>
          <li>
            <a href="#leanpub-auto-yql-by-example">YQL by example</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#leanpub-auto-export-an-image-from-a-d3js-page-as-a-svg-or-bitmap">Export an image from a d3.js page as a SVG or bitmap</a>
        <ul>
          <li>
            <a href="#leanpub-auto-bitmaps">Bitmaps</a>
          </li>
          <li>
            <a href="#svg">Vector Graphics (Specifically SVG)</a>
          </li>
          <li>
            <a href="#leanpub-auto-lets-get-exporting">Let’s get exporting!</a>
            <ul>
              <li>
                <a href="#leanpub-auto-copying-the-image-off-the-web-page">Copying the image off the web page</a>
              </li>
              <li>
                <a href="#leanpub-auto-open-the-svg-image-and-edit">Open the SVG Image and Edit</a>
              </li>
              <li>
                <a href="#leanpub-auto-saving-as-a-bitmap">Saving as a bitmap</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href="#json">Understanding JavaScript Object Notation (JSON)</a>
      </li>
    </ul>
  </li>
  <li>
    <a href="#leanpub-auto-d3js-examples-explained">D3.js Examples Explained</a>
    <ul>
      <li>
        <a href="#leanpub-auto-multi-line-graph-with-automatic-legend-and-toggling-show--hide-lines">Multi-line graph with automatic legend and toggling show / hide lines.</a>
        <ul>
          <li>
            <a href="#leanpub-auto-purpose">Purpose</a>
          </li>
          <li>
            <a href="#leanpub-auto-the-code-6">The Code</a>
          </li>
          <li>
            <a href="#leanpub-auto-description">Description</a>
            <ul>
              <li>
                <a href="#leanpub-auto-nesting-the-data">Nesting the data</a>
              </li>
              <li>
                <a href="#leanpub-auto-applying-the-colours">Applying the colours</a>
              </li>
              <li>
                <a href="#leanpub-auto-adding-the-legend">Adding the legend</a>
              </li>
              <li>
                <a href="#leanpub-auto-making-it-interactive">Making it interactive</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

</ol>
</div>
<div id="leanpub-main" class="kramdown">
<h2 id="leanpub-auto-acknowledgements">Acknowledgements</h2>

<h3 id="leanpub-auto-mike">Mike</h3>

<p>First and foremost I would like to express my thanks to Mike Bostock, the driving force behind d3.js. His efforts are tireless and his altruism in making his work open and available to the masses is inspiring.</p>

<p>The decision for him to leave what must have been an incredible job with the New York Times to return to improving visualisation software (d3.js in particular) has marked him as a very special person indeed. If any reader of this book has the opportunity to support his continuing efforts, please do.</p>

<h3 id="leanpub-auto-partners-supporters-and-contributors">Partners, Supporters and Contributors.</h3>

<p>Mike has worked with a crew of like-minded individuals in bringing D3 to the World. Vadim Ogievetsky and Jeffrey Heer share honours for the work on <a href="http://vis.stanford.edu/papers/d3">D3: Data-Driven Documents</a> and while there has been a cast of over 40 people contributing to the D3 code base, Jason Davies stands out as the man who has provided a generous portion especially in the area of mapping.</p>

<p>Nick Zhu has created a fantastic resource in <a href="https://github.com/NickQiZhu/dc.js/wiki">dc.js</a> (which is built on top of d3.js and crossfilter) and has been kind enough to provide good advice and permission to include some of his work. </p>

<p>Advice given by Christophe Viau has been a great help in getting me settled into the on-line world and his energy in managing and directing the D3 community is amazing.</p>

<p>Mike Dewar (<em>Getting Started with D3</em>), Scott Murray (<em>Interactive Data Visualization for the Web</em>) and Sebastian Gutierrez (<a href="http://www.dashingd3js.com/">dashingd3js.com</a>) lead the pack for providing high quality reference material for learning D3. Many thanks gentlemen.</p>

<h3 id="leanpub-auto-proof-reading">Proof Reading</h3>

<p>I am particularly grateful for the assistance given by Filiep Spyckerelle and Robin Bennett who selflessly donated their time and expertise in proofreading the earlier edition of D3 Tips and Tricks (d3.js v3) (where this document contains any errors, they are most certainly mine). </p>

<p>In fact Robin has been very quick off the mark and is feeding back areas for improvement in the new book already! </p>

<h3 id="leanpub-auto-the-d3js-community">The d3.js Community</h3>

<p>Big thanks go out to the D3 community. Whether providing advice on Google Groups or Stack Overflow, contributing examples on bl.ocks.org or just giving back in the form of time and effort to similar work. Well done all.</p>

<h3 id="leanpub-auto-cover-art">Cover art</h3>

<p>Out of the blue and in yet another example of the friendly and giving nature of people involved in this community I was contacted by Jose (‘Tactician Jenro’) who offered to use his skills to design a cover for the original book. He has subsequently designed the cover for this version and I think he did an awesome job and was super helpful. If you think that he could help you out with a project, you can get in touch with him at <a href="https://twitter.com/mindthetimes">@tacticianjenro</a> or via his web site at <a href="http://mindthetimes.xyz/">http://mindthetimes.xyz/</a>.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/banner.jpg" alt="A sampling of works by Tactician Jenro">
  <figcaption>A sampling of works by Tactician Jenro</figcaption>
</figure>


<h3 id="leanpub-auto-leanpub">Leanpub</h3>

<p>Lastly, I want to pay homage to <a href="https://leanpub.com/">Leanpub</a> who have made the publishing of this document possible. They offer an outstanding service for self-publishing and have made the task of providing and distributing content achievable.</p>

<h3 id="leanpub-auto-make-sure-you-get-the-most-up-to-date-copy-of-d3-tips-and-tricks">Make sure you get the most up to date copy of D3 Tips and Tricks</h3>

<p>If you’ve received a copy of this book from any location other than <a href="https://leanpub.com/d3-t-and-t-v4">Leanpub</a> then it’s possible that you haven’t got the latest version. Go to https://leanpub.com/d3-t-and-t-v4 and download the most recent version. After all, it won’t cost you anything :-). If you find some value in the work, please consider contributing when you download it so that Leanpub get something for hosting the book (and I’ll think of you fondly while I continue adding content :-D).</p>

<div class="page-break"></div>

<h2 id="leanpub-auto-what-is-d3js">What is d3.js?</h2>

<p><a href="http://d3js.org/">d3.js</a> (hereafter abridged as D3) is “<em>a JavaScript library for manipulating documents based on data</em>”.</p>

<p>But that description doesn’t do it justice.</p>

<p>D3 is all about helping you to take information and make it more accessible to others via a web browser. </p>

<p>It’s a JavaScript library. That means that it’s a software tool that can be used in conjunction with other software tools to achieve a task. Those other tools are based on web standards such as HTML, SVG and CSS but you don’t need to know too much about them to start using D3 (although it will help :-)).</p>

<p>It’s an open framework, which means that there are no hidden mysteries about how it does its magic and it allows others to contribute to a constant cycle of improvement.</p>

<p>Being built to leverage web standards means that modern browsers don’t have to do anything special to use D3, they just have to support the framework that the Internet has adopted for ease of use.</p>

<p>The beauty of D3 is that it allows you to associate data and what appears on the screen in a way that directly links the two. Change the data and you change the object on the screen. D3’s trick is to let you set what appears on the screen. A circle, a line, a point on a map, a graph, a bouncing ball, a gradient (and way, way more). Once the data and the object are linked the possibilities are endless.</p>

<p>D3 bridges the gap between the static display of data and the desire of people to represent it dynamically. That applies equally to the developer who wants to show something cool and to the end user who wants to be able to explore information interactively.</p>

<p>It was (and still is being) developed by <a href="http://bost.ocks.org/mike/">Mike Bostock</a> who has not just spent time writing the code, but writing the <a href="https://github.com/mbostock/d3/wiki">documentation</a> for D3 as well. There is an extensive community of supporters who also contribute to the code, provide technical <a href="https://groups.google.com/forum/?fromgroups#!forum/d3-js">support</a> <a href="http://stackoverflow.com/questions/tagged/d3.js">online</a> and generally have fun creating amazing <a href="https://github.com/mbostock/d3/wiki/Gallery">visualizations</a>. Their contributions are extraordinary (you only have to look at the work of Jason Davies to be amazed).</p>

<p>This book has been written to incorporate the changes in version 4 of d3.js to the original edition of D3 Tips and Tricks. If you’re looking for the equivalent for version 3 you can find it <a href="https://leanpub.com/D3-Tips-and-Tricks">here</a>. </p>

<div class="page-break"></div>

<h2 id="leanpub-auto-introduction">Introduction</h2>

<p>I never set out to write treatise on D3… But here I am three years after publishing the first version of this book and I’m in the process of updating it for version 4 of d3.js, while also looking back at a range of other books that have been written as a result of this first foray into publishing. </p>

<p>I am a simple user of this extraordinary framework and when I say simple, I <em>really</em> mean I had no idea how to get it to do anything when I started; I needed to do a lot of searching and learned by trial-and-error (emphasis on the errors which were entirely mine). The one thing that I did know was that the example graphics shown by Mike Bostock and others were the sort of graphical goodness that I wanted to play with.</p>

<p>So to get from the point of having no skills whatsoever to the point where I could begin to code up something to display data in a way I wanted, I had to capture the information as I went. 
The really cool thing about this sort of process is that it doesn’t need to occur all at once. You can start with no knowledge whatsoever (or pretty close) and by standing on the shoulders of other’s work, you can add building blocks to improve what you’re seeing and then change the blocks to adapt and improve. </p>

<p>For example (and this is pretty much how it started). I wanted to draw a line graph, so I imported an example and then got it running locally on my computer. Then I worked out how to change the example data for my data. Then I worked out how to move the Y axis from the right to the left. Then how to make the axis labels larger, change the tick size, make the lines fatter, change the colour, add a label, fill the area under the graph, put the graph in the centre of the page, add a glow to the text to help it stand out, put it in a framework (bootstrap), add buttons to change data sets, animate the transitions between data sets, update the data automatically when it changed, add a pan and zoom feature, turn parts of the graph into hyperlinks to move to other graphs… And then I started on bar graphs :-).  </p>

<p>The point to take away from all of this is that any one graph is just a collection of lots of blocks of code, each block designed to carry out a specific function. Pick the blocks you want and implement them. </p>

<p>I found it was much simpler to work on one thing (block) at a time, and this helped greatly to reduce  the uncertainty factor when things didn’t work as anticipated.
I’m not going to pretend that everything I’ve done while trying to build graphs employs the most elegant or efficient mechanism, but in the end, if it all works on the screen, I walk away happy :-). That’s not to say I have deliberately ignored any best practices – I just never knew what they were. Likewise, wherever possible, I have tried to make things as extensible as possible.</p>

<p>D3 has also steered down the road of providing standalone micro-libraries available as components and this flexibility continues to redefine the maxim of change being the only constant in the software world.</p>

<p>You will find that I have typically eschewed a simple “Do this approach” for more of a story telling exercise. This means that some explanations are longer and more flowery than might be to everyone’s liking, but there you go, try to be brave :-)</p>

<p>I’m sure most authors try to be as accessible as possible. I’d like to do the same, but be warned… There’s a good chance that if you ask me a technical question I may not know the answer. So please be gentle with your emails :-).</p>

<p>Email: ‘d3noobmail+contact@gmail.com’</p>


<h2 id="leanpub-auto-what-do-we-need-to-get-started">What do we need to get started?</h2>

<p>Let’s be honest with each other. D3 is not the simplest way to draw a graph.</p>

<p>However, that doesn’t mean that it’s beyond those with a little computer savy and a willingness to experiment. Remember failure is your friend (I am fairly sure that I am also related by blood). Just learn from your mistakes and it’ll all work out.</p>

<p>So, here in no particular order is a list of good things to know. None of which are essential, but any one (or more) of which will  make your life slightly easier.</p>

<ul>
  <li>HyperText Markup Language (HTML)</li>
  <li>JavaScript</li>
  <li>Cascading Style Sheets (CSS)</li>
  <li>Web Servers</li>
  <li>PHP</li>
</ul>

<aside class="warning blurb">
    <h3 id="leanpub-auto-dont-freak-out"><strong>DON’T FREAK OUT!</strong></h3>
  <p>First things first. This isn’t rocket science. It’s just the Internet.
We’ll take it gently, and I’ll be a little more specific in the following sections.</p>

</aside>

<h3 id="leanpub-auto-html">HTML</h3>
<p>This stands for HyperText Markup Language and is the stuff that web pages are made of. Check out the definition and other information on <a href="http://en.wikipedia.org/wiki/HTML">Wikipedia</a> for a great overview. Just remember that all you’re going to use HTML for is to hold the code that you will use to present your information. This will be as a .html (or .htm) file and they can be pretty simple (we’ll look at some in a moment). </p>

<h3 id="leanpub-auto-javascript">JavaScript</h3>
<p><a href="http://en.wikipedia.org/wiki/JavaScript">JavaScript</a> is what’s called a ‘scripting language’. It is the code that will be contained inside the HTML file that will make D3 do all its fanciness. In fact, D3 is a JavaScript Library, it’s the native language for using D3.</p>

<p>Knowing a little bit about this would be really good, but to be perfectly honest, I didn’t know anything about it before I started. I read a book along the way (<a href="http://shop.oreilly.com/product/9780596515898.do">JavaScript: The Missing Manual</a> from O’Reilly) and that helped with context, but the examples that are available for D3 graphics are understandable, and with a bit of trial and error, you can figure out what’s going on. </p>

<p>In fact, most of what this collection of information’s about is providing examples and explanations for the JavaScript components of D3.</p>

<h3 id="leanpub-auto-cascading-style-sheets-css">Cascading Style Sheets (CSS)</h3>
<p><a href="http://en.wikipedia.org/wiki/Css">Cascading Style Sheets</a> (everyone tends to call them ‘Style Sheets’ or ‘CSS’) is a language used to describe the formatting (or “<em>look and feel</em>”) of a document written in a markup language. The job of CSS is to make the presentation of the components you will draw with D3 simpler by assigning specific styles to specific objects. One of the cool things about CSS is that it is an enormously flexible and efficient method for making everything on the screen look more consistent and when you want to change the format of something you can just change the CSS component and the whole look and feel of your graphics will change.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/wordcloud.png" alt="The wonderful World of Cascading Style Sheets">
  <figcaption>The wonderful World of Cascading Style Sheets</figcaption>
</figure>


<aside class="information blurb">
    <h3 id="leanpub-auto-full-disclosure">Full disclosure</h3>
  <p>I know CSS is an incredibly powerful tool that would make my life easier, but I use it in a very basic (and probably painful) way. Don’t judge me, just accept that the way I’ve learnt was what I needed to get the job done (this probably means that noobs like myself will find it easier, but where possible try and use examples that include what look like logical CSS structures).</p>

</aside>

<div class="page-break"></div>
<h3 id="leanpub-auto-web-servers">Web Servers</h3>

<p>Web servers can go one of two ways. If you have access to a web server and know where to put the files so that you can access them with your browser, you’re in a good place. If you’re not quite sure, read on…</p>

<p>A web server will allow you to access your HTML files and will provide the structure that allows it to be displayed on a web browser. There are some simple instructions on the main <a href="https://github.com/mbostock/d3/wiki">D3 wiki page</a> for setting up a local server. Or you might have access to a remote one and be able to upload your files. However, for a little more functionality and a whole lot of ease of use, I can thoroughly recommend WampServer (WAMP) as a free and simple way to set up a local web server that includes PHP and a MySQL database (more on those later). Go to the <a href="http://www.wampserver.com/en/">WampServer web page</a> (http://www.wampserver.com/en/) and see if it suits you.</p>

<p>Throughout this document I will be describing the files and how they’re laid out in a way that has suited my efforts while using WAMP, but they will work equally well on a remote server. I will explain a little more about how I arrange the files later in the ‘Getting D3’ section.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/wamp.png" alt="WAMP = Windows + Apache + MySQL + PHP">
  <figcaption>WAMP = Windows + Apache + MySQL + PHP</figcaption>
</figure>


<p>There are other options of course. You could host code on <a href="https://github.com/about">GitHub</a> and present the resulting graphics on <a href="http://bl.ocks.org/">bl.ocks.org</a>. This is a great way to make sure that your code is available for peer review and sharing with the wider community. </p>

<p>One such alternative option that I have recently started playing with is Plunker (http://plnkr.co/) This is a lightweight collaborative online editing tool. It’s so cool I wrote a special section for it which you can find later in this document. This is definitely worth trying if you want to use something simple without a great deal of overhead. If you like what you see, perhaps consider an alternative that provides a greater degree of capability if you go on to greater d3.js things.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-php">PHP</h3>

<p>PHP is a scripting language for the web. That is to say that it is a programming language which is executed when you load web pages and it helps web pages do dynamic things. </p>

<p>You might think that this sounds familiar and that JavaScript does the same thing. But not quite.</p>

<p>JavaScript is designed so that it travels <em>with</em> the web page when it is downloaded by a browser (the <strong>client</strong>). However, PHP is executed remotely on the <strong>server</strong> that supplies the web page. This might sound a bit redundant, but it’s a big deal. This means that the PHP which is executed doesn’t form <em>part</em> of the web page, but it can <em>form</em> the web page. The implication here is that the web page you are viewing can be altered by the PHP code that runs on a remote server. This is the dynamic aspect of it.</p>

<p>In practice, PHP could be analogous to the glue that binds web pages together. Allowing different portions of the web page to respond to directions from the end user. </p>

<p>It is widely recognised not only as a relatively simple language to learn, but also as a fairly powerful one. At the same time it comes into criticism for being somewhat fragmented and sometimes contradictory or confusing. But in spite of any perceived shortcomings, it is a very widely used and implemented language and one for which there is no obvious better option.</p>

<h3 id="leanpub-auto-other-useful-stuff">Other Useful Stuff</h3>

<h4 id="leanpub-auto-text-editor">Text Editor</h4>
<p>A good text editor for writing up your code will be a real boost. Don’t make the fatal mistake of using an office word processor or similar. <strong>THEY WILL DOOM YOU TO A LIFE OF MISERY</strong>. They add in crazy stuff that you can’t even see and never save the files in a way that can be used properly. </p>

<p>Preferably, you should get an editor that will provide some assistance in the form of syntax highlighting which is where the editor knows what language you are writing in (JavaScript for example) and highlights the text in a way that helps you read it.
For example, it will change text that might appear as this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>// Get the data
d3.tsv("data/data.tsv", function(error, data) {
data.forEach(function(d) {
    d.date = parseDate(d.date
    d.close = +d.close;
});
</pre></div>

</figure>

<p>Into something like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">tsv</code><code class="p">(</code><code class="s2">"data/data.tsv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
<code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>Infinitely easier to use. Trust me.</p>

<p>There are plenty of editors that will do the trick. I have a preference for <a href="http://www.geany.org/">Geany</a>, mainly because it’s what I started with and it grew on me :-). </p>

<h4 id="leanpub-auto-getting-d3">Getting D3</h4>

<p>Luckily this is pretty easy and could go one of two ways.</p>

<h5 id="leanpub-auto-host-d3js-locally">Host d3.js locally</h5>

<p>Go to the D3 repository on <a href="https://github.com/mbostock/d3">github</a> and download the entire repository by clicking on the ‘ZIP’ button.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/downloadrepository.png" alt="Download the repository as a zip file">
  <figcaption>Download the repository as a zip file</figcaption>
</figure>


<p>What you do with it from here depends on how you’re hosting your graphs. If you’re working on them on your local PC, then you will want to have the d3.js file in the path that can be seen by the browser. Again, I would recommend WAMP (a local web server) to access your files locally. If you’re using WAMP, then you just have to make sure that it knows to use a directory that will contain the d3 directory and you will be away. </p>

<h5 id="leanpub-auto-use-a-remote-cdn-to-always-use-the-latest-version-of-d3js">Use a remote CDN to always use the latest version of d3.js</h5>

<p>The alternative to downloading d3.js and using it locally is to always retrieve it from an online source. For d3.js this could be done via having the following line in our JavaScript; <code>&lt;script src="https://d3js.org/d3.v4.min.js"&gt;&lt;/script&gt;</code>. This method has the advantage of always using the latest version of D3 and is especially useful if your visualisations are hosted somewhere like bl.ocks.org.</p>

<h5 id="leanpub-auto-potential-directory-structure">Potential directory structure</h5>

<p>The following image is intended to provide a very crude overview of how we can set up the directories for our web server.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/dirlayout.png" alt="A potential directory structure for your files">
  <figcaption>A potential directory structure for your files</figcaption>
</figure>


<ul>
  <li>webserver: Use this as our ‘base’ directory where you put our files that we create. That way when we open our browser we point to this directory and it allows us to access the files like a normal web site.</li>
  <li>d3: This would be our unzipped d3 directory. It contains all the examples and more importantly the d3.v4.js file that we need to get things going. To do this we would include a line like the following;</li>
</ul>

<figure class="code">
<div class="highlight"><pre><code></code><code class="o">&lt;</code><code class="nx">script</code> <code class="nx">type</code><code class="o">=</code><code class="s2">"text/javascript"</code> <code class="nx">src</code><code class="o">=</code><code class="s2">"d3/d3.v4.js"</code><code class="o">&gt;&lt;</code><code class="err">/script&gt;</code>
</pre></div>

</figure>

<p>This tells our browser that from the file it is running (one of the html graph files) if it goes into the ‘d3’ folder it will find the <code>d3.v4.js</code> file that it can load.</p>

<ul>
  <li>data: I use this directory to hold any data files that I would use for processing. For example, you will see the following line in the code examples that follow <code>d3.csv("data/data.csv", function(error, data) {</code>. Again, that’s telling the browser to go into the ‘data’ directory and to load the ‘data.csv’ file.</li>
  <li>js: Often we will find that we will want to include other JavaScript libraries to load. This is a good place to put them.</li>
</ul>

<h4 id="leanpub-auto-where-to-get-information-on-d3js">Where to get information on d3.js</h4>

<p>D3 has made huge advances in providing an extensible and practical framework for manipulating data as web objects. At the same time there has been significant increase in information available for people to use it. The following is a far from exhaustive list of sources, but from my own experience it represents a useful subset of knowledge.</p>

<h5 id="leanpub-auto-d3jsorg">d3js.org</h5>

<p>d3js.org would be the first port of call for people wanting to know something about d3.js.</p>

<p>From the overview on the main page you can access a dizzying array of <a href="https://github.com/mbostock/d3/wiki/Gallery">examples</a> that have been provided by the founder of d3 (Mike Bostock) and a host of additional developers, artists, coders and anyone who has something to add to the sum knowledge of cool things that can be done with D3.</p>

<p>There is a link to a <a href="https://github.com/mbostock/d3/wiki">documentation page</a> that serves as a portal to the ever important API reference, contributed tutorials and other valuable links (some of which I will mention in paragraphs ahead).</p>

<p>The last major link is to the <a href="https://github.com/mbostock/d3">Github repository</a> where you can download d3.js itself.</p>

<p>It is difficult to overstate the volume of available information that can be accessed from d3js.org. It stands alone as the one location that anyone interested in D3 should visit.</p>

<h5 id="leanpub-auto-google-groups">Google Groups</h5>

<p>There is a Google Group dedicated to <a href="https://groups.google.com/forum/?fromgroups#!forum/d3-js">discussions on d3.js</a>. </p>

<p>In theory this forum  is for discussions on topics including visualization design, API design, requesting new features, etc. With a specific direction made in the main header that “<em>If you want help using D3, please use the d3.js tag on Stack Overflow!</em>”. </p>

<p>In practice however, it would appear that a sizeable proportion of the posts there are technical assistance requests of one type or another. Having said that this means that if you’re having a problem, there could already be a solution posted there. However, if at all possible the intention is certainly that people use Stack Overflow, so this should be the first port of call for those types of inquiry.</p>

<p>So, by all means add this group as a favourite and this will provide you with the opportunity to receive emailed summaries of postings or just an opportunity to easily browse recent goings-on.</p>

<h5 id="leanpub-auto-stack-overflow">Stack Overflow</h5>

<p>Stack Overflow  is a question and answer site whose stated desire is “<em>to build a library of detailed answers to every question about programming</em>”. Ambitious. So how are they doing? Actually really well. Stack overflow is a fantastic place to get help and information. It’s also a great place to help people out if you have some knowledge on a topic.</p>

<p>They have a funny scheme for rewarding users that encourages providing good answers based on readers voting. It’s a great example of gamification working well. If you want to know a little more about how it works, check out this page; http://stackoverflow.com/about.</p>

<p>They have a d3.js tag (http://stackoverflow.com/questions/tagged/d3.js) and like Google Groups there is a running list of different topics that are an excellent source of information.</p>

<h5 id="leanpub-auto-github">Github</h5>

<p><a href="https://github.com/">Github</a> is predominantly a code repository and version control site. It is highly regarded for its technical acumen and provides a fantastic service that is broadly used for many purposes. Not the least of which is hosting the code (and the wiki) for d3.js.</p>

<p>Whilst not strictly a site that specialises in providing a Q &amp; A function, there is a significant number of repositories which mention d3.js. With the help from an astute search phrase, there is potentially a solution to be found there.</p>

<p>The other associated feature of Github is Gist. Gist is a pastebin service (a place where you can copy and past code) that can provide a ‘wiki like’ feature for individual repositories and web pages that can be edited through a Git repository. Gist plays a role in providing the hub for the bl.ocks.org example hosting service set up by Mike Bostock.</p>

<p>For a new user, Github / Gist can be slightly daunting. It’s an area where you will get most value by understanding something about the services before you start using them. This is certainly true if you want to make use of its incredible features that are available for hosting code. However, if you want to browse other peoples code it’s an easier introduction. Have a look through what’s available and if you feel so inclined, I recommend that you learn enough to use their service. It’s time well spent. </p>

<h5 id="leanpub-auto-blocksorg">bl.ocks.org</h5>

<p><a href="http://bl.ocks.org/">bl.ocks.org</a> is a viewer for code examples which are hosted on Gist. You are able to load your code into Gist, and then from bl.ocks.org you can view them.</p>

<p>This is a really great way for people to provide examples of their work and there are many who do. However, it’s slightly tricky to know what is there. There is a <a href="http://blockbuilder.org/search">project</a> that will help with searching the bl.ocks for key words. This is an immensely valuable service that should be a highlight for someone wanting inspiration or assistance. </p>

<p>I would describe the process of getting your own code hosted and displaying as something that will be slightly challenging for people who are not familiar with Github / Gist, but again, in terms of visibility of the code and providing an external hosting solution, it is excellent and well worth the time to get to grips with.</p>

<h5 id="leanpub-auto-twitter">Twitter</h5>

<p>Twitter provides a great alerting service to inform a large disparate group of people about <em>stuff</em>. </p>

<p>It’s certainly a great way to keep in touch on an hour by hour basis with people who are involved with d3.js and this can be accomplished in a couple of ways. First, find as many people from the various D3 sites around the web who you consider to be influential in areas you want to follow (different aspects such as development, practical output, educational (etc) and follow them. Even better, I found it useful to find a small subset who I considered to be influential people and I noted who they followed. It’s a bit ‘<em>stalky</em>’ if you’re unfamiliar with it, but the end result should be a useful collection of people with something useful to say.</p>

<h5 id="leanpub-auto-books">Books</h5>

<p>The following books are referenced on the D3 wiki;</p>

<ul>
  <li>
<em><a href="http://shop.oreilly.com/product/0636920025429.do">Getting Started with D3</a></em>: Mike Dewar, O’Reilly Media, June 2012</li>
  <li>
<em><a href="http://chimera.labs.oreilly.com/books/1230000000345">Interactive Data Visualization for the Web</a></em>: Scott Murray, O’Reilly Media, November 2012</li>
  <li>
<em><a href="http://www.packtpub.com/data-visualization-with-d3js/book">Data Visualization with d3.js</a></em>: Swizec Teller, Packt Publishing, October 2013</li>
  <li>
<em><a href="http://www.packtpub.com/data-visualization-with-d3-js-cookbook/book">Data Visualization with D3.js Cookbook</a></em>:  Nick Qi Zhu, Packt Publishing, October 2013</li>
  <li>
<em><a href="https://www.packtpub.com/web-development/mastering-d3js">Mastering D3.js</a></em>: Pablo Navarro Castillo, Packt Publishing, August 2014</li>
  <li>
<em><a href="http://www.manning.com/meeks/">D3.js in Action</a></em>: Elijah Meeks, Manning Publications, 2014</li>
  <li>
<em><a href="https://www.packtpub.com/web-development/learning-d3js-mapping">Learning D3.js Mapping</a></em>: Thomas Newton, Oscar Villarreal, Packt Publishing, 2014</li>
  <li>
<em><a href="http://ritchiesking.com/book/">Visual Storytelling with D3</a></em>: Ritchie King, Addison-Wesley, 2014</li>
  <li>
<em><a href="https://leanpub.com/d3angularjs">D3 on AngularJS</a></em>: Ari Lerner + Victor Powell, Leanpub, 2014</li>
</ul>

<p>Of course, there is also the original paper that launched D3 <em><a href="http://vis.stanford.edu/papers/d3">D3: Data-Driven Documents</a></em> by Michael Bostock, Vadim Ogievetsky and Jeffrey Heer (IEEE Trans. Visualization &amp; Comp. Graphics (Proc. InfoVis), 2011)</p>


<h2 id="simplegraph">Starting with a simple graph</h2>

<p>We’ll start with the full code for a simple graph and then we can go through it piece by piece. </p>

<p>Here’s what the basic graph looks like;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/basicgraph.png" alt="Basic Graph">
  <figcaption>Basic Graph</figcaption>
</figure>


<p>And here’s the code that makes it happen;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code> <code class="c">/* set the CSS */</code>

<code class="nc">.line</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>    	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="c1">// set the dimensions and margins of the graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// parse the date / time</code>
<code class="kd">var</code> <code class="nx">parseTime</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">timeParse</code><code class="p">(</code><code class="s2">"%d-%b-%y"</code><code class="p">);</code>

<code class="c1">// set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleTime</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="c1">// define the line</code>
<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>

<code class="c1">// append the svg obgect to the body of the page</code>
<code class="c1">// appends a 'group' element to 'svg'</code>
<code class="c1">// moves the 'group' element to the top left margin</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>

  <code class="c1">// format the data</code>
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
  <code class="p">});</code>

  <code class="c1">// Scale the range of the data</code>
  <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>

  <code class="c1">// Add the valueline path.</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="nx">data</code><code class="p">])</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">);</code>

  <code class="c1">// Add the X Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>

  <code class="c1">// Add the Y Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>

<code class="p">});</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/402dd382a51a4f6eea487f9a35566de0">github</a> or in the code samples bundled with this book (simple-graph.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0">bl.ocks.org</a>. Please note that the <code>&lt;head&gt;&lt;/head&gt;</code> tags are omitted which is a common thing for d3 examples (It’s presumably an effort to reduce potentially distracting code for when modern browsers can cope with the omission). </p>

<p>Once we’ve finished working through the explanation of the functional blocks that make up the graph, we’ll start looking at what we need to add in and adjust so that we can incorporate other useful functions that are completely reusable in other diagrams as well.</p>

<p>Working on the premiss that we can break the file down into component parts we will explain the major blocks as <a href="#html">HTML</a>, <a href="#css">CSS</a> and <a href="#javascript">JavaScript</a>. I’m going to play kind of fast and loose here, but never fear, it’ll all make sense.</p>

<div class="page-break"></div>
<h3 id="html">HTML</h3>

<p>Here’s the HTML portion of the code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>

    <code class="nt">The</code> <code class="nt">CSS</code> <code class="nt">is</code> <code class="nt">in</code> <code class="nt">here</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

    <code class="nx">The</code> <code class="nx">D3</code> <code class="nx">JavaScript</code> <code class="nx">code</code> <code class="nx">is</code> <code class="nx">here</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Compare it with the full code. It kind of looks like a wrapping for the <a href="#css">CSS</a> and <a href="#javascript">JavaScript</a>. You can see that it really doesn’t boil down to much at all (that doesn’t mean it’s not important).</p>

<p>There are plenty of good options for adding additional HTML stuff into this very basic part of the file, but for what we’re going to be doing, we really don’t need to bother too much.</p>

<p>One thing probably worth mentioning is the line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>That’s the line that identifies the file that needs to be loaded to get D3 up and running. In this case the file is sourced from the official d3.js repository on the Internet (that way we are using the most up to date version). The D3 file is actually called <code>d3.v4.min.js</code> which may come as a bit of a surprise. That tells us that this is version 4 of the d3.js file (the <code>v4</code> part) which is an indication that it is separate from the v3 release, which was superseded in the middle of 2016. The other point to note is that this version of d3.js is the minified version (hence <code>min</code>). This means that any extraneous information has been removed from the file to make it quicker to load.</p>

<p>Later when doing things like implementing integration with bootstrap (a pretty layout framework) we will be doing a great deal more, but for now, that’s the basics done.</p>

<p>The two parts that we left out are the <a href="#css">CSS</a> and the D3 <a href="#javascript">JavaScript</a>.</p>

<div class="page-break"></div>
<h3 id="css">Cascading Style Sheets (CSS)</h3>

<p>The CSS is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.line</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Cascading Style Sheets (CSS) give you control over the look / feel / presentation of web content. The idea is to define a set of properties to objects in the web page.</p>

<p>They are made up of ‘rules’. Each rule has a ‘selector’ and one or more ‘declarations’ and each declaration has a property and a value (or a group of properties and values).</p>

<p>For instance in the example code for this web page we have the following rule;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.line</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p><code>line</code> is the selector. The period (.) in front of <code>line</code> indicates that the selector is a ‘class’. This tells us that on the web page, any particular element (and we are going to apply this rule to the line of our graph) which we decorate with the ‘class’, <code>line</code> will have the various declarations applied to it. </p>

<p>There are three declarations as part of the rule. These are contained within the curly braces and separated by semi-colons.</p>

<p>One of the declarations is for the width of the graph line (<code>stroke-width: 2px;</code>) The property is <code>stroke-width:</code> and the value is <code>2px</code> (2 pixels). This tells the web page that any element in the web page that has the class <code>line</code> will have lines drawn that are (amongst other things) 2 pixels wide.</p>

<p>Sure enough if we look at the line of the graph…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/stroke-width-01.png" alt="Graph line with stroke-width of 2 pixels">
  <figcaption>Graph line with stroke-width of 2 pixels</figcaption>
</figure>


<p>That looks as if the line might <em>actually</em> be 2 pixels wide!</p>

<p>Let’s try a test. We can change that particular declaration to the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nt">stroke-width</code><code class="o">:</code> <code class="nt">20px</code><code class="o">;</code>
</pre></div>

</figure>

<p>and the result is…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/stroke-width-02.png" alt="Graph line with stroke-width of 20 pixels">
  <figcaption>Graph line with stroke-width of 20 pixels</figcaption>
</figure>


<p>Ahh…. 20 pixels of goodness!</p>

<p>Because we’re getting the hang of things now, let’s change the colour declaration to…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nt">stroke</code><code class="o">:</code> <code class="nt">red</code><code class="o">;</code>
</pre></div>

</figure>

<p>and we get…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/stroke-width-03.png" alt="Graph line with stroke colour changed to red">
  <figcaption>Graph line with stroke colour changed to red</figcaption>
</figure>


<p>Awesome! I think we can safely say that this has had the desired effect.</p>

<p>So what else is there?</p>

<p>Since there’s only one declaration left, it seems like a shame not to try something different with it;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nt">fill</code><code class="o">:</code> <code class="nt">blue</code><code class="o">;</code>
</pre></div>

</figure>

<p>We’ll get…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/basicgraph-02.png" alt="Basic Graph with changed CSS">
  <figcaption>Basic Graph with changed CSS</figcaption>
</figure>


<p>So the ‘fill’ property looks like it will change the colour of the area that would be closed by the line. Nice.</p>

<p>The one thing to take away from this small exercise is that there is a good deal of flexibility in adjusting properties of elements on the web page via CSS.</p>

<div class="page-break"></div>
<h3 id="javascript">D3 JavaScript</h3>

<p>The D3 JavaScript part of the code is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// set the dimensions and margins of the graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// parse the date / time</code>
<code class="kd">var</code> <code class="nx">parseTime</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">timeParse</code><code class="p">(</code><code class="s2">"%d-%b-%y"</code><code class="p">);</code>

<code class="c1">// set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleTime</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="c1">// define the line</code>
<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>

<code class="c1">// append the svg obgect to the body of the page</code>
<code class="c1">// appends a 'group' element to 'svg'</code>
<code class="c1">// moves the 'group' element to the top left margin</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>

  <code class="c1">// format the data</code>
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
  <code class="p">});</code>

  <code class="c1">// Scale the range of the data</code>
  <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>

  <code class="c1">// Add the valueline path.</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="nx">data</code><code class="p">])</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">);</code>

  <code class="c1">// Add the X Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>

  <code class="c1">// Add the Y Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>

<code class="p">});</code>
</pre></div>

</figure>

<p>Again there’s quite a bit of detail in the code, but it’s not so long that we can’t work out what’s doing what.</p>

<p>The first thing to note is that throughout the code we have lines that are adding a description of what the code does. These have two forward-stroke characters (//) preceding them which the computer will recognise as a line that only contains comments. I recommend that you add them into your own code where you think that you might want reminding of a function or description.</p>

<p>Let’s examine the blocks bit by bit to get a feel for it.</p>

<h4 id="leanpub-auto-setting-up-the-margins-and-the-graph-area">Setting up the margins and the graph area.</h4>

<p>The part of the code responsible for defining the canvas (or the area where the graph and associated bits and pieces is placed ) is this part.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>This is really (<strong><em>really</em></strong>) well explained on Mike Bostock’s page on margin conventions here <a href="http://bl.ocks.org/3019563">http://bl.ocks.org/3019563</a>, but at the risk of confusing you here’s my crude take on it.</p>

<p>The first line defines the four margins which surround the block where the graph (as an object) is positioned.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
</pre></div>

</figure>

<p>So there will be a border of 20 pixels at the top, 20 at the right and 30 and 50 at the bottom and left respectively. Now the cool thing about how these are set up is that they use a JavaScript object to define everything. That means if you want to do calculations in the JavaScript later, you don’t need to put the numbers in, you just use the variable that has been set up. In this case margin.right = 20!</p>

<aside class="information blurb">
    <p>JavaScript can store variables in arrayts and objects. A simple way to consider them is that an array is defined with square brackets or with <code>new Array()</code> and an object uses the curly braces. Above we have a JavaScript object with four properties. Each property of an object must have a unique name, thus each property can be referred to with dot syntax, such as margin.right, while the elements of an array are unnamed and can only be referred by position, such as myArray[0], myArray[3], etc.</p>

  <p>Many thanks to Dave Lampton for providing the clarification above (and others following).</p>

</aside>

<p>So when we go to the next line;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
</pre></div>

</figure>

<p>The width of the inner block of the area where the graph will be drawn is 960 pixels – margin.left –  margin.right or 960-50-20 or 890 pixels wide. Of course now we have another variable ‘width’ that we can use later in the code.</p>

<p>Obviously the same treatment is given to height.</p>

<p>Another cool thing about all of this is that just because we appear to have defined separate areas for the graph and the margins, the whole area in there is available for use. It just makes it really useful to have areas designated for the axis labels and graph labels without having to juggle them and the graph proper at the same time.</p>

<p>So, let’s have a play and change some values.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">80</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">80</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">400</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">270</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/squishedgraph.png" alt="The effect of changing the margins">
  <figcaption>The effect of changing the margins</figcaption>
</figure>


<p>Here we’ve made the  graph narrower (400 pixels) but retained the left / right margins and increased the top / bottom margins while changing the overall height of the canvas to 270 pixels. The really cool thing that you can tell from this is that while we shrank the dimensions of the area that we had to draw the graph in, it was still able to dynamically adapt the axes and line to fit properly (Although the x axis values got a bit squished. Don’t worry we’ll work through that shortly). That is the really cool part of this whole business. D3 is running in the background looking after the drawing of the objects, while you get to concentrate on how the data looks without too much maths!</p>

<aside class="information blurb">
    <p>You will have noticed that the axes have certainly not fared too well in this transformation. This is because we are using absolutely no <a href="#axes">styling or configuration for the axes</a> on this graph at all. We will however certainly be looking at this in more depth in subsequent chapters.</p>

</aside>

<h4 id="leanpub-auto-getting-the-data">Getting the Data</h4>

<p>We’re going to jump forward a little bit here to the portion of the JavaScript code that loads the data for the graph.</p>

<p>I’m going to go out of the sequence of the code here, because if you know what the data is that you’re using, it will make explaining some of the other functions much easier.</p>

<p>The section that grabs the data is this bit.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>
  
<code class="c1">// format the data</code>
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>There’s lots of different ways that we can get data into our web page and turn it into graphics. The method that we’ll want to use will probably depend more on the format that the data is in than the mechanism we want to use for importing. </p>

<p>For instance, if it’s only a few points of data we could include the information directly in the JavaScript. </p>

<p>That would make it look something like;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[</code>
    <code class="p">{</code><code class="nx">date</code><code class="o">:</code><code class="s2">"1-May-12"</code><code class="p">,</code><code class="nx">close</code><code class="o">:</code><code class="s2">"58.13"</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">date</code><code class="o">:</code><code class="s2">"30-Apr-12"</code><code class="p">,</code><code class="nx">close</code><code class="o">:</code><code class="s2">"53.98"</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">date</code><code class="o">:</code><code class="s2">"27-Apr-12"</code><code class="p">,</code><code class="nx">close</code><code class="o">:</code><code class="s2">"67.00"</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">date</code><code class="o">:</code><code class="s2">"26-Apr-12"</code><code class="p">,</code><code class="nx">close</code><code class="o">:</code><code class="s2">"89.70"</code><code class="p">},</code>
    <code class="p">{</code><code class="nx">date</code><code class="o">:</code><code class="s2">"25-Apr-12"</code><code class="p">,</code><code class="nx">close</code><code class="o">:</code><code class="s2">"99.00"</code><code class="p">}</code>
<code class="p">];</code>
</pre></div>

</figure>
<p>The format of the data shown above is called <a href="#json">JSON</a> (JavaScript Object Notation) and it’s a great way to include data since it’s easy for humans to read what’s in there and it’s easy for computers to parse the data out. For a brief overview of JSON there is a <a href="#json">separate section in the “Assorted Tips and Tricks Chapter”</a> that may assist.</p>

<p>But if you’ve got a fair bit of data or if the data you want to include is dynamic and could be changing from one moment to the next, you’ll want to load it from an external source. That’s when we call on D3’s ‘Request’ functions.</p>

<aside class="information blurb">
    <h3 id="leanpub-auto-request-functions">Request Functions</h3>
  <p>A ‘Request’ is a function that instructs the browser to reach out and grab some data from somewhere. It could be stored locally (on the web server) or somewhere out in the Internet.
There are different types of requests depending on the type of data you want to ingest. Each type of data is formatted with different rules, so the different requests interpret those rules to make sure that the data is returned to the D3 processing in a format that it understands. You could therefore think of the different ‘Requests’ as translators and the different data formats as being foreign languages.</p>

</aside>

<p>The different types of data that can be requested by D3 are;</p>

<ul>
  <li>
<strong><a href="https://github.com/d3/d3-request/blob/master/README.md#text">text</a></strong>: A plain old piece of text that has options to be encoded in a particular way.</li>
  <li>
<strong><a href="https://github.com/d3/d3-request/blob/master/README.md#json">json</a></strong>: This is the aforementioned JavaScript Object Notation.</li>
  <li>
<strong><a href="https://github.com/d3/d3-request/blob/master/README.md#xml">xml</a></strong>: Extensible Markup Language is a language that is widely used for encoding documents in a human readable forrm.</li>
  <li>
<strong><a href="https://github.com/d3/d3-request/blob/master/README.md#html">html</a></strong>: HyperText Markup Language is the language used for displaying web pages.</li>
  <li>
<strong><a href="https://github.com/d3/d3-request/blob/master/README.md#csv">csv</a></strong>: Comma Separated Values is a widely used format for storing data where plain text information is separated by (wait for it) commas.</li>
  <li>
<strong><a href="https://github.com/d3/d3-request/blob/master/README.md#tsv">tsv</a></strong>: Tab Separated Values is a widely used format for storing data where plain text information is separated by a tab-stop character.</li>
</ul>

<p>Details on these ingestion methods and the formats for the requests are well explained on the <a href="https://github.com/mbostock/d3/wiki/Requests">D3 Wiki</a> page. In this particular script we will look at the csv request method.</p>

<aside class="information blurb">
    <p>Now, it’s important to note that this is not an exclusive list of what can be ingested. If you’ve got some funky data in a weird format, you can still get it in, but you will most likely need to stand up a small amount of code somewhere else in your page to do the conversion (we will look at this process when describing getting data from a MySQL database).</p>

</aside>

<p>Back to our request…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>
  
<code class="c1">// format the data</code>
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>The first line of that piece of code invokes the d3.csv request (<code>d3.csv</code>) and then the function is pointed to the data file that should be loaded (<code>data.csv</code>). This is referred to as the ‘URL’ (Unique Resource Locator) of the file. In this case the file is stored locally (in the same directory as the <code>simple-graph.html</code> file), but the URL could just as easily point to a file somewhere on the Internet.</p>

<p>The format of the data in the data.csv file looks a bit like this (although the file is longer (about 26 data points));</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close
1-May-12,58.13
30-Apr-12,53.98
27-Apr-12,67.00
26-Apr-12,89.70
25-Apr-12,99.00
</pre></div>

</figure>

<p>The ‘date’ and the ‘close’ heading labels are separated by a comma as are each subsequent date and number. Hence the ‘comma separated values’ :-).</p>

<p>The next part is part of the coolness of JavaScript. With the request for the file made, the script is told to carry out a function on the data (which will now be called ‘data’).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>The function statement will catch any error that is generated and load the data that is ingested as the array ‘data’. The following line ensures that any errors that are generated are captured and ‘thrown’ to an appropriate ‘catch’ block (if it exists) in the function. If it doesn’t exist the program will terminate.  </p>

<p>There are actually more things that get acted on as part of the function call (which we will examine soon), but the one we will consider here is contained in the following lines;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>This block of code ensures that all the values that are pulled out of the csv file are set and formatted correctly. The first line declares that the data array called ‘data’ (confusingly) is being dealt with and tells the block of code that, for each group within the ‘data’ array it should carry out a function on it. Furthermore, when it carries out the formatting of each part of the array, it should designate the equivalent of each row as being ‘d’.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
</pre></div>

</figure>

<p>The information in the array can be considered as being stored in rows. Each row consists of two values: one value for ‘date’ and another value for ‘close’.</p>

<p>The function is pulling out values of ‘date’ and ‘close’ one row at a time.</p>

<p>Each time (Get it? <code>forEach</code>?) it gets a value of ‘date’ and ‘close’ it carries out the following operations;</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
</pre></div>

</figure>

<p>For each value of date being operated on (d.date), d3.js changes it into a date format that is processed via a separate function ‘parseTime’. (The <code>parseTime</code> function is defined in a separate part of the script, and we will examine that later.) For the moment, be satisfied that it takes the raw date information from the CSV file in each row and converts it into a format that D3 can recognise as a date/time. That value is then re-saved in the same variable space.</p>

<p>The next line then sets the ‘close’ variable to a numeric value (if it isn’t already) using the ‘+’ operator.</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
</pre></div>

</figure>

<aside class="tip blurb">
    <p>This appears to be good practice when the format of the number being pulled out of the data may not mean that it is automagically recognised as a number. This line will ensure that it is.</p>

</aside>

<p>At the end of this section of code, we have gone out and picked up a file with data in it of a particular type (comma separated values) and ensured that it is formatted in a way that the rest of the script can use correctly.</p>

<p>Now, the astute amongst you will have noticed that in the first line of that block of code (<code>d3.csv("data.csv", function(error, data) {</code>) we opened a normal bracket ( <code>(</code> ) and a curly bracket ( <code>{</code> ), but we never closed them. That’s because they stay open until the very end of the file. That means that all those blocks that occur after the <code>d3.csv</code> bit are referenced to the <code>data</code> array. Or put another way, it uses the data in the <code>data</code> array to draw stuff!</p>

<p>But anyway, let’s get back to figuring what the code is doing by jumping back to the end of the margins block.</p>

<h4 id="leanpub-auto-formatting-the-date--time">Formatting the Date / Time.</h4>

<p>One of the glorious things about the World is that we all do things a bit differently. One of those things is how we refer to <a href="http://en.wikipedia.org/wiki/Date_format_by_country">dates and time</a>.</p>

<p>In my neck of the woods, it’s customary to write the date as day - month – year. E.g 23-12-2012. But in the United States the more common format would be 12-23-2012. Likewise, the data may be in formats that name the months or weekdays (E.g. January, Tuesday) or combine dates and time together (E.g. 2012-12-23 15:45:32). So, if we were to attempt to try to load in some data and to try and get D3 to recognise it as date / time information, we really need to tell it what format the date / time is in.</p>

<aside class="question blurb">
    <h3 id="leanpub-auto-does-time-matter">Does Time Matter?</h3>
  <p>You might be asking yourself “What’s the point?” All you want to do is give it a number and it can sort it out somehow. Well, that is true, but if you want to really bring out the best in your data and to keep maximum flexibility in representing it on the screen, you will want D3 to play to its strengths. And one of those is being able to adjust dynamically with variable time values.</p>

</aside>

<p>Time for a little demonstration (see what I did there).</p>

<p>We will change our data.csv file so that it only includes two points. The first one and the last one with a separation of a month and a bit. It will therefore look a little like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close
1-May-12,58.13
26-Mar-12,606.98
</pre></div>

</figure>

<p>The graph now looks like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/straightgraph.png" alt="Simple line graph">
  <figcaption>Simple line graph</figcaption>
</figure>


<p>Nothing too surprising here, a very simple graph (note the time scale on the x axis). </p>

<p>Now we will change the later date in the data.csv file so that it is a lot closer to the starting date;</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close
29-Mar-12,58.13
26-Mar-12,606.98
</pre></div>

</figure>

<p>So, just a three day difference. Let’s see what happens.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/straightgraph2.png" alt="Simple line graph over three days">
  <figcaption>Simple line graph over three days</figcaption>
</figure>


<p>Ahh…. Not only did we not have to make any changes to our JavaScript code, but it was able to recognise the dates were closer and fill in the intervening gaps with appropriate time / day values. 
Now, one more time for giggles.</p>

<p>This time we’ll stretch the interval out by a few years.</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close
29-Mar-21,58.13
26-Mar-12,606.98
</pre></div>

</figure>

<p>and the result is…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/straightgraph3.png" alt="Simple line graph over several years">
  <figcaption>Simple line graph over several years</figcaption>
</figure>


<p>Hopefully that’s enough encouragement to impress upon you that formatting the time is a <em>REALLY</em> good thing to get right. Trust me, it will never fail to impress :-).</p>

<p>Back to formatting.</p>

<p>The line in the JavaScript that parses the time is the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">parseTime</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">timeParse</code><code class="p">(</code><code class="s2">"%d-%b-%y"</code><code class="p">);</code>
</pre></div>

</figure>

<p>This line is used when the <code>data.forEach(function(d)</code> portion of the code (that we looked at a couple of pages back) used <code>d.date = parseTime(d.date)</code> as a way to take a date in a specific format and to get it recognised by D3. In effect it said “<em>take this value that is supposedly a date and make it into a value I can work with</em>”.</p>

<p>The function used is the <code>d3.timeParse(specifier)</code> function where the specifier in this case is the mysterious combination of characters <code>%d-%b-%y</code>. The good news is that these are just a combination of directives specific for the type of date we are presenting.</p>

<p>The <code>%</code> signs are used as prefixes to each separate format type and the ‘<code>-</code>’ (minus) signs are literals for the actual ‘<code>-</code>’ (minus) signs that appear in the date to be parsed.</p>

<p>The <code>d</code> refers to a zero-padded day of the month as a decimal number [01,31].</p>

<p>The <code>b</code> refers to an abbreviated month name. </p>

<p>And the <code>y</code> refers to the year (without the centuries) as a decimal number.</p>

<p>If we look at a subset of the data from the data.csv file we see that indeed, the dates therein are formatted in this way.</p>

<figure class="code">
<div class="highlight"><pre><code></code>1-May-12,58.13
30-Apr-12,53.98
27-Apr-12,67.00
26-Apr-12,89.70
25-Apr-12,99.00
</pre></div>

</figure>

<p>That’s all well and good, but what if your data isn’t formatted exactly like that?</p>

<p>Good news. There are multiple different formatters for different ways of telling time and you get to pick and choose which one you want. Check out the Time Formatting page on the <a href="https://github.com/d3/d3-time-format/blob/master/README.md#locale_format">D3 Wiki</a> for the authoritative list and some great detail, but the following is the list of currently available formatters (from the d3 wiki);</p>

<ul>
  <li>%a - abbreviated weekday name.</li>
  <li>%A - full weekday name.</li>
  <li>%b - abbreviated month name.</li>
  <li>%B - full month name.</li>
  <li>%c - date and time, as “%a %b %e %H:%M:%S %Y”.</li>
  <li>%d - zero-padded day of the month as a decimal number [01,31].</li>
  <li>%e - space-padded day of the month as a decimal number [ 1,31].</li>
  <li>%H - hour (24-hour clock) as a decimal number [00,23].</li>
  <li>%I - hour (12-hour clock) as a decimal number [01,12].</li>
  <li>%j - day of the year as a decimal number [001,366].</li>
  <li>%m - month as a decimal number [01,12].</li>
  <li>%M - minute as a decimal number [00,59].</li>
  <li>%p - either AM or PM.</li>
  <li>%S - second as a decimal number [00,61].</li>
  <li>%U - week number of the year (Sunday as the first day of the week) as a decimal number [00,53].</li>
  <li>%w - weekday as a decimal number [0(Sunday),6].</li>
  <li>%W - week number of the year (Monday as the first day of the week) as a decimal number [00,53].</li>
  <li>%x - date, as “%m/%d/%y”.</li>
  <li>%X - time, as “%H:%M:%S”.</li>
  <li>%y - year without century as a decimal number [00,99].</li>
  <li>%Y - year with century as a decimal number.</li>
  <li>%Z - time zone offset, such as “-0700”.</li>
  <li>There is also a  a literal “%” character that can be presented by using double % signs.</li>
</ul>

<p>As an example, if you wanted to input date / time formatted as a generic MySQL ‘YYYY-MM-DD HH:MM:SS’ TIMESTAMP format the D3 parse script would look like;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">parseTime</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">timeParse</code><code class="p">(</code><code class="s2">"%Y-%m-%d %H:%M:%S"</code><code class="p">);</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-setting-scales-domains-and-ranges">Setting Scales Domains and Ranges</h4>

<p>This is another example where, if you set it up right, D3 will look after you forever.</p>

<aside class="tip blurb">
    <h4 id="leanpub-auto-scales-ranges-and-the-ah-ha-moment">Scales, Ranges and the “Ah Ha!” moment.</h4>
  <p>The “Ah Ha!” moment for me in understanding ranges and scales was after reading Jerome Cukier’s  great page on ‘<a href="http://www.jeromecukier.net/blog/2011/08/11/d3-scales-and-color/">d3:scales and color</a>’. I thoroughly recommend you read it (and plenty more of the great work by Jerome) as he really does nail the description in my humble opinion. I will put my own description down here, but if it doesn’t seem clear, head on over to Jerome’s page.</p>

</aside>

<p>From our basic web page we have now moved to the section that includes the following lines;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleTime</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
</pre></div>

</figure>

<p>The purpose of these portions of the script is to ensure that the data we ingest fits onto our graph correctly. Since we have two different types of data (date/time and numeric values) they need to be treated separately (but d3 manages them in almost the same way). To examine this whole concept of scales, domains and ranges properly, we will also move slightly out of sequence and (in conjunction with the earlier scale statements) take a look at the lines of script that occur later and set the domain. They are as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Scale the range of the data</code>
  <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>
</pre></div>

</figure>

<p>The idea of scaling is to take the range of values of data that we have and to fit them into the space we have available. </p>

<p>If we have data that goes from 53.98 to 636.23 (as the data we have for ‘close’ in our csv file does), but we have a graph that is 450 pixels high (<code>height = 500 - margin.top – margin.bottom;</code>) we clearly need to make an adjustment.</p>

<p>Not only that. Even though our data  goes from 53.98 to 636.23, that would look slightly misleading on the graph and it should really go from 0 to a bit over 636.23. It sounds really complicated, so let’s simple it up a bit.</p>

<p>First we make sure that any quantity we specify on the x axis fits onto our graph.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleTime</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
</pre></div>

</figure>

<p>Here we set our variable (<code>x</code>) that will tell D3 where to draw something on the x axis. By using the <code>d3.scaleTime()</code> function we make sure that D3 knows to treat the values as date / time entities (with all their ingrained peculiarities). Then we specify the range that those values will cover (<code>.range</code>) and we specify the range as being from 0 to the width of our graphing area (See? Setting those variables for margins and widths are starting to pay off now!).</p>

<p>Then we do the same for the Y axis. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
</pre></div>

</figure>

<p>There’s a different function call (<code>d3.scaleLinear()</code>) but the <code>.range</code> setting is still there. In the interests of drawing a (semi) pretty picture to try and explain, hopefully this will assist;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/scales1.png" alt="Scaling the data to the graph size">
  <figcaption>Scaling the data to the graph size</figcaption>
</figure>


<p>I know, I know, it’s a little misleading because nowhere have we actually said to D3 this is our data from 53.98 to 636.23. All we’ve said is when we get the data, we’ll be scaling it into this space.</p>

<p>Now hang on, what’s going on with the <code>[height, 0]</code> part in y axis scale statement? The astute amongst you will note that for the time scale we set the range as <code>[0, width]</code> but for this one (<code>[height, 0]</code>) the values look backwards.</p>

<p>Well spotted.</p>

<p>This is all to do with how the screen is laid out and referenced. Take a look at the following diagram showing how the coordinates for drawing on your screen work;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/scales2.png" alt="Coordinates that the browser expects">
  <figcaption>Coordinates that the browser expects</figcaption>
</figure>


<p>The top left hand of the screen is the origin or 0,0 point and as we go left or down the corresponding x and y values increase to the full values defined by height and width.</p>

<p>That’s good enough for the time values on the x axis that will start at lower values and increase, but for the values on the y axis we’re trying to go against the flow. We want the low values to be at the bottom and the high values to be at the top.</p>

<p>No problem. We just tell D3 via the statement <code>y = d3.scaleLinear().range([height, 0]);</code> that the larger values (height) are at the low end of the screen (at the top) and the low values are at the bottom (as you most probably will have guessed by this stage, the <code>.range</code> statement uses the format <code>.range([closer_to_the_origin, further_from_the_origin])</code>. So when we put the height variable first, that is now associated with the top of the screen. </p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/scales3.png" alt="Coordinates with adjusted ranges">
  <figcaption>Coordinates with adjusted ranges</figcaption>
</figure>


<p>We’ve scaled our data to the graph size and ensured that the range of values is set appropriately. What’s with the domain part that was in this section’s title?</p>

<p>Come on, you remember this little piece of script don’t you?</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>
</pre></div>

</figure>

<p>While it exists in a separate part of the file from the scale / range part, it is certainly linked.</p>

<p>That’s because there’s something missing from what we have been describing so far with the set up of the data ranges for the graphs. We haven’t actually told D3 what the range of the data is. That’s also the reason this part of the script occurs where it does. It is within the section where the data.csv file has been loaded as ‘data’ and it’s therefore ready to use it.</p>

<p>So, the <code>.domain</code> function is designed to let D3 know what the scope of the data will be. This is what is then passed to the scale function.</p>

<p>Looking at the first part that is setting up the x axis values, it is saying that the domain for the x axis values will be determined by the <code>d3.extent</code> function which in turn is acting on a separate function which looks through all the ‘date’ values that occur in the ‘data’ array. In this case the <code>.extent</code> function returns the minimum and maximum value in the given array.</p>

<ul>
  <li>
<code>function(d) { return d.date; }</code> returns all the ‘date’ values in ‘data’. This is then passed to…</li>
  <li>The <code>.extent</code> function that finds the maximum and minimum values in the array and then…</li>
  <li>The <code>.domain</code> function which returns those maximum and minimum values to D3 as the range for the x axis.</li>
</ul>

<p>Pretty neat really. At first you might think it was overly complex, but breaking the function down into these components allows additional functionality with differing scales, values and quantities. In short, don’t sweat it. It’s a good thing.</p>

<p>The x axis values are dates; so the domain for them is basically from the 26th of March 2012 till 1st of May 2012. The y axis is done slightly differently</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>
</pre></div>

</figure>

<p>Because the range of values desired on the y axis goes from 0 to the maximum in the data range, that’s exactly what we tell D3. The ‘0’ in the .domain function is the starting point and the finishing point is found by employing a separate function that sorts through all the ‘close’ values in the ‘data’ array and returns the largest one. Therefore the domain is from 0 to 636.23.</p>

<p>Let’s try a small experiment. Let’s change the y axis domain to use the .extent function (the same way the x axis does) to see what it produces.</p>

<p>The JavaScript for the y domain will be;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">}));</code>
</pre></div>

</figure>

<p>You can see apart from a quick copy paste of the internals, all I had to change was the reference to ‘close’ rather than ‘date’.</p>

<p>And the result is…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/scales4.png" alt="Graph using .extent for data values">
  <figcaption>Graph using .extent for data values</figcaption>
</figure>


<p>Look at that! The starting point for the y axis looks like it’s pretty much on the 53.98 mark and the graph itself certainly touches the x axis where the data would indicate it should.</p>

<p>Now, I’m not really advocating making a graph like this since I think it looks a bit nasty (and a casual observer might be fooled into thinking that the x axis was at 0). However, this would be a useful thing to do if the data was concentrated in a narrow range of values that are quite distant from zero.</p>

<p>For instance, if I change the data.csv file so that the values are represented like the following;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/scales5.png" alt="Concentrated data range graph">
  <figcaption>Concentrated data range graph</figcaption>
</figure>


<p>Then it kind of loses the ability to distinguish between values around the median of the data.</p>

<p>But, if I put in our magic .extent function for the y axis and redraw the graph…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/scales6.png" alt="Expanded concentrated data range using .extent">
  <figcaption>Expanded concentrated data range using .extent</figcaption>
</figure>


<p>How about that?</p>

<p>The same data as the previous graph, but with one simple piece of the script changed and D3 takes care of the details.</p>

<h4 id="leanpub-auto-adding-data-to-the-line-function">Adding data to the line function</h4>

<p>We’re getting towards the end of our journey through the script now. The next step is to associate the array ‘data’ with a new array that consists of a set of coordinates that we are going to plot.</p>

<p>I’m aware that the statement above may be somewhat ambiguous. You would be justified in thinking that we already had the data stored and ready to go. But that’s not <em>strictly</em> correct.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// define the line</code>
<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>What we have is data in a raw format, we have added pieces of code that will allow the data to be adjusted for scale and range to fit in the area that we want to draw, but we haven’t actually taken our raw data and adjusted it for our desired coordinates. That’s what the code above does.</p>

<p>The main function that gets used here is the <code>d3.line()</code> <a href="https://github.com/d3/d3-shape/blob/master/README.md#lines">function</a>. This function uses accessor functions to store the appropriate information in the right area and in the case above they use the <code>x</code> and <code>y</code> accessors (that would be the bits that are <code>.x</code> and <code>.y</code>). The <code>d3.line()</code> function is called a ‘path generator’ and this is an indication that it can carry out some pretty clever things on its own accord. But in essence its job is to assign a set of coordinates in a form that can be used to draw a line.</p>

<p>Each time this line function is called on, it will go through the data and will assign coordinates to ‘date’ and ‘close’ pairs using the ‘x’ and ‘y’ functions that we set up earlier (which are responsible for scaling and setting the correct range / domain).</p>

<p>Of course, it doesn’t get the data all by itself, we still need to actually call the valueline function with  ‘data’ as the source to act on. But never fear, that’s coming up soon.</p>

<h4 id="leanpub-auto-adding-the-svg-element">Adding the SVG element.</h4>

<p>As the title states, the next piece of script forms and adds the SVG element to the web page that D3 will then use to draw on.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
</pre></div>

</figure>

<p>So what exactly does that all mean?</p>

<p>Well D3 needs to be able to have a space defined for it to draw things. When you define the space it’s going to use, you can also give the space you’re going to use an identifying name and attributes. </p>

<p>In the example we’re using here, we are ‘appending’ an <a href="#svg">SVG element</a> (an element designed for drawing graphics on) to the <code>&lt;body&gt;</code> of the HTML page.</p>

<aside class="information blurb">
    <p>In human talk that means that on the web page and bounded by the <code>&lt;body&gt;</code> tag that we saw in the HTML part, we will have an area to draw on. That area will be ‘width’ plus the left and right margins wide and ‘height’ plus the top and bottom margins wide.</p>

</aside>

<p>We also add a group element ‘g’ that is referenced to the top left corner of the actual graph area on the canvas. ‘g’ is a grouping element in the sense that it is normally used for grouping together several related elements. So in this case those grouped elements will have a common reference.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/margins.png" alt="Graph area and margins">
  <figcaption>Graph area and margins</figcaption>
</figure>


<p>(the image above is definitely not to scale, but I hope you get the general idea)</p>

<p>Interesting things to note about the code. The <code>.attr("stuff in here")</code> parts are attributes of the appended elements they are part of.</p>

<p>For instance;</p>

<figure class="code">
<div class="highlight"><pre><code></code>   <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
</pre></div>

</figure>

<p>tells us that  the ‘svg’ element has a “width” of width + margin.left + margin.right and the “height”  of  height + margin.top + margin.bottom.</p>

<p>Likewise… </p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
</pre></div>

</figure>

<p>tells us that the group element ‘g’ has been transformed by moving (translating) to the point margin.left, margin.top. Or to the top left of the graph space proper. This way when we tell something to be drawn on our page, we can use this reference point ‘g’ to make sure everything is in the right place.</p>

<h4 id="leanpub-auto-actually-drawing-something">Actually Drawing Something!</h4>

<p>Up until now we have spent a lot of time defining, loading and setting up. Good news! We’re about to finally draw something!</p>

<h5 id="leanpub-auto-drawing-the-line">Drawing the line</h5>

<p>We jump lightly over some of the code that we have already explained and land on the part that draws the line.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the valueline path.</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="nx">data</code><code class="p">])</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">);</code>
</pre></div>

</figure>

<p>This area occurs in the part of the code that has the data loaded (via the <code>d3.csv</code> block) and it’s ready for action.</p>

<p>The <code>svg.append("path")</code> portion adds a new path element . A path element represents a shape that can be manipulated in lots of different ways (see more here: <a href="http://www.w3.org/TR/SVG/paths.html">http://www.w3.org/TR/SVG/paths.html</a>). </p>

<p>We join our array of data (confusingly the array is <em>called</em> ‘data’) to the path element with the <code>.data([data])</code> line. We could have used an alternative method here with a line that read <code>.datum(data)</code>. Both are completely valid to use, but have different strengths. </p>

<aside class="information blurb">
    <h5 id="leanpub-auto-data-vs-datum">data vs datum.</h5>
  <p><code>data</code> takes the specified array and joins it to a selection of data. Joining data allows for dynamic updating of the data via ‘update’, ‘enter’ and ‘exit’ selections (more on these much later in the book).</p>

  <p><code>datum</code> doesn’t join data to any existing array and instead the data will exist as static element. The advantage to this is that it allows access to HTML5 custom data attributes.</p>

  <p>For more detail on the differences, it is worth reading the <a href="https://github.com/d3/d3-selection/blob/master/README.md#joining-data">documentation of joining data</a>.</p>

</aside>

<p>The next line down applies the ‘line’ styles from the CSS section that we <a href="#css">experimented with earlier</a>.  </p>

<p>In the final line (<code>.attr("d", valueline);</code>),  we add the attribute ‘d’ to the path with the data from the <code>valueline</code> function that we had declared earlier. </p>

<aside class="information blurb">
    <p>The <code>d</code> attribute is a <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/d">mini language</a> which contains a series of commands for movement that will describe a path in SVG. These commands are written in a shorthand of single letters such as M-moveto, Z-closepath, L-lineto, C-curveto. The good news is that D3 takes care of the heavy lifting in putting together this set of commands.</p>

</aside>

<h5 id="leanpub-auto-drawing-the-axes">Drawing the Axes</h5>

<p>Then we get to draw in the axes;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the X Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>

  <code class="c1">// Add the Y Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>
</pre></div>

</figure>

<p>Both axes start by appending a group element (‘g’). Each axis will be bound to its own element.</p>

<p>The y axis can be drawn from the default position at the origin of the svg element (which we recall is 0,0 at the top left of the graph). However the x axis needs to be moved to the bottom of our graph.</p>

<p>On the x axis, we have a transform statement (<code>.attr("transform", "translate(0," + height + ")")</code>). If we want our x axis to be on the bottom of the graph, we need to move (transform) it to the bottom by a set amount. The set amount in this case is the height of the graph proper (<code>height</code>). So, for the point of demonstration we will remove the transform line and see what happens;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/axistransformed.png" alt="x axis transformed to the top of the graph">
  <figcaption>x axis transformed to the top of the graph</figcaption>
</figure>


<p>Yep, pretty much as anticipated.</p>

<p>The last part of the two sections of script ( <code>.call(d3.axisBottom(x));</code> and <code>.call(d3.axisLeft(y));</code> ) call the D3 x and y axis functions respectively and initiate the drawing action.</p>

<p>The method by which D3 orientates the axes is relatively self-evident and there are four options;</p>

<ul>
  <li>
<code>.axisTop</code>: An axis with values and ticks drawn above a horizontal axis.</li>
  <li>
<code>.axisRight</code>: An axis with values and ticks drawn to the right of a vertical axis.</li>
  <li>
<code>.axisBottom</code>: An axis with values and ticks drawn below a horizontal axis.</li>
  <li>
<code>.axisLeft</code>: An axis with values and ticks drawn to the left of a vertical axis.</li>
</ul>

<p>Just to illustrate the point, we can reverse the orientation of <code>.axisBottom</code> to <code>.axisTop</code> and <code>.axisLeft</code> to <code>.axisRight</code> to see what it looks like;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/axesreversed.png" alt="x and y axes reversed">
  <figcaption>x and y axes reversed</figcaption>
</figure>


<p>There we go. </p>

<p>It is worth stating that the axes as presented for this simple graph are very much a ‘straight out of the box’ configuration. <a href="#axes">Later in the book</a> we will look at options for configuring and styling axes in more depth.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-wrap-up">Wrap Up</h3>

<p>Well that’s it. In theory, you should now be a complete D3 ninja.</p>

<p>OK, perhaps a slight exaggeration. In fact there is a strong possibility that the information I have laid out here is at best borderline useful and at worst laden with evil practices and gross inaccuracies.</p>

<p>But look on the bright side. Irrespective of the nastiness of the way that any of it was accomplished or the inelegance of the code, if the picture drawn on the screen is pretty, you can walk away with a smile. :-)</p>

<p>This section concludes a very basic description of one type of a graphic that can be built with D3. We will look at adding value to it in subsequent chapters.</p>

<p>I’ve said it before and I’ll say it again. This is not a how-to for learning D3. This is how I have managed to muddle through and achieve what I wanted to do. If some small part of it helps you. All good. Those with a smattering of knowledge of any of the topics I have butchered above (or below) are fully justified in feeling a large degree of righteous indignation. To those I say, please feel free to amend where practical and possible, but please bear in mind this was written from the point of view of someone with no experience in the topic and therefore try to keep any instructions at a level where a new entrant can step in :-).</p>


<h2 id="leanpub-auto-things-we-can-do-with-the-simple-graph">Things we can do with the simple graph</h2>

<p>The following headings in this section are intended to be a list of relatively simple ‘block’ type improvements that you can do to your graph to add functionality. The idea is to be able to use the simple graph that was used for the explanation of how D3 worked and just slot in code to add functionality (let’s hope it works for you :-)).</p>


<h3 id="axes">Setting up and configuring the Axes</h3>

<p>As referenced in the chapter where we initially developed our simple graph, the axes of that graph had no styling or configuration changes made to them at all. One of the results of this is that the font size, type, number of ticks and the way that the values are represented is very much at the default settings. This means that when we change our initial graph…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/basicgraph.png" alt="Basic Graph">
  <figcaption>Basic Graph</figcaption>
</figure>


<p>… and compress the margins or graph size we end up with axes that are not really suitable for the purpose;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/squishedgraph.png" alt="The effect of changing the margins">
  <figcaption>The effect of changing the margins</figcaption>
</figure>


<p>Luckily, the D3 axis component has a wide range of configuration options and we can make changes simply via either the CSS styling or in the JavaScript code.</p>

<h4 id="leanpub-auto-change-the-text-size">Change the text size</h4>

<p>The first thing that we will change is the text size for the axes. The default size (built into D3) is 10px with the font type of sans-serif. </p>

<p>There are a couple of different ways that we could change the font size and either one is valid. The first way is to specify the font as a style when drawing an individual axis. To do this we simply add in a font style as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font"</code><code class="p">,</code> <code class="s2">"14px times"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>
</pre></div>

</figure>
<p>This will increase the x axis font size to 14px and change the font type to ‘times’. Just like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/axes-01.png" alt="X axis 14px, times">
  <figcaption>X axis 14px, times</figcaption>
</figure>


<p>There are a few things to notice here.</p>

<p>Firstly, we do indeed have a larger font and it appears to be of the type ‘times’. Yay!</p>

<p>Secondly, the y axis has remained as 10px sans-serif (which is to be expected since we only added the style to the x axis code block) </p>

<p>Lastly, the number of values represented on the x axis has meant that with the increase in font size there is some overlapping going on. We will deal with that shortly…</p>

<p>The addition of the styling for the x axis has been successful and in a situation where only one element on a page is being adjusted, this is a perfectly valid way to accomplish the task. However, in this case we should be interested in changing the font on both the x <em>and</em> y axes. We could do this by adding a duplicate style line to the y axis block, but we have a slightly better way of accomplishing the task by declaring the style in the HTML style block at the start of the code and then applying the same style to both blocks.</p>

<p>In the <code>&lt;style&gt; ... &lt;/style&gt;</code> section at the start of the file add in the following line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.axis</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">14px</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>
</pre></div>

</figure>

<p>This will set the font to 14px sans-serif (I prefer this to ‘times’) for anything that has the <code>axis</code> class applied to it. All we have to do then is to tell our x and y axes blocks to use the <code>axis</code> class as an attribute. We can do this as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the X Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>

  <code class="c1">// Add the Y Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>
</pre></div>

</figure>

<p>It could be argued that this doesn’t really conserve more code, but in my humble opinion it adds a more elegant way to alter styling in this case.</p>

<p>The end result now looks like the following;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/axes-02.png" alt="Both axes 14px, sans-serif">
  <figcaption>Both axes 14px, sans-serif</figcaption>
</figure>


<h4 id="leanpub-auto-changing-the-number-of-ticks-on-an-axis">Changing the number of ticks on an axis</h4>

<p>Now we shall address the other problem that cropped up when we changed the size of the text. We have overlapping values on the x axis.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/axes-03.png" alt="Overlapping axis values">
  <figcaption>Overlapping axis values</figcaption>
</figure>


<p>If I was to be brutally honest, I think that the number of values (ticks) on the graph is a bit too many. The format of the values (especially on the x axis) is too wide and this type of overlap was bound to happen eventually. </p>

<p>Good news. D3 has got us covered.</p>

<p>The <a href="https://github.com/d3/d3-axis">axis component</a> includes a function to specify the number of ticks on an axis. All we need to do is add in the function and the number of ticks like so;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the X Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
              <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">));</code>
</pre></div>

</figure>

<p>With the end result looking like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/axes-04.png" alt="Nicely spaced axis values">
  <figcaption>Nicely spaced axis values</figcaption>
</figure>


<p>We can see that D3 has picked tick values that seem nice and logical. There’s one that starts on the 1st of April that’s just labelled ‘April’ and they go at a nice interval of one week for the subsequent ticks. Nice. </p>

<p>Hopefully you just did a quick count across the bottom of the previous graph and went “Yep, five ticks. Spot on”. Well done if you did, but there’s a little bit of a sneaky trick up D3’s sleeve with the number of ticks on a graph axis.</p>

<p>For instance, here’s what the graph looks like when the <code>.ticks(5)</code> value is changed to <code>.ticks(4)</code>.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/axes-04.png" alt="Five ticks on the x axis">
  <figcaption>Five ticks on the x axis</figcaption>
</figure>


<p>Eh? Hang on. Isn’t that some kind of mistake? There are still five ticks. Yep, sure is! But wait… we can keep dropping the ticks value till we get to two and it will still be the same. At <code>.ticks(2)</code> though, we finally see a change.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/axes-05.png" alt="Two ticks on the x axis">
  <figcaption>Two ticks on the x axis</figcaption>
</figure>


<p>How about that? At first glance that just doesn’t seem right, then you have a bit of a think about it and you go “Hmm… When there were 5 ticks, they were separated by a week each, and that stayed that way till we got to a point where it could show a separation of a month”.</p>

<p>D3 is making a command decision for you as to how your ticks should be best displayed. This is great for simple graphs and indeed for the vast majority of graphs. Like all things related to D3, if you really need to do something bespoke, it will let you if you understand enough code.</p>

<p>The following is the <a href="https://github.com/d3/d3-scale/blob/master/README.md#time_ticks">list</a> of time intervals that D3 will consider when setting automatic ticks on a time based axis;</p>

<ul>
  <li>1, 5, 15 and 30-second.</li>
  <li>1, 5, 15 and 30-minute.</li>
  <li>1, 3, 6 and 12-hour.</li>
  <li>1 and 2-day.</li>
  <li>1-week.</li>
  <li>1 and 3-month.</li>
  <li>1-year.</li>
</ul>

<p>And yes. If you increase the number of ticks, you need to wait till you get to 10 before they change to an axis with interval of two days. And yes, the overlap is still there;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/axes-03a.png" alt="Still overlapping axis values">
  <figcaption>Still overlapping axis values</figcaption>
</figure>


<p>If we do a quick count we should also notice that we have 19 ticks!</p>

<p>The question should be asked. Can we specify our own intervals? Great question! Yes we can.</p>

<p>What we need to do is to use another D3 trick and specify an exact interval using the <a href="https://github.com/d3/d3-time#d3-time">d3 time component</a>. In our particular situation all we need to do is specify an interval inside the <code>.ticks</code> function. Specifically for an interval of 4 days for example we would use something like;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the X Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
              <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">timeDay</code><code class="p">.</code><code class="nx">every</code><code class="p">(</code><code class="mi">4</code><code class="p">)));</code>
</pre></div>

</figure>

<p>Here we use the <code>timeDay</code> unit of ‘days’ and specify an interval of 4 days.</p>

<p>The graph will subsequently appear as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/axes-06.png" alt="Axis ticks at 4 day intervals">
  <figcaption>Axis ticks at 4 day intervals</figcaption>
</figure>


<p>Intervals have a number of <a href="https://github.com/d3/d3-time#intervals">standard units</a> (including UTC time) such as;</p>

<ul>
  <li>
<code>d3.timeMillisecond</code> : Milliseconds</li>
  <li>
<code>d3.timeSecond</code> : Seconds</li>
  <li>
<code>d3.timeMinute</code> : Minutes</li>
  <li>
<code>d3.timeHour</code> : Hours</li>
  <li>
<code>d3.timeDay</code> : Days</li>
  <li>
<code>d3.timeWeek</code> : This is an alias for <code>d3.timeSunday</code> for a week</li>
  <li>
<code>d3.timeSunday</code> : A week starting on Sunday</li>
  <li>
<code>d3.timeMonday</code> : A week starting on Monday</li>
  <li>
<code>d3.timeTuesday</code> : A week starting on Tuesday</li>
  <li>
<code>d3.timeWednesday</code> : A week starting on Wednesday</li>
  <li>
<code>d3.timeThursday</code> : A week starting on Thursday</li>
  <li>
<code>d3.timeFriday</code> : A week starting on Friday</li>
  <li>
<code>d3.timeSaturday</code> : A week starting on Saturday</li>
  <li>
<code>d3.timeMonth</code> : Months starting on the 1st of the month</li>
  <li>
<code>d3.timeYear</code> : Years Starting on the 1st day of the year</li>
</ul>

<p>But what if we really wanted that two day separation of ticks without the overlap?</p>

<h4 id="leanpub-auto-rotating-text-labels-for-a-graph-axis">Rotating text labels for a graph axis</h4>

<p>An answer to the problem of overlapping axis values might be to rotate the text to provide more space.</p>

<p>The answer I found most usable was provided by Aaron Ward on <a href="https://groups.google.com/forum/#!msg/d3-js/CRlW0ISbOy4/1sgrE5uS5ysJ">Google Groups</a>.</p>

<aside class="information blurb">
    <h4 id="leanpub-auto-there-might-be-a-better-way">There might be a better way</h4>
  <p>Now, I’ll put a bit of a caveat on this solution to the rotating axis label problem. It looks like it’s worked well, but I’ve only carried out this investigation to the point where I’ve got something that looks like it’s a solution. There may be better or more elegant ways of carrying out the same task, so  let Google be your friend if it doesn’t appear to be working out for you.</p>

</aside>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/3c040800ff6457717cca586ae9547dbf">github</a> or in the code samples bundled with this book (simple-axis-rotated.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/3c040800ff6457717cca586ae9547dbf">bl.ocks.org</a>.</p>

<p>The first substantive change would be a little housekeeping. Because we are going to be rotating the text at the bottom of the graph, we are going to need some extra space to fit in our labels. So we should change our bottom margin appropriately.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">70</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
</pre></div>

</figure>

<p>I found that 70 pixels was sufficient.</p>

<p>The remainder of our changes occur in the block that draws the x axis.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the X Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">).</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">10</code><code class="p">))</code>
      <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>	
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code> <code class="s2">"-.8em"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".15em"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-65)"</code><code class="p">);</code>	
</pre></div>

</figure>

<p>It’s pretty standard until the <code>.call(d3.axisBottom(x).ticks(10))</code> portion of the code. Here we remove the semicolon that was there so that the block continues with its function. </p>

<p>Then we select all the text elements that comprise the x axis with the <code>.selectAll("text")</code>. From this point onwards, we are operating on the text elements associated with the x axis. In effect; the following four ‘actions’ are applied to the text labels.</p>

<p>The <code>.style("text-anchor", "end")</code> line ensures that the text label has the end of the label ‘attached’ to the axis tick. This has the effect of making sure that the text rotates about the end of the date. This makes sure that the text all ends up at a uniform distance from the axis ticks.</p>

<p>The <code>dx</code> and <code>dy</code> attribute lines move the end of the text just far enough away from the axis tick so that they don’t crowd it and not too far away so that it appears disassociated. This took a little bit of fiddling to ‘look’ right and you will notice that I’ve used the ‘em’ units to get an adjustment if the size of the font differs.</p>

<p>The final action is kind of the money shot.</p>

<p>The transform attribute applies itself to each text label and rotates each line by -65 degrees. I selected -65 degrees just because it looked OK. There was no deeper reason. </p>

<p>The end result then looks like the following;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/rotate02.png" alt="Rotated x axis labels">
  <figcaption>Rotated x axis labels</figcaption>
</figure>


<p>This was a surprisingly difficult problem to find a solution to that I could easily understand (well done Aaron). That makes me think that there are some far deeper mysteries to it that I don’t fully appreciate that could trip this solution up. But in lieu of that, enjoy!</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-formatting-a-date--time-axis-with-specified-values">Formatting a date / time axis with specified values</h4>

<p>OK then. We’ve been very clever in rotating our text, but you will notice that D3 has used its own good judgement as to what format the days / date will be represented as.</p>

<p>Not that there’s anything wrong with it, but what if we want to put a specific format of date / time nomenclature as axis labels?</p>

<p>No problem. D3 to the rescue again!</p>

<p>This is actually a pretty easy thing to do, but there are plenty of options for the formatting, so the only really tricky part is deciding what to put where.</p>

<p>But, before we start doing anything we are going to have to expand our bottom margin even more than we did with the rotate the axis labels feature.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">100</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
</pre></div>

</figure>

<p>That should see us right.</p>

<p>Now the simple part :-). Changing the format of the label is as simple as inserting the <code>tickFormat</code> command into the xAxis declaration and including a D3 <a href="https://github.com/d3/d3-time-format">time formatting</a> function a little like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
              <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">timeFormat</code><code class="p">(</code><code class="s2">"%Y-%m-%d"</code><code class="p">)))</code>
      <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>	
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code> <code class="s2">"-.8em"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".15em"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-65)"</code><code class="p">);</code>
</pre></div>

</figure>

<p>The <code>timeFormat</code> formatters are the same as those we used when parsing our time values when reading our data with the simple graph;</p>

<ul>
  <li>%a - abbreviated weekday name.</li>
  <li>%A - full weekday name.</li>
  <li>%b - abbreviated month name.</li>
  <li>%B - full month name.</li>
  <li>%c - date and time, as “%a %b %e %H:%M:%S %Y”.</li>
  <li>%d - zero-padded day of the month as a decimal number [01,31].</li>
  <li>%e - space-padded day of the month as a decimal number [ 1,31].</li>
  <li>%H - hour (24-hour clock) as a decimal number [00,23].</li>
  <li>%I - hour (12-hour clock) as a decimal number [01,12].</li>
  <li>%j - day of the year as a decimal number [001,366].</li>
  <li>%m - month as a decimal number [01,12].</li>
  <li>%M - minute as a decimal number [00,59].</li>
  <li>%p - either AM or PM.</li>
  <li>%S - second as a decimal number [00,61].</li>
  <li>%U - week number of the year (Sunday as the first day of the week) as a decimal number [00,53].</li>
  <li>%w - weekday as a decimal number [0(Sunday),6].</li>
  <li>%W - week number of the year (Monday as the first day of the week) as a decimal number [00,53].</li>
  <li>%x - date, as “%m/%d/%y”.</li>
  <li>%X - time, as “%H:%M:%S”.</li>
  <li>%y - year without century as a decimal number [00,99].</li>
  <li>%Y - year with century as a decimal number.</li>
  <li>%Z - time zone offset, such as “-0700”.</li>
  <li>There is also a literal “%” character that can be presented by using double % signs.</li>
</ul>

<p>So the format we have specified (<code>%Y-%m-%d</code>) will show the year with the century as a decimal number (<code>%Y</code>) followed by a hyphen, followed by a zero padded month as a decimal number (<code>%m</code>) followed by another hyphen and lastly the day as a zero padded day of the month (<code>%d</code>).</p>

<p>The end result looking a bit like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/axes-07.png" alt="Rotated x axis labels">
  <figcaption>Rotated x axis labels</figcaption>
</figure>


<p>An example using this code can be found on <a href="https://gist.github.com/d3noob/0e276dc70bb9184727ee47d6dd06e915">github</a> or in the code samples bundled with this book (simple-axis-rotated-formatted.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/0e276dc70bb9184727ee47d6dd06e915">bl.ocks.org</a>. The example code also includes the rotating of the x axis text as described in the previous section.</p>

<p>So how about we try something a little out of the ordinary (extreme)?</p>

<p>How about the full weekday name (<code>%A</code>), the day (<code>%d</code>), the full month name (<code>%B</code>) and the year (<code>%Y</code>) as a four digit number?</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
              <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">timeFormat</code><code class="p">(</code><code class="s2">"%A %d %B %Y"</code><code class="p">)))</code>
      <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>	
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code> <code class="s2">"-.8em"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".15em"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-65)"</code><code class="p">);</code>
</pre></div>

</figure>

<p>We will also need some extra space for the bottom margin, so how about 170?</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">170</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
</pre></div>

</figure>

<p>And….</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/axes-08.png" alt="Extreme format change for the x axis labels">
  <figcaption>Extreme format change for the x axis labels</figcaption>
</figure>


<p>Oh yeah… When axis ticks go bad…</p>

<p>But seriously, that does work as a pretty good example of the flexibility available. </p>

<div class="page-break"></div>

<h3 id="axislabels">Adding Axis Labels</h3>

<p>What’s the first thing you get told at school when drawing a graph?</p>

<p>“<em>Always label your axes!</em>”</p>

<p>So, time to add a couple of labels!</p>

<p>We’ll start with our default code for our simple graph. The full code for this can be found on <a href="https://gist.github.com/d3noob/402dd382a51a4f6eea487f9a35566de0">github</a> or in the code samples bundled with this book (simple-graph.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0">bl.ocks.org</a>. </p>

<p><strong>Preparation</strong>: Because we’re going to be adding labels to the bottom and left of the graph we need to increase the bottom and left margins. Changes like the following should suffice;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">50</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">70</code><code class="p">},</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-the-x-axis-label">The x axis label</h4>

<p>First things first (because they’re done slightly differently), the x axis. If we begin by describing what we want to achieve, it may make the process of implementing a solution a little more logical.</p>

<p>What we want to do is to add a simple piece of text under the x axis and in the centre of the total span. Wow, that does sound easy.</p>

<p>And it is, but there are different ways of accomplishing it, and I think I should take an opportunity to demonstrate them. Especially since one of those ways is a BAD idea.</p>

<p>Lets start with the bad idea first :-).</p>

<p>This is the code we’re going to add to the simple line graph script;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// text label for the x axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>             
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">480</code> <code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code>  <code class="mi">475</code> <code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Date"</code><code class="p">);</code>
</pre></div>

</figure>

<p>We will put it in between the blocks of script that add the x axis and the y axis.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the x Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>

  <code class="c1">// PUT THE NEW CODE HERE!</code>

  <code class="c1">// Add the y Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>
</pre></div>

</figure>

<p>Before we describe what’s happening, let’s take a look at the result;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/date01.png" alt="Date label on x axis">
  <figcaption>Date label on x axis</figcaption>
</figure>


<p>Well, it certainly did what it was asked to do. There’s a ‘Date’ label as advertised! (Yes, I know it’s not pretty.) Let’s describe the code and then work out why there’s a better way to do it.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// text label for the x axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>             
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">480</code> <code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code>  <code class="mi">475</code> <code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Date"</code><code class="p">);</code>
</pre></div>

</figure>

<p>The first line appends a “text” element to our svg element. There is a lot more to learn about “text” elements at the home of the <a href="http://www.w3.org/TR/SVG/text.html#TextElement">World Wide Web Consortium (W3C)</a>.
The next two lines ( <code>.attr("x", 480 ) and .attr("y", 475 )</code> ) set the attributes for the x and y coordinates to position the text on the svg. </p>

<p>The second last line (<code>.style("text-anchor", "middle")</code>) ensures that the text ‘style’ is such that the text is centre aligned and therefore remains nicely centred on the x, y coordinates that we send it to.</p>

<p>The final line (<code>.text("Date");</code>) adds the actual text that we are going to place.</p>

<p>That seems really simple and effective and it is. However, the bad part about it is that we have hard coded the location for the date into the code. This means if we change any of the physical aspects of the graph, we will end up having to re-calculate and edit our code. And we don’t want to do that.</p>

<p>Here’s an example. If I decide that I would prefer to decrease the height of the graph by editing the line here;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>and making the height 490 pixels;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">height</code> <code class="o">=</code> <code class="mi">490</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>The result is as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/date02.png" alt="Hard coded Date label">
  <figcaption>Hard coded Date label</figcaption>
</figure>


<p><em>EVERYTHING</em> about the graph has adjusted itself, except our nasty, hard coded ‘Date’ label which has been cruelly cut off. This is far from ideal and can be easily fixed by using the variables that we set up ever so carefully earlier.</p>

<p>So, instead of;</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">480</code> <code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code>  <code class="mi">475</code> <code class="p">)</code>
</pre></div>

</figure>

<p>lets let our variables do the walking and use;</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code> <code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code>  <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="mi">20</code><code class="p">)</code>
</pre></div>

</figure>

<p>So with this code we tell the script that the ‘Date’ label will always be halfway across the width of the graph (no matter how wide it is) and at the bottom of the graph with respect to its height plus the top margin and 20 pixels (as a fixed offset) (remember it uses a coordinates system that increases from the top down).</p>

<p>The end result of using variables is that if I go to an extreme of changing the height and width of my graph to;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">width</code> <code class="o">=</code> <code class="mi">560</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>We still finish up with an acceptable result;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/date03.png" alt="Auto adjusting Date label">
  <figcaption>Auto adjusting Date label</figcaption>
</figure>


<p>Well, for the label position at least :-).</p>

<p>So the changes to using variables is just a useful lesson that variables rock and mean that you don’t have to worry about your graph staying in relative shape while you change the dimensions. The astute readers amongst you will have learned this lesson very early on in your programming careers, but it’s never a bad idea to make sure that users that are unfamiliar with the concept have an indicator of why it’s a good idea.</p>

<p>Now the third method that I mentioned at the start of our x axis odyssey. This is not mentioned because it’s any better or worse way to implement your script (The reason that I say this is because I’m not sure if it’s better or worse.) but because it’s sufficiently different to make it look confusing if you didn’t think of it in the first place.</p>

<p>So, we’ll take our marvellous coordinates code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code> <code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code>  <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="mi">20</code><code class="p">))</code>
</pre></div>

</figure>

<p>And replace it with a single (longer) line;</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
            <code class="s2">"translate("</code> <code class="o">+</code> <code class="p">(</code><code class="nx">width</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code> <code class="o">+</code> <code class="s2">" ,"</code> <code class="o">+</code> 
                           <code class="p">(</code><code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="mi">20</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
</pre></div>

</figure>

<p>This uses the <code>"transform"</code> attribute to move (translate) the point to place the ‘Date’ label to exactly the same spot that we’ve been using for the other two examples (using variables of course).</p>

<aside class="question blurb">
    <h3 id="leanpub-auto-why-does-that-line-look-odd">Why does that line look odd?</h3>
  <p>The <code>"translate”</code> function is done in a ‘translate(x,y)’ style but it is put on the page in such a way that the verbatim pieces that get passed back are in speech marks and the variables are in the clear (in a manner of speaking). That’s why the comma is in speech marks.
Additionally, the variables are contained within plus signs. I make the assumption that this is a designator for ‘areas where there is variable action going on’. The end result is that if you try to do some maths in that area with a plus sign, it does not appear to work (or at least it didn’t for me). That’s why I put the variable for ( <code>+ (height + margin.top + 20) +</code> )  in parenthesis (then I thought I should make the <code>+ (width / 2) +</code> part look the same, but actually you can get away without them there).</p>

</aside>

<h4 id="leanpub-auto-the-y-axis-label">The y axis label</h4>

<p>So, that’s the x axis label. Time to do the y axis. The code we’re going to use looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-90)"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">0</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code><code class="mi">0</code> <code class="o">-</code> <code class="p">(</code><code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"1em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Value"</code><code class="p">);</code> 
</pre></div>

</figure>

<p>For the sake of neatness we will put the piece of code in a nice logical spot and this would be following the block of code that added the y axis (but before the closing curly bracket)</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the y Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>

  <code class="c1">// PUT THE NEW CODE HERE!</code>

<code class="p">});</code>
</pre></div>

</figure>

<p>And the result looks like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/value01.png" alt="y axis label with rotation!">
  <figcaption>y axis label with rotation!</figcaption>
</figure>


<p>There we go, a label for the y axis that is nicely centred and (gasp!) rotated by 90 degrees! Woah, does the leetness never end! (No. No it does not.)</p>

<p>So, how do we get to this incredible result?</p>

<p>The first thing we do is the same as for the x axis and append a text element to our svg element (<code>svg.append("text")</code>).</p>

<p>Then things get interesting.</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(-90)"</code><code class="p">)</code>
</pre></div>

</figure>

<p>Because that line rotates everything by -90 degrees. While it’s obvious that the text label ‘Value’ has been rotated by -90 degrees (from the picture), the following lines of code show that we also rotated our reference point (which can be a little confusing).</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">0</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code><code class="mi">0</code> <code class="o">-</code> <code class="p">(</code><code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
</pre></div>

</figure>

<p>Let’s get graphical to illustrate how this works;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/value02.png" alt="Reference point pre-rotation">
  <figcaption>Reference point pre-rotation</figcaption>
</figure>


<p>Here’s our starting position, with x,y in the 0,0 coordinate of the graph drawing area surrounded by the margins.</p>

<p>When we apply a -90 degrees transform we get the equivalent of this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/value03.png" alt="Reference point after rotation">
  <figcaption>Reference point after rotation</figcaption>
</figure>


<p>Here the 0,0 coordinate has been shifted by -90 degrees and the x,y designations are flipped so that we now need to tell the script that we’re moving a ‘y’ coordinate when we would have otherwise been moving ‘x’.</p>

<p>Hence, when the script runs…   </p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">0</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code><code class="p">)</code>
</pre></div>

</figure>

<p>… we can see that this is moving the x position to the left from the new 0 coordinate by the margin.left value. </p>

<p>Likewise when the script runs…</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code><code class="mi">0</code> <code class="o">-</code> <code class="p">(</code><code class="nx">height</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
</pre></div>

</figure>

<p>… this is actually moving the y position from the new 0 coordinate halfway up the height of the graph area.</p>

<aside class="information blurb">
    <p>I will be the first to admit that this does seem a little confusing. But here’s the good part. You really don’t need to understand it completely. Simply do what I did when I saw the code. Play with it a bit till you get the result you were looking for. If that means putting in some hard coded numbers and incrementing them to see which way is the new ‘up’. Good! Once you work it out, then work out how to get the right variable expression in there and you’re set.</p>

  <p>In the worst case scenario, simply use the code blocks as shown here and leave well enough alone :-).</p>

</aside>

<p>Right, we’re not quite done yet. The following line has the effect of shifting the text slightly to the right.</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">"1em"</code><code class="p">)</code>
</pre></div>

</figure>

<p>Firstly the reason we do this is that our previous translation of coordinates means that when we place our text label it sits exactly on the line of 0 – margin.left. But in this case that takes the text to the other side of the line, so it actually sits just outside the boundary of the svg element. </p>

<p>The <code>"dy"</code> attribute is another coordinate adjustment move, but this time a relative adjustment and the “1em” is a unit of measure that equals exactly one unit of the currently specified <a href="http://en.wikipedia.org/wiki/Em_(typography)">text point size</a>. So what ends up happening is that the ‘Value’ label gets shifted to the right by exactly the height of the text, which neatly places it exactly on the edge of the canvas.</p>

<p>The two final lines of this part of the script are the same as for the x axis. They make sure the reference point is aligned to the centre of the text (<code>.style("text-anchor", "middle")</code>) and then it prints the text (<code>.text("Value");</code>). There, that wasn’t too painful.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/23e42c8f67210ac6c678db2cd07a747e">github</a> or in the code samples bundled with this book (axis-labels.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/23e42c8f67210ac6c678db2cd07a747e">bl.ocks.org</a>. </p>

<div class="page-break"></div>

<h3 id="title">How to add a title to your graph</h3>

<p>If you’ve read through the <a href="#axislabels">adding the axis labels</a> section most of this will come as no surprise.</p>

<p>What we want to do to add a title to the graph is to add a text element (just a few words) that will appear above the graph and centred left to right.</p>

<p>We’ll start with our default code for our simple graph. The full code for this can be found on <a href="https://gist.github.com/d3noob/402dd382a51a4f6eea487f9a35566de0">github</a> or in the code samples bundled with this book (simple-graph.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0">bl.ocks.org</a>. </p>

<p><strong>Preparation</strong>: Because we’re going to be adding a title to the top of the graph we need to increase the top margin. Changes like the following should suffice;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">40</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">50</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">70</code><code class="p">},</code>
</pre></div>

</figure>
<p>To add the title this is the code we’re going to add to the simple line graph script;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// add a title</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>				
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">0</code> <code class="o">-</code> <code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>	
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"20px"</code><code class="p">)</code> 
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-decoration"</code><code class="p">,</code> <code class="s2">"underline"</code><code class="p">)</code> 	
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Value vs Date Graph"</code><code class="p">);</code>
</pre></div>

</figure>

<p>And the end result will look like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/title01.png" alt="Basic graph with title">
  <figcaption>Basic graph with title</figcaption>
</figure>


<p>A nice logical place to put the block of code would be towards the end of the JavaScript. In fact I would put it as the last element we add. So here;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// add the Y Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>

  <code class="c1">// PUT THE NEW CODE HERE!</code>

<code class="p">});</code>
</pre></div>

</figure>

<p>Now since the vast majority of the code for this block is a regurgitation of the axis labels code, I don’t want to revisit that and bloat up this document even more, so I will direct you <a href="#axislabels">back to that section</a> if you need to refresh yourself on any particular line. But….. There are a couple of new ones in there which could benefit from a little explanation.</p>

<p>Both of them are style descriptors and as such their job is to apply a very specific style to this element.</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"20px"</code><code class="p">)</code> 
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-decoration"</code><code class="p">,</code> <code class="s2">"underline"</code><code class="p">)</code> 	
</pre></div>

</figure>

<p>What they do is pretty self explanatory. Make the text a specific size and underline it. But what is perhaps slightly more interesting is that we have this declaration in the JavaScript code and not in the CSS portion of the file.</p>

<aside class="information blurb">
    <p>Strictly speaking, this is the sort of thing that would be placed in the <code>&lt;style&gt;</code> section of the HTML code, but in this case, since it is only going to be used once, we shouldn’t feel too bad putting it here.</p>

</aside>

<div class="page-break"></div>

<h3 id="leanpub-auto-change-a-line-chart-into-a-scatter-plot">Change a line chart into a scatter plot</h3>

<p>Confession time. </p>

<p>I didn’t actually intend to add in a section with a scatter plot in it because I thought it would be;</p>

<ol class="numeric">
  <li>tricky</li>
  <li>not useful</li>
  <li>all of the above</li>
</ol>

<p>I was wrong on all counts.</p>

<aside class="information blurb">
    <p>I did want to have a scatter plot, because I wanted to display tool tips, but this is too neat to ignore.
It was literally a 5 minute job, 3 minutes of which was taken up by going to the <a href="https://github.com/mbostock/d3/wiki/Gallery">d3 gallery on the wiki</a> and ogling at the cool stuff there before snapping out of it and going to the <a href="http://bl.ocks.org/3887118">scatter plot example</a>.</p>

</aside>

<p>All you need to do is take the <a href="#simplegraph">simple graph</a> example file. The full code for this can be found on <a href="https://gist.github.com/d3noob/402dd382a51a4f6eea487f9a35566de0">github</a> or in the code samples bundled with this book (simple-graph.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0">bl.ocks.org</a>. </p>

<p>We then slot the following block in between the ‘Add the valueline path’ and the ‘add the x axis’ blocks.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the scatterplot</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"dot"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>And you will get…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/scatter01.png" alt="A scatter plot! (with a line)">
  <figcaption>A scatter plot! (with a line)</figcaption>
</figure>


<p>The full code for this graph can also be found on <a href="https://gist.github.com/d3noob/6f082f0e3b820b6bf68b78f2f7786084">github</a> or in the code samples bundled with this book (scatterplot.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/6f082f0e3b820b6bf68b78f2f7786084">bl.ocks.org</a>.</p>

<p>I deliberately put the dots <em>after</em> the line in the drawing section, because I thought they would look better, but you could put the block of code before the line drawing block to get the following effect;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/scatter02.png" alt="A scatter plot with the line in front of the dots">
  <figcaption>A scatter plot with the line in front of the dots</figcaption>
</figure>


<p>(just trying to reinforce the concept that ‘order’ matters when drawing objects :-)).</p>

<p>You could of course just remove the line block all together…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/scatter03.png" alt="A scatter plot without the line this time">
  <figcaption>A scatter plot without the line this time</figcaption>
</figure>


<p>But in my humble opinion it loses something.</p>

<p>So what do the individual lines in the scatter plot block of JavaScript do?</p>

<p>The first line (<code>svg.selectAll("dot")</code>) essentially provides a suitable grouping label for the svg circle elements that will be added. The next line associates the range of data that we have to the group of elements we are about to add in.</p>

<p>Then we add a circle for each data point (<code>.enter().append("circle")</code>) with a radius of 5 pixels (<code>.attr("r", 5)</code>) and appropriate x (<code>.attr("cx", function(d) { return x(d.date); })</code>) and y (<code>.attr("cy", function(d) { return y(d.close); });</code>) coordinates.</p>

<p>There is lots more that we could be doing with this piece of code (check out the <a href="http://bl.ocks.org/3887118">scatter plot example</a>) including varying the colour or size or opacity of the circles depending on the data and all sorts of really neat things, but for the mean time, there we go. Scatter plot!</p>

<div class="page-break"></div>

<h3 id="smoothing">Smoothing out graph lines</h3>

<p>When you draw a line graph, what you’re doing is taking two (or more) sets of coordinates and connecting them with a line (or lines). I know that sounds simplistic, but bear with me. When you connect these points, you’re telling the viewer of the graph that in between the individual points, you expect the value to vary in keeping with the points that the line passes through. So in a way, you’re trying to interpret the change in values that are not shown.</p>

<p>Now this is not strictly true for all graph types, but it does hold for a lot of line graphs. </p>

<p>So… when connecting these known coordinates together, you want to make the best estimate of how the values would be represented. In this respect, sometimes a straight line between points is not  the best representation.</p>

<p>For instance. Earlier, when demonstrating the extent function for graphing we showed a graph of the varying values with the y axis showing a narrow range.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/scales6.png" alt="Expanded values for a narrow range">
  <figcaption>Expanded values for a narrow range</figcaption>
</figure>


<p>The resulting variation of the graph shows a fair amount of extremes and you could be forgiven for thinking that if this represented a smoothly flowing analog system of some kind then some of those sharp peaks and troughs would not be a true representation of how the system or figures varied.</p>

<p>So how should it look? Ahh… The $64,000 question. I don’t know :-). You will have a better idea since you are the person who will know your data best. However, what I do know is that D3 has some tricks up its sleeve to help.</p>

<p>We can easily change what we see above into;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth02.png" alt='Smoothing using "basis"'>
  <figcaption>Smoothing using “basis”</figcaption>
</figure>


<p>How about that? And the massive amount of code required to carry out what must be a ridiculously difficult set of calculations?</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">curve</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">curveBasis</code><code class="p">);</code>
</pre></div>

</figure>

<aside class="information blurb">
    <p>Now, that is slightly unfair because that’s the code that WE need to put in your script, but Mike Bostock probably had to do the mental equivalent of walking across hot coals to get it to work so nicely.</p>

</aside>

<p>So where does this neat piece of code go? Here;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// define the line</code>
<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">curve</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">curveBasis</code><code class="p">)</code>	 		<code class="c1">// &lt;=== THERE IT IS!</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>So is that it? Nooooo…….. There’s more! This is one form of interpolation effect that can be applied to your data, but there is a range and depending on your data you can select the one that is appropriate.</p>

<p>Here’s the list of available options and for more about them head on over to the <a href="https://github.com/d3/d3-shape/blob/master/README.md#curves">D3 wiki</a>.</p>

<ul>
  <li>linear (<code>d3.curveLinear</code>) – Normal line (jagged).</li>
  <li>linear-closed (<code>d3.curveLinearClosed</code>) – A normal line (jagged) families of curves available with the start and the end closed in a loop.</li>
  <li>step (<code>d3.curveStep</code>)- a stepping graph alternating between vertical and horizontal segments. The y values change at the mid point of the adjacent x values</li>
  <li>step-before (<code>d3.curveStepBefore</code>) - a stepping graph alternating between vertical and horizontal segments. The y values change before the x value.</li>
  <li>step-after (<code>d3.curveStepAfter</code>) - a stepping graph alternating between horizontal and vertical segments. The y values change after the x value.</li>
  <li>basis (<code>d3.curveBasis</code>) - a B-spline, with control point duplication on the ends (that’s the one above).</li>
  <li>basis-open (<code>d3.curveBasisOpen</code>) - an open B-spline; may not intersect the start or end.</li>
  <li>basis-closed (<code>d3.curveBasisClosed</code>) - a closed B-spline, with the start and the end closed in a loop.</li>
  <li>bundle (<code>d3.curveBundle</code>) - equivalent to basis, except a separate tension parameter is used to straighten the spline. This could be really cool with varying tension.</li>
  <li>cardinal (<code>d3.curveCardinal</code>) - a Cardinal spline, with control point duplication on the ends. It looks slightly more ‘jagged’ than basis.</li>
  <li>cardinal-open (<code>d3.curveCardinalOpen</code>) - an open Cardinal spline; may not intersect the start or end, but will intersect other control points. So kind of shorter than ‘cardinal’.</li>
  <li>cardinal-closed (<code>d3.curveCardinalClosed</code>) - a closed Cardinal spline, looped back on itself.</li>
  <li>monotone (<code>d3.curveMonotoneX</code>) - cubic interpolation that makes the graph only slightly smoother.</li>
  <li>catmull-Rom (<code>d3.curveCatmullRom</code>) - New for v4 - a cubic <a href="https://en.wikipedia.org/wiki/Centripetal_Catmull%E2%80%93Rom_spline">Catmull–Rom spline</a>
</li>
  <li>catmull-Rom-closed (<code>d3.curveCatmullRomClosed</code>) - New for v4 - a closed cubic Catmull–Rom spline</li>
  <li>catmull-Rom-open (<code>d3.curveCatmullRomOpen</code>) - New for v4 - an open cubic Catmull–Rom spline</li>
</ul>

<p>Because in the course of writing this I took an opportunity to play with each of them, I was pleasantly surprised to see some of the effects and it seems like a shame to deprive the reader of the same joy :-). So at the risk of deforesting the planet (so I hope you are reading this in electronic format) here is each of the above interpolation types applied to the same data.</p>

<p>This is also an opportunity to add some reader feedback awesomeness. Many thanks to ‘enjalot’ for the great suggestion to plot the points of the data as separate circles on the graphs. Since the process of interpolation has the effect of ‘interpreting’ the trends of the data to the extent that in some cases, the lines don’t intersect the actual data much at all.</p>

<p>Each of the following shows the smoothing curve and the data that is used to plot the graph (as a scatterplot).   </p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth03.png" alt='Smoothing using "linear"'>
  <figcaption>Smoothing using “linear”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth03a.png" alt='Smoothing using "linear-closed"'>
  <figcaption>Smoothing using “linear-closed”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth04a.png" alt='Smoothing using "step"'>
  <figcaption>Smoothing using “step”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth04.png" alt='Smoothing using "step-before"'>
  <figcaption>Smoothing using “step-before”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth05.png" alt='Smoothing using "step-after"'>
  <figcaption>Smoothing using “step-after”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth06.png" alt='Smoothing using "basis"'>
  <figcaption>Smoothing using “basis”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth07.png" alt='Smoothing using "basis-open"'>
  <figcaption>Smoothing using “basis-open”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth08.png" alt='Smoothing using "basis-closed"'>
  <figcaption>Smoothing using “basis-closed”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth09.png" alt='Smoothing using "bundle"'>
  <figcaption>Smoothing using “bundle”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth10.png" alt='Smoothing using "cardinal"'>
  <figcaption>Smoothing using “cardinal”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth11.png" alt='Smoothing using "cardinal-open"'>
  <figcaption>Smoothing using “cardinal-open”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth12.png" alt='Smoothing using "cardinal-closed"'>
  <figcaption>Smoothing using “cardinal-closed”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth13.png" alt='Smoothing using "monotone"'>
  <figcaption>Smoothing using “monotone”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth14.png" alt='Smoothing using "catmull-Rom"'>
  <figcaption>Smoothing using “catmull-Rom”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth15.png" alt='Smoothing using "catmull-Rom-closed"'>
  <figcaption>Smoothing using “catmull-Rom-closed”</figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth16.png" alt='Smoothing using "catmull-Rom-open"'>
  <figcaption>Smoothing using “catmull-Rom-open”</figcaption>
</figure>


<p>Just in case you’re in the mood for another example, feel free to check out the <a href="http://bl.ocks.org/d3noob/ced1b9b18bd8192d2c898884033b5529">bl.ock here</a> which shows all of the basic forms of the curve types (I didn’t include the open and closed versions or ‘bundle’ since it is the equivalent of ‘basis’). The full code for this can also be found in the code samples bundled with this book (interpolate.html and data-3.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/402dd382a51a4f6eea487f9a35566de0">bl.ocks.org</a>. </p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/smooth17.png" alt="Comparison of curve types">
  <figcaption>Comparison of curve types</figcaption>
</figure>


<p>So, over to you to decide which format of interpolation is going to suit your data best:-).</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-make-a-dashed-line">Make a dashed line</h3>

<p>Dashed lines totally rock!</p>

<aside class="information blurb">
    <p>OK, there may be an element of exaggeration there, but I certainly found it interesting that there didn’t seem to be a lot of explanation for a simple person like myself to make a dashed line in D3. So for me they rocked :-)</p>

</aside>

<p>One of the best parts about it is that they’re so simple to do!</p>

<p>Literally one line!!!!</p>

<p>So lets imagine that we want to make the line on our <a href="#simplegraph">simple graph</a> dashed. All we have to do is insert the following line in our JavaScript code here;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the valueline path.</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="nx">data</code><code class="p">])</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-dasharray"</code><code class="p">,</code> <code class="p">(</code><code class="s2">"3, 3"</code><code class="p">))</code>  <code class="c1">// &lt;== This line here!!</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">);</code>
</pre></div>

</figure>

<p>And our graph ends up like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/dashed01.png" alt="Dashed line for the basic graph">
  <figcaption>Dashed line for the basic graph</figcaption>
</figure>


<p>Hey! It’s dashtastic!</p>

<p>So how does it work?</p>

<p>Well, obviously <code>"stroke-dasharray"</code> is a style for the path element, but the magic is in the numbers.</p>

<p>Essentially they describe the on length and off length of the line. So <code>"3, 3"</code> translates to 3 pixels (or whatever they are) on and 3 pixels off. Then it repeats. Simple eh?</p>

<p>So, experiment time :-)</p>

<p>What would the following represent?</p>

<p><code>"5, 5, 5, 5, 5, 5, 10, 5, 10, 5, 10, 5"</code></p>

<p>Try not to cheat…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/dashed02.png" alt="Dashed lines for fun">
  <figcaption>Dashed lines for fun</figcaption>
</figure>


<p>Ahh yes, Mr. Morse would be proud.</p>

<p>And you can put them anywhere. Here are our axes perverted with dashes;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the X Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-dasharray"</code><code class="p">,</code> <code class="p">(</code><code class="s2">"3, 3"</code><code class="p">))</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>

  <code class="c1">// Add the Y Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-dasharray"</code><code class="p">,</code> <code class="p">(</code><code class="s2">"3, 3"</code><code class="p">))</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/dashed03.png" alt="When dashed lines go bad">
  <figcaption>When dashed lines go bad</figcaption>
</figure>


<p>Well… I suppose you can have too much of a good thing. With great power comes great responsibility. Use your dash skills wisely and only for good.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-filling-an-area-under-the-graph">Filling an area under the graph</h3>

<p>Lines are all very well and good, but that’s not the whole story for graphs. Sometimes you’ve just got to go with a fill.</p>

<p>Filling an area with a solid colour isn’t too hard. I mean we did it by mistake back a few pages when we were trying to draw a line.</p>

<p>But to do it in a nice coherent way is fairly straight forward.</p>

<p>It takes three sections of code in much the same way that we drew our grid lines earlier;</p>

<ol class="numeric">
  <li>One in the CSS section to define what style the area will have.</li>
  <li>One to define the functions that generate the area. And…</li>
  <li>One to draw the area.</li>
</ol>

<p>The end result will looks a bit like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/fill01.png" alt="Basic graph with an area fill">
  <figcaption>Basic graph with an area fill</figcaption>
</figure>


<p>While we’ll start with our default code for our simple graph, the full code for this area graph can be found on <a href="https://gist.github.com/d3noob/119a138ef9bd1d8f0a8d57ea72355252">github</a> or in the code samples bundled with this book (area.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/119a138ef9bd1d8f0a8d57ea72355252">bl.ocks.org</a>. </p>

<h4 id="leanpub-auto-css-for-an-area-fill">CSS for an area fill</h4>

<p>This is pretty straight forward and only consists of one rule;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.area</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">lightsteelblue</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Put it at the bottom of your <code>&lt;style&gt;</code> section.</p>

<p>The style (<code>fill: lightsteelblue;</code>) sets the colour of our fill (and in this case we have chosen a lighter shade of the same colour as our line to match it).</p>

<h4 id="leanpub-auto-define-the-area-function">Define the area function</h4>

<p>We need a function that will tell the area what space to fill. This is accessed from the <a href="https://github.com/d3/d3-shape/blob/master/README.md#areas"><code>d3.area</code> function</a></p>

<p>The code that we will use is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// define the area</code>
<code class="kd">var</code> <code class="nx">area</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="nx">height</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">y1</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>I have placed it in between the range variable definitions and the line definitions here;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleTime</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

                         <code class="o">&lt;====</code> <code class="nx">Put</code> <code class="nx">the</code> <code class="k">new</code> <code class="nx">code</code> <code class="nx">here</code><code class="o">!</code>

<code class="c1">// define the line</code>
<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<aside class="information blurb">
    <p>You will notice it looks <em>INCREDIBLY</em> similar to the valueline function definition. That’s because; while the line definition describes drawing a line that connects a set of coordinates, I imagine the area definition describes drawing two lines that share the same x coordinates, but simultaneously draws two y coordinates, y0 and y1. Then when it’s finished drawing the resultant shape, it fills it with the colour of your choosing.</p>

</aside>

<p>So the only changes to the code are the addition of the <code>y0</code> line and the renaming of the <code>y</code> line <code>y1</code>.</p>

<p>Here’s a picture that might help explain;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/fill03.png" alt="How the area is defined">
  <figcaption>How the area is defined</figcaption>
</figure>


<p>As should be apparent, the top line (<code>y1</code>) follows the valueline line and the bottom line is at the constant ‘height’ value. Everything in between these lines is what gets filled. The function in this section describes the area.</p>

<h4 id="leanpub-auto-draw-the-area">Draw the area</h4>

<p>Now to the money maker.</p>

<p>The final section of code in the area filling odyssey is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// add the area</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
       <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="nx">data</code><code class="p">])</code>
       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area"</code><code class="p">)</code>
       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">);</code>
</pre></div>

</figure>

<p>We should place this block directly after the domain functions but before the drawing of the valueline path;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// scale the range of the data</code>
  <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>

                                <code class="c1">//   &lt;== Area drawing code here!</code>

  <code class="c1">// add the valueline path.</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="nx">data</code><code class="p">])</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">);</code>
</pre></div>

</figure>

<p>This is actually a pretty good idea to put it there since the various bits and pieces that are drawn in the graph are done so one after the other. This means that the filled area comes first, then the valueline is layered on top and then the axes come last. This is a pretty good sequence since if there are areas where two or more elements overlap, it might cause the graph to look ‘wrong’.</p>

<p>For instance, here is the graph drawn with the area added last.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/fill04.png" alt="Area overlaps and obscures">
  <figcaption>Area overlaps and obscures</figcaption>
</figure>


<p>You should be able to notice that part of the valueline line has been obscured and the line for the y axis where it coincides with the area is obscured also.</p>

<p>Looking at the code we are adding here, the first line appends a path element (<code>svg.append("path")</code>) much like the script that draws the line.</p>

<p>The second line (<code>.data([data])</code>) declares the data we will be utilising for describing the area and the third line (<code>.attr("class", "area")</code>) makes sure that the style we apply to it is as defined in the CSS section (under ‘area’).</p>

<p>The final line (<code>.attr("d", area);</code>) declares “d” as the attributer for path data and calls the ‘area’ function to do the drawing.</p>

<p>And that’s it!</p>

<h4 id="leanpub-auto-filling-an-area-above-the-line">Filling an area above the line</h4>

<p>Pop Quiz:</p>

<p>How would you go about filling the area <em>ABOVE</em> the graph?</p>

<aside class="information blurb">
    <p>Now it might sound a little trite, but believe it or not, this could come in handy. For instance, what if you want to highlight an area that was too high and an area that was too low for a line of data on a graph with an area in the centre where a projected ‘normal’ set of values should be present?</p>

</aside>

<p>In this instance, you could fill the lower area as has been demonstrated here, and with a small change you can fill another area with a solid colour above another line.</p>

<p>How is this incredible feat achieved?</p>

<p>Well, remember the code that defined the area?</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// define the area</code>
<code class="kd">var</code> <code class="nx">area</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="nx">height</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">y1</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>All we have to do is tell it that instead of setting the <code>y0</code> constant value to the height of the graph (remember, this is the bottom of the graph) we will set it to the constant value that is at the top of the graph. In other words zero (0).</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
</pre></div>

</figure>

<p>That’s it.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/fill05.png" alt="Fill an area above a line">
  <figcaption>Fill an area above a line</figcaption>
</figure>


<p>Now, I’m not going to go over the process of drawing two lines and filling each in different directions to demonstrate the example I described, but this provides a germ of an idea that you might be able to flesh out :-)</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-adding-a-drop-shadow-to-allow-text-to-stand-out-on-graphics">Adding a drop shadow to allow text to stand out on graphics.</h3>

<p>I’ve deliberately positioned this particular tip to follow the ‘filling an area’ description because it provides an opportunity to demonstrate the principle to slightly better effect.</p>

<p>While we’ll start with our code for our area graph, the full code for the graph with shadowy text can be found on <a href="https://gist.github.com/d3noob/aa55e2004abba3c503116b103a1f0ff2">github</a> or in the code samples bundled with this book (shadow.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/aa55e2004abba3c503116b103a1f0ff2">bl.ocks.org</a>.</p>

<p>There have been several opportunities where I have wanted to place text overlaid on graphs for convenience sake only to have it look overly messy as the text interferes with the graph.</p>

<aside class="question blurb">
    <h3 id="leanpub-auto-is-this-evil">Is this evil?</h3>
  <p>Now, I’ll be the first to say that the principle of overlaying text on a graph is probably not best practice, but sometimes you’ve got to do what you’ve got to do. Besides. Sometimes it’s a valid idea. If I remember rightly, the first time I came across this idea, it was being used to highlight text when positioned on bars of a bar graph. So it’s not always an evil practice :-).</p>

</aside>

<p>Anyway, what we’ll do is leave the area fill in place and place the title back on the graph, but position the title so that it lays on top of the fill like so;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/drop01.png" alt="Title lost in the area fill">
  <figcaption>Title lost in the area fill</figcaption>
</figure>


<p>The additional code for the title is the following and appears just after the drawing of the axes.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>				
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">25</code> <code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>	
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"24px"</code><code class="p">)</code> 
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-decoration"</code><code class="p">,</code> <code class="s2">"underline"</code><code class="p">)</code> 	
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Value vs Date Graph"</code><code class="p">);</code>
</pre></div>

</figure>

<p>(the only change from the previous title example is the ‘y’ attribute which has been hard coded to 25 to place it inconveniently on the filled area and the size of the font)</p>

<p>So, what we want to end up with is something like the following…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/drop02.png" alt="A nice white drop shadow effect">
  <figcaption>A nice white drop shadow effect</figcaption>
</figure>


<p>In my humble opinion, it’s just enough to make the text acceptable :-).</p>

<p>The method that I’ll describe to carry this out is designed so that the drop shadow effect can be applied to any text elements in the graph, not the isolated example that we will use here. In order to implement this marvel of utility we will need to make changes in two areas. One in the CSS where we will define a style for white shadowy backgrounds and the second to draw it.</p>

<h4 id="leanpub-auto-css-for-white-shadowy-background">CSS for white shadowy background</h4>

<p>The code to add to the CSS section is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">text</code><code class="nc">.shadow</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">4px</code><code class="p">;</code>
  <code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">8</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The first line designates that the style applies to text with a ‘shadow’ label. The stroke is set to white. The width of the line is set to 4px and it is made to be slightly see-through. So by setting the line that surrounds the text to be thick, white and see-through gives it a slightly ‘cloudy’ effect. If we remove the black text from over the top we get a slightly better look;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/drop03.png" alt="A closer look at just the drop shadow">
  <figcaption>A closer look at just the drop shadow</figcaption>
</figure>


<p>Of course if you want to have a play with any of these settings, you should have a go and see what works best for your graph.</p>

<h4 id="leanpub-auto-drawing-the-white-shadowy-background">Drawing the white shadowy background.</h4>

<p>Now that we’ve set the style for our background, we need to draw it in.</p>

<p>The code for this should be extremely familiar;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">))</code>				
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">25</code> <code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>	
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"24px"</code><code class="p">)</code> 
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-decoration"</code><code class="p">,</code> <code class="s2">"underline"</code><code class="p">)</code> 
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"shadow"</code><code class="p">)</code>			<code class="c1">// &lt;=== Here's the different line</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Value vs Date Graph"</code><code class="p">);</code>
</pre></div>

</figure>

<p>That’s because it’s identical to the piece of code that was used to draw the title except for the one line that is indicated above. The reason that it’s identical is that what we are doing is placing a white shadow on the graph and then the text on top of it, if it deviated by a significant amount it will just look silly. Of course a slight amount could look effective, in which case adjust the ‘<code>x</code>’ or ‘<code>y</code>’ attributes.</p>

<p>One of the things I pointed out in the previous paragraph was extremely important. That’s the bit that tells you that we needed to place the shadow <strong>before</strong> we placed the black text. For the same reason that we placed the area fill on first in the area fill example, If black text goes on before the shadow, it will look pretty silly. So place this block of code just before the block that draws the title.</p>

<p>So the line that has been added in is the one that tells D3 that the text that is being drawn will have the white cloudy effect. And at the risk of repeating myself, if you have several text elements that could benefit from this effect, once you have the CSS code in place, all you need to do is duplicate the block that adds the text and add in that single line and voila!</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-adding-grid-lines-to-a-graph">Adding grid lines to a graph</h3>

<p>Grid lines are an important feature for some graphs as they allow the eye to associate three analogue scales (the x and y axis and the displayed line).</p>

<p>There is currently a tendency to use graphs without grid lines online as it gives the appearance of a ‘cleaner’ interface, but they are still widely used and a necessary component for graphing.</p>

<p>This is what we’re going to draw;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/grid01.png" alt="Basic graph with gridlines">
  <figcaption>Basic graph with gridlines</figcaption>
</figure>


<p>While we’ll start with our default code for our simple graph, the full code for the graph with grid lines can be found on <a href="https://gist.github.com/d3noob/c506ac45617cf9ed39337f99f8511218">github</a> or in the code samples bundled with this book (grid.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/c506ac45617cf9ed39337f99f8511218">bl.ocks.org</a>. </p>

<aside class="information blurb">
    <p>Like pretty much everything in this document, the clever parts of this are not my work. I’ve simply used other peoples cleverness to solve my problems. In this case I think the source of this solution came from the good work of Justin Palmer in his excellent description of the design of a line graph <a href="http://dealloc.me/2011/06/24/d3-is-not-a-graphing-library.html">here</a>. However, in retrospect when I’ve looked back, I’m not sure if I got this right (as I did this quite a while ago when I was less fastidious about noting my sources). In any case, Justin’s work is excellent and I heartily recommend it, and here is my implementation of what I think is his work :-)</p>

</aside>

<p>How to build grid lines?</p>

<p>We’re going to use the axis function to generate two more axis elements (one for x and one for y) but for these ones instead of drawing the main lines and the labels, we’re just going to draw the tick lines. Really long tick lines (I’m considering calling them <a href="http://knowyourmeme.com/memes/longcat">long cat</a> lines).</p>

<p>To create them we have to add in 3 separate blocks of code.</p>

<ol class="numeric">
  <li>One in the CSS section to define what style the grid lines will have.</li>
  <li>One to define the functions that generate the grid lines. And…</li>
  <li>One to draw the lines.</li>
</ol>

<h4 id="leanpub-auto-the-grid-line-css">The grid line CSS</h4>

<p>This is the total styling that we need to add for the tick lines;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.grid</code> <code class="nt">line</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="nb">lightgrey</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="m">0</code><code class="o">.</code><code class="m">7</code><code class="p">;</code>
  <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.grid</code> <code class="nt">path</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">0</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Just add this block of code at the end of the current CSS that is in the simple graph template (just before the <code>&lt;/style&gt;</code> tag).</p>

<p>The CSS here is done in two parts.</p>

<p>The first portion sets the line colour (stroke), the opacity (transparency) of the lines and make sure that the lines are narrow (<code>crispEdges</code>).</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nt">stroke</code><code class="o">:</code> <code class="nt">lightgrey</code><code class="o">;</code>
  <code class="nt">stroke-opacity</code><code class="o">:</code> <code class="nt">0</code><code class="nc">.7</code><code class="o">;</code>
  <code class="nt">shape-rendering</code><code class="o">:</code> <code class="nt">crispEdges</code><code class="o">;</code>
</pre></div>

</figure>

<p>The colour is pretty standard, but in using the opacity style we give ourselves the opportunity to use a good shade of colour (if grey actually is a colour) and to juggle the degree to which it stands out a little better.</p>

<p>The second part is the stroke width.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nt">stroke-width</code><code class="o">:</code> <code class="nt">0</code><code class="o">;</code>
</pre></div>

</figure>

<p>Now it might seem a little weird to be setting the stroke width to zero, but if you don’t (and we remove the style) this is what happens;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/grid02.png" alt="Axis lines made too thick">
  <figcaption>Axis lines made too thick</figcaption>
</figure>


<p>If you look closely (compare with the previous picture if necessary) the grid lines for the top and right edges have turned black. The stroke width style is obviously adding in new axis lines and we’re not interested in them at the moment. Therefore, if we set the stroke width to zero, we get rid of the problem.</p>

<h4 id="leanpub-auto-define-the-grid-line-functions">Define the grid line functions</h4>

<p>We will need to define two functions to generate the grid lines and they look a little like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// gridlines in x axis function</code>
<code class="kd">function</code> <code class="nx">make_x_gridlines</code><code class="p">()</code> <code class="p">{</code>		
    <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code>
<code class="p">}</code>

<code class="c1">// gridlines in y axis function</code>
<code class="kd">function</code> <code class="nx">make_y_gridlines</code><code class="p">()</code> <code class="p">{</code>		
    <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Each function will carry out its configuration when called from the later part of the script (the drawing part).</p>

<p>A good spot to place the code is just before we load the data with the d3.csv </p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="c1">//   &lt;== Put the functions here!</code>

<code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>
</pre></div>

</figure>

<p>Both functions are almost identical. They give the function a name (make_x_gridlines and  make_y_gridlines) which will be used later when the piece of code that draws the lines calls out to them.</p>

<p>Both functions also show which parameters will be fed back to the drawing process when called. Both make sure they use the d3.axis function and then they set individual attributes which make sense. </p>

<p>They make sure they’ve got the right axes (with the <code>x</code> and <code>y</code> variables in the function). 
They set the orientation of the axes to match the incumbent axes (<code>d3.axisBottom(x)</code> and <code>d3.axisLeft(y)</code>).
And they set the number of ticks to match the number of ticks in the main axis (<code>.ticks(5)</code> and <code>.ticks(5)</code>). You have the opportunity here to do something slightly different if you want. For instance, think back to when we were setting up the axis for the basic graph and we messed about, seeing how many ticks we could get to appear. If we increase the number of ticks that appear in the grid (lets say to <code>.ticks(30)</code> and <code>.ticks(10)</code>)) we get the following;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/grid03.png" alt="Grid lines with greater divisions">
  <figcaption>Grid lines with greater divisions</figcaption>
</figure>


<p>So the grid lines can now show divisions of 20 on the y axis and per 2 days on the x axis :-)</p>

<h4 id="leanpub-auto-draw-the-lines">Draw the lines</h4>

<p>The final block of code we need is the bit that draws the lines.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// add the X gridlines</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>			
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"grid"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">make_x_gridlines</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">tickSize</code><code class="p">(</code><code class="o">-</code><code class="nx">height</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>
      <code class="p">)</code>

  <code class="c1">// add the Y gridlines</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>			
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"grid"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">make_y_gridlines</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">tickSize</code><code class="p">(</code><code class="o">-</code><code class="nx">width</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>
      <code class="p">)</code>
</pre></div>

</figure>

<p>The first two lines of both the x and y axis grid lines code above should be pretty familiar by now. The first one appends the element to be drawn to the group “g”. the second line (<code>.attr("class", "grid")</code>) makes sure that the style information set out in the CSS is applied.</p>

<p>The x axis grid lines portion makes a slight deviation from conformity here to adjust its positioning to take into account the coordinates system <code>.attr("transform", "translate(0," + height + ")")</code>.</p>

<p>Then both portions call their respective make axis functions (<code>.call(make_x_gridlines()</code> and <code>.call(make_y_gridlines()</code>).</p>

<p>Now comes the really interesting bit. </p>

<p>What you will see if you go to the <a href="https://github.com/mbostock/d3/wiki/SVG-Axes#wiki-tickSize">D3 API wiki</a> is that for the .tickSize function, the following is the format.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">axis</code><code class="p">.</code><code class="nx">tickSize</code><code class="p">([</code><code class="nx">size</code><code class="p">])</code>
</pre></div>

</figure>

<p>So in our example we are setting our ticks to a length that corresponds to the full height or width of the graph. Which of course means that they extend across the graph and have the appearance of grid lines! What a neat trick.</p>

<p>The last thing that is included in the code to draw the grid lines is the instruction to suppress printing any label for the ticks;</p>

<figure class="code">
<div class="highlight"><pre><code></code>          <code class="p">.</code><code class="nx">tickFormat</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>
</pre></div>

</figure>

<p>After all, that would become a bit confusing to have two sets of labels. Even if one was on top of the other. They do tend to become obvious if that occurs (they kind of bulk out a bit like bold text).</p>

<p>And that’s it. Grid lines!</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-adding-more-than-one-line-to-a-graph">Adding more than one line to a graph</h3>

<p>All right, we’re starting to get serious now. Two lines on a graph is a bit of a step into a different world in one respect. I mean that in the sense that there’s more than one way to carry out the task, and I tend to do it one way and not the other mainly because I don’t fully understand the other way :-(.</p>

<aside class="information blurb">
    <p>I should stress that that’s not because it’s more complex, or that it’s a bad way, it’s just that once I started doing things one way, I haven’t come across a need to do things another way. There’s a good chance I will have to revisit this decision in the future, but for now I’ll keep moving.</p>

</aside>

<p>How are we going to do this? I think that the best way will be to make the executive decision that we have suddenly come across more data and that it is also in our data.csv file (which we’ll rename data2.csv just to highlight the difference between the two data sets). In fact it looks a little like this (apologies in advance for the big ugly block of data);</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close,open
1-May-12,68.13,34.12
30-Apr-12,63.98,45.56
27-Apr-12,67.00,67.89
26-Apr-12,89.70,78.54
25-Apr-12,99.00,89.23
24-Apr-12,130.28,99.23
23-Apr-12,166.70,101.34
20-Apr-12,234.98,122.34
19-Apr-12,345.44,134.56
18-Apr-12,443.34,160.45
17-Apr-12,543.70,180.34
16-Apr-12,580.13,210.23
13-Apr-12,605.23,223.45
12-Apr-12,622.77,201.56
11-Apr-12,626.20,212.67
10-Apr-12,628.44,310.45
9-Apr-12,636.23,350.45
5-Apr-12,633.68,410.23
4-Apr-12,624.31,430.56
3-Apr-12,629.32,460.34
2-Apr-12,618.63,510.34
30-Mar-12,599.55,534.23
29-Mar-12,609.86,578.23
28-Mar-12,617.62,590.12
27-Mar-12,614.48,560.34
26-Mar-12,606.98,580.12
</pre></div>

</figure>

<p>Three columns, date open and close. The first two are exactly what we have been dealing with all along and the last (open) is our new made up data. Each column is separated by a comma (hence .csv (comma separated values)), which is the format we’re currently using to import data.</p>

<p>We should save this as a new file so we don’t mess up our previous data, so (as mentioned earlier) let’s call it data2.csv. </p>

<p>There is a copy of this file and the sample code at <a href="https://gist.github.com/d3noob/4db972df5d7efc7d611255d1cc6f3c4f">github</a> and in the code samples bundled with this book (multiple-lines.html and data2.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/4db972df5d7efc7d611255d1cc6f3c4f">bl.ocks.org</a>.</p>

<p>We will build our new code using our <a href="#simplegraph">simple graph</a> template to start with, so the immediate consequence of this is that we need to edit the line that was looking for ‘data.csv’ to reflect the new name.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data2.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>So when you browse to our new graph’s html file, we don’t see any changes. It still happily loads the new data, but because it hasn’t been told to do anything with it, nothing new happens.</p>

<p>What we need to do now it to essentially duplicate the code blocks that drew the first line for the second line.</p>

<p>The good news is that in the simplest way possible that’s just two code blocks.
The first sets up the function that defines the new line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// define the 2nd line</code>
<code class="kd">var</code> <code class="nx">valueline2</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">open</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>You should notice that this block is identical to the block that sets up the function for the first line, except this one is called (imaginatively) valueline2 and instead of including the variable ‘close’ for our datapoint we are using our new variable (from the extra column in the csv file) ‘open’. We should put it directly after the block that sets up the function for valueline.</p>

<p>The second block draws our new line;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the valueline2 path.</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="nx">data</code><code class="p">])</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline2</code><code class="p">);</code>
</pre></div>

</figure>

<p>Again, this is identical to the block that draws the first line, except this one is called valueline2. We should put it directly after the block that draws valueline.</p>

<p>After those three small changes, check out your new graph;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/twolines01.png" alt="Two lines, but the same colour">
  <figcaption>Two lines, but the same colour</figcaption>
</figure>


<p>Hey! Two lines! Hmm…. Both being the same colour is a bit confusing. Good news. We can change the colour of the second line by inserting a line that adjusts its stroke (colour) very simply.</p>

<p>So here’s what our new drawing block looks like;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the valueline2 path.</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="nx">data</code><code class="p">])</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline2</code><code class="p">);</code>
</pre></div>

</figure>

<p>And as if by magic, here’s our new graph;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/twolines02.png" alt="Two lines with two colours">
  <figcaption>Two lines with two colours</figcaption>
</figure>


<p>Wow. Right about now, we’re thinking ourselves pretty clever. But there are two places where we’re not doing things right. We took a simple way, but we took some short cuts that might bite us in the posterior.</p>

<p>The first mistake we made was not ensuring that our variable <code>"d.open"</code> is being treated as a number or a string. We’re fortunate in this case that it is, but this can’t always be assumed. So, this is an easy fix and we just need to put the following (indicated line) in our code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// format the data</code>
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">open</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">open</code><code class="p">;</code>         <code class="c1">//  &lt;=== Add this line in!</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>The second and potentially more fatal flaw is that nowhere in our code do we make allowance for our second set of data (the second line’s values) exceeding our first lines values. </p>

<p>That might not sound too normal straight away, but consider this. What if when we made up our data earlier, some of the new data exceeded our maximum value in our original data? As a means of demonstration, here’s what happens when our second line of data has values higher than the first lines;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/twolines03.png" alt="Two lines but the domain's not right">
  <figcaption>Two lines but the domain’s not right</figcaption>
</figure>


<p>Ahh…. We’re not too clever now.</p>

<p>Good news though, we can fix it!</p>

<p>The problem comes about because when we set the domain for the y axis this is what we put in the code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code> <code class="p">})]);</code>
</pre></div>

</figure>

<p>So that only considers <code>d.close</code> when establishing the domain. With <code>d.open</code> exceeding our domain, it just keeps drawing off the graph!</p>

<p>The good news is that ‘Bill’ has provided a solution for just this problem <a href="http://stackoverflow.com/questions/12732487/d3-js-dataset-array-w-multiple-y-axis-values">here</a>; </p>

<p>All you need to replace the <code>y.domain</code> line with is this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
	  <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">open</code><code class="p">);</code> <code class="p">})]);</code>
</pre></div>

</figure>

<p>It does much the same thing, but this time it returns the maximum of <code>d.close</code> and <code>d.open</code> (whichever is largest). Good work Bill. </p>

<p>If we put that code into the graph with the higher values for our second line we are now presented with this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/twolines04.png" alt="Two lines with everything fitting onto the canvas">
  <figcaption>Two lines with everything fitting onto the canvas</figcaption>
</figure>


<p>And it doesn’t matter which of the two sets of data is largest, the graph will always adjust :-)</p>

<p>You will also have noticed that our y axis has auto adjusted again to cope. Clever eh?</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-labelling-multiple-lines-on-a-graph">Labelling multiple lines on a graph</h3>

<p>Our previous example of a graph with multiple lines is a thing of rare beauty, but which line relates to which set of data? We have data that defines values for <code>open</code> and <code>close</code>, but we don’t know which line is which.</p>

<p>In this section we will add labels to our lines so that we know what it what.</p>

<p>This section was inspired by a question from a reader (Arun b.s) of the <a href="http://www.d3noob.org/2013/01/adding-more-than-one-line-to-graph-in.html">d3noob.org</a> blog where the question was asked “How can we put text at the end of each line on the graph?”. </p>

<p>The question was so good I realised that it had to be part of the book, so here you go :-).</p>

<p>It’s actually not too difficult. What we are trying to achieve is to find the position of the end of each line and to add a text label at that position so that the association of proximity denotes the linkage. Of course we’re going to go a little further and colour the text so that it’s really clear which label belongs with which line, but you get the idea.</p>

<p>Each line requires a single block of script to add the text. The block that adds the <code>open</code> label is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code><code class="o">+</code><code class="p">(</code><code class="nx">width</code><code class="o">+</code><code class="mi">3</code><code class="p">)</code><code class="o">+</code><code class="s2">","</code><code class="o">+</code><code class="nx">y</code><code class="p">(</code><code class="nx">data</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">open</code><code class="p">)</code><code class="o">+</code><code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Open"</code><code class="p">);</code>
</pre></div>

</figure>

<p>So firstly it appends a textual element to the svg object;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
</pre></div>

</figure>

<p>Then it finds the position of the end of the line;</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate("</code><code class="o">+</code><code class="p">(</code><code class="nx">width</code><code class="o">+</code><code class="mi">3</code><code class="p">)</code><code class="o">+</code><code class="s2">","</code><code class="o">+</code><code class="nx">y</code><code class="p">(</code><code class="nx">data</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">open</code><code class="p">)</code><code class="o">+</code><code class="s2">")"</code><code class="p">)</code>
</pre></div>

</figure>

<p>To do this we use the <code>transform</code> and <code>translate</code> attribute and find the x position that equates to the end of the graph plus 3 pixels (<code>(width+3)</code>) (we add in the three pixels to create a small separation between the end of the line and the label). The <code>y</code> position is far more interesting. We need to find the position of the last point in our line for the <code>open</code> data. Because the data is in the form of an indexed array and because the data has the latest date at the start of the array, we only need to find the point at the <code>0</code> position of the array. This is <code>data[0].open</code>. But of course, we also need to adjust our data for our scale and range, so we transform it using the <code>y</code> function (in the same way that we do it for the <code>valueline</code> and <code>valueline2</code> points. So the script to find the point on the screen in the y direction is <code>y(data[0].open)</code>.</p>

<p>If our data was arranged with the last date at the end of our data we would have to find the final index point and we would use <code>y(data[data.length-1].open))</code>.</p>

<p>Then it’s just a matter of aligning and justifying our text correctly;</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">)</code>
</pre></div>

</figure>

<p>Then colouring it the correct colour;</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>
</pre></div>

</figure>

<p>And adding out text;</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Open"</code><code class="p">);</code>
</pre></div>

</figure>

<p>We put this block of code after the blocks that add in the axes so that they make sure they’re on top of anything else we draw. Of course we will want to add another (almost) duplicate of the block for the ‘close’ column.</p>

<p>The only other small change we want to make is to change the right margin for the graph that we set at the start of our script from 20 to 40 so that there is enough room to add our label without cutting it off.</p>

<p>After that you have a marvellously labelled multi-line graph!</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/multiplelabels.png" alt="Multi-line graph with labels">
  <figcaption>Multi-line graph with labels</figcaption>
</figure>


<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/9edcd7a67e9ec8c8d24d20f3a47e8879">github</a> or in the code samples bundled with this book (dual-labels.html and data2.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/9edcd7a67e9ec8c8d24d20f3a47e8879">bl.ocks.org</a>. </p>

<p>Now, I’d like to pretend that this is perfection, but it isn’t. If our lines end too close together, the labels will interfere with each other, so in the ideal world I would include a bit of fanciness to prevent that, but for the purposes of this exercise we can consider ourselves happy.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-multiple-axes-for-a-graph">Multiple axes for a graph</h3>

<p>Alrighty… Let’s imagine that we want to show our wonderful graph with two lines, much like we already have, but imagine that the data that the lines are made from is significantly different in magnitude from the original data (in the example below, the data for the second line has been reduced by approximately a factor of 10 from our original data).</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close,open
1-May-12,58.13,3.41
30-Apr-12,53.98,4.55
27-Apr-12,67.00,6.78
26-Apr-12,89.70,7.85
25-Apr-12,99.00,8.92
24-Apr-12,130.28,9.92
23-Apr-12,166.70,10.13
20-Apr-12,234.98,12.23
19-Apr-12,345.44,13.45
18-Apr-12,443.34,16.04
17-Apr-12,543.70,18.03
16-Apr-12,580.13,21.02
13-Apr-12,605.23,22.34
12-Apr-12,622.77,20.15
11-Apr-12,626.20,21.26
10-Apr-12,628.44,31.04
9-Apr-12,636.23,35.04
5-Apr-12,633.68,41.02
4-Apr-12,624.31,43.05
3-Apr-12,629.32,46.03
2-Apr-12,618.63,51.03
30-Mar-12,599.55,53.42
29-Mar-12,609.86,57.82
28-Mar-12,617.62,59.01
27-Mar-12,614.48,56.03
26-Mar-12,606.98,58.01
</pre></div>

</figure>

<p>Now this isn’t a problem in itself. D3 will still make a reasonable graph of the data, but because of the difference in range, the detail of the second line will be lost.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/multiaxes01.png" alt="One line is dominating the other">
  <figcaption>One line is dominating the other</figcaption>
</figure>


<p>What I’m proposing is that we have a second y axis on the right hand side of the graph that relates to the red line.</p>

<p>The mechanism used is based on the great examples put forward by Ben Christensen <a href="http://benjchristensen.com/2012/05/02/line-graphs-using-d3-js/">here</a>.</p>

<aside class="information blurb">
    <p>Now… You’ll need to concentrate a bit since there are quite a few different bits to change and adapt, but don’t despair, they’re all quite logical and make sense.</p>

</aside>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/814a2bcb3e7d8d8db74f36f77c8e6b7f">github</a> or in the code samples bundled with this book (dual-axes.html and data4.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/814a2bcb3e7d8d8db74f36f77c8e6b7f">bl.ocks.org</a>. </p>

<p>First things first, there won’t be space on the right hand side of our graph to show the extra axis, so we should make our right hand margin a little larger. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">40</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
</pre></div>

</figure>

<p>I went for 40 and it seems to fit pretty well.</p>

<p>Then (and here’s where the main point of difference for this graph comes in) you want to amend the code to separate out the two scales for the two lines in the graph. This is actually a lot easier than it sounds, since it consists mainly of finding anywhere that mentions <code>y</code> and replacing it with <code>y0</code> and then adding in a reciprocal piece of code for <code>y1</code>.</p>

<aside class="tip blurb">
    <p>The idea here is that we will be creating two references for the y axis. One for each column of data. Then when we draw the lines the scales will automatically scale the data correctly (and separately) to our svg element and we will draw two different y axes with the different scales. Believe it or not, it sounds a lot harder than it is.</p>

</aside>

<p>Let’s get started. </p>

<p>In order to colour the text on the two different y axes we will need to declare their styles in the <code>&lt;style&gt;</code> section at the start of the code. In the declaration shown below we are calling the two different classes ‘axisSteelBlue’ and ‘axisRed’. The style that we set for each is ‘fill’ since this is the style that will colour the text</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.axisSteelBlue</code> <code class="nt">text</code><code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.axisRed</code> <code class="nt">text</code><code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">red</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Then into the JavaScript and we want to change the variable declaration for <code>y</code> to <code>y0</code> and add in <code>y1</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleTime</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y0</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y1</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
</pre></div>

</figure>

<p>Now change our valueline declarations so that they refer to the <code>y0</code> and <code>y1</code> scales.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// define the 1st line</code>
<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y0</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>

<code class="c1">// define the 2nd line</code>
<code class="kd">var</code> <code class="nx">valueline2</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y1</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">open</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>There are a few different ways for the scaling to work, but we’ll stick with the fancy max method we used in the dual line example (although technically it’s not required).</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">y0</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);})]);</code>
  <code class="nx">y1</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">open</code><code class="p">);</code> <code class="p">})]);</code> 
</pre></div>

</figure>

<p>Again, here’s the <code>y0</code> and <code>y1</code> changed and added and the maximums for <code>d.close</code> and <code>d.open</code> are separated out).</p>

<p>The final piece of the puzzle is to draw the new axis, but we also want to colour code the text in the axes to match the lines. We do this using the styling that we declared earlier</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the Y0 Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axisSteelBlue"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y0</code><code class="p">));</code>

  <code class="c1">// Add the Y1 Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axisRed"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate( "</code> <code class="o">+</code> <code class="nx">width</code> <code class="o">+</code> <code class="s2">", 0 )"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisRight</code><code class="p">(</code><code class="nx">y1</code><code class="p">));</code>	
</pre></div>

</figure>

<p>In the above code you can see where we have added in a ‘style’ change for the axisLeft to make it ‘steelblue’ and a complementary change in the new section for axisRight to make that text red.</p>

<p>The yAxisRight section obviously needs to be added in, but the only significant difference is the transform / translate attribute that moves the axis to the right hand side of the graph.</p>

<p>And after all that, here’s the result…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/multiaxes02.png" alt="Two lines with full range of the domain and two axes">
  <figcaption>Two lines with full range of the domain and two axes</figcaption>
</figure>


<p>Now, let’s not kid ourselves that it’s a thing of beauty, but we should console our aesthetic concerns with the warm glow of understanding how the function works :-).</p>

<div class="page-break"></div>

<h2 id="leanpub-auto-elements-attributes-and-styles">Elements, Attributes and Styles</h2>

<p>This chapter is intended to provide an overview of some of the simpler things that d3.js can do, but in a way that may help some understand a little more about how images can be added to a web page and how they can be manipulated.</p>

<p>Loosely speaking we will look at how objects (elements (like circles, rectangles, lines and even text)) can be declared and added to a page, how their attributes in relation to the page (position, size, shape, actions) can be changed and how their style (colour, width, transparency) can be applied.</p>

<p>As we go through the explanation of different changes that can be applied to different elements there will be a small amount of repetition where there is cross-over with related drawing features. Please be patient :-). The aim is to have each section as complete in its own right as practical. </p>

<h3 id="EASframework">The Framework</h3>

<p>To be able to demonstrate how these three related aspects of drawing objects work we will have to use a small, simple script to draw them in your web browser.</p>

<p>We will just take a moment to explain the script that draws a circle.</p>

<p>Here’s the contents of the file in its entirety. I have imaginatively called it <code>circle.html</code> and you can find it in the code samples that can be downloaded with the book.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
 
<code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code> <code class="c1">// select the 'body' element</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>           <code class="c1">// append an SVG element to the body</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">449</code><code class="p">)</code>      <code class="c1">// make the SVG element 449 pixels wide</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">249</code><code class="p">);</code>    <code class="c1">// make the SVG element 249 pixels high</code>

<code class="c1">// draw a circle</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Please feel free to jump ahead slightly if you understand how a HTML file with JavaScript goes together :-).</p>

<p>The HTML part of the file can be thought of as a wrapper for the JavaScript that will draw our circle. These are the HTML parts here…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
 
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>This portion of the file is built using HTML ‘tags’. These will set up the environment for the JavaScript.</p>

<p>The tags tell the web browser what sort of language is being used and the type of characters used to write the code…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Areas of the code are labelled. </p>

<p>Like the body…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

In this area we can put the stuff that will be 
displayed on our web page.

<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>And the place where we put the JavaScript…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="nx">Our</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">js</code> <code class="nx">code</code> <code class="nx">will</code> <code class="nx">go</code> <code class="nx">here</code><code class="p">.</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>We even load an external file that contains JavaScript that will help run our code.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c">&lt;!-- load the d3.js library --&gt;</code>	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>Yes, that’s the line that loads d3.js. Once it’s loaded we can use the instructions that it makes available to make other JavaScript code (in this case ours) work.</p>

<p>Then we have the JavaScript code that allows us to <em>use</em> the functions made possible by d3.js.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code> <code class="c1">// select the 'body' element</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>           <code class="c1">// append an SVG element to the body</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">449</code><code class="p">)</code>      <code class="c1">// make the SVG element 449 pixels wide</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">249</code><code class="p">);</code>    <code class="c1">// make the SVG element 249 pixels high</code>

<code class="c1">// draw a circle</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>I’ve broken the code into two separate blocks to provide some clarity to their function. We could make it one block, but that wouldn’t necessarily make it easier to understand.</p>

<p>Firstly we add a ‘holder’ for our graphics on the web page. I’ve named it <code>holder</code> but we could just as easily named it anything we wanted.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code> <code class="c1">// select the 'body' element</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>           <code class="c1">// append an SVG element to the body</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">449</code><code class="p">)</code>      <code class="c1">// make the SVG element 449 pixels wide</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">249</code><code class="p">);</code>    <code class="c1">// make the SVG element 249 pixels high</code>
</pre></div>

</figure>

<p>The first thing we do when declaring our holder is to select the <code>body</code> element of our web page (Remember those <code>&lt;body&gt;</code> tags in the HTML part earlier?).</p>

<p>Then we append a Scalable Vector Graphic (SVG) object to the body and we make it 449 pixels wide and 249 pixels high. </p>

<p>The <code>width</code> and <code>height</code> are ‘attributes’ of the SVG object. That is to say they describe a property of the object.</p>

<aside class="information blurb">
    <p>Believe it or not, I have made the container size unusual (not nice round numbers like 450 x 250) for a good reason. Later I will introduce a grid to our diagram so we can see where everything is laid out and this size makes the grid look better.</p>

</aside>

<p>The second block of our JavaScript finally draws our circle.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>The first line appends a new element (a circle) to our SVG ‘holder’.</p>

<aside class="information blurb">
    <p>If you like, you can think of having the <code>holder</code> declaration in front of the <code>.append("circle")</code> as being a nice short-hand way of writing the code. We could have had a much longer line that selected the <code>body</code>, appended the svg element and then appended our circle in one line, but it’s actually a far better scheme for building multiple objects to break the sequences up which will allow us to manipulate groupings of objects in future code.</p>

</aside>

<p>The second and third lines declare the attribute of our circle that specify where the centre of the circle is. In this case it’s at the x/y position 200/100 (<code>cx</code>/<code>cy</code>).</p>

<p>The last line adds the radius attribute <code>r</code>. Here it is set to 50 pixels.</p>

<p>The three attributes <code>cx</code>, <code>cy</code> and <code>r</code> are all required when drawing a circle. There are other attributes we can put in there (and when we look at some of the upcoming elements, you should get a feel for them), but these are the minimum.</p>

<p>The purpose of describing this block of code that draws a circle isn’t to show you how to draw a circle. This has only been a way of showing you how the code in the following sections is laid out and how it works. The elements we are going to generate can be drawn with exactly the same file but with just the section that adds the circle altered.  </p>

<p>For example if you were to change this block of code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>For this block of code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>          <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>            <code class="c1">// x position of the top-left corner</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>             <code class="c1">// y position of the top-left corner</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>        <code class="c1">// set the rectangle width</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">);</code>      <code class="c1">// set the rectangle height</code>
</pre></div>

</figure>

<p>Instead of drawing a circle we would be drawing a rectangle.</p>

<p>So this is what our circle will look like;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-01.png" alt="Circle">
  <figcaption>Circle</figcaption>
</figure>


<p>Because it will help a great deal to have a common frame of reference, I’m going to display the elements on a grid that looks a little like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-02.png" alt="Circle with Grid">
  <figcaption>Circle with Grid</figcaption>
</figure>


<aside class="information blurb">
    <p>The grid won’t form part of the code that gets explained, but I will take the time out to describe how it’s generated in another section, because it’s quite cool in its own way :-).</p>

</aside>

<p>With the grid in place it’s far easier to see that the centre of our circle is indeed at the coordinates x = 200, y = 100 and that the radius is 50.</p>

<p>The circle is still somewhat plain, but bear with me because as we start to explore what we can do with styles and attributes we can add some variation to our elements.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-03.png" alt="Fancier Circle">
  <figcaption>Fancier Circle</figcaption>
</figure>


<p>With that explanation behind us we should begin our odyssey into the world of d3 elements.</p>

<h3 id="elements">Elements</h3>

<p>We will begin by describing what we mean when we talk about an ‘element’.</p>

<p>There is considerable scope for confusion when talking about elements on a web page. Are we talking about <a href="http://reference.sitepoint.com/html/page-structure">HTML elements</a>, <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element">SVG elements</a> or something different?</p>

<p>In fact we are going to be describing a subset of SVG elements. Specifically a collection of common shapes and objects which include circles, ellipses, rectangles, lines, polylines, polygons, text and paths.</p>

<p>“Text?” I hear you say. “Doesn’t sound like a shape.” I suppose it depends on how you think of it. We can use text in different ways in d3, but for this particular exercise we <em>can</em> regard text as an SVG element.</p>

<div class="page-break"></div>
<h4 id="circle">Circle</h4>

<p>A <a href="http://www.w3schools.com/svg/svg_circle.asp">circle is a simple SVG shape</a> that is described by three required attributes. </p>

<ul>
  <li>
<code>cx</code>: The position of the centre of the circle in the x direction (left / right) measured from the left side of the screen.</li>
  <li>
<code>cy</code>: The position of the centre of the circle in the y direction (up / down) measured from the top of the screen.</li>
  <li>
<code>r</code>: The radius of the circle from the <code>cx</code>, <code>cy</code> position to the perimeter of the circle.</li>
</ul>

<p>The following is an example of the code section required to draw a circle in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>This will produce a circle as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-02.png" alt="Circle">
  <figcaption>Circle</figcaption>
</figure>


<p>The centre of the circle is at x = 200 and y = 100 and the radius is 50 pixels. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-ellipse">Ellipse</h4>

<p>An <a href="http://www.w3schools.com/svg/svg_ellipse.asp">ellipse</a> is described by four required attributes;</p>

<ul>
  <li>
<code>cx</code>: The position of the centre of the ellipse in the x direction (left / right) measured from the left side of the screen.</li>
  <li>
<code>cy</code>: The position of the centre of the ellipse in the y direction (up / down) measured from the top of the screen.</li>
  <li>
<code>rx</code>: The radius of the ellipse in the x dimension from the <code>cx</code>, <code>cy</code> position to the perimeter of the ellipse.</li>
  <li>
<code>ry</code>: The radius of the ellipse in the y dimension from the <code>cx</code>, <code>cy</code> position to the perimeter of the ellipse.</li>
</ul>

<p>The following is an example of the code section required to draw an ellipse in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"ellipse"</code><code class="p">)</code>       <code class="c1">// attach an ellipse</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set the x radius</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>           <code class="c1">// set the y radius</code>
</pre></div>

</figure>

<p>This will produce an ellipse as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-04.png" alt="Ellipse">
  <figcaption>Ellipse</figcaption>
</figure>


<p>The centre of the ellipse is at x = 200 and y = 100 and the radius is 50 pixels vertically and 100 pixels horizontally. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-rectangle">Rectangle</h4>

<p>A <a href="http://www.w3schools.com/svg/svg_rect.asp">rectangle</a> is described by four required attributes and two optional ones;</p>

<ul>
  <li>
<code>x</code>: The position on the x axis of the left hand side of the rectangle (required).</li>
  <li>
<code>y</code>: The position on the y axis of the top of the rectangle (required).</li>
  <li>
<code>width</code>: the width (in pixels) of the rectangle (required).</li>
  <li>
<code>height</code>: the height (in pixels) of the rectangle (required).</li>
  <li>
<code>rx</code>: The radius curve of the corner of the rectangle in the x dimension (optional).</li>
  <li>
<code>ry</code>: The radius curve of the corner of the rectangle in the y dimension (optional).</li>
</ul>

<p>The following is an example of the code section required to draw a rectangle (using only the required attributes) in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>       <code class="c1">// attach a rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>         <code class="c1">// position the left of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>          <code class="c1">// position the top of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>    <code class="c1">// set the height</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>    <code class="c1">// set the width</code>
</pre></div>

</figure>

<p>This will produce a rectangle as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-05.png" alt="Rectangle">
  <figcaption>Rectangle</figcaption>
</figure>


<p>The top left corner of the rectangle is at 100, 50 and the rectangle is 200 pixels wide and 100 pixels high.</p>

<p>The following code section includes the optional attributes for the curved corners;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>       <code class="c1">// attach a rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>         <code class="c1">// position the left of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>          <code class="c1">// position the top of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>    <code class="c1">// set the height</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>     <code class="c1">// set the width</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>         <code class="c1">// set the x corner curve radius</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>        <code class="c1">// set the y corner curve radius</code>
</pre></div>

</figure>

<p>This will produce a rectangle (with curved corners) as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-06.png" alt="Rectangle with curved corners">
  <figcaption>Rectangle with curved corners</figcaption>
</figure>


<p>The corners are curved with radii in the x and y direction of 10 pixels.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-line">Line</h4>

<p>A <a href="http://www.w3schools.com/svg/svg_line.asp">line</a> is a simple line between two points and is described by four required attributes. </p>

<ul>
  <li>
<code>x1</code>: The x position of the first end of the line as measured from the left of the screen.</li>
  <li>
<code>y1</code>: The y position of the first end of the line as measured from the top of the screen.</li>
  <li>
<code>x2</code>: The x position of the second end of the line as measured from the left of the screen.</li>
  <li>
<code>y2</code>: The y position of the second end of the line as measured from the top of the screen.</li>
</ul>

<p>The following is an example of the code section required to draw a line in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. A notable addition to this code is the <code>style</code> declaration. In this case the line has no colour and this can be added with the <code>stroke</code> style which applies a colour to a line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>          <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>      <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">150</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>
</pre></div>

</figure>

<p>This will produce a line as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-07.png" alt="Line">
  <figcaption>Line</figcaption>
</figure>


<p>The line extends from the point 100,50 to 300,150. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-polyline">Polyline</h4>

<p>A <a href="http://www.w3schools.com/svg/svg_polyline.asp">polyline</a> is a sequence of connected lines described with a single attribute, <code>points</code>.</p>

<ul>
  <li>
<code>points</code>: The <code>points</code> attribute is a list of x,y coordinates that are the locations of the connecting points of the polyline.</li>
</ul>

<p>The following is an example of the code section required to draw a polyline in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. A notable addition to this code are the <code>style</code> declarations. In this case the line of the polyline has no colour and this can be added with the <code>stroke</code> style which applies the colour black to a line. Likewise the area that is bounded by the polyline will be automatically filled with black unless we explicitly tell the object not to. This is achieved in this example by addition of the <code>fill</code> style to <code>none</code>. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"polyline"</code><code class="p">)</code>      <code class="c1">// attach a polyline</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>     <code class="c1">// remove any fill colour</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"points"</code><code class="p">,</code> <code class="s2">"100,50, 200,150, 300,50"</code><code class="p">);</code>  <code class="c1">// x,y points</code>
</pre></div>

</figure>

<p>This will produce a polyline as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-08.png" alt="Polyline">
  <figcaption>Polyline</figcaption>
</figure>


<p>The polyline extends from the point 100,50 to 200,150 to 300,50. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-polygon">Polygon</h4>

<p>A <a href="http://www.w3schools.com/svg/svg_polygon.asp">polygon</a> is a sequence of connected lines which form a closed shape described with a single attribute, <code>points</code>.</p>

<ul>
  <li>
<code>points</code>: The <code>points</code> attribute is a list of x,y coordinates that are the locations of the connecting points of the polygon. The last point is in turn connected to the first point.</li>
</ul>

<p>The following is an example of the code section required to draw a polygon in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. A notable addition to this code are the <code>style</code> declarations. In this case the line of the polygon has no colour and this can be added with the <code>stroke</code> style which applies the colour black to a line. Likewise the area that is bounded by the polygon will be automatically filled with black unless we explicitly tell the object not to. This is achieved in this example by addition of the <code>fill</code> style to <code>none</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"polygon"</code><code class="p">)</code>       <code class="c1">// attach a polygon</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>     <code class="c1">// remove any fill colour</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"points"</code><code class="p">,</code> <code class="s2">"100,50, 200,150, 300,50"</code><code class="p">);</code>  <code class="c1">// x,y points </code>
</pre></div>

</figure>

<p>This will produce a polygon as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-09.png" alt="Polyline">
  <figcaption>Polyline</figcaption>
</figure>


<p>The polygon extends from the point 100,50 to 200,150 to 300,50 and then back to 100,50. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-path">Path</h4>

<p>A <a href="http://www.w3schools.com/svg/svg_path.asp">path</a> is an outline of an SVG shape which is described with a ‘mini-language’ inside a single attribute.</p>

<ul>
  <li>
<code>d</code>: This attribute is a list of instructions that allow a shape to be drawn in a complex way using a <a href="http://www.w3.org/TR/SVG/paths.html#PathData">‘mini-language’ of commands</a>. These commands are written in a shorthand of single letters such as <code>M</code>-moveto, <code>Z</code>-closepath, <code>L</code>-lineto, <code>C</code>-curveto. These commands can be absolute (normally designated by capital letters) or relative (lower case).</li>
</ul>

<p>The following is an example of the code section required to draw a triangle in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. A notable addition to this code are the <code>style</code> declarations. In this case the line of the path has no colour and this can be added with the <code>stroke</code> style which applies the colour black to a line. Likewise the area that is bounded by the path will be automatically filled with black unless we explicitly tell the object not to. This is achieved in this example by addition of the <code>fill</code> style to <code>none</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>          <code class="c1">// attach a path</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>     <code class="c1">// remove any fill colour</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="s2">"M 100,50, L 200,150, L 300,50 Z"</code><code class="p">);</code>  <code class="c1">// path commands </code>
</pre></div>

</figure>

<p>This will produce a path as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-10.png" alt="Path">
  <figcaption>Path</figcaption>
</figure>


<p>The path mini-language first moves (<code>M</code>) to 100,50 then draws a line (<code>L</code>) to 200,150 then draws another line (<code>L</code>) to 300,50 then closes the path (<code>Z</code>). </p>

<div class="page-break"></div>
<h4 id="clipPath">Clipped Path (AKA clipPath)</h4>

<p>A <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/clipPath">clipPath</a> is the path of a SVG shape that can be used in combination with another shape to remove any parts of the combined shape that doesn’t fall within the clipPath. That sounds slightly confusing, so we will break it down a bit to hopefully clarify the explanation. </p>

<p>Let’s imagine that we want to display the intersection of two shapes. What we will do is define our <code>clipPath</code> which will act as a ‘cookie cutter’ which can cut out the shape we want (we will choose an ellipse). Then we will draw our base shape (which is analogous to the dough) that we will use our cookie cutter on (our dough will be shaped as a rectangle). The intersection of the cookie cutter and the dough is our clipped path.</p>

<p>Our clipPath (cookie cutter) element is an ellipse;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-44.png" alt="clipPath (cookie cutter)">
  <figcaption>clipPath (cookie cutter)</figcaption>
</figure>


<p>Our shape that we will be clipping (the dough) is a rectangle;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-45.png" alt="Rectangle element (dough)">
  <figcaption>Rectangle element (dough)</figcaption>
</figure>


<p>The intersection of the two is the clipped path (shaded grey);</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-46.png" alt="Combination of the ellipse and the rectangle">
  <figcaption>Combination of the ellipse and the rectangle</figcaption>
</figure>


<p>The graphic examples above are misleading in the sense that the two basic shapes are not actually displayed. All that results from the use of the <code>clipPath</code> is the region that is the intersection of the two.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-47.png" alt="The clipped path">
  <figcaption>The clipped path</figcaption>
</figure>


<p>The following is an example of the code section required to draw the clipped path in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. The <code>clipPath</code> element is given the <code>ID</code> ‘ellipse-clip’ and a specified size and location. Then when the rectangle is appended. the <code>clipPath</code> is specified as an attribute (via a URL) using <code>clip-path</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// define the clipPath</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"clipPath"</code><code class="p">)</code>       <code class="c1">// define a clip path</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"ellipse-clip"</code><code class="p">)</code> <code class="c1">// give the clipPath an ID</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"ellipse"</code><code class="p">)</code>            <code class="c1">// shape it as an ellipse</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">175</code><code class="p">)</code>            <code class="c1">// position the x-centre</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>            <code class="c1">// position the y-centre</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>            <code class="c1">// set the x radius</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the y radius</code>

<code class="c1">// draw clipped path on the screen</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>       <code class="c1">// attach a rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">125</code><code class="p">)</code>         <code class="c1">// position the left of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">75</code><code class="p">)</code>          <code class="c1">// position the top of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"clip-path"</code><code class="p">,</code> <code class="s2">"url(#ellipse-clip)"</code><code class="p">)</code> <code class="c1">// clip the rectangle</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"lightgrey"</code><code class="p">)</code>   <code class="c1">// fill the clipped path with grey</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>    <code class="c1">// set the height</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>    <code class="c1">// set the width</code>
</pre></div>

</figure>

<p>This will produce a path as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-47.png" alt="The clipped path">
  <figcaption>The clipped path</figcaption>
</figure>


<p>An example of this in use can bee seen in the <a href="#difference">difference chart</a> explanation later in the book. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-text">Text</h4>

<p>A <a href="http://www.w3schools.com/svg/svg_text.asp">text</a> element is an SVG object which is shaped as text. It is described by two required attributes and three optional ones.</p>

<ul>
  <li>
<code>x</code>: This attribute designates the anchor point location for the text in the x dimension (required).</li>
  <li>
<code>y</code>: This attribute designates the anchor point location for the text in the y dimension (required).</li>
  <li>
<code>dx</code>: This attribute designates the offset of the text from the anchor point in the x dimension (optional). There are several different sets of units that can be used to designated the offset of the text from an anchor point. These include <code>em</code> which is a scalable unit (used in these examples), <code>px</code> (pixels), <code>pt</code> (points (kind of like pixels)) and <code>5</code> (percent (scalable and kind of like <code>em</code>))  </li>
  <li>
<code>dy</code>: This attribute designates the offset of the text from the anchor point in the y dimension (optional).</li>
  <li>
<code>text-anchor</code>: This attribute controls the horizontal text alignment (optional). It has three values; <code>start</code> (left aligned), <code>middle</code> (centre aligned) and <code>end</code> (right aligned).</li>
</ul>

<p>The following is an example of the code section required to draw the text “Hello World” in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. A notable addition to this code is the <code>style</code> declaration which applies a <code>black</code> <code>fill</code> to the text. Additionally there is the declaration <code>.text</code> which defines the text that will be displayed.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>     <code class="c1">// define the text to display </code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-11.png" alt="Text">
  <figcaption>Text</figcaption>
</figure>


<p>It can be seen from the image that the anchor point for the text is at 200,100 and that the text is positioned with this anchor point at the bottom, left of the text.</p>

<p>The following examples will demonstrate the various options for positioning and aligning text so that you can arrange it correctly.</p>

<h5 id="leanpub-auto-anchor-at-the-bottom-middle-of-the-text">Anchor at the bottom, middle of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-12.png" alt="Text: Anchored Bottom-middle">
  <figcaption>Text: Anchored Bottom-middle</figcaption>
</figure>


<div class="page-break"></div>
<h5 id="leanpub-auto-anchor-at-the-bottom-right-of-the-text">Anchor at the bottom, right of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>  <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>        <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-13.png" alt="Text: Anchored Bottom-Right">
  <figcaption>Text: Anchored Bottom-Right</figcaption>
</figure>


<h5 id="leanpub-auto-anchor-at-the-middle-left-of-the-text">Anchor at the middle, left of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">)</code>  <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-15.png" alt="Text: Anchored Middle-Left">
  <figcaption>Text: Anchored Middle-Left</figcaption>
</figure>


<div class="page-break"></div>
<h5 id="leanpub-auto-anchor-in-the-middle-centre-of-the-text">Anchor in the middle, centre of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-14.png" alt="Text: Anchored Middle-Centre">
  <figcaption>Text: Anchored Middle-Centre</figcaption>
</figure>


<h5 id="leanpub-auto-anchor-in-the-middle-right-of-the-text">Anchor in the middle, right of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>         <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>  <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>        <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-16.png" alt="Text: Anchored Middle-Right">
  <figcaption>Text: Anchored Middle-Right</figcaption>
</figure>


<div class="page-break"></div>
<h5 id="leanpub-auto-anchor-at-the-top-left-of-the-text">Anchor at the top, left of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">)</code>  <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-17.png" alt="Text: Anchored Top-Left">
  <figcaption>Text: Anchored Top-Left</figcaption>
</figure>


<h5 id="leanpub-auto-anchor-at-the-top-middle-of-the-text">Anchor at the top, middle of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>            <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>  <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>           <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-18.png" alt="Text: Anchored Top-Middle">
  <figcaption>Text: Anchored Top-Middle</figcaption>
</figure>


<div class="page-break"></div>
<h5 id="leanpub-auto-anchor-at-the-top-right-of-the-text">Anchor at the top, right of the text:</h5>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".71em"</code><code class="p">)</code>          <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>   <code class="c1">// set anchor y justification </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>         <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-19.png" alt="Text: Anchored Top-Right">
  <figcaption>Text: Anchored Top-Right</figcaption>
</figure>


<div class="page-break"></div>
<h3 id="leanpub-auto-attributes">Attributes</h3>

<p>At the start of writing this section I was faced with the question “What’s an attribute?”. But a reasonable answer has eluded me, so I will make the assumption that the answer will be something of a compromise :-). I like to think that an attribute of an element is something that is a characteristic of the object without defining it, and/or it may affect the object’s position or orientation on the page. There could be a strong argument to say that the following section on styles could be seen to cross-over into attributes and I agree. However, for the purposes of providing a description of the syntax and effects, I’m happy with the following list :-).  </p>

<p>Because not all attributes are applicable to all elements, there will be a bit of variation in the type of shapes we deal with in the description below, but there won’t be any that are different to those that we’ve already looked at. There will be some repetition with recurring information from the elements section. This is intentional to hopefully allow each section to exist in its own right.</p>

<h4 id="leanpub-auto-x-y">
<code>x</code>, <code>y</code>
</h4>

<p>The <code>x</code> and <code>y</code> attributes are used to designate a position on the web page that is set from the top, left hand corner of the web page.
Using the <code>x</code> and <code>y</code> attributes places the anchor points for these elements at a specified location. Of the elements that we have examined thus far, the rectangle element and the text element have anchor points to allow them to be positioned.</p>

<p>For example the following is a code section required to draw a rectangle (using only the required attributes) in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>       <code class="c1">// attach a rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>         <code class="c1">// position the left of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>          <code class="c1">// position the top of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>    <code class="c1">// set the height</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>    <code class="c1">// set the width</code>
</pre></div>

</figure>

<p>This will produce a rectangle as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-05.png" alt="Rectangle with `x`,`y` at 100,50">
  <figcaption>Rectangle with <code>x</code>,<code>y</code> at 100,50</figcaption>
</figure>


<p>The top left corner of the rectangle is specified using <code>x</code> and <code>y</code> at 100 and 50 respectively.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-x1-x2-y1-y2">
<code>x1</code>, <code>x2</code>, <code>y1</code>, <code>y2</code>
</h4>

<p>The <code>x1</code>, <code>x2</code>, <code>y1</code> and <code>y2</code> attributes are used to designate the position of two points on a web page that are set from the top, left hand corner of the web page. These two points are connected with a line as part of the <code>line</code> element.</p>

<p>The attributes are described as follows;</p>

<ul>
  <li>
<code>x1</code>: The x position of the first end of the line as measured from the left of the screen.</li>
  <li>
<code>y1</code>: The y position of the first end of the line as measured from the top of the screen.</li>
  <li>
<code>x2</code>: The x position of the second end of the line as measured from the left of the screen.</li>
  <li>
<code>y2</code>: The y position of the second end of the line as measured from the top of the screen.</li>
</ul>

<p>The following is an example of the code section required to draw a line in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. The attributes connect the point 100,50 (<code>x1</code>, <code>y1</code>) with 300,150 (<code>x2</code>, <code>y2</code>);</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>          <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x1 position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>      <code class="c1">// y1 position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x2 position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">150</code><code class="p">);</code>    <code class="c1">// y2 position of the second end of the line</code>
</pre></div>

</figure>

<p>This will produce a line as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-07.png" alt="Line">
  <figcaption>Line</figcaption>
</figure>


<p>The line extends from the point 100,50 to 300,150. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-points">points</h4>

<p>The <code>points</code> attribute is used to set a series of points which are subsequently connected with a line and / or which may form the bounds of a shape. These are specifically associated with the <code>polyline</code> and <code>polygon</code> elements. Like the <code>x</code>, <code>y</code> and <code>x1</code>, <code>x2</code>, <code>y1</code>, <code>y2</code> attributes, the coordinates are set from the top, left hand corner of the web page.</p>

<p>The data for the points is entered as a sequence of x,y points in the following format;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"points"</code><code class="p">,</code> <code class="s2">"100,50, 200,150, 300,50"</code><code class="p">);</code> 
</pre></div>

</figure>

<p>Where 100,50 is the first x,y point then 200,150 is the second.</p>

<p>The following is an example of the code section required to draw a polyline in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. The additional <code>style</code> declarations are included to illustrate the shape better. The <code>points</code> values can be compared with the subsequent image.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"polyline"</code><code class="p">)</code>      <code class="c1">// attach a polyline</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>  <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>     <code class="c1">// remove any fill colour</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"points"</code><code class="p">,</code> <code class="s2">"100,50, 200,150, 300,50"</code><code class="p">);</code>  <code class="c1">// x,y points</code>
</pre></div>

</figure>

<p>This will produce a polyline as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-08.png" alt="Polyline using `points` attribute">
  <figcaption>Polyline using <code>points</code> attribute</figcaption>
</figure>


<p>The polyline extends from the point 100,50 to 200,150 to 300,50. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-cx-cy">
<code>cx</code>, <code>cy</code>
</h4>

<p>The <code>cx</code>, <code>cy</code> attributes are associated with the circle and ellipse elements and designate the centre of each shape. The coordinates are set from the top, left hand corner of the web page.</p>

<ul>
  <li>
<code>cx</code>: The position of the centre of the element in the x axis measured from the left side of the screen.</li>
  <li>
<code>cy</code>: The position of the centre of the element in the y axis measured from the top of the screen.</li>
</ul>

<p>The following is an example of the code section required to draw an ellipse in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. In it the centre of the ellipse is set by <code>cx</code>, <code>cy</code> as 200, 100. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"ellipse"</code><code class="p">)</code>       <code class="c1">// attach an ellipse</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set the x radius</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>           <code class="c1">// set the y radius</code>
</pre></div>

</figure>

<p>This will produce an ellipse as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-04.png" alt="Ellipse with Centre at 200, 100">
  <figcaption>Ellipse with Centre at 200, 100</figcaption>
</figure>


<p>The centre of the ellipse is at x = 200 and y = 100 and the radius is 50 pixels vertically and 100 pixels horizontally. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-r"><code>r</code></h4>

<p>The <code>r</code> attribute determines the radius of a circle element from the <code>cx</code>, <code>cy</code> position (the centre of the circle) to the perimeter of the circle.</p>

<p>The following is an example of the code section required to draw a circle in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>This will produce a circle with a radius of 50 pixels as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-02.png" alt="Circle with Radius of 50 Pixels">
  <figcaption>Circle with Radius of 50 Pixels</figcaption>
</figure>


<p>The centre of the circle is at x = 200 and y = 100 and the radius is 50 pixels. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-rx-ry">
<code>rx</code>, <code>ry</code>
</h4>

<p>The <code>rx</code>, <code>ry</code> attributes are associated with the ellipse element and designate the radius in the x direction (<code>rx</code>) and the radius in the y direction (<code>ry</code>). </p>

<ul>
  <li>
<code>rx</code>: The radius of the ellipse in the x direction from the <code>cx</code>, <code>cy</code> position to the perimeter of the ellipse.</li>
  <li>
<code>ry</code>: The radius of the ellipse in the y direction from the <code>cx</code>, <code>cy</code> position to the perimeter of the ellipse.</li>
</ul>

<p>The following is an example of the code section required to draw an ellipse in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter. In it, the centre of the ellipse is set by <code>cx</code>, <code>cy</code> as 200, 100 and the radius in the x direction (<code>rx</code>) is 100 pixels and the radius in the y direction (<code>ry</code>) is 50 pixels.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"ellipse"</code><code class="p">)</code>       <code class="c1">// attach an ellipse</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set the x radius</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>           <code class="c1">// set the y radius</code>
</pre></div>

</figure>

<p>This will produce an ellipse as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-04.png" alt="Ellipse with x Radius of 100 and y Radius of 50">
  <figcaption>Ellipse with x Radius of 100 and y Radius of 50</figcaption>
</figure>


<p>The centre of the ellipse is at x = 200 and y = 100 and the radius is 50 pixels vertically and 100 pixels horizontally. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-transform-translatexy-scalek-rotatea"><code>transform (translate(x,y), scale(k), rotate(a))</code></h4>

<p>The transform attribute is a powerful one which allows us to change the properties of an element in several different ways.</p>

<ul>
  <li>
<code>translate</code>: Where the element is moved by a relative value in the x,y direction. </li>
  <li>
<code>scale</code>: Where the element’s attributes are increased or reduced by a specified factor.</li>
  <li>
<code>rotate</code>: Where the element is rotated about its reference point by an angular value.</li>
</ul>

<p>Without a degree of prior understanding, these transforms can appear to behave in unusual ways, but hopefully we’ll explain it sufficiently here so that you can appreciate the logic in the way they work.  </p>

<h5 id="leanpub-auto-transform-translatexy"><code>transform (translate(x,y))</code></h5>

<p>The transform-translate attribute will take an element’s position and adjust it based on a specified value(s) in the x,y directions.</p>

<p>The best way to illustrate this is with an example;</p>

<p>This is the code snippet from <a href="#EASframework">the HTML file</a> outlined at the start of this chapter which draws a circle at the position 200,100 (<code>cx</code>,<code>cy</code>);</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>This will produce a circle as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-02.png" alt="Circle">
  <figcaption>Circle</figcaption>
</figure>


<p>If we add in a <code>transform (translate(*x*,*y*))</code> attribute for values of x,y of 50,50 this will shift our circle by an additional 50 pixels in the x direction and 50 pixels in the y direction. </p>

<p>Here’s the code snippet that will draw our new circle;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-center</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(50,50)"</code><code class="p">)</code> <code class="c1">// translate the circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>And here’s the resulting change;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-20.png" alt="Circle">
  <figcaption>Circle</figcaption>
</figure>


<p>The circle was positioned at the point 200,100 and then translated by 50 pixels in both axes to 250,150.</p>

<p>The original code snippet could in fact be written as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(200,100)"</code><code class="p">)</code> <code class="c1">// translate the circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>            <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>Since by default our starting position is 0,0 if we apply a translation of 200,100 we will end up at 200,100.</p>

<h5 id="leanpub-auto-transform-scalek"><code>transform (scale(k))</code></h5>

<p>The translate-scale attribute will take an element’s attributes and scale them by a factor <em>k</em>.</p>

<p>Originally I thought that this attribute would affect the size of the element, but it affects more than that! As with the transform-translate attribute, the best way to illustrate this is with an example;</p>

<p>The following code snippet (in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) which draws a circle at the position 150,50 with a radius of 25 pixels;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>     <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>        <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>         <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">25</code><code class="p">);</code>         <code class="c1">// set the radius</code>
</pre></div>

</figure>

<p>This will produce a circle as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-21.png" alt="Circle">
  <figcaption>Circle</figcaption>
</figure>


<p>If we now introduce a transform-scale attribute with a scale of 2 we will see all three of the other attributes (<code>cx</code>, <code>cy</code> and <code>r</code>) scaled by a factor of two to 300, 100 and 50 respectively.</p>

<p>Here is the code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>             <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>                <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>                 <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">25</code><code class="p">)</code>                  <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"scale(2)"</code><code class="p">);</code> <code class="c1">// scale the circle attributes</code>
</pre></div>

</figure>

<p>Which will produce a circle as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-22.png" alt="Circle">
  <figcaption>Circle</figcaption>
</figure>


<p>In this example we can see that the position (<code>cx</code>, <code>cy</code>) and the radius (<code>r</code>) have been scaled up by a factor of 2.</p>

<h5 id="leanpub-auto-transform-rotatea"><code>transform (rotate(a))</code></h5>

<p>The translate-rotate attribute will rotate an element and its attributes by a declared angle in degrees.</p>

<p>The ability to rotate elements is obviously a valuable tool. The transform-rotate attribute does a great job of it, but the key to making sure that you know exactly what will happen to an object is to remember where the anchor point is for the object and to ensure that the associated attributes are set appropriately.  As with the transform translate &amp; scale attributes, the best way to illustrate this is with an example;</p>

<p>The following is the code snippet (in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) which draws the text “Hello World” at the position 200,100 with the anchor point being the the middle of the text;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce text as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-14.png" alt="Text: Anchored Middle-Centre">
  <figcaption>Text: Anchored Middle-Centre</figcaption>
</figure>


<p>If we then apply a transform-rotate of 10 degrees as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"rotate(10)"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>We will see the following on the screen;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-23.png" alt="Text: Anchored Middle-Centre">
  <figcaption>Text: Anchored Middle-Centre</figcaption>
</figure>


<p>Obviously the text has been rotated, but hopefully you’ll have noticed that it’s also been displaced. This is because the transform-rotate attribute has been applied to both the text element (which <em>has</em> been rotated by 10 degrees) <em>and</em> the <code>x</code>,<code>y</code> attributes. If you imagine the origin point for the element being at 0,0, the centre, middle of the text element has been rotated about the point 0,0 by 10 degrees (hopefully slightly better explained in the following picture).</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-24.png" alt="Text: All positioning Attributes Rotated">
  <figcaption>Text: All positioning Attributes Rotated</figcaption>
</figure>


<p>This could be seen as an impediment to getting things to move / change as you want to, but instead it’s an indication of a different way of doing things. The solution to this particular feature is to combine the transform-rotate with the transform-translate that we used earlier so that the code looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(200,100) rotate(10)"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>And the image on the page looks like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-25.png" alt="Text: Rotated by 10 Degrees Anchored Middle-Centre">
  <figcaption>Text: Rotated by 10 Degrees Anchored Middle-Centre</figcaption>
</figure>


<p>Which leads us to the final example which is a combination of all three aspects of the transform attribute.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>           <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(200,100) scale(2) rotate(10)"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>          <code class="c1">// define the text to display</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-26.png" alt="Text: Translated, Scaled and Rotated">
  <figcaption>Text: Translated, Scaled and Rotated</figcaption>
</figure>


<p>Here we have a text element translated to its position on the page, rotated by 10 degrees about the centre of the text and scaled by a factor of two.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-width-height">
<code>width</code>, <code>height</code>
</h4>

<p><code>width</code> and <code>height</code> are required attributes of the rectangle element. <code>width</code> designates the width of the rectangle and <code>height</code> designates the height (If you’re wondering, I often struggle defining the obvious). </p>

<p>The following is an example of the code section required to draw a rectangle (using only the required attributes) in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>       <code class="c1">// attach a rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>         <code class="c1">// position the left of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>          <code class="c1">// position the top of the rectangle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>    <code class="c1">// set the height</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>    <code class="c1">// set the width</code>
</pre></div>

</figure>

<p>This will produce a rectangle as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-05.png" alt="Rectangle">
  <figcaption>Rectangle</figcaption>
</figure>


<p>The width of the triangle is 200 pixels and the height is 100 pixels. </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-text-anchor"><code>text-anchor</code></h4>

<p>The <code>text-anchor</code> attribute determines the justification of a text element</p>

<p>Text can have one of three <code>text-anchor</code> types;</p>

<ul>
  <li>
<code>start</code> where the text is left justified.</li>
  <li>
<code>middle</code> where the text is centre justified.</li>
  <li>
<code>end</code> where the text is right justified.</li>
</ul>

<p>The following is an example of code that will draw three separate lines of text with the three different <code>text-anchor</code> types in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>            <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World - start"</code><code class="p">);</code> <code class="c1">// define the text to display</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World - middle"</code><code class="p">);</code> <code class="c1">// define the text to display</code>
    
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code> <code class="c1">// set anchor y justification</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World - end"</code><code class="p">);</code> <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>This will produce an output as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-27.png" alt="Text with Different `text-anchor` Attributes">
  <figcaption>Text with Different <code>text-anchor</code> Attributes</figcaption>
</figure>


<div class="page-break"></div>
<h4 id="leanpub-auto-dx-dy">
<code>dx</code>, <code>dy</code>
</h4>

<p><code>dx</code> and <code>dy</code> are optional attributes that designate an offset of text elements from the anchor point in the x and y dimension . There are several different sets of units that can be used to designate the offset of the text from an anchor point. These include <code>em</code> which is a scalable unit, <code>px</code> (pixels), <code>pt</code> (points (kind of like pixels)) and <code>%</code> (percent (scalable and kind of like <code>em</code>))  </p>

<p>We can demonstrate the offset effect by noting the difference in two examples.</p>

<p>The first is a simple projection of SVG text that aligns the text “Hello World” above and to the right of the anchor point at 200,100 (It does this in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter.). </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>     <code class="c1">// define the text to display </code>
</pre></div>

</figure>

<p>Which produces the following on the page;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-11.png" alt="Text with the Anchor at the Bottom Left Corner">
  <figcaption>Text with the Anchor at the Bottom Left Corner</figcaption>
</figure>


<p>The second example introduces the <code>dx</code> attribute setting the offset to 50 pixels. This adds another 50 pixels to the x dimension. We also introduce the <code>dy</code> attribute with an offset of <code>.35em</code>. This scalable unit allows the text to be set as a factor of the size of the text. In this case <code>.35em</code> will add half the height of the text to the y dimension placing the text so that it is exactly in the middle (vertically) of the 100 pixel line on the y dimension.  </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>         <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dx"</code><code class="p">,</code> <code class="s2">"50px"</code><code class="p">)</code>       <code class="c1">// set offset x position</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>      <code class="c1">// set offset y position</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>     <code class="c1">// define the text to display </code>
</pre></div>

</figure>

<p>Which produces the following on the page;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-28.png" alt="Text with 50 Pixel x Offset and Half Height y Offset">
  <figcaption>Text with 50 Pixel x Offset and Half Height y Offset</figcaption>
</figure>


<p>The text has been moved 50 pixels to the right and half the height of the text down the page.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-textlength"><code>textLength</code></h4>

<p>The <code>textLength</code> attribute adjusts the length of the text to fit a specified value.</p>

<p>The following is a code snippet that prints the text “Hello World” above and to the right of the anchor point at 200,100 (It does this in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter.). The addition of the <code>textLength</code> attribute declaration in the code stretches the “Hello World” out so that it fills 150 pixels.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>          <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>    <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>            <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>            <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"textLength"</code><code class="p">,</code> <code class="s2">"150"</code><code class="p">)</code> <code class="c1">// set text length</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>      <code class="c1">// define the text to display </code>
</pre></div>

</figure>

<p>Which produces the following on the page;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-29.png" alt="Text Stretched to 150 Pixels Wide">
  <figcaption>Text Stretched to 150 Pixels Wide</figcaption>
</figure>


<p>It is worth noting that while the text has been spread out, the individual letters remain un-stretched. Only the letter and word spacing has been adjusted. However, using the <code>lengthAdjust</code> attribute can change this.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-lengthadjust"><code>lengthAdjust</code></h4>

<p>The <code>lengthAdjust</code> attribute allows the <code>textLength</code> attribute to have the spacing of a text element controlled to be either <code>spacing</code> or <code>spacingAndGlyphs</code>;</p>

<ul>
  <li>
<code>spacing</code>: In this option the letters remain the same size, but the spacing between the letters and words are adjusted.</li>
  <li>
<code>spacingAndGlyphs</code>: In this option the text is stretched or squeezed to fit.</li>
</ul>

<p>The attribute can be best illustrated via an example. The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) shows three versions of the text element. The top line is the standard text. The middle line is the <code>textLength</code> set to 150 and the <code>lengthAdjust</code> set to <code>spacing</code> (which is the default). The bottom line is the <code>textLength</code> set to 150 and the <code>lengthAdjust</code> set to <code>spacingAndGlyphs</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>          <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>    <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>            <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>             <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>      <code class="c1">// define the text to display </code>
    
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>          <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>    <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>            <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>            <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"textLength"</code><code class="p">,</code> <code class="s2">"150"</code><code class="p">)</code> <code class="c1">// set text length</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"lengthAdjust"</code><code class="p">,</code> <code class="s2">"spacing"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>      <code class="c1">// define the text to display </code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>          <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>    <code class="c1">// fill the text with the colour black</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>            <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>            <code class="c1">// set y position of bottom of text </code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"textLength"</code><code class="p">,</code> <code class="s2">"150"</code><code class="p">)</code> <code class="c1">// set text length</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"lengthAdjust"</code><code class="p">,</code> <code class="s2">"spacingAndGlyphs"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>      <code class="c1">// define the text to display </code>
</pre></div>

</figure>

<p>The image on the screen will look like the following;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-30.png" alt="Text Stretched in Three Ways">
  <figcaption>Text Stretched in Three Ways</figcaption>
</figure>


<p>The image shows that the top line looks normal, the middle line has had the spaces increased to increase the length of the text and the bottom line has been stretched.</p>

<div class="page-break"></div>
<h3 id="leanpub-auto-styles">Styles</h3>

<p>What’s a style?</p>

<p>Believe it or not, that’s as difficult a question to answer as “What’s an attribute?”. I like to think that an element can be selected and arranged on a web page with <code>select</code> and <code>attr</code>, but once it’s there, changes to how it looks are a matter for <code>style</code>. We will cover a range of qualities that neatly fit into this definition in the following section (such as fill, opacity and stroke-width) but there are also a range of unusual style declarations that many may not have come across (I certainly hadn’t before writing this).</p>

<p>The other important thing to mention about setting styles for elements is that there are different ways to accomplish the task. We’ll go through the process of describing different styles as they can be applied to individual elements in isolation, but there is a more powerful way to manage styles across a range of elements via Cascading Style Sheets (CSS) in the <code>&lt;style&gt;</code> section of a web page or even via an external style sheet. We will examine these possibilities at the end of the section. </p>

<p>Full disclosure: I have not figured out how to work some of the styles for d3.js I’m afraid that <code>clip-path</code> and <code>mask</code> have exceeded my skill-set and I will have to leave them for another day :-(. I found that there are several good examples that make use of these styles, but I have struggled (unsuccessfully) to present them in a simple example.  </p>

<div class="page-break"></div>
<h4 id="leanpub-auto-fill"><code>fill</code></h4>

<p>The <code>fill</code> style will fill the element being presented with a specified colour.</p>

<p>By default, most elements will be filled with black (the majority of the examples used in this chapter make no <code>fill</code> declaration). </p>

<p>The following example (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) shows the syntax for filling a simple circle with the colour red;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>             <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">);</code>     <code class="c1">// set the fill colour </code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-31.png" alt="Circle with Red Fill">
  <figcaption>Circle with Red Fill</figcaption>
</figure>


<p>As we saw with the <code>polyline</code> and <code>polygon</code> examples earlier in the chapter some shapes may need to have their <code>fill</code> colour turned off in some circumstances and this can be accomplished by declaring the colour to be <code>none</code> (<code>.style("fill", "none");</code>).</p>

<p>There are several different ways to define exactly what colour we want as a fill. The example above uses a ‘named colour code’ to declare the colour as “red” but we could also have defined it as rgb (<code>.style("fill", "rgb(255,0,0)");</code>) or in hexadecimal (<code>.style("fill", "#f00");</code>)</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-stroke"><code>stroke</code></h4>

<p>The <code>stroke</code> style applies a colour to lines. </p>

<p>By default many elements do not have a stroke colour set, so it’s a matter of declaring the colour with either a named colour code (“red”), an rgb value (“rgb(255,0,0)”) or the appropriate hex (“#f00”).</p>

<p>The following example (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) shows the syntax for applying the colour red to a simple circle. The fill has been set to <code>none</code> to help the colour stand out.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>             <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>    <code class="c1">// set the line colour</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code>    <code class="c1">// set the fill colour </code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-32.png" alt="Circle with Red Border">
  <figcaption>Circle with Red Border</figcaption>
</figure>


<div class="page-break"></div>
<h4 id="leanpub-auto-opacity"><code>opacity</code></h4>

<p>The <code>opacity</code> style has the effect of varying an element’s transparency.</p>

<p>The valid range for <code>opacity</code> is from 0 (completely transparent) to 1 (solid colour). We should make the distinction at this point that <code>opacity</code> affects the entire element, whereas the following <code>fill-opacity</code> and <code>stroke-opacity</code> affect only the fill and stroke respectively.</p>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates a green circle with a red border. The opacity value of .2 creates a degree of transparency which will show the grid lines underneath the element.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>             <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">2</code><code class="p">)</code>      <code class="c1">// set the element opacity</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>    <code class="c1">// set the line colour</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"green"</code><code class="p">);</code>   <code class="c1">// set the fill colour</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-33.png" alt="Circle with opacity">
  <figcaption>Circle with opacity</figcaption>
</figure>


<div class="page-break"></div>
<h4 id="leanpub-auto-fill-opacity"><code>fill-opacity</code></h4>

<p>The <code>fill-opacity</code> style changes the transparency of the fill of an element.</p>

<p>The valid range for <code>fill-opacity</code> is from 0 (completely transparent) to 1 (solid colour). We should make the distinction at this point that <code>fill-opacity</code> affects only the fill of an element, whereas <code>opacity</code> will affect the entire element.</p>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates a green circle with a red border. The opacity value of .2 creates a degree of transparency for the fill which will show the grid lines underneath.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>        <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>           <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>           <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>             <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill-opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">2</code><code class="p">)</code> <code class="c1">// set the fill opacity</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>    <code class="c1">// set the line colour</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"green"</code><code class="p">);</code>   <code class="c1">// set the fill colour</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-34.png" alt="Circle with Semi-Transparent Fill">
  <figcaption>Circle with Semi-Transparent Fill</figcaption>
</figure>


<p>The distinction between this image and the one for the <code>opacity</code> style clearly shows the line around the outside of the object as still a solid (opaque) colour.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-stroke-opacity"><code>stroke-opacity</code></h4>

<p>The <code>stroke-opacity</code> style changes the transparency of the stroke (line) of an element.</p>

<p>The valid range for <code>stroke-opacity</code> is from 0 (completely transparent) to 1 (solid colour). We should make the distinction at this point that <code>stroke-opacity</code> affects only the line or border of an element, whereas <code>opacity</code> will affect the entire element.</p>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates an empty circle with a red border. The opacity value of .2 creates a degree of transparency for the stroke which will show the grid lines underneath (or at least make it appear more ‘muted’).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>          <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>             <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>             <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>               <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">2</code><code class="p">)</code> <code class="c1">// set the stroke opacity</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>      <code class="c1">// set the line colour</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code>      <code class="c1">// set the fill colour</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-35.png" alt="Circle with Red Border and opacity">
  <figcaption>Circle with Red Border and opacity</figcaption>
</figure>


<p>Although it is not necessarily easy to see in this example because the line is quite thin, the lines of the grid behind the circle will be showing through the line of the circle.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-stroke-width"><code>stroke-width</code></h4>

<p>The <code>stroke-width</code> style adjusts the width of the line of an element.</p>

<p>The value specified when setting <code>stroke-width</code> is in pixels.</p>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates an empty circle with a red border. The <code>stroke-width</code> is set to 5 which equates to 5 pixels (it can also be specified as “5px”).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>          <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>             <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>             <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>               <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>    <code class="c1">// set the stroke width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>      <code class="c1">// set the line colour</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code>      <code class="c1">// set the fill colour</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-36.png" alt="Circle with Thicker Red Border">
  <figcaption>Circle with Thicker Red Border</figcaption>
</figure>


<p>The width of the line that forms the border of the circle is now 5 pixels wide :-).</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-stroke-dasharray"><code>stroke-dasharray</code></h4>

<p>The <code>stroke-dasharray</code> style allows us to form element lines with dashes instead of solid lines.</p>

<p>We have covered dashed lines in practical way in a previous section of the book (‘Make a Dashed Line’) but for the sake of completeness I will include dashed lines here as well.</p>

<p>We create a dashed line by specifying the length of a dash and then the length of a space. We can include a long list of dashes and spaces and once complete our line will simply repeat the pattern we have specified.</p>

<p>For example the following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates a line with a dash of 10 pixels followed by a space of 3 pixels;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>       <code class="c1">// attach a circle</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>          <code class="c1">// position the x-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>          <code class="c1">// position the y-centre</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>            <code class="c1">// set the radius</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-dasharray"</code><code class="p">,</code> <code class="p">(</code><code class="s2">"10,3"</code><code class="p">))</code> <code class="c1">// make the stroke dashed</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>   <code class="c1">// set the line colour</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">);</code>   <code class="c1">// set the fill colour</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-37.png" alt="Circle with Dashed Red Border">
  <figcaption>Circle with Dashed Red Border</figcaption>
</figure>


<p>More complex combinations of dashes and spaces are possible as are complex animation sequences that leverage the ability to move objects along a path (these are certainly more advanced examples).</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-stroke-linecap"><code>stroke-linecap</code></h4>

<p>The <code>stroke-linecap</code> style allows control of the shape of the ends of lines in d3.js.</p>

<p>There are three shape options;</p>

<ul>
  <li>
<code>butt</code> where the line simply butts up to the starting or ending position and is cut off squarely.</li>
  <li>
<code>round</code> where the line is rounded in proportion to its width.</li>
  <li>
<code>square</code> where the line is squared off but extended in proportion to its width.</li>
</ul>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) generates three lines showing each <code>stroke-linecap</code> style option. The top line uses <code>butt</code>. The middle line uses <code>round</code> and the bottom line uses <code>square</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>                 <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>         <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>        <code class="c1">// adjust line width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"butt"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>      <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>     <code class="c1">// y position of the second end of the line</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>                  <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>          <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>         <code class="c1">// adjust line width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"round"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">100</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>                   <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>           <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>          <code class="c1">// adjust line width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"square"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>     <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">150</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-38.png" alt="Three Lines with Different End Shapes">
  <figcaption>Three Lines with Different End Shapes</figcaption>
</figure>


<p>The shapes are quite distinct for each type and it is useful to note the degree to which the lines extend beyond their start and end points.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-stroke-linejoin"><code>stroke-linejoin</code></h4>

<p>The <code>stroke-linejoin</code> style specifies the shape of the join of two lines. This would be used on <code>path</code>, <code>polyline</code> and <code>polygon</code> elements (and possibly more).</p>

<p>There are three line join options;</p>

<ul>
  <li>
<code>miter</code> where the join is squared off as would be expected at the join of two lines. </li>
  <li>
<code>round</code> where the outside portion of the join is rounded in proportion to its width.</li>
  <li>
<code>bevel</code> where the join  has a straight edged outer portion clipped off to provide a slightly more contoured effect while still being angular.</li>
</ul>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) generates a poly line where the join has the connection shaped using the <code>stroke-linejoin</code> <code>round</code> style. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"polyline"</code><code class="p">)</code>       <code class="c1">// attach a polyline</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>   <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>      <code class="c1">// remove any fill colour</code>
	<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>  <code class="c1">// colour the line</code>
	<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linejoin"</code><code class="p">,</code> <code class="s2">"round"</code><code class="p">)</code>  <code class="c1">// shape the line join</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"points"</code><code class="p">,</code> <code class="s2">"100,50, 200,150, 300,50"</code><code class="p">);</code>  <code class="c1">// x,y points </code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-39.png" alt="Polyline with Round Join">
  <figcaption>Polyline with Round Join</figcaption>
</figure>


<p>Note the curve on the outer of the join.</p>

<p>Changing the shape of the line join to <code>bevel</code> produces the following;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-40.png" alt="Polyline with Bevel Join">
  <figcaption>Polyline with Bevel Join</figcaption>
</figure>


<p>Here we can see the clipping of the outer portion of the join.</p>

<p>And using <code>miter</code> produces a standard connection;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-41.png" alt="Polyline with Miter Join">
  <figcaption>Polyline with Miter Join</figcaption>
</figure>


<p>This is the default setting for line joins and does not need to be added unless the line join type has already been set to a different default.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-writing-mode"><code>writing-mode</code></h4>

<p>The <code>writing-mode</code> style changes the orientation of the text so that it prints out top to bottom. It has a single option “tb” that accomplishes this. It is relatively limited in scope compared to the equivalent for CSS, but for the purposes of generating some text it has a definite use.</p>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates a line of text that is now printed from top to bottom instead of left to right.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>            <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>      <code class="c1">// make the text black</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"writing-mode"</code><code class="p">,</code> <code class="s2">"tb"</code><code class="p">)</code> <code class="c1">// set the writing mode</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>         <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>         <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>   <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-42.png" alt="Text rotated using writing-mode">
  <figcaption>Text rotated using writing-mode</figcaption>
</figure>


<p>It is significant to note that while it looks like the text has been rotated about its anchor point, this actually isn’t the case since the anchor point should be at 200,100. Also, the <code>glyph-orientation-vertical</code> style (which follows) will allow the text to be orientated vertically which will be useful.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-glyph-orientation-vertical"><code>glyph-orientation-vertical</code></h4>

<p>The <code>glyph-orientation-vertical</code> style changes the rotation of the individual glyphs (characters) in text and if used in conjunction with the <code>writing-mode</code> style (and set to 0) will allow the text to be displayed vertically with the letters orientated vertically as well.</p>

<p>The following code snippet (which works in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter) creates a line of text that is now printed from top to bottom with letters orientated vertically.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>            <code class="c1">// append text</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>      <code class="c1">// make the text black</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"writing-mode"</code><code class="p">,</code> <code class="s2">"tb"</code><code class="p">)</code> <code class="c1">// set the writing mode</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"glyph-orientation-vertical"</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>         <code class="c1">// set x position of left side of text</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">25</code><code class="p">)</code>          <code class="c1">// set y position of bottom of text</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Hello World"</code><code class="p">);</code>   <code class="c1">// define the text to display</code>
</pre></div>

</figure>

<p>Which results in the following image;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-43.png" alt="Text rotated and orientated">
  <figcaption>Text rotated and orientated</figcaption>
</figure>


<p>It is worth noting that the text spacing increases dramatically as the spacing for each letter relies on the normal distance between the bottom and top of a line of text.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-using-styles-in-cascading-style-sheets">Using styles in Cascading Style Sheets</h4>

<p>Declaring styles on an element by element basis is an OK way to apply styles, but when our visualizations become more complex, this can be an inefficient use of code.</p>

<p>A smarter way to provide a common set of styles to elements is to declare them in the <code>&lt;style&gt;</code> section of our HTML document using Cascading Style Sheets (CSS). These will then be automatically applied to our elements.</p>

<p>We start with an example script that draws our three lines that have different styles of linecaps. Our previous example looked like the following 
(in conjunction with <a href="#EASframework">the HTML file</a> outlined at the start of this chapter)</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>                 <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>         <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>        <code class="c1">// adjust line width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"butt"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>      <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>     <code class="c1">// y position of the second end of the line</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>                  <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>          <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>         <code class="c1">// adjust line width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"round"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">100</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>                   <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>           <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>          <code class="c1">// adjust line width</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"square"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>     <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">150</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>
</pre></div>

</figure>

<p>Which resulted in the following image;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/EAS-38.png" alt="Three Lines with Different End Shapes">
  <figcaption>Three Lines with Different End Shapes</figcaption>
</figure>


<p>The block of code for each of the three lines contains three separate <code>style</code> declarations. Two of which are identical for all three blocks of code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>         <code class="c1">// colour the line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>        <code class="c1">// adjust line width</code>
</pre></div>

</figure>

<p>To make these styles available from a common point, we declare them in the <code>&lt;style&gt;</code> section of our HTML file as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="nt">line</code><code class="nc">.linecap</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="nb">black</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">20</code><code class="p">;</code>  
<code class="p">}</code>
<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The <code>&lt;style&gt;</code> tags simply tell our browser which part of <a href="#EASframework">the HTML file</a> we are using to define our styles.</p>

<p>The <code>line.linecap</code> portion identifies the following styles as belonging to the <code>line</code> elements that are also identified as belonging to the ‘class’ <code>linecap</code> (We have used the <code>linecap</code> name as a convenience only and it could just as easily have been <code>foobar</code>.).</p>

<p>The two styles are enclosed within curly braces and are declared in the form <code>&lt;style-name&gt;: &lt;style-value&gt;;</code>. So for our example here, the stroke is black and its width is 20 pixels.</p>

<p>Then our example script can have the two styles removed from each of the blocks that draws the lines and in their place we add a new attribute <code>class</code> that assigns a class to the element (in this case the class <code>linecap</code>). Our new code will look like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>           <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"butt"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"linecap"</code><code class="p">)</code>   <code class="c1">// inherits styles from CSS</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>      <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>     <code class="c1">// y position of the second end of the line</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>           <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"round"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"linecap"</code><code class="p">)</code>   <code class="c1">// inherits styles from CSS</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">100</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"line"</code><code class="p">)</code>           <code class="c1">// attach a line</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-linecap"</code><code class="p">,</code> <code class="s2">"square"</code><code class="p">)</code>  <code class="c1">// stroke-linecap type</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"linecap"</code><code class="p">)</code>   <code class="c1">// inherits styles from CSS</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>     <code class="c1">// x position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>     <code class="c1">// y position of the first end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>     <code class="c1">// x position of the second end of the line</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="mi">150</code><code class="p">);</code>    <code class="c1">// y position of the second end of the line</code>
</pre></div>

</figure>

<p>While this has only replaced two lines with one in our code, the potential for use in far more complex examples should be obvious. There is significantly more detail that can be gone into with regard to CSS, but that would be beyond my meagre abilities.</p>


<h2 id="leanpub-auto-manipulating-data">Manipulating data</h2>


<h3 id="leanpub-auto-how-to-use-data-imported-from-a-csv-file-with-spaces-in-the-header">How to use data imported from a csv file with spaces in the header.</h3>

<p>When importing data from a csv file (dataSpace.csv) that has headers with spaces in the middle of some of the fields there is a need to address the data slightly differently in order for it to be used easily in your JavaScript.</p>

<p>For example the following csv data has a column named ‘Date Purchased’;</p>

<figure class="code">
<div class="highlight"><pre><code></code>Date Purchased,close
1-May-12,58.13
30-Apr-12,53.98
27-Apr-12,67.00
26-Apr-12,89.70
25-Apr-12,99.00
</pre></div>

</figure>

<p>This is not an uncommon occurrence since <a href="http://tools.ietf.org/html/rfc4180">RFC 4180</a> which specifies csv content allows for it and d3.js supports the RFC;</p>

<blockquote>
  <p>Within the header and each record, there may be one or more fields, separated by commas. Each line should contain the same number of fields throughout the file. Spaces are considered part of a field and should not be ignored.</p>
</blockquote>

<p>When we go to import the data using the d3.csv function, we need to reference the ‘Data Purchased’ column in a way that makes allowances for the space. The following piece of script (with grateful thanks to <a href="http://stackoverflow.com/questions/21715201/unable-to-reference-d3-js-data-imported-from-a-csv-file-with-spaces-in-the-heade">Stephen Thomas for answering my Stack Overflow question</a>) appears to be the most basic solution.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"dataSpace.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>

  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseTime</code><code class="p">(</code><code class="nx">d</code><code class="p">[</code><code class="s1">'Date Purchased'</code><code class="p">]);</code>
  <code class="p">});</code>
<code class="p">...</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>In the example above the ‘Date Purchased’ column is re-declared as ‘date’ making working in the following script much easier.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-extracting-data-from-a-portion-of-a-string">Extracting data from a portion of a string.</h3>

<p>Suppose we have a set of values we want to extract from a string because they cannot be used in their original form.</p>

<p>For example, the following csv file contains the column ‘value’ and the values of the data in that column are prefixed with a dollar sign ($). </p>

<figure class="code">
<div class="highlight"><pre><code></code>value,date,score
$1234,2011-03-23,99
$2234,2011-03-24,100
$3234,2011-03-25,99
$4235,2011-03-26,100
</pre></div>

</figure>

<p>We can use the JavaScript substring() method to easily remove the leading character from the data.</p>

<p>The following example processes our csv file after loading it and for each ‘value’ entry on each row takes a substring of the entry that removes the first character and retains the rest.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"dataSample.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>

    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">.</code><code class="nx">substring</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>
    <code class="p">});</code>
<code class="p">...</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>The substring() function includes a ‘start’ index (as used above) and optionally a ‘stop’ index. More on how these can be configured can be found on the <a href="http://www.w3schools.com/jsref/jsref_substring.asp">w3schools</a> site. </p>

<div class="page-break"></div>

<h3 id="nest">Grouping and summing data (d3.nest)</h3>

<p>Often we will wish to group elements in an array into a hierarchical structure similar to the <code>GROUP BY</code> operator in SQL (but with the scope for multiple levels). This can be achieved using the <a href="https://github.com/d3/d3-collection/blob/master/README.md#nests"><code>d3.nest</code></a> operator. Additionally we will sometimes wish to collapse the elements that we are grouping in a specific way (for instance to sum values). This can be achieved using the <code>rollup</code> function.</p>

<p>The example we will use is having the following csv file consisting of a column of dates and corresponding values;</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,value
23-Mar-11,3
23-Mar-11,2
24-Mar-11,3
24-Mar-11,3
24-Mar-11,6
24-Mar-11,2
24-Mar-11,7
25-Mar-11,4
25-Mar-11,5
25-Mar-11,1
25-Mar-11,4
</pre></div>

</figure>

<p>We will nest the data according to the date and sum the data for each date so that our data is in the equivalent form of;</p>

<figure class="code">
<div class="highlight"><pre><code></code>key,values
23-Mar-11,5
24-Mar-11,21
25-Mar-11,14
</pre></div>

</figure>

<p>We will do this with the following script;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"source-data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">csv_data</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;})</code>
    <code class="p">.</code><code class="nx">rollup</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
        <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">sum</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">g</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">g</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">});</code>
    <code class="p">}).</code><code class="nx">entries</code><code class="p">(</code><code class="nx">csv_data</code><code class="p">);</code>

<code class="p">});</code>
</pre></div>

</figure>

<p>We are assuming the data is in a csv file and is named <code>source-data.csv</code>.</p>

<p>The first thing we do is load that file and assign the loaded array the variable name <code>csv_data</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"source-data.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">csv_data</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>
</pre></div>

</figure>

<p>Then we declare our new array’s name will be <code>data</code> and we initiate the <code>nest</code> function;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
</pre></div>

</figure>

<p>We assign the <code>key</code> for our new array as <code>date</code>. A ‘key’ is like a way of saying “<em>This is the thing we will be grouping on</em>”. In other words our resultant array will have a single entry for each unique <code>date</code> value.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;})</code>
</pre></div>

</figure>

<p>Then we include the <code>rollup</code> function that takes all the individual <code>value</code> variables that are in each unique <code>date</code> field and sums them;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">rollup</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
        <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">sum</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">g</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">g</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>Lastly we tell the entire nest function which data array we will be using for our source of data.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">}).</code><code class="nx">entries</code><code class="p">(</code><code class="nx">csv_data</code><code class="p">);</code>
</pre></div>

</figure>

<p>What if your data turns out to be unsorted? Never fear, we can easily sort on the key value by tacking on the <code>sortKeys</code> function like so;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;}).</code><code class="nx">sortKeys</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">ascending</code><code class="p">)</code>
</pre></div>

</figure>

<p>You should note that our data will have changed name from <code>date</code> and <code>value</code>. This is as a function of the <code>nest</code> and <code>rollup</code> process. But never fear, it’s a simple task to re-name them if necessary using the following function (which could include a call to parse the date, but I have omitted it for clarity);</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">;</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">;</code>
<code class="p">});</code>
</pre></div>

</figure>

<div class="page-break"></div>

<h3 id="leanpub-auto-selecting-a-random-string-from-an-array">Selecting a random string from an array.</h3>

<p>What if we had a situation where we wanted to be able to select a random colour for the fill of a set of objects from a restricted set of colour options.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/randomColour.png" alt="An array of random colours">
  <figcaption>An array of random colours</figcaption>
</figure>


<p>The colours we want are green, orange, red and blue and the solution uses an adaptation of the one <a href="http://stackoverflow.com/questions/4550505/getting-random-value-from-an-array">presented by Jacob Relkin on stackoverflow</a>.</p>

<p>First we start by declaring the colours in an array;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">colorRange</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'green'</code><code class="p">,</code> <code class="s1">'orange'</code><code class="p">,</code> <code class="s1">'red'</code><code class="p">,</code> <code class="s1">'blue'</code><code class="p">];</code> 
</pre></div>

</figure>

<p>From there we set up the function that will return one of the elements of the array at random by calculating an index number from the array of possible options based on the length of the array;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">randomColor</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">colorRange</code><code class="p">[</code><code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="nx">colorRange</code><code class="p">.</code><code class="nx">length</code><code class="p">)];</code>
<code class="p">}</code>
</pre></div>

</figure>

<p><code>colorRange.length</code> returns the number of elements in the array (in this case 4). This is multiplied by a random number between 0 and 1 (<code>Math.random()</code>). Then we get the largest integer that is less than or equal to our generated number using <code>Math.floor</code>. This ‘flattens out’ the result to be one of 0,1,2 or 3.</p>

<p>Then when we want to find one of our random colours we simply call our <code>randomColour</code> function a little like the following for a <code>fill</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">...</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="nx">randomColor</code><code class="p">)</code>
<code class="p">...</code>
</pre></div>

</figure>

<div class="page-break"></div>

<h2 id="leanpub-auto-bar-charts-and-histograms">Bar Charts and Histograms</h2>

<p>Yes! There is a difference! I know they look similar but for a bar charts, each column represents a group defined by a category and with a histogram, each column represents a group defined by a range.</p>

<h3 id="leanpub-auto-bar-chart">Bar Chart</h3>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/bar-01.png" alt="Bar chart">
  <figcaption>Bar chart</figcaption>
</figure>


<ul>
  <li>Each column is positioned over a label that represents a categorical variable.</li>
  <li>The height of the column indicates the size of the group defined by the category.</li>
</ul>

<h4 id="leanpub-auto-histogram">Histogram</h4>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/hist-01.png" alt="Histogram">
  <figcaption>Histogram</figcaption>
</figure>


<ul>
  <li>Each column is positioned over a label that represents a quantitative variable.</li>
  <li>The column label can be a single value or a range of values.</li>
</ul>

<div class="page-break"></div>

<h3 id="leanpub-auto-bar-charts">Bar Charts</h3>

<p>A bar chart is a visual representation using either horizontal or vertical bars to show comparisons between discrete categories. There are a number of variations of bar charts including stacked, grouped, horizontal and vertical. </p>

<p>We will work through a simple vertical bar chart that uses a value on the y axis and category in the form of a name on the x axis.</p>

<p>The end result will look like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/bar-01.png" alt="Bar chart">
  <figcaption>Bar chart</figcaption>
</figure>


<h4 id="leanpub-auto-the-data">The data</h4>

<p>The data for this example will be sourced from an external (purely fictional) csv file named <code>sales.csv</code>. It consists of a column of names and ‘sales’ and its contents are as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>salesperson,sales
Bob,33
Robin,12
Anne,41
Mark,16
Joe,59
Eve,38
Karen,21
Kirsty,25
Chris,30
Lisa,47
Tom,5
Stacy,20
Charles,13
Mary,29
</pre></div>

</figure>

<h4 id="leanpub-auto-the-code">The code</h4>

<p>The full code listing for the example we are going to work through is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code> <code class="c">/* set the CSS */</code>

<code class="nc">.bar</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code> <code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
	
<code class="c">&lt;!-- load the d3.js library --&gt;</code>    	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"//d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="c1">// set the dimensions and margins of the graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleBand</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">])</code>
          <code class="p">.</code><code class="nx">padding</code><code class="p">(</code><code class="mf">0.1</code><code class="p">);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
          
<code class="c1">// append the svg object to the body of the page</code>
<code class="c1">// append a 'group' element to 'svg'</code>
<code class="c1">// moves the 'group' element to the top left margin</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"sales.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>

  <code class="c1">// format the data</code>
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">sales</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">sales</code><code class="p">;</code>
  <code class="p">});</code>

  <code class="c1">// Scale the range of the data in the domains</code>
  <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">salesperson</code><code class="p">;</code> <code class="p">}));</code>
  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">sales</code><code class="p">;</code> <code class="p">})]);</code>

  <code class="c1">// append the rectangles for the bar chart</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".bar"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bar"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">salesperson</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">x</code><code class="p">.</code><code class="nx">bandwidth</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">sales</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">height</code> <code class="o">-</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">sales</code><code class="p">);</code> <code class="p">});</code>

  <code class="c1">// add the x Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>

  <code class="c1">// add the y Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>

<code class="p">});</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<aside class="information blurb">
    <p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/bdf28027e0ce70bd132edc64f1dd7ea4">github</a> or in the code samples bundled with <a href="https://leanpub.com/d3-t-and-t-v4">this book</a> (bar.html and sales.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/bdf28027e0ce70bd132edc64f1dd7ea4">bl.ocks.org</a>. </p>

</aside>

<h4 id="leanpub-auto-the-bar-chart-explained">The bar chart explained</h4>

<p>In the course of describing the operation of the file I will gloss over the aspects of the structure of an HTML file which have already been described at the start of the book. Likewise, aspects of the JavaScript functions that have already been covered will only be briefly explained.</p>

<p>The start of the file deals with setting up the document’s head and body, loading the d3.javascript script and setting up the CSS in the <code>&lt;style&gt;</code> section.</p>

<p>The CSS section sets styling for the colour of the bars. In all reality we could have placed it as a style later in the code, but it’s nice to have something in the CSS area because you never know, we might want it later.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.bar</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code> <code class="p">}</code>
</pre></div>

</figure>

<p>Then our JavaScript section starts and the first thing that happens is that we set the size of the area that we’re going to use for the chart and the margins;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// set the dimensions and margins of the graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>The next section of our code includes some of the functions that will be called from the main body of the code. This includes the functions to determine positioning in the x and y domains.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleBand</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">])</code>
          <code class="p">.</code><code class="nx">padding</code><code class="p">(</code><code class="mf">0.1</code><code class="p">);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
</pre></div>

</figure>

<p>The band scale set up for the x domain is a neat function that allows the creation of a series of uniform bands that can be computed from the assigned range. For the purposes of our bar chart, these will be the equivalent of the bars. These bands and their properties (the spacing between them and other details) can be assigned for display purposes.</p>

<p>For example, in this case the padding is the space made available between bars. This is set to <code>0.1</code>, or 1/10th of the width of the space available for each band. If we were to alter the padding to <code>0.5</code> (or half the width of the band) we would have the following;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/bar-02.png" alt="Bar chart with 0.5 padding">
  <figcaption>Bar chart with 0.5 padding</figcaption>
</figure>


<p>For the full description of band scales, check out the <a href="https://github.com/d3/d3-scale#band-scales">D3 wiki</a>.</p>

<p>The function to set the scaling in the y domain is the same as most of our other graph examples; </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">])</code>
</pre></div>

</figure>

<p>The next block of code selects the <code>body</code> on the web page and appends an svg object to it of the size that we have set up with our <code>width</code>, <code>height</code> and <code>margin</code>s.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
</pre></div>

</figure>

<p>It also adds a <code>g</code> element that provides a reference point for adding our axes.</p>

<p>Then we begin the main body of our JavaScript. We load our csv file and then loop through it making sure that the dates and numerical values are recognised correctly;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"sales.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>

  <code class="c1">// format the data</code>
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">sales</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">sales</code><code class="p">;</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>We then work through our x and y data and ensure that it is scaled to the domains we are working in;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Scale the range of the data in the domains</code>
  <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">salesperson</code><code class="p">;</code> <code class="p">}));</code>
  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">sales</code><code class="p">;</code> <code class="p">})]);</code>
</pre></div>

</figure>

<p>Then we add the bars to our chart;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// append the rectangles for the bar chart</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".bar"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bar"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">salesperson</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">x</code><code class="p">.</code><code class="nx">bandwidth</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">sales</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">height</code> <code class="o">-</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">sales</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>This block of code creates the bars (<code>selectAll("bar")</code>) and associates each of them with a data set (<code>.data(data)</code>).</p>

<p>We then append a rectangle (<code>.append("rect")</code>) with the colour assigned by our class (set in the <code>&lt;style&gt;</code> section) along with values for x/y position. The width of the bars is determined from our band scale function we assigned earlier and is found by retrieving the value via the <code>.bandwidth()</code> call. The height is as configured in our earlier code.</p>

<p>Finally we append our axes;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// add the x Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>

  <code class="c1">// add the y Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>
</pre></div>

</figure>
<p>The end result is our pretty looking bar chart;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/bar-01.png" alt="Bar chart">
  <figcaption>Bar chart</figcaption>
</figure>


<div class="page-break"></div>

<h3 id="leanpub-auto-histograms">Histograms</h3>

<p>A histogram is a graphical representation of the distribution of numerical data. It is typically formed by creating ‘bins’ of a larger dataset that group the data into a range of values and count the number of pieces of data fall into each bin. Each bin is then represented as a bar showing the relationship between each range.</p>

<p>The example we will work through shows the frequency of earthquakes above magnitude 3 between July 2010 and January 2012 in Christchurch, New Zealand (A time of some significant seismic activity). Data was sourced from New Zealand’s <a href="http://www.geonet.org.nz/">Geonet</a> site.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/hist-01.png" alt="Histogram">
  <figcaption>Histogram</figcaption>
</figure>


<p>We can see that the data has been ‘binned’ by month and that between the 1st of September and the 1st of October there were over 1800 earthquakes registering over magnitude 3.</p>

<h4 id="leanpub-auto-the-data-1">The data</h4>

<p>The data for this example will be sourced from an external (purely fictional) csv file named <code>sales.csv</code>. It consists of a column of dates in day-month-year format (and magnitudes, which won’t be used in this graph) and its contents looks similar to the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code>dtg,value
01-08-2010,3
01-08-2010,3
01-08-2010,3
01-08-2010,3
01-08-2010,3.1
01-08-2010,3.2
01-08-2010,3.2
.
.
.
31-12-2011,3.2
31-12-2011,3.3
31-12-2011,3.4
31-12-2011,3.5
31-12-2011,3.5
31-12-2011,4.1
31-12-2011,4.9
</pre></div>

</figure>

<h4 id="leanpub-auto-the-code-1">The code</h4>

<p>The full code listing for the example we are going to work through is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code> <code class="c">/* set the CSS */</code>

<code class="nt">rect</code><code class="nc">.bar</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code> <code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>    	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"//d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="c1">// set the dimensions and margins of the graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// parse the date / time</code>
<code class="kd">var</code> <code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">timeParse</code><code class="p">(</code><code class="s2">"%d-%m-%Y"</code><code class="p">);</code>

<code class="c1">// set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleTime</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="k">new</code> <code class="nb">Date</code><code class="p">(</code><code class="mi">2010</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">3</code><code class="p">),</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">(</code><code class="mi">2012</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">)])</code>
          <code class="p">.</code><code class="nx">rangeRound</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="c1">// set the parameters for the histogram</code>
<code class="kd">var</code> <code class="nx">histogram</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">histogram</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">value</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">())</code>
    <code class="p">.</code><code class="nx">thresholds</code><code class="p">(</code><code class="nx">x</code><code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">timeMonth</code><code class="p">));</code>

<code class="c1">// append the svg object to the body of the page</code>
<code class="c1">// append a 'group' element to 'svg'</code>
<code class="c1">// moves the 'group' element to the top left margin</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"earthquakes.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>

  <code class="c1">// format the data</code>
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">);</code>
  <code class="p">});</code>

  <code class="c1">// group the data for the bars</code>
  <code class="kd">var</code> <code class="nx">bins</code> <code class="o">=</code> <code class="nx">histogram</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>

  <code class="c1">// Scale the range of the data in the y domain</code>
  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">bins</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code> <code class="p">})]);</code>

  <code class="c1">// append the bar rectangles to the svg element</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">bins</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bar"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">x0</code><code class="p">)</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">x1</code><code class="p">)</code> <code class="o">-</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">x0</code><code class="p">)</code> <code class="o">-</code><code class="mi">1</code> <code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">height</code> <code class="o">-</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code> <code class="p">});</code>

  <code class="c1">// add the x Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>

  <code class="c1">// add the y Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>
      
<code class="p">});</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<aside class="information blurb">
    <p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/96b74d0bd6d11427dd797892551a103c">github</a> or in the code samples bundled with <a href="https://leanpub.com/d3-t-and-t-v4">this book</a> (histogram.html and earthquakes.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/96b74d0bd6d11427dd797892551a103c">bl.ocks.org</a>. </p>

</aside>

<h4 id="leanpub-auto-the-histogram-explained">The histogram explained</h4>

<p>In the course of describing the operation of the file I will gloss over the aspects of the structure of an HTML file which have already been described at the start of the book. Likewise, aspects of the JavaScript functions that have already been covered will only be briefly explained.</p>

<p>The start of the file deals with setting up the document’s head and body, loading the d3.javascript script and setting up the CSS in the <code>&lt;style&gt;</code> section.</p>

<p>The CSS section sets styling for the colour of the rectangles that make up the bars. Similar to the Bar graph, we could have placed it as a style later in the code, but it’s nice to have something in the CSS area.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">rect</code><code class="nc">.bar</code> <code class="p">{</code> <code class="n">fill</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code> <code class="p">}</code>
</pre></div>

</figure>

<p>Then our JavaScript section starts and the first thing that happens is that we set the size of the area that we’re going to use for the chart and the margins;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// set the dimensions and margins of the graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">40</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">960</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>Then we declare the code that parses the time;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// parse the date / time</code>
<code class="kd">var</code> <code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">timeParse</code><code class="p">(</code><code class="s2">"%d-%m-%Y"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Here we have it set to look for time that is formatted as day-month-year.</p>

<p>The next section of our code scales the ranges for x and y.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleTime</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="k">new</code> <code class="nb">Date</code><code class="p">(</code><code class="mi">2010</code><code class="p">,</code> <code class="mi">6</code><code class="p">,</code> <code class="mi">3</code><code class="p">),</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">(</code><code class="mi">2012</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">)])</code>
          <code class="p">.</code><code class="nx">rangeRound</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>
</pre></div>

</figure>

<p><code>y</code> is pretty standard, but for <code>x</code> we specify a time scale that has a domain that goes from one date to another. The date specified here is mildly artificial in the sense that I selected it to look good with the graph when I adjust the bins (you’ll see later), but a bit of experimentation will see you right. Lastly for the x range we get it to round itself to logical values using <code>rangeRound</code>.</p>

<p>Now we start to setup the function that will apply the D3 magic required to form our histogram with the code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// set the parameters for the histogram</code>
<code class="kd">var</code> <code class="nx">histogram</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">histogram</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">value</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">())</code>
    <code class="p">.</code><code class="nx">thresholds</code><code class="p">(</code><code class="nx">x</code><code class="p">.</code><code class="nx">ticks</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">timeMonth</code><code class="p">));</code>
</pre></div>

</figure>

<p>The <code>d3.histogram</code> function allows us to form our data into ‘bins’ that form “<em>discrete samples into continuous, non-overlapping intervals</em>”. In other words in this case we are going to take a data set of close to 10,000 points and we are going to form them into bins corresponding to the months that they occurred in. The value that we’re going to bin will be the variable <code>date</code> and they will fit into the domain that we have already specified in the range section (via <code>.domain(x.domain())</code>). Lastly, we apply the thresholds that we are going to use for the bins which in this case is monthly via <code>.thresholds(x.ticks(d3.timeMonth));</code>. </p>

<p>We can very crudely change our histogram by simply changing that to <code>.thresholds(x.ticks(d3.timeWeek));</code> to produce the following;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/hist-02.png" alt="Histogram with weekly bins">
  <figcaption>Histogram with weekly bins</figcaption>
</figure>


<p>And we can go slightly more extreme by specifying a daily bin and produce the following;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/hist-03.png" alt="Histogram with daily bins">
  <figcaption>Histogram with daily bins</figcaption>
</figure>


<p>(Although technically I cheated slightly with this version and I removed the padding between the bars to allow the data to be presented a bit more faithfully.)</p>

<p>The next block of code selects the <code>body</code> on the web page and appends an svg object to it of the size that we have set up with our <code>width</code>, <code>height</code> and <code>margin</code>s.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
</pre></div>

</figure>

<p>It also adds a <code>g</code> element that provides a reference point for adding our axes.</p>

<p>Then we begin the main body of our JavaScript. We load our csv file and then loop through it making sure that the dates converted into a time format correctly;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"earthquakes.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>

  <code class="c1">// format the data</code>
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">dtg</code><code class="p">);</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>Now that we have our data we can put it into the appropriate bins using the histogram function that we declared earlier;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// group the data for the bars</code>
  <code class="kd">var</code> <code class="nx">bins</code> <code class="o">=</code> <code class="nx">histogram</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
</pre></div>

</figure>

<p>At this point we have two data sets. The first is our array of information from our earthquakes.csv file which is called ‘data’. The second is an array of grouped data called ‘bins’. We use the ‘bins’ data to draw our histogram.</p>

<p>We then use our ‘bin’ data to ensure that the y domain is scaled to the longest bar in the ‘bins’ data set;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Scale the range of the data in the y domain</code>
  <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">bins</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code> <code class="p">})]);</code>
</pre></div>

</figure>

<p>Then we add the bars to our chart;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// append the bar rectangles to the svg element</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">bins</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"bar"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">x0</code><code class="p">)</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">x1</code><code class="p">)</code> <code class="o">-</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">x0</code><code class="p">)</code> <code class="o">-</code><code class="mi">1</code> <code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">height</code> <code class="o">-</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>This block of code selects all the rectangles (<code>selectAll("rect")</code>) and associates each of them with our binned data set (<code>.data(bins)</code>).</p>

<p>We then append the rectangles (<code>.append("rect")</code>) with the colour assigned by our class (set in the <code>&lt;style&gt;</code> section) and we offset all the bars by 1 to make sure that we have a nice symmetrical set of bars with a thin separation (<code>.attr("x", 1)</code>).</p>

<p>The transform function sets the starting point for where we begin drawing the rectangles and the height and width attributes set the height and width of the rectangles. If you really want to stop and look at the transform and height attributes you will notice that it seems a bit ‘odd’. That is because it draws the graph from the top of the screen down. The origin is at the top left of the screen remember and we are trying to represent bars that appear to extend upwards from a ‘0’ point (on the y axis) that exists at a distance ‘height’ from the top of the screen. Sound weird. It is a little, but at the very least it’s logical. You can do it in several different ways, some more confusing than this, and I think that this represents a good balance between code complexity and understandability.</p>

<p>It’s also useful to note that when our histogram function was creating our bins, it also associated some variables with each bin. <code>x0</code> and <code>x1</code> to denote the start and stop point for each bin in the x domain and <code>length</code> for the number of data points in each bin. You can see more details in the <a href="https://github.com/d3/d3-array/blob/master/README.md#histogram">D3 wiki here</a>.</p>

<p>Finally we append our axes;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// add the x Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>

  <code class="c1">// add the y Axis</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>
</pre></div>

</figure>
<p>The end result is our sharp looking histogram;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/hist-01.png" alt="Histogram">
  <figcaption>Histogram</figcaption>
</figure>


<div class="page-break"></div>

<h2 id="leanpub-auto-tree-diagrams">Tree Diagrams</h2>

<h3 id="leanpub-auto-what-is-a-tree-diagram">What is a Tree Diagram?</h3>

<p>The ‘<a href="https://github.com/d3/d3-hierarchy/blob/master/README.md#_tree">Tree layout</a>’ is not a distinct type of diagram per se. Instead, it’s representative of D3’s family of hierarchical layouts. </p>

<p>It’s designed to produce a ‘node-link’ diagram that lays out the connection between nodes in a method that displays the relationship of one node to another in a parent-child fashion.</p>

<p>For example, the following diagram shows a root node (the starting position) labelled ‘Top Node’ which has two children (Bob: Child of Top Node and Sally: Child of Top Node). Subsequently, Bob:Child of Top Node has two dependant nodes (children) ‘Son of Bob’ and ‘Daughter of Bob’.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/tree-01.png" alt="Tree layout diagram">
  <figcaption>Tree layout diagram</figcaption>
</figure>


<p>The clear advantage to this style of diagram is that describing it in text is difficult, but representing it graphically makes the relationships easy to determine.</p>

<p>The data required to produce this type of layout needs to describe the relationships, but this is not necessarily an onerous task. For example, the following is the data (in JSON form) for the diagram above and it shows the minimum information required to form the correct layout hierarchy.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  {
    "name": "Top Node",
    "children": [
      {
        "name": "Bob: Child of Top Node",
        "children": [
          {
            "name": "Son of Bob"
          },
          {
            "name": "Daughter of Bob"
          }
        ]
      },
      {
        "name": "Sally: Child of Top Node"
      }
    ]
  }
</pre></div>

</figure>

<p>It shows each node as having a name that identifies it on the tree and, where appropriate, the children it has (as an array).</p>

<aside class="information blurb">
    <p>The data shown above is arranged as a hierarchy and it is not always possible to source data that is organised so nicely. As we go through examples for this type of diagram we will look at options for importing ‘flat’ data (for example from a csv file) and converting it into a hierarchical form.</p>

</aside>

<p>There is a wealth of examples of tree diagrams on the web, but I would recommend a visit to <a href="http://blockbuilder.org/search#d3version=v4;api=d3.tree">blockbuilder.org</a> as a starting point to get some ideas.</p>

<p>In this chapter we’re going to look at a very simple piece of code to generate a tree diagram before looking at different ways to adapt it. Including rotating it to be vertical, adding some dynamic styling to the nodes, importing from a flat file and from an external source. Finally we’ll look at a more complex example that is more commonly used on the web that allows a user to expand and collapse nodes interactively.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-a-simple-tree-diagram-explained">A simple Tree Diagram explained</h3>

<p>We are going to work through a simple example of the code that draws a tree diagram, This is more for the understanding of the process rather than because it is a good example of code for drawing a tree diagram. It is a very limited example that lacks any real interactivity which is one of the strengths of d3.js graphics. However, we will outline the operation of an interactive version towards the end of the chapter once we have explored some possible configuration options that we might want to make.</p>

<p>The graphic that we are going to generate will look like this…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/tree-02.png" alt="Simple tree layout diagram">
  <figcaption>Simple tree layout diagram</figcaption>
</figure>


<aside class="question blurb">
    <p>You might well be asking why, when introducing the topic of tree diagrams we showed a horizontal tree and why we are now going to draw a vertical tree diagram. That would be a good question that deserves a good answer.  When we look at the code for drawing a vertical tree diagram it will look logical and we will be able to describe it beautifully. That’s because the default standard when D3 is drawing a tree diagram is to have it going from top to bottom. When we look at a horizontal tree diagram, the diagram and the code has to be rotated by 90 degrees. This means that when we go to move or draw something in the x direction we will need to move in the y direction in the code and vice versa. It has the potential to be quite confusing, so if we consider the vertical diagram first and then rotate everything it seems much easier. Trust me.  </p>

</aside>

<p>The full code for it looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code> <code class="c">/* set the CSS */</code>
    
<code class="nc">.node</code> <code class="nt">circle</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="m">#fff</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">3px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>

<code class="nc">.node--internal</code> <code class="nt">text</code> <code class="p">{</code>
  <code class="nb">text-shadow</code><code class="o">:</code> <code class="m">0</code> <code class="m">1px</code> <code class="m">0</code> <code class="m">#fff</code><code class="o">,</code> <code class="m">0</code> <code class="m">-1px</code> <code class="m">0</code> <code class="m">#fff</code><code class="o">,</code> <code class="m">1px</code> <code class="m">0</code> <code class="m">0</code> <code class="m">#fff</code><code class="o">,</code> <code class="m">-1px</code> <code class="m">0</code> <code class="m">0</code> <code class="m">#fff</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.link</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>    	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"//d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
	
<code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code>
  <code class="p">{</code>
    <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
    <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
      <code class="p">{</code> 
		<code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code>
        <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
          <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Son of A"</code> <code class="p">},</code>
          <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Daughter of A"</code> <code class="p">}</code>
        <code class="p">]</code>
      <code class="p">},</code>
      <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: B"</code> <code class="p">}</code>
    <code class="p">]</code>
  <code class="p">};</code>

<code class="c1">// set the dimensions and margins of the diagram</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">40</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">50</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">30</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">660</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// declares a tree layout and assigns the size</code>
<code class="kd">var</code> <code class="nx">treemap</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">tree</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">width</code><code class="p">,</code> <code class="nx">height</code><code class="p">]);</code>

<code class="c1">//  assigns the data to a hierarchy using parent-child relationships</code>
<code class="kd">var</code> <code class="nx">nodes</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">hierarchy</code><code class="p">(</code><code class="nx">treeData</code><code class="p">);</code>

<code class="c1">// maps the node data to the tree layout</code>
<code class="nx">nodes</code> <code class="o">=</code> <code class="nx">treemap</code><code class="p">(</code><code class="nx">nodes</code><code class="p">);</code>

<code class="c1">// append the svg obgect to the body of the page</code>
<code class="c1">// appends a 'group' element to 'svg'</code>
<code class="c1">// moves the 'group' element to the top left margin</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">),</code>
    <code class="nx">g</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
            <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// adds the links between the nodes</code>
<code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code> <code class="nx">nodes</code><code class="p">.</code><code class="nx">descendants</code><code class="p">().</code><code class="nx">slice</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
       <code class="k">return</code> <code class="s2">"M"</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code>
         <code class="o">+</code> <code class="s2">"C"</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code>
         <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code>  <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code>
         <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code>
       <code class="p">});</code>

<code class="c1">// adds each node as a group</code>
<code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".node"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">descendants</code><code class="p">())</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
      <code class="k">return</code> <code class="s2">"node"</code> <code class="o">+</code> 
        <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">?</code> <code class="s2">" node--internal"</code> <code class="o">:</code> <code class="s2">" node--leaf"</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
      <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>

<code class="c1">// adds the circle to the node</code>
<code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>

<code class="c1">// adds the text to the node</code>
<code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">?</code> <code class="o">-</code><code class="mi">20</code> <code class="o">:</code> <code class="mi">20</code><code class="p">;</code> <code class="p">})</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">});</code>
    
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<aside class="information blurb">
    <p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/b024fcce8b4b9264011a1c3e7c7d70dc">github</a> or in the code samples bundled with this book (simple-vertical-tree-diagram.html). A working example can be found on <a href="http://bl.ocks.org/d3noob/b024fcce8b4b9264011a1c3e7c7d70dc">bl.ocks.org</a>. </p>

</aside>

<p>In the course of describing the operation of the file I will gloss over the aspects of the structure of an HTML file which have already been described at the start of the book. Likewise, aspects of the JavaScript functions that have already been covered will only be briefly explained.</p>

<p>The start of the file deals with setting up the document’s head and body loading the d3.js script and setting up the CSS in the <code>&lt;style&gt;</code> section.</p>

<p>The CSS section sets styling for the circle that represents the nodes, the text alongside them and the links between them.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.node</code> <code class="nt">circle</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="m">#fff</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">3px</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="nb">sans-serif</code><code class="p">;</code> <code class="p">}</code>

<code class="nc">.node--internal</code> <code class="nt">text</code> <code class="p">{</code>
  <code class="nb">text-shadow</code><code class="o">:</code> <code class="m">0</code> <code class="m">1px</code> <code class="m">0</code> <code class="m">#fff</code><code class="o">,</code> <code class="m">0</code> <code class="m">-1px</code> <code class="m">0</code> <code class="m">#fff</code><code class="o">,</code> <code class="m">1px</code> <code class="m">0</code> <code class="m">0</code> <code class="m">#fff</code><code class="o">,</code> <code class="m">-1px</code> <code class="m">0</code> <code class="m">0</code> <code class="m">#fff</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.link</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#ccc</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>Then our JavaScript section starts and the first thing that happens is that we declare our array of data in the following code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code>
  <code class="p">{</code>
    <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
    <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
      <code class="p">{</code> 
		<code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code>
        <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
          <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Son of A"</code> <code class="p">},</code>
          <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Daughter of A"</code> <code class="p">}</code>
        <code class="p">]</code>
      <code class="p">},</code>
      <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: B"</code> <code class="p">}</code>
    <code class="p">]</code>
  <code class="p">};</code>
</pre></div>

</figure>

<p>As outlined at the start of the chapter, this data is encoded hierarchically in JavaScript Object Notation (JSON). Each node must have a name and if it is going to have subordinate nodes it must include a ‘children’ element. There are many examples of hierarchical data that can be encoded in this way. From the traditional parent - offspring example to directories on a hard drive or a breakdown of materials for a complex object. Any system of encoding where there is a single outcome from multiple sources like an election or an alert encoding system dependent on multiple trigger points.</p>

<p>The next section of our code declares some of the standard features for our diagram such as the size and shape of the svg container with margins included.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// set the dimensions and margins of the diagram</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">40</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">90</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">50</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">90</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">660</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">500</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>Now we start to get into the specifics for the diagram. The next block of code invokes the D3 <code>.tree</code> component, configures the data and assigns it to the tree structure (no actual drawing mind you, just getting the data ready).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// declares a tree layout and assigns the size</code>
<code class="kd">var</code> <code class="nx">treemap</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">tree</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">width</code><code class="p">,</code> <code class="nx">height</code><code class="p">]);</code>

<code class="c1">//  assigns the data to a hierarchy using parent-child relationships</code>
<code class="kd">var</code> <code class="nx">nodes</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">hierarchy</code><code class="p">(</code><code class="nx">treeData</code><code class="p">);</code>

<code class="c1">// maps the node data to the tree layout</code>
<code class="nx">nodes</code> <code class="o">=</code> <code class="nx">treemap</code><code class="p">(</code><code class="nx">nodes</code><code class="p">);</code>
</pre></div>

</figure>

<p>The first part of this is the declaration of <code>treemap</code> as using the <code>d3.tree</code> function and assigning the size of the diagram from our earlier variables;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// declares a tree layout and assigns the size</code>
<code class="kd">var</code> <code class="nx">treemap</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">tree</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">width</code><code class="p">,</code> <code class="nx">height</code><code class="p">]);</code>
</pre></div>

</figure>

<p>Then we assign our data (with the variable <code>treeData</code>) to <code>nodes</code> using the <code>d3.hierarchy</code> function.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">//  assigns the data to a hierarchy using parent-child relationships</code>
<code class="kd">var</code> <code class="nx">nodes</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">hierarchy</code><code class="p">(</code><code class="nx">treeData</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code><code class="p">;</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>This assigns a range of properties to each node including;</p>

<ul>
  <li>
<code>node.data</code> - the data associated with the node (in our case it will include the name accessible as <code>node.data.name</code>)</li>
  <li>
<code>node.depth</code> - a representation of the depth or number of hops from the initial ‘root’ node.</li>
  <li>
<code>node.height</code> - the greatest distance from any descendant leaf nodes</li>
  <li>
<code>node.parent</code> - the parent node, or null if it’s the root node</li>
  <li>
<code>node.children</code> - child nodes or undefined for any leaf nodes</li>
</ul>

<p>While we’re telling the function to use the ‘children’ elements from ‘treeData’, to generate the properties for the nodes, by default it will use the name ‘<em>children</em>’ if a name is not specified. </p>

<p>Lastly for this block we map the ‘nodes’ data to the tree layout;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// maps the node data to the tree layout</code>
<code class="nx">nodes</code> <code class="o">=</code> <code class="nx">treemap</code><code class="p">(</code><code class="nx">nodes</code><code class="p">);</code>
</pre></div>

</figure>

<p>The next block of code appends our SVG working area to the body of our web page and creates a group element (<code>&lt;g&gt;</code>) that will contain our svg objects (our nodes, text and links).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">),</code>
    <code class="nx">g</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code>
            <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Now we’re going to start drawing something! First up is the trickiest part. The links between the nodes. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// adds the links between the nodes</code>
<code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code> <code class="nx">nodes</code><code class="p">.</code><code class="nx">descendants</code><code class="p">().</code><code class="nx">slice</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
       <code class="k">return</code> <code class="s2">"M"</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code>
         <code class="o">+</code> <code class="s2">"C"</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code>
         <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code>  <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code>
         <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code>
       <code class="p">});</code>
</pre></div>

</figure>

<p>I say <em>tricky</em> because we’re going to be using the svg mini language again, and while it will work just fine if we simply paste it in and move on, if we want to understand a bit more about how it works, we will need to take a bit of a detour.</p>

<p>But first we need to get the details for this block of code explained. We declare and select all the ‘links’ and then assign the nodes as ‘data’ (<code>.data(nodes.descendants().slice(1))</code>). When we do this we are using  <code>.descendants()</code> to return the array of ‘descendant’ nodes. We also specify <code>.slice(1)</code> to not include the main ‘root’ node since the links will be drawn by drawing a line from a child node to its parent (which we wouldn’t be able to do with the root node).</p>

<p>We append a path (<code>.enter().append("path")</code>) and apply some styling (<code>.attr("class", "link")</code>) and then embark on drawing the link lines with the SVG mini language via the ‘d’ attribute.</p>

<p>As we have mentioned previously the ‘d’ attribute allows for the creation of a string of instructions that describe a path. These instructions include;</p>

<ul>
  <li>Moveto : moves the drawing point using <code>M</code> for absolute coordinates and <code>m</code> for relative movements </li>
  <li>Lineto : draws a straight line from the current position to the next specified location using <code>L</code> for absolute coordinates and <code>l</code> for relative movement.</li>
  <li>Curveto : draws a <a href="https://developer.mozilla.org/en-US/docs/User:Jt_Sandbox/Curves_in_Paths">Bezier curve</a> using control points from the current position to an end point. <code>C</code> designates absolute coordinates and <code>c</code> is used for relative movement. Either one or two sets of control points are used depending on whether a quadratic or cubic Bezier curve is used. </li>
  <li>Arcto : describes a curved path as an elliptical curve rather than a Bezier with additional complexity</li>
  <li>ClosePath : draws a straight line from the current position to the first point in the path</li>
</ul>

<p>If we look at a single node instance and break down the ‘d’ attribute path we can see the following;</p>

<ul>
  <li>
<code>"M" + d.x + "," + d.y</code> : Moves to the starting point of our node</li>
  <li>
<code>"C" + d.x + "," + (d.y + d.parent.y) / 2</code> : Establishes that we are going to draw a Cubic (<code>C</code>) Bezier curve and the first control point for it is at <code>d.x</code> in the x dimension and halfway between the starting node and its parent.</li>
  <li>
<code>" " + d.parent.x + "," +  (d.y + d.parent.y) / 2</code> : Sets the second control point for the curve in line with the parent node in the x dimension and still halfway between the starting node and its parent in the y dimension.</li>
  <li>
<code>" " + d.parent.x + "," + d.parent.y</code> : sets the end point for our curve at the parent node location.</li>
</ul>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/tree-03.png" alt="Tree layout node locations for links">
  <figcaption>Tree layout node locations for links</figcaption>
</figure>


<p>If we wanted to make the code easier to follow we could change the curve between nodes to a straight line with the following code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// adds the links between the nodes</code>
<code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code> <code class="nx">nodes</code><code class="p">.</code><code class="nx">descendants</code><code class="p">().</code><code class="nx">slice</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
       <code class="k">return</code> <code class="s2">"M"</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code>
         <code class="o">+</code> <code class="s2">"L"</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code>
       <code class="p">});</code>
</pre></div>

</figure>

<p>Which would result in lines being drawn with coordinates from the ‘d’ attribute as follows;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/tree-03a.png" alt="Tree layout node locations for links">
  <figcaption>Tree layout node locations for links</figcaption>
</figure>


<p>Then we create a variable <code>node</code> that creates a group element (<code>g</code>) for each node;  </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// adds each node as a group</code>
<code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".node"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">descendants</code><code class="p">())</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
      <code class="k">return</code> <code class="s2">"node"</code> <code class="o">+</code> 
        <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">?</code> <code class="s2">" node--internal"</code> <code class="o">:</code> <code class="s2">" node--leaf"</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
      <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>This time we can see that;</p>

<ul>
  <li>We don’t slice off the root node (<code>.data(nodes.descendants())</code>) from our data set.</li>
  <li>We apply a different ‘class’ to the node depending on whether it’s an internal node (it has children) or it’s a leaf node (it has no children) <code>d.children ? " node--internal" : " node--leaf"</code>.  </li>
  <li>We place each node ‘group’ at the appropriate location.</li>
  <li>We don’t <em>actually</em> draw anything. All we’re doing is getting the properties for each node set.</li>
</ul>

<p>Once we have everything set up we can start to add objects to our node groups.</p>

<p>First we add our circle;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// adds the circle to the node</code>
<code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
</pre></div>

</figure>

<p>And then we add the text;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// adds the text to the node</code>
<code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">?</code> <code class="o">-</code><code class="mi">20</code> <code class="o">:</code> <code class="mi">20</code><code class="p">;</code> <code class="p">})</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>When we’re adding the text, we make sure that we add it on the side appropriate for either a leaf node or an internal node.</p>

<p>And there’s our tree diagram.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/tree-02.png" alt="Simple tree layout diagram">
  <figcaption>Simple tree layout diagram</figcaption>
</figure>


<div class="page-break"></div>

<h3 id="leanpub-auto-a-horizontal-tree-diagram-explained">A horizontal tree diagram explained</h3>

<p>As we discussed at the start of the previous section, we wanted to start describing tree diagrams with a vertical version because there was an added degree of complexity with the horizontal version that might cause some confusion. If you have worked through and understood the vertical version, the horizontal won’t present any problems other than when you go “<em>Oh, I see what’s going on.</em>”. If you find yourself part way through this description of the changes to the code and can’t see what’s going on, revisit the vertical code and come back.</p>

<p>The graphic that we are going to generate will look like this…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/htree-01.png" alt="Horizontal tree layout diagram">
  <figcaption>Horizontal tree layout diagram</figcaption>
</figure>


<p>The full code for this is almost identical to the code for the vertical tree diagram with a couple of simple, yet major changes.</p>

<p>The first change is that the way that we draw the diagram relies on changing our reference by rotating everything by 90 degrees.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/htree-02.png" alt="Rotate the tree by 90 degrees">
  <figcaption>Rotate the tree by 90 degrees</figcaption>
</figure>


<p>The (very simplistic) diagram shows that what used to be our ‘x’ dimension is now our ‘y’ dimension and visa versa.</p>

<p>The second change is that where we rotated our axes above we are now left with y and x dimensions that have an origin in the bottom left of the graph. Of course when we draw our diagram, the origin is in the top left corner. This vertical flip occurs automatically and is the reason the diagram doesn’t appear to have ‘just’ rotated.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/htree-03.png" alt="Flip the tree vertically">
  <figcaption>Flip the tree vertically</figcaption>
</figure>


<p>Now we have our origin in the top left again and the layout of our tree looks pretty much as the example we will be producing.</p>

<p>Believe it or not, this is <strong>WAY</strong> more difficult to explain than it is to actually do. Again, D3 takes care of the heavy lifting, the explanation of the changes above is just to help us understand <em>why</em> we make some of the changes.</p>

<p>The first change we make is just to give ourselves some extra margin space since some of the labels extend slightly more left and right with a horizontal diagram;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">90</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">90</code><code class="p">},</code>
</pre></div>

</figure>

<p>The second change sets the size of the graphic. Here the width and height are swapped as part of the rotation. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// declares a tree layout and assigns the size</code>
<code class="kd">var</code> <code class="nx">treemap</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">tree</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>
</pre></div>

</figure>

<p>When we add the links we need to incorporate the rotation and the easiest way to appreciate the change is to compare the two pieces of code at the same time. In fact it is only when we draw the ‘d’ attribute for the path that we see the changes.</p>

<div class="page-break"></div>
<p>Firstly the vertical tree code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
       <code class="k">return</code> <code class="s2">"M"</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code>
         <code class="o">+</code> <code class="s2">"C"</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code>
         <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code>  <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code>
         <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">;</code>
       <code class="p">});</code>
</pre></div>

</figure>

<p>Then the horizontal tree code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
       <code class="k">return</code> <code class="s2">"M"</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code>
         <code class="o">+</code> <code class="s2">"C"</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code>
         <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">x</code>
         <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">x</code><code class="p">;</code>
       <code class="p">});</code>
</pre></div>

</figure>

<p>While there is a bit of math involved, the easiest way to tell that there is a difference is that for the horizontal tree, each coordinate is being described in y,x fashion rather than the conventional x,y.</p>

<p>A similar coordinate change is made when we translate the positions for the nodes;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
      <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>And lastly when we place the text next to the circles we need to adjust the default ‘y’ distance value with an ‘x’ distance value and to ensure that the labels are spaced at an appropriate distance and to align the text to either the left or right depending on whether it has children or not. We adjust the text anchor appropriately with an ‘end’ or ‘start’.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">?</code> <code class="o">-</code><code class="mi">13</code> <code class="o">:</code> <code class="mi">13</code><code class="p">;</code> <code class="p">})</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
    <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">?</code> <code class="s2">"end"</code> <code class="o">:</code> <code class="s2">"start"</code><code class="p">;</code> <code class="p">})</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>And there we are….</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/htree-01.png" alt="Horizontal tree layout diagram">
  <figcaption>Horizontal tree layout diagram</figcaption>
</figure>


<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/5537fe63086c4f100114f87f124850dd">github</a>, or in the code samples bundled with this book (simple-horizontal-tree-diagram.html). A working example can be found on <a href="http://bl.ocks.org/d3noob/5537fe63086c4f100114f87f124850dd">bl.ocks.org</a>. </p>

<div class="page-break"></div>

<h3 id="leanpub-auto-styling-nodes-in-a-tree-diagram">Styling nodes in a tree diagram</h3>

<h4 id="tree-styling">Changing node and link colours</h4>

<p>The nodes in a tree diagram are objects that exist to provide a representation of the structure of data, but on a tree diagram they should also be viewed as an opportunity to encode additional information about the underlying data. </p>

<p>From the horizontal example shown we have encoded a certain amount of information already. The position of the text relative to each node is determined by whether or not the node is the parent of another node (if it’s a parent it’s on the left) or a child that is on the edge of the tree (in which case it is on the right of the node).</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/htree-01.png" alt="Node position on the tree diagram">
  <figcaption>Node position on the tree diagram</figcaption>
</figure>


<p>Now, that’s nice, but are we going to be satisfied with that??? (The answer is “No” by the way.)</p>

<p>This example is fairly simple, but it is an example of applying different styles to the nodes to convey additional information. I should be clear at this stage that I am not advocating turning your tree diagram into something that looks like it came out of a circus, because that would be a crime against style, so don’t repeat my upcoming example, but let some of the features be a trigger for developing your own subtle, yet compelling visualizations.</p>

<p>Brace yourself. Here’s a picture of the tree diagram that we’re going to generate. Those with weaker constitutions should look away and flip forward a few pages;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/tree-07.png" alt="Tree diagram with excessive styling">
  <figcaption>Tree diagram with excessive styling</figcaption>
</figure>


<p>The changes that have been made are as a result of additional data fields that have been added to the JSON array and these fields have been applied to various style options throughout the code.</p>

<p>The types of style changes we have made are
- Variation of the diameter of nodes
- Changing the fill and stroke colour of nodes
- Changing the colour of links depending on the associated node they are connected to.</p>

<p>The code changes we describe from here are assuming that we start with our simple horizontal tree diagram from the previous chapter. We’ll start by looking at the new JSON data set;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  {
    "name": "Top Level",
    "value": 10,
    "type": "black",
    "level": "red",
    "children": [
      {
        "name": "Level 2: A",
        "value": 15,
        "type": "grey",
        "level": "red",
        "children": [
          {
            "name": "Son of A",
            "value": 5,
            "type": "steelblue",
            "level": "orange"
          },
          {
            "name": "Daughter of A",
            "value": 8,
            "type": "steelblue",
            "level": "red"
          }
        ]
      },
      {
        "name": "Level 2: B",
        "value": 10,
        "type": "grey",
        "level": "green"
      }
    ]
  }
</pre></div>

</figure>

<p>Each node now has a <code>value</code> which might represent a degree of importance (we will use this to affect the radius of the nodes), a <code>type</code> which might indicate a difference in the type of node (they might be in active, inactive or undetermined states) and a <code>level</code> which might indicate an alert level for determining problems (red = bad, orange = caution and green = normal).</p>

<p>Irrespective of the contrived nature of our styling options, they are applied to our tree in fairly similar ways with some subtle differences.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/08ecb6ea9bb68ba0d9a7e89f344acec8">github</a> or in the code samples bundled with this book (tree-styling.html). A working example can be found on <a href="http://bl.ocks.org/d3noob/08ecb6ea9bb68ba0d9a7e89f344acec8">bl.ocks.org</a>.</p>

<p>The first change is to the node radius, stroke colour and fill colour.</p>

<p>We simply change the portion of the code that appends the circle from this…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// adds the circle to the node</code>
<code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
</pre></div>

</figure>

<p>… to this …</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// adds the circle to the node</code>
<code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">})</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">type</code><code class="p">;</code> <code class="p">})</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">level</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>The changes return the radius attribute as a function using <code>data.value</code>, the stroke colour is returned using <code>data.type</code> and the fill colour is returned with <code>data.level</code>. This is nice and simple, but we do need to make a slight adjustment to the code that sets the distance that the text is from the nodes so that when the radius expands or contracts, the text distance from the edge of the node adjusts as well.</p>

<p>To do this we take the clever piece of code that adjusts the distance that the text is in the x dimension from the node that looks like this … </p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">?</code> <code class="o">-</code><code class="mi">13</code> <code class="o">:</code> <code class="mi">13</code><code class="p">;</code> <code class="p">})</code>
</pre></div>

</figure>

<p>… and we add in a dynamic aspect using the <code>data.value</code> field.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">?</code> 
    <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">value</code> <code class="o">+</code> <code class="mi">4</code><code class="p">)</code> <code class="o">*</code> <code class="o">-</code><code class="mi">1</code> <code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">value</code> <code class="o">+</code> <code class="mi">4</code> <code class="p">})</code>
</pre></div>

</figure>

<p>The last thing we wanted to do is to change the colour of the link based on the colour of the node. We accomplish this by taking the code that inserts the links…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// adds the links between the nodes</code>
<code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code> <code class="nx">nodes</code><code class="p">.</code><code class="nx">descendants</code><code class="p">().</code><code class="nx">slice</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
       <code class="k">return</code> <code class="s2">"M"</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code>
         <code class="o">+</code> <code class="s2">"C"</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code>
         <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">x</code>
         <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">x</code><code class="p">;</code>
       <code class="p">});;</code>
</pre></div>

</figure>

<p>… and adding in a line that styles the link colour (the stroke) based on the <code>data.level</code> colour of node. </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// adds the links between the nodes</code>
<code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">g</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">data</code><code class="p">(</code> <code class="nx">nodes</code><code class="p">.</code><code class="nx">descendants</code><code class="p">().</code><code class="nx">slice</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">level</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
       <code class="k">return</code> <code class="s2">"M"</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code>
         <code class="o">+</code> <code class="s2">"C"</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code>
         <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code><code class="p">)</code> <code class="o">/</code> <code class="mi">2</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">x</code>
         <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">.</code><code class="nx">x</code><code class="p">;</code>
       <code class="p">});</code>
</pre></div>

</figure>

<p>Use the concepts here wisely. I don’t want to see any heinously styled tree diagrams floating around the internet with “Thanks to the help from D3 Tips and Tricks” next to them. Be subtle, be thoughtful :-).</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-changing-the-nodes-to-different-shapes">Changing the nodes to different shapes</h4>

<p>Many thanks to Josiah who <a href="http://www.d3noob.org/2014/01/tree-diagrams-in-d3js_11.html?showComment=1398062145979#c8289012474475643167">asked a question</a> on the d3noob.org blog on how the shapes of the nodes could be varied based on an associated value in the data.</p>

<p>There is more than one way to do this, but perhaps the simplest is to replace the section of the JavaScript that appends the circle with one that appends a symbol from d3’s <a href="https://github.com/d3/d3-shape/blob/master/README.md#symbols">symbol generator</a>.</p>

<p>There are six pre-defined symbol types as follows;</p>

<ul>
  <li>circle (<code>d3.symbolCircle</code>) - a circle.</li>
  <li>cross (<code>d3.symbolCross</code>) - a Greek cross or plus sign.</li>
  <li>diamond (<code>d3.symbolDiamond</code>) - a rhombus.</li>
  <li>square (<code>d3.symbolSquare</code>) - an axis-aligned square.</li>
  <li>triangle (<code>d3.symbolTriangle</code>) - an upward-pointing equilateral triangle.</li>
  <li>star (<code>d3.symbolStar</code>) - a five pointed star.</li>
  <li>‘Y’ (<code>d3.symbolWye</code>) - a ‘Y’ shape.</li>
</ul>

<p>If we start with our ‘<a href="#tree-styling">tree-styling</a>’ script from above we can replace the code  block that added the circles with the following script will look at the <code>value</code> in the data and assign either a cross or a diamond depending on the <code>value</code></p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// adds symbols as nodes</code>
<code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">type</code><code class="p">;</code> <code class="p">})</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">level</code><code class="p">;</code> <code class="p">})</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">symbol</code><code class="p">()</code>
     <code class="p">.</code><code class="nx">size</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">value</code> <code class="o">*</code> <code class="mi">30</code><code class="p">;</code> <code class="p">}</code> <code class="p">)</code>
     <code class="p">.</code><code class="nx">type</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">if</code>
       <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">value</code> <code class="o">&gt;=</code> <code class="mi">9</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">symbolCross</code><code class="p">;</code> <code class="p">}</code> <code class="k">else</code> <code class="k">if</code>
       <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">value</code> <code class="o">&lt;=</code> <code class="mi">9</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">symbolDiamond</code><code class="p">;}</code>
     <code class="p">}));</code>
</pre></div>

</figure>

<p>It will also adjust the size of the symbol along with the stroke and fill.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/tree-12.png" alt="Tree diagram different node shapes">
  <figcaption>Tree diagram different node shapes</figcaption>
</figure>


<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/76d6fa0dff4af77544da9dd69aef9249">github</a> or in the code samples bundled with this book (tree-symbol.html). A working online example can be found on <a href="http://bl.ocks.org/d3noob/76d6fa0dff4af77544da9dd69aef9249">bl.ocks.org</a>.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-using-images-as-nodes">Using images as nodes</h4>

<p>Many thanks to nbhatta who <a href="http://www.d3noob.org/2014/01/tree-diagrams-in-d3js_11.html?showComment=1399025834455#c4911480988339223702">asked a question</a> on the d3noob.org blog on how to use images as nodes.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/tree-13.png" alt="Tree diagram with images for nodes">
  <figcaption>Tree diagram with images for nodes</figcaption>
</figure>


<p>This was a slightly simpler change and just involved replacing the code snippet that added the circles with one that added an image;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// adds images as nodes</code>
<code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"image"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"xlink:href"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">icon</code><code class="p">;</code> <code class="p">})</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="s2">"-12px"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="s2">"-12px"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="s2">"24px"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="s2">"24px"</code><code class="p">);</code>
</pre></div>

</figure>

<p>The images I chose were all 48 x 48 pixel for the sake of consistency and in the code above I formatted them to be half that size and moved them in the x and y direction so that they were centred correctly.</p>

<p>The cool thing that you will notice is that the specific icon that is placed at each node position is set by the name of the icon which is gathered from the JSON file with the tree details;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code> 
  <code class="p">{</code>
    <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
    <code class="s2">"value"</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code>
    <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"black"</code><code class="p">,</code>
    <code class="s2">"level"</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">,</code>
    <code class="s2">"icon"</code><code class="o">:</code> <code class="s2">"earth.png"</code><code class="p">,</code>
    <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code>
        <code class="s2">"value"</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
        <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"grey"</code><code class="p">,</code>
        <code class="s2">"level"</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">,</code>
       <code class="s2">"icon"</code><code class="o">:</code> <code class="s2">"cart.png"</code><code class="p">,</code>
        <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Son of A"</code><code class="p">,</code>
            <code class="s2">"value"</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
            <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"steelblue"</code><code class="p">,</code>
            <code class="s2">"icon"</code><code class="o">:</code> <code class="s2">"lettern.png"</code><code class="p">,</code>
            <code class="s2">"level"</code><code class="o">:</code> <code class="s2">"orange"</code>
          <code class="p">},</code>
          <code class="p">{</code>
            <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Daughter of A"</code><code class="p">,</code>
            <code class="s2">"value"</code><code class="o">:</code> <code class="mi">18</code><code class="p">,</code>
            <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"steelblue"</code><code class="p">,</code>
            <code class="s2">"icon"</code><code class="o">:</code> <code class="s2">"vlc.png"</code><code class="p">,</code>
            <code class="s2">"level"</code><code class="o">:</code> <code class="s2">"red"</code>
          <code class="p">}</code>
        <code class="p">]</code>
      <code class="p">},</code>
      <code class="p">{</code>
        <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: B"</code><code class="p">,</code>
        <code class="s2">"value"</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code>
        <code class="s2">"type"</code><code class="o">:</code> <code class="s2">"grey"</code><code class="p">,</code>
        <code class="s2">"icon"</code><code class="o">:</code> <code class="s2">"random.png"</code><code class="p">,</code>
        <code class="s2">"level"</code><code class="o">:</code> <code class="s2">"green"</code>
      <code class="p">}</code>
    <code class="p">]</code>
  <code class="p">};</code>
</pre></div>

</figure>

<p>It’s possible to just have a single image and to hard-code it into the script, but where’s the fun in that? </p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/52945c64ab37f9f285c8797bcbf86d16">github</a> or in the code samples bundled with this book (tree-images.html, cart.png, earth.png, lettern.png, random.png and vlc.png). A working online example can be found on <a href="http://bl.ocks.org/d3noob/52945c64ab37f9f285c8797bcbf86d16">bl.ocks.org</a>.</p>

<div class="page-break"></div>

<h3 id="treeFromExternal">Generating a tree diagram from external data</h3>

<p>In all the examples we have looked at so far we have used data that we have declared from within the file itself. Being able to import data from an external file is an important feature that we need to know how to implement.</p>

<p>Starting from the simple tree diagram example that we began with at the start of the chapter, the first change that we need to make is to remove the section of code that declares our data.  But don’t throw it away since we will use it to create a separate file called <code>treeData.json</code>. Its contents will be;</p>

<figure class="code">
<div class="highlight"><pre><code></code>{
  "name": "Top Level",
  "children": [
    { 
      "name": "Level 2: A",
      "children": [
        { "name": "Son of A" },
        { "name": "Daughter of A" }
      ]
    },
    { "name": "Level 2: B" }
  ]
}
</pre></div>

</figure>

<p>(don’t include the <code>treeData =</code> part, or the semicolon at the end (you <em>can</em> delete those))</p>

<p>Then all we need to do is include a section that uses the <code>d3.json</code> accessor to load  the file <code>treeData.json</code> (Remember to correctly address the file. This one assumes that the <code>treeData.json</code> file is in the same directory as the html file we are opening). </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// load the external data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"treeData.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">treeData</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>
</pre></div>

</figure>

<p>We can put it somewhere near the start of the JavaScript, but make sure it comes before the ‘nodes’ declaration (when in doubt, check out the sample code).</p>

<p>We also need to make sure that we include the wrapping, closing curly braces and bracket / semicolon (<code>});</code>) at the end of the script.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/d316a488cae262ae24e6ca897b209f9e">github</a> or in the code samples bundled with this book (tree-from-external.html and treeData.json). A working example can be found on <a href="http://bl.ocks.org/d3noob/d316a488cae262ae24e6ca897b209f9e">bl.ocks.org</a>.</p>

<div class="page-break"></div>

<h3 id="treeFromFlat">Generating a tree diagram from ‘flat’ data</h3>

<p>Tree diagrams are a fantastic way of displaying information, but one of the drawbacks (to the examples we’ve been using so far) is the need to have your data encoded hierarchically. Most data in a raw form will be flat. That is to say, it won’t be formatted as an array with the parent - child relationships. Instead it will be a list of objects (which we will want to turn into nodes) that might describe the relationship to each other, but they won’t be encoded that way. For example, the following is the flat representation of the example data we have been using thus far.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  {"name": "Top Level", "parent": null}, 
  {"name": "Level 2: A", "parent": "Top Level" },
  {"name": "Level 2: B", "parent": "Top Level" },
  {"name": "Son of A", "parent": "Level 2: A" },
  {"name": "Daughter of A", "parent": "Level 2: A" }
</pre></div>

</figure>

<p>It is actually fairly simple and consists of only the name of the node and the name of its parent node. It’s easy to see how this data could be developed into a hierarchical form, but it would take a little time and for a larger data set, that would be tiresome.</p>

<p>Luckily computers are built for shuffling data about and with the advent of v4 of d3.js we now have the <code>d3.stratify</code> operator that will convert flat data into a hierarchy suitable for use in our tree diagram.</p>

<p>We will be using the simple example that we started with at the start of the chapter and the first change we need to make is to replace our original data…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code>
  <code class="p">{</code>
    <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code>
    <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
      <code class="p">{</code> 
		<code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code>
        <code class="s2">"children"</code><code class="o">:</code> <code class="p">[</code>
          <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Son of A"</code> <code class="p">},</code>
          <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Daughter of A"</code> <code class="p">}</code>
        <code class="p">]</code>
      <code class="p">},</code>
      <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: B"</code> <code class="p">}</code>
    <code class="p">]</code>
  <code class="p">};</code>
</pre></div>

</figure>

<p>… with our flat data array…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">flatData</code> <code class="o">=</code> <code class="p">[</code>
  <code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Top Level"</code><code class="p">,</code> <code class="s2">"parent"</code><code class="o">:</code> <code class="kc">null</code><code class="p">},</code> 
  <code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code><code class="p">,</code> <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code> <code class="p">},</code>
  <code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Level 2: B"</code><code class="p">,</code> <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Top Level"</code> <code class="p">},</code>
  <code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Son of A"</code><code class="p">,</code> <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code> <code class="p">},</code>
  <code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Daughter of A"</code><code class="p">,</code> <code class="s2">"parent"</code><code class="o">:</code> <code class="s2">"Level 2: A"</code> <code class="p">}</code>
<code class="p">];</code>
</pre></div>

</figure>

<p>It’s worth noting here that we have also changed the name of the array (to <code>flatData</code>) since we are going to convert, then declare our newly massaged data with our original variable name <code>treeData</code> so that the remainder of our code thinks there have been no changes.</p>

<p>Then we use the <code>d3.stratify</code> operator on our flat data; </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// convert the flat data into a hierarchy </code>
<code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">stratify</code><code class="p">()</code>
  <code class="p">.</code><code class="nx">id</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
  <code class="p">.</code><code class="nx">parentId</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">;</code> <code class="p">})</code>
  <code class="p">(</code><code class="nx">flatData</code><code class="p">);</code>
</pre></div>

</figure>

<p>The stratify function requires a unique identifier to be used for each node and it will be declared as <code>.id</code>. In this example each of our nodes has a unique ‘name’, so we are using that as our <code>id</code> (<code>.id(function(d) { return d.name; })</code>). We also need to understand the hierarchy by having each node identify who its parent is. This will be stored as <code>parentId</code> (<code>.parentId(function(d) { return d.parent; })</code>)</p>

<p>That’s it!</p>

<p>Because we want to be able to use our code as intact as possible from our horizontal tree example we will want to run through our dataset and assign the ‘name’ to each node that has been stored as <code>id</code>;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// assign the name to each node</code>
<code class="nx">treeData</code><code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d</code><code class="p">.</code><code class="nx">name</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">id</code><code class="p">;</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>That’s it! </p>

<p>The brevity of the code to do this is fantastic and well done to Mike Bostock for including the new function in v4. Of course, the end result looks exactly the same;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/htree-01.png" alt="Tree diagram (but from flat data)">
  <figcaption>Tree diagram (but from flat data)</figcaption>
</figure>


<p>… but it adds a significant capability for use of additional data.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/e7e37cfe0e8763cb0915dee33cc2a24b">github</a> or in the code samples bundled with this book (tree-from-flat.html). A working example can be found on <a href="http://bl.ocks.org/d3noob/e7e37cfe0e8763cb0915dee33cc2a24b">bl.ocks.org</a>.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-generating-a-tree-diagram-from-a-csv-file">Generating a tree diagram from a CSV file.</h3>

<p>Creating a tree diagram from a csv file is an extension of the sections where we <a href="#treeFromFlat">create a diagram from flat data</a> and where we <a href="#treeFromExternal">create a diagram from an external file</a>.</p>

<p>By mashing these together and using a csv file something like the following…</p>

<figure class="code">
<div class="highlight"><pre><code></code>name,parent
Top Level,null
Level 2: A,Top Level
Level 2: B,Top Level
Son of A,Level 2: A
Daughter of A,Level 2: A
</pre></div>

</figure>

<p>… we can ingest the name of the nodes and their relationships and then format the data correctly.</p>

<p>The main piece of code that we would add that is different from the standard horizontal tree diagram is as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// load the external data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"treeCsv.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">flatData</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>

  <code class="c1">// assign null correctly</code>
  <code class="nx">flatData</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">parent</code> <code class="o">==</code> <code class="s2">"null"</code><code class="p">)</code> <code class="p">{</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code> <code class="o">=</code> <code class="kc">null</code><code class="p">};</code>
    <code class="p">});</code>

  <code class="c1">// convert the flat data into a hierarchy </code>
  <code class="kd">var</code> <code class="nx">treeData</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">stratify</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">id</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">parentId</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">parent</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">(</code><code class="nx">flatData</code><code class="p">);</code>

  <code class="c1">// assign the name to each node</code>
  <code class="nx">treeData</code><code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">name</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">id</code><code class="p">;</code>
    <code class="p">});</code>
</pre></div>

</figure>

<p>The only part of that code which is new is the portion where we look for the node whose parent is ‘“null”’ and change it to null. This is necessary since the script interprets the name as actually being the text ‘null’ so we have to force the code to realise that we want it to refer to a null amount.</p>

<p>The end result looks very familiar.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/htree-01.png" alt="Tree diagram (but from csv)">
  <figcaption>Tree diagram (but from csv)</figcaption>
</figure>


<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/https://gist.github.com/d3noob/1dbf3d4abe0ab53f8c4c6bd24192bb6b">github</a> or in the code samples bundled with this book (tree-from-csv.html and treeCsv.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/1dbf3d4abe0ab53f8c4c6bd24192bb6b">bl.ocks.org</a>.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-an-interactive-tree-diagram">An interactive tree diagram</h3>

<p>The examples presented thus far have all been static in the sense that they present information on a web page, but that’s where they stop. One of the strengths of web content is the ability to involve the reader to a greater extent. Therefore the following tree diagram example includes an interactive element where the user can click on any parent node and it will collapse on itself to make more room for others or to simplify a view. Additionally, any collapsed parent node can be clicked on and it will re-grow to its previous condition.</p>

<p>The example included here has it’s roots in the is v3 tree diagram of <a href="http://bl.ocks.org/mbostock/4339083">Mike Bostock’s example</a>. Kudos and thanks also go out to Soumya Ranjan for steering me in the fight direction for the diagonal solution. This was necessary to work around the deprecation of <code>svg.diagonal</code> in v3.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/43a860bc0024792f8803bba8ca0d5ecd">github</a>, in the appendices of this book or in the code samples bundled with this book (interactive-tree.html). A working online example can be found on <a href="http://bl.ocks.org/d3noob/43a860bc0024792f8803bba8ca0d5ecd">bl.ocks.org</a>.</p>

<p>For a brief visual description of the action. The diagram will initially display a partially collapsed tree…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/tree-10.png" alt="Partially collapsed tree diagram)">
  <figcaption>Partially collapsed tree diagram)</figcaption>
</figure>


<p>Then when clicking on the ‘Level 2: A’ node, the tree expands to…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/htree-01.png" alt="Tree diagram)">
  <figcaption>Tree diagram)</figcaption>
</figure>


<p>We could also click on the root node (`Top Level’) to fully collapse the tree…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/tree-11.png" alt="Fully collapsed tree diagram)">
  <figcaption>Fully collapsed tree diagram)</figcaption>
</figure>


<p>Then clicking on the nodes opens the diagram back up again.</p>

<p>One of the important changes is to allow the diagram to follow the d3.js model of enter - update - exit for the nodes with a suitable transition in between.</p>

<p>Nodes are coloured (“steelblue”) if they have been collapsed and at the end of the script we have a function that makes use of the <code>d._children</code> reference we have been using in most of our examples.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">click</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">children</code><code class="p">)</code> <code class="p">{</code>
	<code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">children</code><code class="p">;</code>
	<code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
	<code class="nx">d</code><code class="p">.</code><code class="nx">children</code> <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">_children</code><code class="p">;</code>
	<code class="nx">d</code><code class="p">.</code><code class="nx">_children</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="nx">update</code><code class="p">(</code><code class="nx">d</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>This allows the action of clicking on the nodes to update the data associated with the node and as a consequence change it’s properties in the script based on if statements (Such as <code>"fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; }</code> which will fill the node with “lightsteelblue” if <code>d._children</code> exists, otherwise make it white.)</p>

<p>The examples we have looked at in the previous sections in this chapter are all applicable to this interactive version, so this should provide you with the capability to generate some interesting visualizations. </p>

<div class="page-break"></div>

<h2 id="leanpub-auto-sankey-diagrams">Sankey Diagrams</h2>

<h3 id="leanpub-auto-what-is-a-sankey-diagram">What is a Sankey Diagram?</h3>

<p>A Sankey diagram is a type of flow diagram where the ‘flow’ is represented by arrows of varying thickness depending on the quantity of flow.</p>

<p>They are often used to visualize energy, material or cost transfers and are especially useful in demonstrating proportionality to a flow where different parts of the diagram represent different quantities in a system.</p>

<p>Probably the most famous example of a Sankey diagram is Charles Minard’s Map of Napoleon’s Russian Campaign of 1812.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/sankey01.png" alt="Napoleon's Russian March">
  <figcaption>Napoleon’s Russian March</figcaption>
</figure>


<p>From Wikipedia;</p>

<p>“<em>Étienne-Jules Marey first called notice to this dramatic depiction of the fate of Napoleon’s army in the Russian campaign, saying it defies the pen of the historian in its brutal eloquence. Edward Tufte says it “may well be the best statistical graphic ever drawn” and uses it as a prime example in The Visual Display of Quantitative Information</em>.”</p>

<p>Wikipedia has a great explanation of the <a href="http://en.wikipedia.org/wiki/Sankey_diagram">diagram type</a> and there is a wealth of information dedicated to it on the inter-web. I heartily recommend http://www.sankey-diagrams.com/ for all things Sankey!</p>

<p>So it would come as little surprise that Mike Bostock has developed a plugin for Sankey diagrams (http://bost.ocks.org/mike/sankey/) so that we can all enjoy Sankey goodness with lashings of D3.</p>

<h3 id="leanpub-auto-which-sankey-plugin-should-we-use">Which Sankey plugin should we use?</h3>

<p>Hmmmm…… Good question.</p>

<p>As at the time of writing there were 4 different sankey plugins listed on the <a href="https://github.com/d3/d3/wiki/Plugins">d3 wiki</a> (including the vertical one). The examples we will walk through have used the plugins from <a href="https://github.com/soxofaan/d3-plugin-captain-sankey">Stefaan Lippens</a> and <a href="https://github.com/d3/d3-plugins/tree/master/sankey">Jason Davies</a> without problem. I have used the Jason Davies version for no other reason than it appears to be the originator from which others have been derived.</p>

<div class="page-break"></div>

<h3 id="sankeydata">How d3.js Sankey Diagrams want their data formatted</h3>

<p>If we think of Sankey diagrams consisting of ‘nodes’ and ‘links’…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/sankey02.png" alt="A simple Sankey diagram">
  <figcaption>A simple Sankey diagram</figcaption>
</figure>


<p>… the data that generates them must be formatted as nodes and links as well.</p>

<p>For instance a JSON file with appropriate data to build the diagram above could look like the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code>{
"nodes":[
{"node":0,"name":"node0"},
{"node":1,"name":"node1"},
{"node":2,"name":"node2"},
{"node":3,"name":"node3"},
{"node":4,"name":"node4"}
],
"links":[
{"source":0,"target":2,"value":2},
{"source":1,"target":2,"value":2},
{"source":1,"target":3,"value":2},
{"source":0,"target":4,"value":2},
{"source":2,"target":3,"value":2},
{"source":2,"target":4,"value":2},
{"source":3,"target":4,"value":4}
]}
</pre></div>

</figure>

<p>In the file above we have 6 nodes (0-5) sequentially numbered and with names appropriate to their position in the list. </p>

<p>The sequential numbering is only for the purpose of highlighting the structure of the data, since when we get D3 running, it will automatically index each of the nodes according to its position. In other words, we could have omitted the “node”:n parts since D3 will know where each node is anyway. The big deal is that <em>WE</em> need to know what each node is as well. Especially if we’re going to be building the data by hand (doing it dynamically would be cool, but let’s not get ahead of ourselves just yet).</p>

<p>The ‘links’ part of the data can be broken down into individual source to target ‘links’ that have an associated value (could be a quantity or strength, but at least a numeric value).</p>

<p>The ‘source’ and ‘target’ numbers are references to the list of nodes. So, “source”:1, “target”:2 means that this link is whatever node appears at position 1 going to whatever node appears at position 2. The important point to make here is that D3 will not be interested in the numerical value of the node, just its position in the list (starting at zero).</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-description-of-the-code">Description of the code</h3>
<p>The code for the Sankey diagram is significantly different to that for a <a href="#simplegraph">line graph</a> although it shares the same core language and programming methodology. </p>

<p>The code we’ll go through is an adaptation of the <a href="http://bost.ocks.org/mike/sankey/">version first demonstrated by Mike Bostock</a> so it’s got a pretty good pedigree. We will begin with a version that uses data that is formatted so that it can be used directly with no manipulation, then in subsequent sections we will work on different techniques for getting data from different formats (and with different structures) to work. </p>

<p>I found that getting data in the correct format was the biggest hurdle for getting a Sankey diagram to work. We will start off assuming that the data is perfectly formatted, then where only the link data is available, then where there is just names to work with (no numeric node values) and lastly, one that can be used for people with changeable data from a MySQL database.</p>

<p>We won’t try to go over every inch of the code as we did with the <a href="#simplegraph">simple graph example</a> (I’ll skip things like the HTML header) and will focus on the style sheet (CSS) portion and the JavaScript.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/013054e8d7807dff76247b81b0e29030">github</a> or in the code samples bundled with this book (sankey-formatted-json.html, sankey.js and sankey.json). A live example can be found on <a href="http://bl.ocks.org/d3noob/013054e8d7807dff76247b81b0e29030">bl.ocks.org</a>.</p>

<p>On to the code…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>SANKEY Experiment<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>

<code class="nc">.node</code> <code class="nt">rect</code> <code class="p">{</code>
  <code class="nb">cursor</code><code class="o">:</code> <code class="n">move</code><code class="p">;</code>
  <code class="n">fill</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">9</code><code class="p">;</code>
  <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code>
  <code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="nb">text-shadow</code><code class="o">:</code> <code class="m">0</code> <code class="m">1px</code> <code class="m">0</code> <code class="m">#fff</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.link</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">2</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.link</code><code class="nd">:hover</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">5</code><code class="p">;</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"sankey.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
	
<code class="kd">var</code> <code class="nx">units</code> <code class="o">=</code> <code class="s2">"Widgets"</code><code class="p">;</code>

<code class="c1">// set the dimensions and margins of the graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">10</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">700</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// format variables</code>
<code class="kd">var</code> <code class="nx">formatNumber</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">",.0f"</code><code class="p">),</code>    <code class="c1">// zero decimal places</code>
    <code class="nx">format</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">formatNumber</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">units</code><code class="p">;</code> <code class="p">},</code>
    <code class="nx">color</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleOrdinal</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">schemeCategory20</code><code class="p">);</code>

<code class="c1">// append the svg object to the body of the page</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// Set the sankey diagram properties</code>
<code class="kd">var</code> <code class="nx">sankey</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">sankey</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">nodeWidth</code><code class="p">(</code><code class="mi">36</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">nodePadding</code><code class="p">(</code><code class="mi">40</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">width</code><code class="p">,</code> <code class="nx">height</code><code class="p">]);</code>

<code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">link</code><code class="p">();</code>

<code class="c1">// load the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"sankey.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">graph</code><code class="p">)</code> <code class="p">{</code>

  <code class="nx">sankey</code>
      <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">layout</code><code class="p">(</code><code class="mi">32</code><code class="p">);</code>

<code class="c1">// add in the links</code>
  <code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".link"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">b</code><code class="p">.</code><code class="nx">dy</code> <code class="o">-</code> <code class="nx">a</code><code class="p">.</code><code class="nx">dy</code><code class="p">;</code> <code class="p">});</code>

<code class="c1">// add the link titles</code>
  <code class="nx">link</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    		<code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">" → "</code> <code class="o">+</code> 
                <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">"\n"</code> <code class="o">+</code> <code class="nx">format</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">});</code>

<code class="c1">// add in the nodes</code>
  <code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".node"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">drag</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">subject</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>
        <code class="p">})</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"start"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
          <code class="k">this</code><code class="p">.</code><code class="nx">parentNode</code><code class="p">.</code><code class="nx">appendChild</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
        <code class="p">})</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"drag"</code><code class="p">,</code> <code class="nx">dragmove</code><code class="p">));</code>

<code class="c1">// add the rectangles for the nodes</code>
  <code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">nodeWidth</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/ .*/</code><code class="p">,</code> <code class="s2">""</code><code class="p">));</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">rgb</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">color</code><code class="p">).</code><code class="nx">darker</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">"\n"</code> <code class="o">+</code> <code class="nx">format</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">});</code>

<code class="c1">// add in the title for the nodes</code>
  <code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="o">-</code><code class="mi">6</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kc">null</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">&lt;</code> <code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">6</code> <code class="o">+</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">nodeWidth</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">);</code>

<code class="c1">// the function for moving the nodes</code>
  <code class="kd">function</code> <code class="nx">dragmove</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
            <code class="s2">"translate("</code> 
               <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> 
               <code class="o">+</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code>
                  <code class="mi">0</code><code class="p">,</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">height</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">y</code><code class="p">))</code>
                 <code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
    <code class="nx">sankey</code><code class="p">.</code><code class="nx">relayout</code><code class="p">();</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">});</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>So, going straight to the style sheet bounded by the <code>&lt;style&gt;</code> tags;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.node</code> <code class="nt">rect</code> <code class="p">{</code>
  <code class="nb">cursor</code><code class="o">:</code> <code class="n">move</code><code class="p">;</code>
  <code class="n">fill</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">9</code><code class="p">;</code>
  <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code>
  <code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="nb">text-shadow</code><code class="o">:</code> <code class="m">0</code> <code class="m">1px</code> <code class="m">0</code> <code class="m">#fff</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.link</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">2</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.link</code><code class="nd">:hover</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">5</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The CSS in this example is mainly concerned with formatting of the mouse cursor as it moves around the diagram.</p>

<p>The first part…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.node</code> <code class="nt">rect</code> <code class="p">{</code>
  <code class="nb">cursor</code><code class="o">:</code> <code class="n">move</code><code class="p">;</code>
  <code class="n">fill</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">9</code><code class="p">;</code>
  <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>… provides the properties for the node rectangles. It changes the icon for the cursor when it moves over the rectangle to one that looks like it will move the rectangle (there is a range of different icons that can be defined here http://www.echoecho.com/csscursors.htm), sets the fill colour to mostly opaque and keeps the edges sharp.</p>

<p>The next block…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.node</code> <code class="nt">text</code> <code class="p">{</code>
  <code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="nb">text-shadow</code><code class="o">:</code> <code class="m">0</code> <code class="m">1px</code> <code class="m">0</code> <code class="m">#fff</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>… sets the properties for the text at each node. The mouse is told to essentially ignore the text in favour of anything that’s under it (in the case of moving or highlighting something else) and a slight shadow is applied for readability).</p>

<p>The following block…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.link</code> <code class="p">{</code>
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">:</code> <code class="m">#000</code><code class="p">;</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">2</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>… makes sure that the link has no fill (it actually appears to be a bendy rectangle with very thick edges that make the element appear to be a solid block), colours the edges black (<code>#000</code>) and makes the edges almost transparent.</p>

<p>The last block….</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.link</code><code class="nd">:hover</code> <code class="p">{</code>
  <code class="n">stroke</code><code class="o">-</code><code class="nb">opacity</code><code class="o">:</code> <code class="o">.</code><code class="m">5</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>… simply changes the opacity of the link when the mouse goes over it so that it’s more visible. If so desired, we could change the colour of the highlighted link by adding in a line to this block changing the colour like this <code>stroke: red;</code>.</p>

<p>Just before we get into the JavaScript, we do something a little different for d3.js. We tells it to use a plug-in with the following line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"sankey.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The concept of a plug-in is that it is a separate piece of code that will allow additional functionality to a core block (which in this case is d3.js). There are a range of <a href="https://github.com/d3/d3/wiki/Plugins">plug-ins available</a> and we will need to source the <code>sankey.js</code> file from <a href="https://github.com/d3/d3-plugins/tree/master/sankey">the repository</a> and place that somewhere where our HTML code can access it. In this case I have put it in the same directory as the main sankey web page.</p>

<p>The start of our JavaScript begins by defining a range of variables that we’ll be using. </p>

<p>Our units are set as ‘Widgets’ (<code>var units = "Widgets";</code>), which is just a convenient generic (nonsense) term to provide the impression that the flow of items in this case is widgets being passed from one person to another.</p>

<p>We then set our canvas size and margins…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">10</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">700</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="err">–</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="err">–</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>… before setting some formatting.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">formatNumber</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">format</code><code class="p">(</code><code class="s2">",.0f"</code><code class="p">),</code>    <code class="c1">// zero decimal places</code>
    <code class="nx">format</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">formatNumber</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="o">+</code> <code class="s2">" "</code> <code class="o">+</code> <code class="nx">units</code><code class="p">;</code> <code class="p">},</code>
    <code class="nx">color</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleOrdinal</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">schemeCategory20</code><code class="p">);</code>
</pre></div>

</figure>

<p>The <code>formatNumber</code> function acts on a number to set it to zero decimal places in this case. In the original Mike Bostock example it was to three places, but for ‘widgets’ I’m presuming we don’t divide :-).</p>

<p><code>format</code> is a function that returns a given number formatted with <code>formatNumber</code> as well as a space and our units of choice (‘Widgets’). This is used to display the values for the links and nodes later in the script.</p>

<p>The <code>color = d3.scaleOrdinal(d3.schemeCategory20);</code> line is really interesting and provides access to a colour scale that is <a href="https://github.com/d3/d3-scale/blob/master/README.md#schemeCategory20">pre-defined for your convenience</a>! Later in the code we will see it in action.</p>

<p>Our next block of code positions our svg element onto our page in relation to the size and margins we have already defined;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
          <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Then we set the variables for our sankey diagram;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">sankey</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">sankey</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">nodeWidth</code><code class="p">(</code><code class="mi">36</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">nodePadding</code><code class="p">(</code><code class="mi">40</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">size</code><code class="p">([</code><code class="nx">width</code><code class="p">,</code> <code class="nx">height</code><code class="p">]);</code>
</pre></div>

</figure>

<p>Without trying to state the obvious, this sets the width of the nodes (<code>.nodeWidth(36)</code>), the padding between the nodes (<code>.nodePadding(40)</code>) and the size of the diagram(<code>.size([width, height]);</code>).</p>

<p>The following line defines the <code>path</code> variable as a pointer to the sankey function that makes the links between the nodes do their clever thing of bending into the right places;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">link</code><code class="p">();</code>
</pre></div>

</figure>

<p>I make the presumption that this is a defined function within <code>sankey.js</code>.</p>

<p>Then we load the data for our sankey diagram with the following line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"sankey.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">graph</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>As we have seen in previous usage of the <code>d3.json</code>, <code>d3.csv</code> and <code>d3.tsv</code> functions, this is a wrapper that acts on all the code within it bringing the data in the form of <code>graph</code> to the remaining code.</p>

<p>I think it’s a good time to take a slightly closer look at the data that we’ll be using;</p>

<figure class="code">
<div class="highlight"><pre><code></code>{
"nodes":[
{"node":0,"name":"node0"},
{"node":1,"name":"node1"},
{"node":2,"name":"node2"},
{"node":3,"name":"node3"},
{"node":4,"name":"node4"}
],
"links":[
{"source":0,"target":2,"value":2},
{"source":1,"target":2,"value":2},
{"source":1,"target":3,"value":2},
{"source":0,"target":4,"value":2},
{"source":2,"target":3,"value":2},
{"source":2,"target":4,"value":2},
{"source":3,"target":4,"value":4}
]}
</pre></div>

</figure>

<p>I want to look at the data now, because it highlights how it is accessed throughout this portion of the code. It is split into two different blocks, ‘nodes’ and ‘links’. The subset of variables available under ‘nodes’ is ‘node’ and ‘name’. Likewise under ‘links’ we have ‘source’, ‘target’ and ‘value’. This means that when we want to act on a subset of our data we define which piece by defining the hierarchy that leads to it. For instance, if we want to define an action for all the links, we would use graph.links (they’re kind of chained together).</p>

<aside class="information blurb">
    <p>Let me take this opportunity to apologise to all those programmers who <em>actually</em> know exactly what is going on here. It’s a mystery to me, but this is how I like to tell myself it works to help me get by :-).</p>

</aside>

<p>Now that we have our data loaded, we can assign the data to the sankey function so that it knows how to deal with it behind the scenes;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">sankey</code>
      <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">layout</code><code class="p">(</code><code class="mi">32</code><code class="p">);</code>
</pre></div>

</figure>

<p>In keeping with our previous description of what’s going on with the data, we have told the sankey function that the nodes it will be dealing with are in <code>graph.nodes</code> of our data structure.</p>

<p>I’m not sure what the <code>.layout(32);</code> portion of the code does, but I’d be interested to hear from any more knowledgeable readers. I’ve tried changing the values to no apparent effect and googling has drawn a blank. Internally to the <code>sankey.js</code> file it seems to indicate ‘iterations’ while it establishes     computeNodeLinks, computeNodeValues, computeNodeBreadths, computeNodeDepths (iterations) and computeLinkDepths.</p>

<p>Then we add our links to the diagram with the following block of code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">link</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".link"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"link"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">b</code><code class="p">.</code><code class="nx">dy</code> <code class="o">-</code> <code class="nx">a</code><code class="p">.</code><code class="nx">dy</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>This is an analogue of the block of code we examined way back in the section that we covered in explaining the code of our first <a href="#simplegraph">simple graph</a>.</p>

<p>We append svg elements for our links based on the data in <code>graph.links</code>, then add in the paths (using the appropriate CSS). We set the stroke width to the width of the value associated with each link or ‘1’. Whichever is the larger (by virtue of the Math.max function). As an interesting sideline, if we force this value to ‘10’ thusly…</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke-width"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
</pre></div>

</figure>

<p>… the graph looks quite interesting.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/sankey03.png" alt="stroke-width 10 for Sankey links">
  <figcaption>stroke-width 10 for Sankey links</figcaption>
</figure>


<p>The sort function (<code>.sort(function(a, b) { return b.dy - a.dy; });</code>) makes sure the link for which the target has the highest y coordinate departs first out of the rectangle. Meaning if you have flows of 30,40,50 out of node 1, heading towards nodes 2, 3 and 4, with node 3 located above node 2 and that above node 4, the outflow order from node 1 will be 40,50,30. This makes sure there are a minimum of flow crosses. It’s slightly confusing and for a long time it was a mystery (big thanks and kudos to ‘napicool’ who was able to <a href="http://www.d3noob.org/2013/02/formatting-data-for-sankey-diagrams-in.html">explain it on d3noob.org</a>.</p>

<p>The next block adds the titles to the links;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">link</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    		<code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">" → "</code> <code class="o">+</code> 
                <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">"\n"</code> <code class="o">+</code> <code class="nx">format</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>This code appends a text element to each link when moused over that contains the source and target name (with a neat little arrow in between and the value) which, when applied with the <code>format</code> function, adds the units.</p>

<p>The next block appends the node objects (but not the rectangles or text) and contains the instructions to allow them to be arranged with the mouse.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">var</code> <code class="nx">node</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">).</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">".node"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"node"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">drag</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">subject</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">return</code> <code class="nx">d</code><code class="p">;</code>
        <code class="p">})</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"start"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
          <code class="k">this</code><code class="p">.</code><code class="nx">parentNode</code><code class="p">.</code><code class="nx">appendChild</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
        <code class="p">})</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"drag"</code><code class="p">,</code> <code class="nx">dragmove</code><code class="p">));</code>
</pre></div>

</figure>

<p>While it starts off in familiar territory with appending the node objects using the <code>graph.nodes</code> data and putting them in the appropriate place with the <code>transform</code> attribute, I can only assume that there is some trickery going on behind the scenes to make sure the mouse can do what it needs to do with the <code>d3.behaviour,drag</code> function. There is some excellent documentation on the <a href="https://github.com/d3/d3-drag">wiki</a>, but I can only presume that it knows what it’s doing :-). The <code>dragmove</code> function is laid out at the end of the code, and we will explain how that operates later. Kudos for <a href="http://bl.ocks.org/syntagmatic/77c7f7e8802e8824eed473dd065c450b">this code portion</a> should go to @syntagmatic.</p>

<p>I really enjoyed the next block;</p>

<figure class="code">
<div class="highlight"><pre><code></code> <code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">nodeWidth</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/ .*/</code><code class="p">,</code> <code class="s2">""</code><code class="p">));</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">rgb</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">color</code><code class="p">).</code><code class="nx">darker</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"title"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 
		  <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">"\n"</code> <code class="o">+</code> <code class="nx">format</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>It starts off with a fairly standard appending of a rectangle with a height generated by its value <code>{ return d.dy; }</code> and a width dictated by the <code>sankey.js</code> file to fit the area (<code>.attr("width", sankey.nodeWidth())</code>).</p>

<p>Then it gets interesting.</p>

<p>The colours are assigned in accordance with our earlier colour declaration and the individual colours are added to the nodes by finding the first part of the name for each node and assigning it a colour from the palate (the script looks for the first space in the name using a regular expression). For instance: ‘Widget X’, ‘Widget Y’ and ‘Widget’ will all be coloured the same even if the ‘Widget X’ and ‘Widget Y’ are inputs on the left and ‘Widget’ is a node in the middle.</p>

<p>The stroke around the outside of the rectangle is then drawn in the same shade, but <code>darker</code>.
Then we return to the basics where we add the title of the node in a tool tip type effect along with the value for the node.</p>

<p>From here we add the titles for the nodes;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">node</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="o">-</code><code class="mi">6</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"end"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="kc">null</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">&lt;</code> <code class="nx">width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">6</code> <code class="o">+</code> <code class="nx">sankey</code><code class="p">.</code><code class="nx">nodeWidth</code><code class="p">())</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"start"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Again, this looks pretty familiar. We position the text titles carefully to the left of the nodes. All except for those affected by the filter function (<code>return d.x &lt; width / 2;</code>). Where if the position of the node on the x axis is less than half the width, the title is placed on the right of the node and anchored at the start of the text. Very neat.</p>

<p>The last block is also pretty neat, and contains a little surprise for those who are so inclined.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">function</code> <code class="nx">dragmove</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
            <code class="s2">"translate("</code> 
               <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">","</code> 
               <code class="o">+</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code>
                  <code class="mi">0</code><code class="p">,</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">height</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">y</code><code class="p">))</code>
                 <code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
    <code class="nx">sankey</code><code class="p">.</code><code class="nx">relayout</code><code class="p">();</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">);</code>
</pre></div>

</figure>

<p>This declares the function that controls the movement of the nodes with the mouse.
It selects the item that it’s operating over (<code>d3.select(this)</code>) and then allows translation in the y axis while maintaining the link connection (<code>sankey.relayout(); link.attr("d", path);</code>).</p>

<p>But that’s not the cool part. A quick look at the code should reveal that if you can move a node in the y axis, there should be no reason why you can’t move it in the x axis as well!</p>

<p>Sure enough, if you replace the code above with this…</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="kd">function</code> <code class="nx">dragmove</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
        <code class="s2">"translate("</code> <code class="o">+</code> <code class="p">(</code>
            <code class="nx">d</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">width</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dx</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">x</code><code class="p">))</code>
        <code class="p">)</code>
        <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="p">(</code>
            <code class="nx">d</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">min</code><code class="p">(</code><code class="nx">height</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">dy</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">y</code><code class="p">))</code>
        <code class="p">)</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>
    <code class="nx">sankey</code><code class="p">.</code><code class="nx">relayout</code><code class="p">();</code>
    <code class="nx">link</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">path</code><code class="p">);</code>
</pre></div>

</figure>

<p>… you can move your nodes anywhere on the canvas. </p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/sankey04.png" alt="Move your nodes in x *and* y!">
  <figcaption>Move your nodes in x <em>and</em> y!</figcaption>
</figure>


<p>I know it doesn’t seem to add anything to the diagram (in fact, it could be argued that there is a certain aspect of detraction) however, it doesn’t mean that one day the idea doesn’t come in handy :-). You can see a live version on <a href="http://bl.ocks.org/d3noob/3337957c360d55c245f6057ab0866c05">bl.ocks.org</a>.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-formatting-data-for-sankey-diagrams">Formatting data for Sankey diagrams</h3>

<h4 id="leanpub-auto-from-a-json-file-with-numeric-link-values">From a JSON file with numeric link values</h4>

<p>As explained in the <a href="#sankeydata">previous section</a>, data to form a Sankey diagram needs to be a combination of nodes and links.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">{</code>
<code class="nt">"nodes"</code><code class="p">:[</code>
<code class="p">{</code><code class="nt">"node"</code><code class="p">:</code><code class="mi">0</code><code class="p">,</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"node0"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"node"</code><code class="p">:</code><code class="mi">1</code><code class="p">,</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"node1"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"node"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"node2"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"node"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"node3"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"node"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"node4"</code><code class="p">}</code>
<code class="p">],</code>
<code class="nt">"links"</code><code class="p">:[</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">0</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">1</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">1</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">0</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">4</code><code class="p">}</code>
<code class="p">]}</code>
</pre></div>

</figure>

<p>As we also noted earlier, the <code>"node"</code> entries in the <code>"nodes"</code> section of the JSON file are superfluous and are really only there for our benefit since D3 will automatically index the nodes starting at zero. As a test to check this out we can change our data to the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">{</code>
<code class="nt">"nodes"</code><code class="p">:[</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Barry"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Frodo"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Elvis"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Sarah"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Alice"</code><code class="p">}</code>
<code class="p">],</code>
<code class="nt">"links"</code><code class="p">:[</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">0</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">1</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">1</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">0</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">2</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="mi">3</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="mi">4</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">4</code><code class="p">}</code>
<code class="p">]}</code>
</pre></div>

</figure>

<p>This will produce the following graph;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/sankey05.png" alt="Sankey graph with names">
  <figcaption>Sankey graph with names</figcaption>
</figure>


<p>As you can see, essentially the same, but with easier to understand names.</p>

<p>As you can imagine, while the end result is great, the creation of the JSON file manually would be painful at best. Doing something similar but with a greater number of nodes / links would be a nightmare.</p>

<p>Let’s see if we can make the process a bit easier and more flexible.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-from-a-json-file-with-links-as-names">From a JSON file with links as names</h4>

<p>It would make thing much easier, if you are building the data from hand, to have nodes with names, and the ‘source’ and ‘target’ links to have those same name values as identifiers.</p>

<p>In other words a list of unique names for the nodes (and perhaps some details) and a list of the links between those nodes using the names for the nodes. </p>

<p>So, something like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">{</code>
<code class="nt">"nodes"</code><code class="p">:[</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Barry"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Frodo"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Elvis"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Sarah"</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"name"</code><code class="p">:</code><code class="s2">"Alice"</code><code class="p">}</code>
<code class="p">],</code>
<code class="nt">"links"</code><code class="p">:[</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Barry"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Elvis"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Frodo"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Elvis"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Frodo"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Sarah"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Barry"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Alice"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Elvis"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Sarah"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Elvis"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Alice"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">2</code><code class="p">},</code>
<code class="p">{</code><code class="nt">"source"</code><code class="p">:</code><code class="s2">"Sarah"</code><code class="p">,</code><code class="nt">"target"</code><code class="p">:</code><code class="s2">"Alice"</code><code class="p">,</code><code class="nt">"value"</code><code class="p">:</code><code class="mi">4</code><code class="p">}</code>
<code class="p">]}</code>
</pre></div>

</figure>

<p>Once again, D3 to the rescue!</p>

<p>The little piece of code that can do this for us is here;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">nodeMap</code> <code class="o">=</code> <code class="p">{};</code>
    <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="nx">nodeMap</code><code class="p">[</code><code class="nx">x</code><code class="p">.</code><code class="nx">name</code><code class="p">]</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code> <code class="p">});</code>
    <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code> <code class="o">=</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="p">{</code>
        <code class="nx">source</code><code class="o">:</code> <code class="nx">nodeMap</code><code class="p">[</code><code class="nx">x</code><code class="p">.</code><code class="nx">source</code><code class="p">],</code>
        <code class="nx">target</code><code class="o">:</code> <code class="nx">nodeMap</code><code class="p">[</code><code class="nx">x</code><code class="p">.</code><code class="nx">target</code><code class="p">],</code>
        <code class="nx">value</code><code class="o">:</code> <code class="nx">x</code><code class="p">.</code><code class="nx">value</code>
      <code class="p">};</code>
    <code class="p">});</code>
</pre></div>

</figure>

<p>This elegant solution comes from <a href="http://stackoverflow.com/questions/14629853/json-representation-for-d3-networks">Stack Overflow</a> and was provided by Chris Pettitt (nice job).</p>

<p>So if we sneak this piece of code into here… </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"sankey-names.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">graph</code><code class="p">)</code> <code class="p">{</code>

            <code class="c1">//  &lt;= Put the code here.</code>

  <code class="nx">sankey</code>
      <code class="p">.</code><code class="nx">nodes</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">links</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">layout</code><code class="p">(</code><code class="mi">32</code><code class="p">);</code>
</pre></div>

</figure>

<p>… and this time we use our JSON file with just names (sankey-names.json) and our new html file (sankey-formatted-names.html) we find our Sankey diagram working perfectly!</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/d7800f34062b116f9ec0588f2e85e549">github</a> or in the code samples bundled with this book (sankey-formatted-names.html, sankey.js and sankey-names.json). A live example can be found on <a href="http://bl.ocks.org/d3noob/d7800f34062b116f9ec0588f2e85e549">bl.ocks.org</a>.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/sankey06.png" alt="Sankey graph with names again">
  <figcaption>Sankey graph with names again</figcaption>
</figure>


<p>Looking at our new piece of code…</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">nodeMap</code> <code class="o">=</code> <code class="p">{};</code>
    <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="nx">nodeMap</code><code class="p">[</code><code class="nx">x</code><code class="p">.</code><code class="nx">name</code><code class="p">]</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>…  the first thing it does is create an object called <code>nodeMap</code> (The difference between an array and an object in JavaScript is one that is still a little blurry to me and judging from online comments, I am not alone).</p>

<p>Then for each of the <code>graph.node</code> instances (where <code>x</code> is a range of numbers from 0 to the last node), we assign each node name to a number.</p>

<p>Then in the next piece of code…</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code> <code class="o">=</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="p">{</code>
        <code class="nx">source</code><code class="o">:</code> <code class="nx">nodeMap</code><code class="p">[</code><code class="nx">x</code><code class="p">.</code><code class="nx">source</code><code class="p">],</code>
        <code class="nx">target</code><code class="o">:</code> <code class="nx">nodeMap</code><code class="p">[</code><code class="nx">x</code><code class="p">.</code><code class="nx">target</code><code class="p">],</code>
        <code class="nx">value</code><code class="o">:</code> <code class="nx">x</code><code class="p">.</code><code class="nx">value</code>
      <code class="p">};</code>
</pre></div>

</figure>

<p>… we go through all the links we have and for each link, we map the appropriate number to the correct name.</p>

<p>Very clever.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-from-a-csv-with-source-target-and-value-info-only">From a CSV with ‘source’, ‘target’ and ‘value’ info only.</h4>

<p>In the first iteration of this section of the book I had no solution to creating a Sankey diagram using a csv file as the source of the data.</p>

<p>But cometh the hour, cometh the man. Enter @timelyportfolio who, while claiming no expertise in D3 or JavaScript was able to demonstrate a <a href="http://bl.ocks.org/timelyportfolio/5052095">solution</a> to exactly the problem I was facing! Well done Sir! I salute you and name the technique the timelyportfolio csv method!</p>

<aside class="information blurb">
    <p>Observant readers will notice that there is a tiny difference between the solution that timelyportfolio demonstrates (using d3.js v3) and the example below (using v4). Using v4 I found that I had to use <code>.object</code> when nesting the data instead of <code>.map</code>. </p>

</aside>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/06e72deea99e7b4859841f305f63ba85">github</a> or in the code samples bundled with this book (sankey-formatted-csv.html, sankey.js and sankey.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/06e72deea99e7b4859841f305f63ba85">bl.ocks.org</a>.</p>

<p>So here’s the cleverness that @timelyportfolio demonstrated;</p>

<p>Using a csv file (in this case called <code>sankey.csv</code>) that looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>source,target,value
Barry,Elvis,2
Frodo,Elvis,2
Frodo,Sarah,2
Barry,Alice,2
Elvis,Sarah,2
Elvis,Alice,2
Sarah,Alice,4
</pre></div>

</figure>

<p>We take this single line from our original Sankey diagram code;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="s2">"sankey-formatted.json"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">graph</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>And replace it with the following block;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"sankey.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
 
  <code class="c1">//set up graph in same style as original example but empty</code>
  <code class="nx">graph</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"nodes"</code> <code class="o">:</code> <code class="p">[],</code> <code class="s2">"links"</code> <code class="o">:</code> <code class="p">[]};</code>

  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code> <code class="s2">"name"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code> <code class="p">});</code>
    <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code> <code class="s2">"name"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code> <code class="p">});</code>
    <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code> <code class="s2">"source"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">,</code>
                       <code class="s2">"target"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">,</code>
                       <code class="s2">"value"</code><code class="o">:</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="p">});</code>
   <code class="p">});</code>

  <code class="c1">// return only the distinct / unique nodes</code>
  <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">keys</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">object</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">));</code>

  <code class="c1">// loop through each link replacing the text with its index from node</code>
  <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">source</code> <code class="o">=</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">source</code><code class="p">);</code>
    <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">target</code> <code class="o">=</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">target</code><code class="p">);</code>
  <code class="p">});</code>

  <code class="c1">// now loop through each nodes to make nodes an array of objects</code>
  <code class="c1">// rather than an array of strings</code>
  <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="nx">d</code> <code class="p">};</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>The comments in the code (and they are fuller in @timelyportfolio’s <a href="http://bl.ocks.org/timelyportfolio/5052095">original gist solution</a>) explain the operation;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"sankey.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>… Loads the csv file from the data directory.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">graph</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"nodes"</code> <code class="o">:</code> <code class="p">[],</code> <code class="s2">"links"</code> <code class="o">:</code> <code class="p">[]};</code>
</pre></div>

</figure>

<p>… Declares <code>graph</code> to consist of two empty arrays called <code>nodes</code> and <code>links</code>.</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code> <code class="s2">"name"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code> <code class="p">});</code>
      <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code> <code class="s2">"name"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code> <code class="p">});</code>
      <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code> <code class="s2">"source"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">source</code><code class="p">,</code>
                         <code class="s2">"target"</code><code class="o">:</code> <code class="nx">d</code><code class="p">.</code><code class="nx">target</code><code class="p">,</code>
                         <code class="s2">"value"</code><code class="o">:</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">value</code> <code class="p">});</code>
     <code class="p">});</code>
</pre></div>

</figure>

<p>… Takes the <code>data</code> loaded with the csv file and for each row loads variables for the <code>source</code> and <code>target</code> into the <code>nodes</code> array. Then for each row it loads variables for the <code>source</code> <code>target</code> and <code>value</code> into the <code>links</code> array.</p>

<figure class="code">
<div class="highlight"><pre><code></code>     <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">keys</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
       <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code> <code class="p">})</code>
       <code class="p">.</code><code class="nx">object</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">));</code>
</pre></div>

</figure>

<p>… Is a routine that Mike Bostock described on <a href="https://groups.google.com/forum/#!msg/d3-js/pl297cFtIQk/Eso4q_eBu1IJ">Google Groups</a> that (as I understand it) nests each node name as a key so that it returns with only unique nodes.</p>

<figure class="code">
<div class="highlight"><pre><code></code>     <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>
       <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">source</code> <code class="o">=</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">source</code><code class="p">);</code>
       <code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">target</code> <code class="o">=</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">graph</code><code class="p">.</code><code class="nx">links</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">target</code><code class="p">);</code>
     <code class="p">});</code>
</pre></div>

</figure>

<p>… Goes through each <code>link</code> entry and, for each <code>source</code> and <code>target</code>, it finds the unique index number of that name in the nodes array and assigns the link source and target an appropriate number.</p>

<p>And finally… </p>

<figure class="code">
<div class="highlight"><pre><code></code>     <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">d</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="p">{</code>
       <code class="nx">graph</code><code class="p">.</code><code class="nx">nodes</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code> <code class="s2">"name"</code><code class="o">:</code> <code class="nx">d</code> <code class="p">};</code>
     <code class="p">});</code>
</pre></div>

</figure>

<p>… Goes through each node and (in the words of @timelyportfolio) “<em>make nodes an array of objects rather than an array of strings</em>” (I don’t really know what that means :-(. I just know it works :-).)</p>

<p>There you have it. A Sankey diagram from a csv file. Well played @timelyportfolio!</p>

<div class="page-break"></div>

<h2 id="leanpub-auto-assorted-tips-and-tricks">Assorted Tips and Tricks</h2>


<h3 id="scatterplot">Change a line chart into a scatter plot</h3>

<p>Confession time. </p>

<p>In the original book I didn’t actually intend to add in a section with a scatter plot in it for its own sake because I thought it would be;</p>

<ol class="numeric">
  <li>tricky</li>
  <li>not useful</li>
  <li>all of the above</li>
</ol>

<p>I was wrong on all counts.</p>

<aside class="information blurb">
    <p>I did want to have a scatter plot, because I wanted to display tool tips, but this is too neat to ignore.
It was literally a 5 minute job, 3 minutes of which was taken up by going to the <a href="https://github.com/mbostock/d3/wiki/Gallery">d3 gallery on the wiki</a> and ogling at the cool stuff there before snapping out of it and going to the <a href="http://bl.ocks.org/3887118">scatter plot example</a> (that’s the v3 example by the way).</p>

</aside>

<p>All we need to do is take the <a href="#simplegraph">simple graph</a> example file and slot the following block in between the ‘Add the valueline path’ and the ‘add the x axis’ blocks.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// add the dots</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"dot"</code><code class="p">)</code>
     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
     <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>
       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
       <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>And we will get…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/scatter01.png" alt="A scatter plot! (with a line)">
  <figcaption>A scatter plot! (with a line)</figcaption>
</figure>


<p>The full code for this graph can also be found on <a href="https://gist.github.com/d3noob/2505b09d0feb51d0c9873cc486f10f67">github</a> or in the code samples bundled with this book (simple-scatterplot.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/2505b09d0feb51d0c9873cc486f10f67">bl.ocks.org</a>.</p>

<p>I deliberately put the dots <em>after</em> the line in the drawing section, because I thought they would look better, but we could put the block of code before the line drawing block to get the following effect;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/scatter02.png" alt="A scatter plot with the line in front of the dots">
  <figcaption>A scatter plot with the line in front of the dots</figcaption>
</figure>


<p>(just trying to reinforce the concept that ‘order’ matters when drawing objects :-)).</p>

<p>We could of course just remove the line block all together…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/scatter03.png" alt="A scatter plot without the line this time">
  <figcaption>A scatter plot without the line this time</figcaption>
</figure>


<p>But in my humble opinion it loses something.</p>

<p>So what do the individual lines in the scatter plot block of JavaScript do?</p>

<p>The first line (<code>svg.selectAll("dot")</code>) essentially provides a suitable group label for the svg circle elements that will be added. The next line associates the range of data that we have to the group of elements we are about to add in.</p>

<p>Then we add a circle for each data point (<code>.enter().append("circle")</code>) with a radius of 5 pixels (<code>.attr("r", 5)</code>) and appropriate x (<code>.attr("cx", function(d) { return x(d.date); })</code>) and y (<code>.attr("cy", function(d) { return y(d.close); });</code>) coordinates.</p>

<p>There is lots more that we could be doing with this piece of code including varying the colour or size or opacity of the circles depending on the data and all sorts of really neat things, but for the mean time, there we go. Scatter plot!</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-adding-tooltips">Adding tooltips.</h3>

<p>Tooltips have a marvellous duality. They are on one hand a pretty darned useful thing that aids in giving context and information where required and on the other hand, if done with a bit of care, they can look very stylish :-).</p>

<p>Technically, they represent a slight deviation from what we have been playing with so far into a mildly more complex arena of ‘transitions’ and ‘events’. You will probably regard this one of two ways. Either accepting that it just works and using it as shown, or you will actually know what’s going on in which case feel free to deride my efforts as those of a rank amateur :-).</p>

<aside class="information blurb">
    <p>The original (d3.js v3) source for the implementation was taken from Mike Bostock’s example on <a href="http://bl.ocks.org/1087001">bl.ocks.org</a>. This was combined with a few other bit’s and pieces (the trickiest being working out how to format the displayed date correctly and inserting a line break in the tooltip (which I found on <a href="https://groups.google.com/forum/?fromgroups=#!topic/d3-js/GgFTf24ltjc">Google Groups</a>;  (well done to all those participating in that discussion)). I make the assumption that any or all errors that occur in the implementation will be mine, whereas, any successes will be down to the original contributors.</p>

</aside>

<p>Just in case there is some confusion, a tooltip (one word or two?) is a discrete piece of information that will pop into view when the mouse hovers over somewhere specific. Most of us have seen and used them, but I suppose we all tend to call them different things such as ‘infotip’, ‘hint’ or ‘hover box’ I don’t know if there’s a right name for them, but here’s an example of what we’re trying to achieve;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/tips01.png" alt="A tooltip magically appears over a dot">
  <figcaption>A tooltip magically appears over a dot</figcaption>
</figure>


<p>We can see the mouse has hovered over one of the scatter plot circles and a tip has appeared that provides us with the exact date and value for that point.</p>

<p>We can also notice that there’s a certain degree of ‘fancy’ here as the information is bound by a rectangular shape with rounded corners and a slight opacity. The other piece of ‘fancy’ which you don’t see in a PDF (or whatever format this distinguished tome will be published in on its 33rd reprint in the year 2034), is that when these tool tips appear and disappear, they do so in an elegant fade-in, fade-out way. Pretty!</p>

<p>Before we get started describing how the code goes together, let’s take a quick look at the two technique specifics that I mentioned earlier, ‘transitions’ and ‘events’.</p>

<h4 id="leanpub-auto-transitions">Transitions</h4>

<p>From the main d3.js web page (d3js.org) transitions are described as gradually interpolating styles and attributes over time. So what I take that to mean is that if you want to change an object, you can do so by simply specifying the attribute / style end point that you want it to end up with and the time you want it to take and go!</p>

<p>Of course, it’s not quite that simple, but luckily, smarter people than I have done some fantastic work describing different aspects of transitions so please see the following for a more complete description of the topic;</p>

<ul>
  <li>Mike Bostock’s <a href="https://bost.ocks.org/mike/transition/">Transition tutorial</a>
</li>
  <li>Christophe Viau’s <a href="http://christopheviau.com/d3_tutorial/">‘Try D3 Now!’ tutorial</a>
</li>
</ul>

<p>Hopefully observing the mouseover and mouseout transitions in the tooltips example will whet your appetite for more!</p>

<h4 id="leanpub-auto-events">Events</h4>

<p>The other technique is related to mouse ‘events’. This describes the browser watching for when ‘something’ happens with the mouse on the screen and when it does, it takes a specified action. A (probably non-comprehensive) list of the types of events are the following;</p>

<ul>
  <li>mousedown: Triggered by an element when a mouse button is pressed down over it</li>
  <li>mouseup: Triggered by an element when a mouse button is released over it</li>
  <li>mouseover: Triggered by an element when the mouse comes over it</li>
  <li>mouseout: Triggered by an element when the mouse goes out of it</li>
  <li>mousemove: Triggered by an element on every mouse move over it.</li>
  <li>click: Triggered by a mouse click: mousedown and then mouseup over an element</li>
  <li>contextmenu: Triggered by a right-button mouse click over an element.</li>
  <li>dblclick: Triggered by two clicks within a short time over an element</li>
</ul>

<p>How many of these are valid to use within d3 I’m not sure, but I’m willing to bet that there are probably more than those here as well. Please go to <a href="http://javascript.info/tutorial/mouse-events">http://javascript.info/tutorial/mouse-events</a> for a far better description of the topic if required.</p>

<h4 id="leanpub-auto-get-tipping">Get tipping</h4>

<p>So, bolstered with a couple of new concepts to consider, let’s see how they are enacted in practice.</p>

<p>The full code for this graph can also be found on <a href="https://gist.github.com/d3noob/257c360b3650b9f0a52dd8257d7a2d73">github</a> or in the code samples bundled with the book (simple-tooltips.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/257c360b3650b9f0a52dd8257d7a2d73">bl.ocks.org</a>.</p>

<p>If we start with our simple-scatter plot graph there are 4 areas in it that we will want to modify (it may be easier to check the simple-tooltips.html file in the code samples bundled with this book).</p>

<p>The first area is the CSS. The following code should be added just before the <code>&lt;/style&gt;</code> tag;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">div</code><code class="nc">.tooltip</code> <code class="p">{</code>
  <code class="nb">position</code><code class="o">:</code> <code class="nb">absolute</code><code class="p">;</code>
  <code class="nb">text-align</code><code class="o">:</code> <code class="nb">center</code><code class="p">;</code>
  <code class="nb">width</code><code class="o">:</code> <code class="m">60px</code><code class="p">;</code>
  <code class="nb">height</code><code class="o">:</code> <code class="m">28px</code><code class="p">;</code>
  <code class="nb">padding</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>
  <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="nb">sans-serif</code><code class="p">;</code>
  <code class="nb">background</code><code class="o">:</code> <code class="nb">lightsteelblue</code><code class="p">;</code>
  <code class="nb">border</code><code class="o">:</code> <code class="m">0px</code><code class="p">;</code>
  <code class="nb">border</code><code class="o">-</code><code class="n">radius</code><code class="o">:</code> <code class="m">8px</code><code class="p">;</code>
  <code class="nb">pointer</code><code class="o">-</code><code class="n">events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>These styles are defining how our tooltip will appear . Most of them are fairly straight forward. The position of the tooltip is done in absolute measurements, not relative. The text is centre aligned, the height, width and colour of the rectangle is <code>28px</code>, <code>60px</code> and <code>lightsteelblue</code> respectively. The ‘padding’ is an interesting feature that provides a neat way to grow a shape by a fixed amount from a specified size.</p>

<p>We set the border to <code>0px</code> so that it doesn’t show up and a neat style (attribute?) called <code>border-radius</code> provides the nice rounded corners on the rectangle.</p>

<p>Lastly, but by no means least, the <code>pointer-events: none</code> line is in place to instruct the mouse event to go ‘through’ the element and target whatever is ‘underneath’ that element instead (Read more <a href="https://developer.mozilla.org/en-US/docs/CSS/pointer-events">here</a>). That means that even if the tooltip partly obscures the circle, the code will still act as if the mouse is only over the circle.</p>

<p>The second addition is a simple one-liner that should (for forms sake) be placed under the <code>parseTime</code> variable declaration;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">formatTime</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">timeFormat</code><code class="p">(</code><code class="s2">"%e %B"</code><code class="p">);</code>
</pre></div>

</figure>

<p>This line formats the date when it appears in our tooltip. Without it, the time would default to a disturbingly long combination of temporal details. In the case here we have declared that we want to see the day of the month (<code>%e</code>) and the full month name(<code>%B</code>).</p>

<p>The third block of code is the function declaration for ‘div’.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">div</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"div"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"tooltip"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
</pre></div>

</figure>

<p>We can place that just after the <code>valueline</code> definition in the JavaScript. Again there’s not too much here that’s surprising. We tell it to attach a <code>div</code> element to the body element, we set the class to the tooltip class (from the CSS) and we set the opacity to zero. It might sound strange to have the opacity set to zero, but remember, that’s the natural state of a tooltip. It will live unseen until it’s moment of revelation arrives and it pops up!</p>

<p>The final block of code is slightly more complex and could be described as a mutant version of the neat little bit of code that we used to do the drawing of the dots for the scatter plot. That’s because the tooltips are all about the scatter plot circles. Without a circle to ‘mouseover’, the tooltip never appears :-).</p>

<p>So here’s the code that includes the scatter plot drawing (it’s included since it’s pretty much integral);</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// add the dots with tooltips</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"dot"</code><code class="p">)</code>
     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
   <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>
     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">})</code>
     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
       <code class="nx">div</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
         <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code>
         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">9</code><code class="p">);</code>
       <code class="nx">div</code><code class="p">.</code><code class="nx">html</code><code class="p">(</code><code class="nx">formatTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"&lt;br/&gt;"</code> <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code>
         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageX</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>
         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageY</code> <code class="o">-</code> <code class="mi">28</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">);</code>
       <code class="p">})</code>
     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseout"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
       <code class="nx">div</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
         <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>
         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
       <code class="p">});</code>
</pre></div>

</figure>

<p>The first six lines of the code are a repeat of the scatter plot drawing script. The only changes are that we’ve removed the semicolon from the <code>cy</code> attribute line since the code now has to carry on.</p>

<p>So the additions are broken into two areas that correspond to the two events. <code>mouseover</code> and <code>mouseout</code>. When the mouse moves over any of the circles in the scatter plot, the mouseover code is executed on the <code>div</code> element. When the mouse is moved off the circle a different set of instructions are executed.</p>

<aside class="information blurb">
    <h3 id="leanpub-auto-there-is-only-one">There is only one!</h3>
  <p>It would be a mistake to think of tooltips in the plural because there aren’t a whole series of individual tooltips just waiting to appear for their specific circle. There is only one tooltip that will appear when the mouse moves over a circle. And depending on what circle it’s over, the properties of the tooltip will alter slightly (in terms of its position and contents).</p>

</aside>

<h4 id="leanpub-auto-onmouseover">on.mouseover</h4>

<p>The <code>.on("mouseover"</code> line initiates the introduction of the tooltip. Then we declare the element we will be introducing (‘<code>div</code>’) and that we will be applying a transition to its introduction (<code>.transition()</code>). The next two lines describe the transition. It will take 200 milliseconds (<code>.duration(200)</code>) and will result in changing the element’s opacity to .9 (<code>.style("opacity", .9);</code>). Given that the natural state of our tooltip is an opacity of 0, this make sense for something appearing, but it doesn’t go all the way to a solid object and it retains a slight transparency just to make it look less permanent.</p>

<p>The following three lines format our tooltip. The first one adds an html element that contains our x and y information (the <code>date</code> and the <code>close</code> value). Now this is done in a slightly strange way. Other tooltips that I have seen have used a ‘<code>.text</code>’ element instead of a ‘<code>.html</code>’ one, but I have used ‘<code>.html</code>’ in this case because I wanted to include the line break tag <code>&lt;br/&gt;</code> to separate the date and value. I’m sure there are other ways to do it, but this worked for me. The other interesting part of this line is that this is where we call our time formatting function that we described earlier. The next two lines position the tooltip on the screen and to do this they grab the x and y coordinates of the mouse when the event takes place (with the <code>d3.event.pageX</code> and <code>d3.event.pageY</code> snippets) and apply a correction in the case of the y coordinate to raise the tooltip up by the same amount as its height (28 pixels).</p>

<h4 id="leanpub-auto-onmouseout">on.mouseout</h4>

<p>The <code>.on("mouseout"</code> section is slightly simpler in that it doesn’t have to do any fancy text / html / coordinate stuff. All it has to do is to fade out the ‘div’ element. And that is done by simply reversing the opacity back to 0 and setting the duration for the transition to 500 milliseconds (being slightly longer than the fade-in makes it look slightly cooler IMHO).</p>

<p>Right, there you go. As a description it’s ended up being a bit of a wall of text I’m afraid. But hopefully between the explanation and the example code you will get the idea. Please take the time to fiddle with the settings described here to find the ones that work for you and in the process you will reinforce some of the principles that help D3 do its thing.</p>

<h4 id="leanpub-auto-including-an-html-link-in-a-tool-tip">Including an HTML link in a tool tip</h4>

<p>There was an interesting question on <a href="http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html">d3noob.org</a> about adding an HTML link to a tooltip. While the person asking the question had the problem pretty much solved already, I thought it might be useful for others.</p>

<p>The premise is that you want to add a tool tip to your visualization using the method described here, but you also want to include an HTML link in the tooltip that will  link somewhere else. This might look a little like the following;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/tool-01.png" alt="Tool tip with an HTML Link">
  <figcaption>Tool tip with an HTML Link</figcaption>
</figure>


<p>In the image above the date has been turned into a link. In this case the link goes to google.com, but that can obviously be configurable.</p>

<p>The full code for this example can be found on <a href="https://https://gist.github.com/d3noob/036d13e5173de69f7758091ba9a2df2b">github</a> or in the code samples bundled with this book (simple-tooltips-link.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/036d13e5173de69f7758091ba9a2df2b">bl.ocks.org</a>. </p>

<p>There are a few changes that we would want to make to our original tooltip code to implement this feature.</p>

<p>First of all, we’ll add the link to the date element. Adding an HTML link can be as simple as wrapping the ‘thing’ to be used as a link in <a href="http://www.w3schools.com/tags/tag_a.asp"><code>&lt;a&gt;</code> tags</a> with an appropriate URL to go to.</p>

<p>The following adaptation of the code that prints the information into our tooltip code does just that;</p>

<figure class="code">
<div class="highlight"><pre><code></code>       <code class="nx">div</code> <code class="p">.</code><code class="nx">html</code><code class="p">(</code>
         <code class="s1">'&lt;a href= "http://google.com"&gt;'</code> <code class="o">+</code> <code class="c1">// The first &lt;a&gt; tag</code>
         <code class="nx">formatTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code>
         <code class="s2">"&lt;/a&gt;"</code> <code class="o">+</code>                          <code class="c1">// closing &lt;/a&gt; tag</code>
         <code class="s2">"&lt;br/&gt;"</code>  <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code>     
         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageX</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>             
         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageY</code> <code class="o">-</code> <code class="mi">28</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">);</code>
</pre></div>

</figure>

<p><code>&lt;a href= "http://google.com"&gt;</code> places our first <code>&lt;a&gt;</code> tag and declares the URL and the second tag follows after the date.</p>

<p>The second change we will want to make is to ensure that the tooltip stays in place long enough for us to actually click on the link. The problem being solved here is that our original code relies on the mouse being over the dot on the graph to display the tooltip. if the tooltip is displayed and the cursor moves to press the link, it will move off the dot on the graph and the tooltip vanishes (Darn!).</p>

<p>To solve the problem we can leave the tooltip in place adjacent to a dot while the mouse roams freely over the graph until the next time it reaches a dot and then the previous tooltip vanishes and a new one appears. The best way to appreciate this difference is to check out the live example on <a href="http://bl.ocks.org/d3noob/036d13e5173de69f7758091ba9a2df2b">bl.ocks.org</a>.</p>

<p>The code is as follows (you may notice that this also includes the link as described above);</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// add the dots with tooltips</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"dot"</code><code class="p">)</code>
     <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
   <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>
     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">})</code>
     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"mouseover"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
       <code class="nx">div</code><code class="p">.</code><code class="nx">transition</code><code class="p">()</code>
         <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code>
         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="p">.</code><code class="mi">9</code><code class="p">);</code>
       <code class="nx">div</code> <code class="p">.</code><code class="nx">html</code><code class="p">(</code>
         <code class="s1">'&lt;a href= "http://google.com"&gt;'</code> <code class="o">+</code> <code class="c1">// The first &lt;a&gt; tag</code>
         <code class="nx">formatTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code>
         <code class="s2">"&lt;/a&gt;"</code> <code class="o">+</code>                          <code class="c1">// closing &lt;/a&gt; tag</code>
         <code class="s2">"&lt;br/&gt;"</code>  <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code>     
         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageX</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>             
         <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageY</code> <code class="o">-</code> <code class="mi">28</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">);</code>
       <code class="p">});</code>
</pre></div>

</figure>

<p>We have removed the <code>.on("mouseout"</code> portion and moved the function that it used to carry out to the start of the <code>.on("mouseover"</code> portion. That way the first thing that occurs when the mouse cursor moves over a dot is that it removes the previous tooltip and then it places the new one.</p>

<p>The last change we need to make is to remove from the <code>&lt;style&gt;</code> section the line that told the mouse to ignore the tooltip;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    pointer-events: none;   /* This line needs to be removed */
</pre></div>

</figure>

<h5 id="leanpub-auto-moar-links">Moar Links!</h5>

<p>One link is interesting, but let’s face it, we didn’t go to all the trouble of putting a link into a tool tip to just go to one location. Now we shift it up a gear and start linking to different places depending on our data. At the same time (and because someone asked) we will make the link open in a new tab!</p>

<p>The changes to the script are fairly minor, but one fairly large change is the need to have links to go to. For this example I have added a range of links to visit to our csv file so it now looks like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close,link
1-May-12,58.13,http://bl.ocks.org/d3noob/c37cb8e630aaef7df30d
30-Apr-12,53.98,http://bl.ocks.org/d3noob/11313583
27-Apr-12,67.00,http://bl.ocks.org/d3noob/11306153
26-Apr-12,89.70,http://bl.ocks.org/d3noob/11137963
25-Apr-12,99.00,http://bl.ocks.org/d3noob/10633856
24-Apr-12,130.28,http://bl.ocks.org/d3noob/10633704
23-Apr-12,166.70,http://bl.ocks.org/d3noob/10633421
20-Apr-12,234.98,http://bl.ocks.org/d3noob/10633192
19-Apr-12,345.44,http://bl.ocks.org/d3noob/10632804
18-Apr-12,443.34,http://bl.ocks.org/d3noob/9692795
17-Apr-12,543.70,http://bl.ocks.org/d3noob/9267535
16-Apr-12,580.13,http://bl.ocks.org/d3noob/9211665
13-Apr-12,605.23,http://bl.ocks.org/d3noob/9167301
12-Apr-12,622.77,http://bl.ocks.org/d3noob/8603837
11-Apr-12,626.20,http://bl.ocks.org/d3noob/8375092
10-Apr-12,628.44,http://bl.ocks.org/d3noob/8329447
9-Apr-12,636.23,http://bl.ocks.org/d3noob/8329404
5-Apr-12,633.68,http://bl.ocks.org/d3noob/8150631
4-Apr-12,624.31,http://bl.ocks.org/d3noob/8273682
3-Apr-12,629.32,http://bl.ocks.org/d3noob/7845954
2-Apr-12,618.63,http://bl.ocks.org/d3noob/6584483
30-Mar-12,599.55,http://bl.ocks.org/d3noob/5893649
29-Mar-12,609.86,http://bl.ocks.org/d3noob/6077996
28-Mar-12,617.62,http://bl.ocks.org/d3noob/5193723
27-Mar-12,614.48,http://bl.ocks.org/d3noob/5141528
26-Mar-12,606.98,http://bl.ocks.org/d3noob/5028304
</pre></div>

</figure>

<p>The code change is to the piece of JavaScript where we add the HTML. This is what we end up with;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">div</code> <code class="p">.</code><code class="nx">html</code><code class="p">(</code>
        <code class="s1">'&lt;a href= "'</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">link</code><code class="o">+</code><code class="s1">'" target="_blank"&gt;'</code> <code class="o">+</code> <code class="c1">//with a link</code>
        <code class="nx">formatTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">)</code> <code class="o">+</code>
        <code class="s2">"&lt;/a&gt;"</code> <code class="o">+</code>
        <code class="s2">"&lt;br/&gt;"</code>  <code class="o">+</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">)</code>     
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"left"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageX</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">)</code>             
        <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"top"</code><code class="p">,</code> <code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">event</code><code class="p">.</code><code class="nx">pageY</code> <code class="o">-</code> <code class="mi">28</code><code class="p">)</code> <code class="o">+</code> <code class="s2">"px"</code><code class="p">);</code>
</pre></div>

</figure>

<p>We’ve replaced the URL <code>http://google.com</code> with the variable for our <code>link</code> column <code>d.link</code> and we’ve also added in the <code>target="_blank"</code> statement so that our link opens in a new tab. </p>

<aside class="warning blurb">
    <p>A quick word of warning on this piece of code. it can look a little messy because it includes nested speech-marks and quotation marks. This makes it a bit confusing if you’re unused to the idea of nesting this type of information. If things aren’t working in this part of your code, I recommend going back to basics and adding one piece at a time, getting it right and then add the next piece. Take it slow :-).</p>

</aside>

<p>The full code for this multi link example can be found on <a href="https://gist.github.com/d3noob/a04a5897a92c046563017c7590f0c12c">github</a> or in the code samples bundled with this book (tooltips-link-multi.html and data-link.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/a04a5897a92c046563017c7590f0c12c">bl.ocks.org</a>. </p>

<p>Hopefully that helps people with a similar desire to include links in their tooltips. Many thanks to the reader who suggested it :-).</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-what-are-the-predefined-named-colours">What are the predefined, named colours?</h3>

<p>Throughout this document I generally use colours defined by name. This is mainly because I can, and not for any other reason. In fact there several different ways to define colours used in D3 / JavaScript / CSS and HTML. I have no idea what the limitations for use are and / or how their use in different browsers impacts on correct representation. But I do know that they’re used widely.</p>

<p>There seem to be several different standards for what constitutes an authoritative list of named colours. After a cursory search I was able to find a great list on <a href="http://webdesign.about.com/od/colorcharts/l/bl_namedcolors.htm">about.com</a> and there are some nice representations on <a href="http://en.wikipedia.org/wiki/Web_colors#X11_color_names">Wikipedia</a>.</p>

<p>The overriding point of all this is that there’s more than one way to define colours in your graphs.</p>

<p>It means that considering… 
		<code>.style("fill", "steelblue")</code><br>
and…<br>
		<code>.style("fill", "#4682b4")</code><br>
and…<br>
		<code>.style("fill", "rgb(70,130,180)")</code>  </p>

<p>All three alternatives result in the same colour being applied.</p>

<p>For a long time I didn’t actually have the images of the colours represented here in D3 Tips and Tricks, but like all things, one day I thought ‘Hey, I could just write a simple script that placed them on the screen’. So here they are :-). </p>

<p>I have tried to group them as ‘like’ colours per the entry in Wikipedia.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-01.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-02.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-03.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-04.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-05.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-06.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-07.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-08.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-09.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-10.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-11.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-12.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-13.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-14.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-15.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-16.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-17.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-18.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-19.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-20.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-21.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-22.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-23.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-24.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-25.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-26.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-27.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-28.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-29.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-30.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-31.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-32.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-33.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-34.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-35.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-36.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-37.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-39.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-40.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-41.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-42.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-43.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-44.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-45.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-46.png" alt="">
  <figcaption></figcaption>
</figure>



<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/colour-47.png" alt="">
  <figcaption></figcaption>
</figure>


<p>You can also see a live page with the script that produces the rectangles at <a href="http://bl.ocks.org/d3noob/11313583">bl.ocks.org</a>.</p>

<div class="page-break"></div>

<h3 id="filtering">Selecting / filtering a subset of objects</h3>

<p>Imagine a scenario where you want to select (or should we say <strong>filter</strong>) a particular range of objects from a larger set.</p>

<p>For example, what if we wanted to use our scatter plot example to show the line as normal, but we are particularly interested in the points where the values of the points fall below 400. Therefore, when the value falls below 400 we want them highlighted with a circle as we have done with *the scatter plot points previously.</p>

<p>So that we end up with something that looks a little like this…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/filter01.png" alt="Only the points below 400 are selected">
  <figcaption>Only the points below 400 are selected</figcaption>
</figure>


<p>Err… Yes, for those among you who are of the observant persuasion, I have deliberately coloured them red as well (red for <strong>DANGER</strong>!).</p>

<p>This is a fairly simple example, but serves to illustrate the principle adequately.
From our simple scatter plot example we only need to add in two lines to the block of code that draws the circles as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the scatterplot</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"dot"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">&lt;</code> <code class="mi">400</code> <code class="p">})</code>  <code class="c1">// &lt;== This line</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">)</code>                          <code class="c1">// &lt;== and this one</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>
</pre></div>

</figure>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/47b319ec0250b4063063942c64f0f949">github</a> or in the code samples bundled with this book (filter-selection.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/47b319ec0250b4063063942c64f0f949">bl.ocks.org</a>. </p>

<p>The first added line uses the <code>.filter</code> function to act on the data points and according to the arguments passed to it in this case, only return those where the value of d.close is less than 400 (<code>return d.close &lt; 400</code>).</p>

<p>The second added line simply colours the circles red (<code>.style("fill", "red")</code>).</p>

<p>That’s all there is to it. Pretty simple, but the filter function can be very powerful when used wisely.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-select-items-with-an-if-statement">Select items with an IF statement.</h3>

<p>The <a href="#filtering">filtering – selection section</a> above is a good way to adapt what you see on a graph, but so is a more familiar friend… The ‘if’ statement.</p>

<p>An ‘if’ statement will act to carry out a task in a particular way dependant on a condition that you specify. </p>

<aside class="tip blurb">
    <p>Here’s an example, what if we wanted to show our scatter plot as normal, but all those with a ‘close’ value less than 400 should be coloured red. Sound familiar?  Yes, I know it’s similar to the example above, with the subtle difference that it is leaving the circles above 400 in place (more on that to follow).</p>

</aside>

<p>Starting with the <a href="#scatterplot">simple scatter plot</a> example all we have to do is include the if statement in the block of code that draws the circles. Here’s the entire block with the additions highlighted;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the scatterplot</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"dot"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>            <code class="c1">// &lt;== Add these</code>
          <code class="k">if</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">&lt;=</code> <code class="mi">400</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="s2">"red"</code><code class="p">}</code>  <code class="c1">// &lt;== Add these</code>
          <code class="k">else</code> <code class="p">{</code> <code class="k">return</code> <code class="s2">"black"</code> <code class="p">}</code>             <code class="c1">// &lt;== Add these</code>
      <code class="p">;})</code>                                     <code class="c1">// &lt;== Add these</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>	
</pre></div>

</figure>

<p>Our first added line introduces the style modifier and the rest of the code acts to provide a return for the ‘fill’ attribute.</p>

<p>The second line introduces our if statement. There’s very little difference using <code>if</code> statements between languages. Just look out for maintaining the correct syntax and you should be fine. In this case we’re asking if the value of ‘d.close’ is less than or equal to 400 and if it is it will return the <code>"red"</code> statement for our fill.</p>

<p>The third line covers our rear and make sure that if the colour isn’t going to be red, it’s going to be black. The last line just closes the style and function statements.</p>

<p>The result?</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/if01.png" alt="Points above 400 black and points below 400 red">
  <figcaption>Points above 400 black and points below 400 red</figcaption>
</figure>


<p>Aww….. nice.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/491c32149571faef2750632d4620e7ce">github</a> or in the code samples bundled with this book (if-selection.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/491c32149571faef2750632d4620e7ce">bl.ocks.org</a>. </p>

<p>Could it be any cooler? I’m glad you asked.</p>

<p>What if we wanted to have all the points where close was less than 400 red and all those where close was greater than 620 green? Oh yeah! Now we’re talking.</p>

<p>So with one small change to the if statement;</p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>   
         <code class="k">if</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">&lt;=</code> <code class="mi">400</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="s2">"red"</code><code class="p">}</code>  
         <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">&gt;=</code> <code class="mi">620</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="s2">"lawngreen"</code><code class="p">}</code> <code class="c1">// &lt;== Right here </code>
         <code class="k">else</code> <code class="p">{</code> <code class="k">return</code> <code class="s2">"black"</code> <code class="p">}</code>  
      <code class="p">;})</code>  	
</pre></div>

</figure>

<p>Check it out…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/if02.png" alt="Points coloured differently depending on their value">
  <figcaption>Points coloured differently depending on their value</figcaption>
</figure>


<p>Nice.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-applying-a-colour-gradient-to-a-line-based-on-value">Applying a colour gradient to a line based on value.</h3>

<p>I know that we were impressed with the changing dots in a scatter plot based on the value. But could we go one better?</p>

<p>How about we try to reproduce the same effect but by varying the colour of the plotted line.
This is a neat feature and a useful example of the flexibility of d3.js and SVG in general.
I used the appropriate bits of code from Mike Bostock’s <a href="http://bl.ocks.org/3970883">Threshold Encoding example</a>. And I should take the opportunity to heartily recommend browsing through his collection of examples on <a href="http://bl.ocks.org/mbostock">bl.ocks.org</a>.</p>

<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/d3a22ef27b253ab8d49e97699a8e84b1">github</a> or in the code samples bundled with this book (line-graph-gradient.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/d3a22ef27b253ab8d49e97699a8e84b1">bl.ocks.org</a>. </p>

<p>Here then is a plotted line that is red below 400, green above 620 and black in between.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/gradientline01.png" alt="Line colour varied with gradient">
  <figcaption>Line colour varied with gradient</figcaption>
</figure>


<p>How cool is that?</p>

<p>Enough beating around the bush, how is the magic line produced?</p>

<p>Starting with our <a href="#simplegraph">simple line graph</a>, there are only two blocks of code to go in. One is CSS in the <code>&lt;style&gt;</code> area and the second is a tricky little piece of code that deals with gradients.</p>

<p>First the CSS.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.line</code> <code class="p">{</code>							
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>					
  <code class="n">stroke</code><code class="o">:</code> <code class="sx">url(#line-gradient)</code><code class="p">;</code>	
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>			
<code class="p">}</code>	
</pre></div>

</figure>

<p>This block will go in the <code>&lt;style&gt;</code> area.</p>

<p>There’s the fairly standard fill of none and a stroke width of 2 pixels, but the <code>stroke: url(#line-gradient);</code> is something different.</p>

<p>In this case the stroke (the colour of the line) is being determined at a link within the page which is set by the anchor <code>#line-gradient</code>. We will see shortly that this is in our second block of code, so the colour is being defined in a separate portion of the script.</p>

<p>And now the JavaScript gradient code;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// set the gradient</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"linearGradient"</code><code class="p">)</code>				
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"line-gradient"</code><code class="p">)</code>			
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"gradientUnits"</code><code class="p">,</code> <code class="s2">"userSpaceOnUse"</code><code class="p">)</code>	
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x1"</code><code class="p">,</code> <code class="mi">0</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y1"</code><code class="p">,</code> <code class="nx">y</code><code class="p">(</code><code class="mi">0</code><code class="p">))</code>			
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x2"</code><code class="p">,</code> <code class="mi">0</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y2"</code><code class="p">,</code> <code class="nx">y</code><code class="p">(</code><code class="mi">1000</code><code class="p">))</code>		
  <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"stop"</code><code class="p">)</code>						
    <code class="p">.</code><code class="nx">data</code><code class="p">([</code>								
      <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"0%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">},</code>		
      <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"40%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">},</code>	
      <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"40%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"black"</code><code class="p">},</code>		
      <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"62%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"black"</code><code class="p">},</code>		
      <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"62%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"lawngreen"</code><code class="p">},</code>	
      <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"100%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"lawngreen"</code><code class="p">}</code>	
    <code class="p">])</code>					
  <code class="p">.</code><code class="nx">enter</code><code class="p">().</code><code class="nx">append</code><code class="p">(</code><code class="s2">"stop"</code><code class="p">)</code>			
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"offset"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">offset</code><code class="p">;</code> <code class="p">})</code>	
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"stop-color"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code><code class="p">;</code> <code class="p">});</code>		
</pre></div>

</figure>

<p>There’s our anchor on the third line!</p>

<p>But let’s not get ahead of ourselves. This block should be placed after the x and y domains are set, but before the line is drawn.</p>

<aside class="information blurb">
    <p>Seems a bit strange doesn’t it? This block is all about defining the actions of an element, but the element in this case is a gradient and the gradient acts on the line. This is one of the cool things about writing code and regarding that code as a set of building blocks of the final product. There are many supporting components for the final product.</p>

</aside>

<p>Our second line adds our linear gradient. Gradients consist of continuously smooth colour transitions along a vector from one colour to another. We can have a linear or radial gradient and depending on which you select, there are a few options to define. There is some great information on gradients at <a href="http://www.w3.org/TR/SVG/pservers.html">http://www.w3.org/TR/SVG/pservers.html</a> (more than I ever thought existed).</p>

<p>The third line (<code>.attr("id", "line-gradient")</code>) sets our anchor for the CSS that we saw earlier.</p>

<p>The fourth, fifth and sixth lines define the bounds of the area over which the gradient will act. Since the coordinates <code>x1</code>, <code>y1</code>, <code>x2</code>, <code>y2</code> will describe an area. The values for <code>y1</code> (0) and <code>y2</code> (1000) are used more for convenience to align with our data (which has a maximum value around 630 or so). For more information on the ‘gradientUnits’ attribute I found this page useful <a href="https://developer.mozilla.org/en-US/docs/SVG/Attribute/gradientUnits">https://developer.mozilla.org/en-US/docs/SVG/Attribute/gradientUnits</a>. We’ll come back to the coordinates in a moment.</p>

<p>The next block selects all the ‘stop’ elements for the gradients. These stop elements define where on the range covered by our coordinates the colours start and stop. These have to be defined as either percentages or numbers (where the numbers are really just percentages in disguise (i.e. 45% =0.45)).</p>

<p>The best way to consider the stop elements is in conjunction with the <code>gradientUnits</code>. The image following may help.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/gradientline02.png" alt="Varying colours for varying values make a gradient">
  <figcaption>Varying colours for varying values make a gradient</figcaption>
</figure>


<p>In this case our coordinates describe a vertical line from 0 to 1000. Our colours transition from red (0) to red (400) at which point they change to black (400) and this will continue until it gets to black (620). Then this changes to green (620) and from there, any value above that will be green.</p>

<aside class="information blurb">
    <p>Now, it might seem a little convoluted to be doubling up on the colours and values, but the reason is that the gradient functions have a lot more to them than meets the eye and we’ll have a look at the possibilities once the explanation of the code is done.</p>

</aside>

<p>After defining the stop elements, we enter and append the elements to the gradient (<code>.enter().append("stop")</code>) with attributes for offset and colour that we defined in the stop elements area.</p>

<p>Now, that <em>IS</em> cool, but by now, I hope that you have picked that a gradient function really does mean a gradient, and not just a straight change from one colour to another.</p>

<p>So, let’s try changing the stop element offsets to the following (and making the stroke-width slightly larger to see more clearly what’s going on);</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">data</code><code class="p">([</code>								
      <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"0%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">},</code>		
      <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"30%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"red"</code><code class="p">},</code>	
      <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"45%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"black"</code><code class="p">},</code>		
      <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"55%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"black"</code><code class="p">},</code>		
      <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"60%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"lawngreen"</code><code class="p">},</code>	
      <code class="p">{</code><code class="nx">offset</code><code class="o">:</code> <code class="s2">"100%"</code><code class="p">,</code> <code class="nx">color</code><code class="o">:</code> <code class="s2">"lawngreen"</code><code class="p">}</code>	
    <code class="p">])</code>		
</pre></div>

</figure>

<p>And here we go…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/gradientline03.png" alt="Line with a gradually changing gradient">
  <figcaption>Line with a gradually changing gradient</figcaption>
</figure>


<p>Ahh… A real gradient.</p>

<p>I have tended to find that I need to have a good think about how I set the offsets and bounds when doing this sort of thing since it can get quite complicated quite quickly :-)</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-applying-a-colour-gradient-to-an-area-fill">Applying a colour gradient to an area fill.</h3>

<p>The previous example of a varying gradient on a line is neat, but hopefully you’re already thinking “Hang on, can’t that same thing be applied to an area fill?”.</p>

<p>Damn! You’re catching on.</p>

<p>To do this there’s only a few things we need to change;</p>

<p>First of all the CSS for the line needs to be amended to refer to the area. So this…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.line</code> <code class="p">{</code>							
  <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>					
  <code class="n">stroke</code><code class="o">:</code> <code class="sx">url(#line-gradient)</code><code class="p">;</code>	
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2px</code><code class="p">;</code>			
<code class="p">}</code>		
</pre></div>

</figure>

<p>…gets changed to this…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nc">.area</code> <code class="p">{</code>							
  <code class="n">fill</code><code class="o">:</code> <code class="sx">url(#area-gradient)</code><code class="p">;</code>					
  <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">0px</code><code class="p">;</code>			
<code class="p">}</code>		
</pre></div>

</figure>

<p>We’ve defined the styles for the area this time, but instead of the stroke being defined by the separate script, now it’s the area. While we’ve changed the url name, it’s actually the same piece of code, with a different id (because it seemed wrong to be talking about an area when the label said line). We’ve also set the stroke width to zero, because we don’t want any lines around our filled area.</p>

<p>Now we want to take the block of code that defined our line…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// define the line</code>
<code class="kd">var</code> <code class="nx">valueline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>		
</pre></div>

</figure>

<p>… and we need to replace it with the standard block that defined an area fill.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// define the area</code>
<code class="kd">var</code>	<code class="nx">area</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">area</code><code class="p">()</code>	
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>	
    <code class="p">.</code><code class="nx">y0</code><code class="p">(</code><code class="nx">height</code><code class="p">)</code>					
    <code class="p">.</code><code class="nx">y1</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code> <code class="p">});</code>		
</pre></div>

</figure>

<p>So we’re not going to be drawing a line at all. Just the area fill.</p>

<p>Next, as I mentioned earlier, we change the id for the <code>linearGradient</code> block from <code>"line-gradient"</code> to <code>"area-gradient"</code></p>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"area-gradient"</code><code class="p">)</code>			
</pre></div>

</figure>

<p>And lastly, we remove the block of code that drew the line and replace it with a block that draws  an area. So change this….</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the valueline path.</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="nx">data</code><code class="p">])</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">);</code>
</pre></div>

</figure>

<p>… to this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// Add the area.</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="nx">data</code><code class="p">])</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"area"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">area</code><code class="p">);</code>
</pre></div>

</figure>

<p>And then sit back and marvel at your creation;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/gradientarea01.png" alt="Area fill with a gradually changing gradient">
  <figcaption>Area fill with a gradually changing gradient</figcaption>
</figure>


<p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/49570a3cd70390c257c80ac75c5049f1">github</a> or in the code samples bundled with this book (area-graph-gradient.html and data.csv). A working example can be found on <a href="http://bl.ocks.org/d3noob/49570a3cd70390c257c80ac75c5049f1">bl.ocks.org</a>. </p>

<p>For a slightly ‘nicer’ looking example, you could check out a variation of one of Mike Bostock’s (v3) originals here; <a href="http://bl.ocks.org/4433087">http://bl.ocks.org/4433087</a>.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-transitions-1">Transitions</h3>

<p>A transition in d3 is an application of an animation to an <a href="#elements">element</a> on the page. For the purpose of demonstration  we can think of an <a href="#elements">element</a> being one of the common shapes and objects which include circles, ellipses, rectangles, lines, polylines, polygons, text and paths. This is a gross oversimplification as transitions can be applied in far more complex ways, but this will help us get started. An animation could be described as a change in an attribute or style of an element over time.</p>

<p>If we use a <a href="#circle">circle</a> as an example we know that a <a href="#circle">circle</a> is described by three required attributes; </p>

<ul>
  <li>
<code>cx</code>: The position of the centre of the circle in the x direction (left / right) measured from the left side of the screen.</li>
  <li>
<code>cy</code>: The position of the centre of the circle in the y direction (up / down) measured from the top of the screen.</li>
  <li>
<code>r</code>: The radius of the circle from the <code>cx</code>, <code>cy</code> position to the perimeter of the circle. </li>
</ul>

<p>To animate a <a href="#circle">circle</a> we would therefore be <em>changing</em> (or transitioning) one of those attributes over time.</p>

<p>The following JavaScript will draw a simple blue circle with radius 20 pixels at the position 40,250 </p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code> <code class="c1">// Select the body element</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>          <code class="c1">// Append an SVG element to the body</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">960</code><code class="p">)</code>     <code class="c1">// make it 960 pixels wide</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">500</code><code class="p">)</code>    <code class="c1">// make it 500 pixels high</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>       <code class="c1">// append a cicle to the svg</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code>   <code class="c1">// fill the circle with 'blue'</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>          <code class="c1">// set the radius to 10 pixels</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">40</code><code class="p">)</code>         <code class="c1">// position the circle at 40 on the x axis</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cy'</code><code class="p">,</code> <code class="mi">250</code><code class="p">);</code>       <code class="c1">// position the circle at 250 on the y axis</code>
</pre></div>

</figure>

<p>To transition that circle from left to right we would change the <code>cx</code> attribute by simply including the transition instruction the new value of the attribute to be changed and the time that it should be completed in;</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="p">.</code><code class="nx">transition</code><code class="p">()</code>           <code class="c1">// apply a transition</code>
	<code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">4000</code><code class="p">)</code>         <code class="c1">// apply it over 4000 milliseconds</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">920</code><code class="p">);</code>       <code class="c1">// new horizontal position at 920 on x axis</code>
</pre></div>

</figure>

<p>The total amount of code required is;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>    
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code> <code class="c1">// Select the body element</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>          <code class="c1">// Append an SVG element to the body</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">960</code><code class="p">)</code>     <code class="c1">// make it 960 pixels wide</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">500</code><code class="p">)</code>    <code class="c1">// make it 500 pixels high</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>       <code class="c1">// append a circle to the svg</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code>   <code class="c1">// fill the circle with 'blue'</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>          <code class="c1">// set the radius to 10 pixels</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">40</code><code class="p">)</code>         <code class="c1">// position the circle at 40 on the x axis</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cy'</code><code class="p">,</code> <code class="mi">250</code><code class="p">)</code>        <code class="c1">// position the circle at 250 on the y axis</code>
	<code class="p">.</code><code class="nx">transition</code><code class="p">()</code>           <code class="c1">// apply a transition</code>
	<code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">4000</code><code class="p">)</code>         <code class="c1">// apply it over 4000 milliseconds</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">920</code><code class="p">);</code>       <code class="c1">// new horizontal position at 920 on x axis</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<aside class="information blurb">
    <p>The full code for this example can also be found on <a href="https://gist.github.com/d3noob/c3cbb8af554eb848d09ab97306bb5583">github</a> or in the code samples bundled with <a href="https://leanpub.com/d3-t-and-t-v4">this book</a> (transition-circle.html). A working example can be found on <a href="http://bl.ocks.org/d3noob/c3cbb8af554eb848d09ab97306bb5583">bl.ocks.org</a>. </p>

</aside>

<p>And seen on the web page our circle moves from left to right.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/transition-01.png" alt="Circle Transition">
  <figcaption>Circle Transition</figcaption>
</figure>


<p>A transition can be of more than one attribute at the same time. If we add lines to change the radius and fill colour as well we will have some JavaScript that looks a bit like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code> <code class="c1">// Select the body element</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>          <code class="c1">// Append an SVG element to the body</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">960</code><code class="p">)</code>     <code class="c1">// make it 960 pixels wide</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">500</code><code class="p">)</code>    <code class="c1">// make it 500 pixels high</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>       <code class="c1">// append a circle to the svg</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code>  <code class="c1">// fill the circle with 'blue'</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>          <code class="c1">// set the radius to 10 pixels</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">40</code><code class="p">)</code>         <code class="c1">// position the circle at 40 on the x axis</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cy'</code><code class="p">,</code> <code class="mi">250</code><code class="p">)</code>        <code class="c1">// position the circle at 250 on the y axis</code>
    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>           <code class="c1">// apply a transition</code>
    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">4000</code><code class="p">)</code>         <code class="c1">// apply it over 4000 milliseconds</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">920</code><code class="p">)</code>        <code class="c1">// new horizontal position at 920 on x axis</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'r'</code><code class="p">,</code> <code class="mi">40</code><code class="p">)</code>          <code class="c1">// new radius of 40 pixels</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s1">'fill'</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">);</code>  <code class="c1">// new colour red</code>
</pre></div>

</figure>

<p>And when we load the page we see our circle move from left to right wile at the same time increasing in radius and changing colour from blue to red.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/transition-02.png" alt="Multi Attribute Circle Transition">
  <figcaption>Multi Attribute Circle Transition</figcaption>
</figure>


<h4 id="chaining">Transitioning Chaining</h4>

<p>Instead of having multiple attributes / styles changing at once we can stagger them using transition chaining. This is where we can employ several different transitions to an element one after the other.</p>

<p>For example, the following JavaScript will move our circle from left to right <em>then</em> it will increase the radius from 20 to 40 and <em>then</em> it will change it’s colour from blue to red.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code> <code class="c1">// Select the body element</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>          <code class="c1">// Append an SVG element to the body</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">960</code><code class="p">)</code>     <code class="c1">// make it 960 pixels wide</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">500</code><code class="p">)</code>    <code class="c1">// make it 500 pixels high</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>       <code class="c1">// append a circle to the svg</code>
	<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code>  <code class="c1">// fill the circle with 'blue'</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>          <code class="c1">// set the radius to 10 pixels</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">40</code><code class="p">)</code>         <code class="c1">// position the circle at 40 on the x axis</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cy'</code><code class="p">,</code> <code class="mi">250</code><code class="p">)</code>        <code class="c1">// position the circle at 250 on the y axis</code>
    <code class="c1">// 1st transition  </code>
	<code class="p">.</code><code class="nx">transition</code><code class="p">()</code>           <code class="c1">// apply a transition</code>
	<code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">4000</code><code class="p">)</code>         <code class="c1">// apply it over 4000 milliseconds</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">920</code><code class="p">)</code>        <code class="c1">// new horizontal position at 920 on x axis</code>
    <code class="c1">// 2nd transition</code>
	<code class="p">.</code><code class="nx">transition</code><code class="p">()</code>           <code class="c1">// apply a transition</code>
	<code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">4000</code><code class="p">)</code>         <code class="c1">// apply it over 4000 milliseconds</code>
	<code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'r'</code><code class="p">,</code> <code class="mi">40</code><code class="p">)</code>          <code class="c1">// new radius of 40 pixels</code>
    <code class="c1">// 3rd transition</code>
	<code class="p">.</code><code class="nx">transition</code><code class="p">()</code>           <code class="c1">// apply a transition</code>
	<code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">4000</code><code class="p">)</code>         <code class="c1">// apply it over 4000 milliseconds</code>
	<code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s1">'fill'</code><code class="p">,</code> <code class="s2">"red"</code><code class="p">);</code>  <code class="c1">// new colour red</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/transition-03.png" alt="Transition Chaining">
  <figcaption>Transition Chaining</figcaption>
</figure>


<aside class="information blurb">
    <p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/899a0b2490318a96f9ebd40a5a84e4a7">github</a> or in the code samples bundled with <a href="https://leanpub.com/d3-t-and-t-v4">this book</a> (transition-chaining.html). A working example can be found on <a href="http://bl.ocks.org/d3noob/899a0b2490318a96f9ebd40a5a84e4a7">bl.ocks.org</a>. </p>

</aside>

<h4 id="leanpub-auto-transition-easing">Transition Easing</h4>

<p>The reader who runs the code or checks out the simple example <a href="http://bl.ocks.org/d3noob/c3cbb8af554eb848d09ab97306bb5583">here</a> will notice that our circle does not move from one side to the other at a constant speed. It starts off slowly, builds up speed towards the middle of its travels and then slows down before stopping. This gives the movement a pleasing appearance, but it is an example of the ‘<a href="https://github.com/d3/d3-ease">easing</a>’ of the transition from one point to another.</p>

<p>To apply a linear motion to the movement we can introduce <code>.ease(d3.easeLinear)</code> to the code as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code> <code class="c1">// Select the body element</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>          <code class="c1">// Append an SVG element to the body</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">960</code><code class="p">)</code>     <code class="c1">// make it 960 pixels wide</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">500</code><code class="p">)</code>    <code class="c1">// make it 500 pixels high</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>       <code class="c1">// append a circle to the svg</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code>  <code class="c1">// fill the circle with 'blue'</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code>          <code class="c1">// set the radius to 10 pixels</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">40</code><code class="p">)</code>         <code class="c1">// position the circle at 40 on the x axis</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cy'</code><code class="p">,</code> <code class="mi">250</code><code class="p">)</code>        <code class="c1">// position the circle at 250 on the y axis</code>
    <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>           <code class="c1">// apply a transition</code>
    <code class="p">.</code><code class="nx">ease</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">easeLinear</code><code class="p">)</code>    <code class="c1">// control the speed of the transition</code>
    <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">4000</code><code class="p">)</code>         <code class="c1">// apply it over 4000 milliseconds</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">920</code><code class="p">);</code>       <code class="c1">// new horizontal position at 920 on x axis</code>
</pre></div>

</figure>

<p>The easing of an element describes a distortion in the apparent flow of time. There are a range of different types of easing described in the <a href="https://github.com/d3/d3-ease">d3 wiki</a>. Most are representative of a function although there are some which are intended to represent specific real-world motions.</p>

<ul>
  <li>linear</li>
  <li>quad</li>
  <li>cubic</li>
  <li>poly</li>
  <li>sin</li>
  <li>exp</li>
  <li>circle</li>
  <li>bounce</li>
  <li>back</li>
  <li>elastic</li>
</ul>

<p>Each easing (except linear) can be further modified using ‘In’, ‘Out’ or InOut’ which allows for variations in the animation that can give the appearance of starting or stopping at different points in the curves or in the case of ‘InOut’ of going through a complete transition. For example, <code>.ease(d3.easeExpIn)</code> or <code>.ease(d3.easePolyInOut)</code>.</p>

<p>If an easing function is not specified, the default used is cubic and if ‘In’, ‘Out’ or InOut’ aren’t specified, the default is ‘InOut’ except for bounce and elastic which use ‘Out’. Therefore we can use <code>.ease(d3.easePoly)</code> which is an alias for <code>.ease(d3.easePolyInOut)</code>. ‘easePoly’ is also an alias for ‘easeCubic’ (and vice versa).</p>

<p>To get a good impression of the way that each easing method is represented, Mike Bostock has an ‘<a href="http://bl.ocks.org/mbostock/248bac3b8e354a9103c4">Easing Explorer</a>’ block set up here. There is also a block to do a side by side comparison <a href="http://bl.ocks.org/d3noob/1ea51d03775b9650e8dfd03474e202fe">here</a> (this is also in the code samples bundled with <a href="https://leanpub.com/d3-t-and-t-v4">this book</a> (transition-easing-multiple.html)).</p>

<h4 id="leanpub-auto-looping-a-transition">Looping a Transition</h4>

<p>We can use a transition to create a convincing impression of an element that is in a constant rate of change in a looping condition. We achieve this by creating a <a href="#chaining">transition chain</a> that starts and ends in the same state and then we instruct the transition code to repeat itself.</p>

<p>In the example we will have a circle that moves from left to right and then back again constantly.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/transition-04.png" alt="Looping Transitionn">
  <figcaption>Looping Transitionn</figcaption>
</figure>


<aside class="information blurb">
    <p>The full code for this example can be found on <a href="https://gist.github.com/d3noob/bf44061b1d443f455b3f857f82721372">github</a> or in the code samples bundled with <a href="https://leanpub.com/d3-t-and-t-v4">this book</a> (transition-looping.html). A working example can be found on <a href="http://bl.ocks.org/d3noob/bf44061b1d443f455b3f857f82721372">bl.ocks.org</a>. </p>

</aside>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>    
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">960</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">500</code><code class="p">);</code>

<code class="kd">function</code> <code class="nx">circleTransition</code><code class="p">()</code> <code class="p">{</code> 

    <code class="kd">var</code> <code class="nx">timeCircle</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"steelblue"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">20</code><code class="p">);</code>
    <code class="nx">repeat</code><code class="p">();</code>
    
    <code class="kd">function</code> <code class="nx">repeat</code><code class="p">()</code> <code class="p">{</code>
      <code class="nx">timeCircle</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">40</code><code class="p">)</code>      <code class="c1">// position the circle at 40 on the x axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cy'</code><code class="p">,</code> <code class="mi">250</code><code class="p">)</code>     <code class="c1">// position the circle at 250 on the y axis</code>
        <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>        <code class="c1">// apply a transition</code>
        <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">2000</code><code class="p">)</code>      <code class="c1">// apply it over 2000 milliseconds</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">920</code><code class="p">)</code>     <code class="c1">// move the circle to 920 on the x axis</code>
        <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>        <code class="c1">// apply a transition</code>
        <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">2000</code><code class="p">)</code>      <code class="c1">// apply it over 2000 milliseconds</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">40</code><code class="p">)</code>      <code class="c1">// return the circle to 40 on the x axis</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"end"</code><code class="p">,</code> <code class="nx">repeat</code><code class="p">);</code>  <code class="c1">// when the transition finishes start again</code>
    <code class="p">};</code>

<code class="p">};</code>

<code class="nx">circleTransition</code><code class="p">();</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The JavaScript starts by creating an SVG element;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">960</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">500</code><code class="p">);</code>
</pre></div>

</figure>

<p>We then declare the function <code>circleTransition</code> which starts by creating the component that defines the circle and gives it a colour and radius;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">timeCircle</code> <code class="o">=</code> <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"steelblue"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">20</code><code class="p">);</code>
</pre></div>

</figure>

<p>We then call a sub function <code>repeat</code> that performs the transition chaining loop. Then the looping transition is declared;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">function</code> <code class="nx">repeat</code><code class="p">()</code> <code class="p">{</code>
      <code class="nx">timeCircle</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">40</code><code class="p">)</code>      <code class="c1">// position the circle at 40 on the x axis</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cy'</code><code class="p">,</code> <code class="mi">250</code><code class="p">)</code>     <code class="c1">// position the circle at 250 on the y axis</code>
        <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>        <code class="c1">// apply a transition</code>
        <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">2000</code><code class="p">)</code>      <code class="c1">// apply it over 2000 milliseconds</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">920</code><code class="p">)</code>     <code class="c1">// move the circle to 920 on the x axis</code>
        <code class="p">.</code><code class="nx">transition</code><code class="p">()</code>        <code class="c1">// apply a transition</code>
        <code class="p">.</code><code class="nx">duration</code><code class="p">(</code><code class="mi">2000</code><code class="p">)</code>      <code class="c1">// apply it over 2000 milliseconds</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'cx'</code><code class="p">,</code> <code class="mi">40</code><code class="p">)</code>      <code class="c1">// return the circle to 40 on the x axis</code>
        <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"end"</code><code class="p">,</code> <code class="nx">repeat</code><code class="p">);</code>  <code class="c1">// when the transition finishes start again</code>
    <code class="p">};</code>
</pre></div>

</figure>

<p>Here we can see the familiar parts of a transition where the attributes and transition details are declared in a chain so that when it completes, the circle has moved from the left to the right and then back to the starting position. At that point the code listens for the <code>end</code> of the transformations, and when this occurs it calls the transition function <code>repeat</code> again. This will continue to cycle indefinitely.</p>

<p>The last part of the code is the instruction to call our initial function;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">circleTransition</code><code class="p">();</code>
</pre></div>

</figure>

<p>Because the code is executing <a href="https://www.pluralsight.com/guides/front-end-javascript/introduction-to-asynchronous-javascript">asynchronously</a>, it can continue to oscillate while other code could be carrying out other tasks.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-show--hide-an-element-by-clicking-on-another-element">Show / hide an element by clicking on another element</h3>

<p>This is a trick that I found I wanted to implement in order to present a graph with a range of lines and to then provide the reader with the facility to click on the associated legend to toggle the visibility of the lines off and on as required.</p>

<p>The example we’ll follow is our friend from earlier, a slightly modified example of the graph with two lines.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/show-hide-01.png" alt="Show / hide lines on a graph">
  <figcaption>Show / hide lines on a graph</figcaption>
</figure>


<p>In this example we will be able to click on either of the two titles at the bottom of the graph (‘Blue Line’ or ‘Red Line’) and have it toggle the respective line and Y axis.</p>

<h5 id="leanpub-auto-the-code-2">The code</h5>

<p>The code for the example is available online at <a href="http://http://bl.ocks.org/d3noob/4abb9dc578abf070fe62302282a29c41">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/4abb9dc578abf070fe62302282a29c41">GitHub</a>. It is also available as the file ‘show-hide.html’ that can be a download when you <a href="https://leanpub.com/d3-t-and-t-v4">download the book from Leanpub</a>.</p>

<p>There are more changes in the example code than we will explain below such as the addition of CSS to the <code>&lt;style&gt;</code> area and the code that allows both of the lines to be shown / hidden (we’ll only go through the blue line code).</p>

<p>There are two main parts to implementing this technique. Firstly we have to label the element (or elements) that we wish to show / hide and then we have to give the object that will get clicked on the attribute that allows it to recognise a mouse click and the code that it subsequently uses to show / hide our labelled element.</p>

<p>Labelling the element that is to be switched on and off is dreadfully easy. It simply involves including an <code>id</code> attribute to an element that identifies it uniquely. </p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// add the valueline path.</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">data</code><code class="p">([</code><code class="nx">data</code><code class="p">])</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"blueLine"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">valueline</code><code class="p">);</code>
</pre></div>

</figure>

<p>In the example above we have applied the <code>id</code> <code>blueLine</code> to the path that draws the blue line on our graph.</p>

<p>The second part is a little trickier. The following is the portion of JavaScript that places our text label under the graph. The only part of it that is unusual is the <code>.on("click", function()</code> section of the code.</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// add the blue line legend</code>
  <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>             
     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="mi">15</code><code class="p">)</code>    
     <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"legend"</code><code class="p">)</code>
     <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"steelblue"</code><code class="p">)</code>         
     <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(){</code>
       <code class="c1">// determine if current line is visible</code>
       <code class="kd">var</code> <code class="nx">active</code> <code class="o">=</code> <code class="nx">blueLine</code><code class="p">.</code><code class="nx">active</code> <code class="o">?</code> <code class="kc">false</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
       <code class="nx">newOpacity</code> <code class="o">=</code> <code class="nx">active</code> <code class="o">?</code> <code class="mi">0</code> <code class="o">:</code> <code class="mi">1</code><code class="p">;</code>
       <code class="c1">// hide or show the elements</code>
       <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#blueLine"</code><code class="p">).</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="nx">newOpacity</code><code class="p">);</code>
       <code class="c1">// update whether or not the elements are active</code>
       <code class="nx">blueLine</code><code class="p">.</code><code class="nx">active</code> <code class="o">=</code> <code class="nx">active</code><code class="p">;</code>
     <code class="p">})</code>
     <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"Blue Line"</code><code class="p">);</code>
</pre></div>

</figure>

<p>When we click on our ‘Blue Line’ text element the <code>.on("click", function()</code> section executes.</p>

<p>We’re using a short-hand version of the <code>if</code> statement a couple of times here. Firstly we check to see if the variable <code>blueLine.active</code> is true or false and if it’s true it gets set to false and if it’s false it gets set to true (not at all confusing).</p>

<figure class="code">
<div class="highlight"><pre><code></code>       <code class="kd">var</code> <code class="nx">active</code> <code class="o">=</code> <code class="nx">blueLine</code><code class="p">.</code><code class="nx">active</code> <code class="o">?</code> <code class="kc">false</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
       <code class="nx">newOpacity</code> <code class="o">=</code> <code class="nx">active</code> <code class="o">?</code> <code class="mi">0</code> <code class="o">:</code> <code class="mi">1</code><code class="p">;</code>
</pre></div>

</figure>

<p>Then after toggling this variable we set the value of <code>newOpacity</code> to either 0 or 1 depending on whether <code>active</code> is <code>false</code> or <code>true</code> (the second short-hand JavaScript if statement).</p>

<p>We can then select our identifiers that we have declared using the <code>id</code> attributes in the earlier pieces of code and modify their opacity to either <code>0</code> (off) or <code>1</code> (on) </p>

<figure class="code">
<div class="highlight"><pre><code></code>       <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#blueLine"</code><code class="p">).</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="nx">newOpacity</code><code class="p">);</code>
</pre></div>

</figure>

<p>Lastly we update our <code>blueLine.active</code> variable to whatever the <code>active</code> state is so that it can toggle correctly the next time it is clicked on. </p>

<figure class="code">
<div class="highlight"><pre><code></code>       <code class="nx">blueLine</code><code class="p">.</code><code class="nx">active</code> <code class="o">=</code> <code class="nx">active</code><code class="p">;</code>
</pre></div>

</figure>

<p>Quite a neat piece of code. Kudos to Max Leiserson for providing the example on which it is largely based in an <a href="http://stackoverflow.com/questions/20249215/how-to-display-and-hide-links-and-nodes-when-clicking-on-a-node-in-d3-javascript">answer to a question on Stack Overflow</a>.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-using-html-inputs-with-d3js">Using HTML inputs with d3.js</h3>

<p>Part of the attraction of using technologies like d3.js is that it expands the scope of what is possible in a web page. At the same time, there are many different options for displaying content on a page and plenty of ways of interacting with it. </p>

<p>Some of the most basic of capabilities has been the use of HTML entities that allow the entry of data on a page. This can take a range of different forms (pun intended) and the <code>&lt;input&gt;</code> tag is one of the most basic.</p>

<h4 id="leanpub-auto-what-is-an-html-input">What is an HTML input?</h4>

<p>An HTML input is an element in HTML that allows a web page to input data. There are a range of different input types (with varying degrees of compatibility with browsers) and they are typically utilised inside a <code>&lt;form&gt;</code> element.</p>

<p>For example the following code allows a web page to place two fields on a web page so that a user can enter their first and last names in separate boxes;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">form</code><code class="p">&gt;</code>
  First name: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"firstname"</code><code class="p">&gt;&lt;</code><code class="nt">br</code><code class="p">&gt;</code>
  Last name: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"lastname"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The page would then display the following;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/input-01.png" alt="A form input">
  <figcaption>A form input</figcaption>
</figure>


<p>The range of input types is large and includes;</p>

<ul>
  <li>text: A simple text field that a user can enter information into.</li>
  <li>radio: Buttons that let a user select only one of a limited number of choices.</li>
  <li>button: A clickable button that can activate JavaScript.</li>
  <li>range: A slider control for setting a number whose exact value is not important.</li>
  <li>number: A field for entering a number or toggling a number up and down.</li>
</ul>

<p>… and many more. To check out others and get further background, it would be worthwhile visiting the<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/Input"> Mozilla developer</a> pages or <a href="http://www.w3schools.com/tags/tag_input.asp">w3schools.com</a>.</p>

<p>While d3.js has the power to control and manipulate a web page to an extreme extent, sometimes it’s desirable to use a simple process to get a result. The following explanations will demonstrate a simple use case linking an HTML input with a d3.js element and will go on to provide examples of using multiple inputs, affecting multiple elements and using different input types. The examples are deliberately kept simple. They are intended to demonstrate functionality and to provide a starting position for you to go forward :-).</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-using-a-range-input-with-d3js">Using a <code>range</code> input with d3.js</h4>

<p>The first example we will follow will use a <code>range</code> input to adjust the radius of a circle.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/input-02.png" alt="Adjust the radius of a circle">
  <figcaption>Adjust the radius of a circle</figcaption>
</figure>


<h5 id="leanpub-auto-the-code-3">The code</h5>

<p>The following is the full code for the example. A live version is available online at <a href="http://bl.ocks.org/d3noob/147791d51cf6516715914c49cb869f57">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/147791d51cf6516715914c49cb869f57">GitHub</a>. It is also available as the file ‘input-radius.html’ as a separate download with the book D3 Tips and Tricks v4.x. A copy of the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/d3-t-and-t-v4">download the book from Leanpub</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Input test (circle)<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>
  
<code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nRadius"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         radius = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nRadius-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"1"</code> <code class="na">max</code><code class="o">=</code><code class="s">"150"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nRadius"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code>
 
<code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>    
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code> 

<code class="c1">// draw the circle</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code> 
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>   
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code> 
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">120</code><code class="p">);</code>

<code class="c1">// when the input range changes update the circle </code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nRadius"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">update</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>

<code class="c1">// Initial starting radius of the circle </code>
<code class="nx">update</code><code class="p">(</code><code class="mi">120</code><code class="p">);</code>

<code class="c1">// update the elements</code>
<code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">nRadius</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nRadius-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nRadius</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nRadius"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nRadius</code><code class="p">);</code>

  <code class="c1">// update the circle radius</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="nx">nRadius</code><code class="p">);</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-the-explanation">The explanation</h5>

<p>As with the other examples in the book I will not go over some of the simpler lines of code that are covered in greater detail in earlier sections of the book and will concentrate on those sections that contain new concepts, code or look like they might need expanding :-).</p>

<p>The first section is the portion that sets out the html <code>range</code> input;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nRadius"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         radius = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nRadius-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"1"</code> <code class="na">max</code><code class="o">=</code><code class="s">"150"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nRadius"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The entire block is enclosed in a paragraph (<code>&lt;p&gt;</code>) tag so that is appears on a single line. It can be broken down into the label that occurs before the input slider which is given the id <code>nRadius-value</code> and the <code>input</code> proper. </p>

<p>The <code>for</code> attribute of the <code>label</code> tag equals to the id attribute of the input element to bind them together. This allows us to update the text later as the slider is moved.</p>

<p>The <code>input</code> tag can include four attributes that specify restrictions on the operation of the slider;</p>

<ul>
  <li>
<code>max</code>: specifies the maximum value allowed</li>
  <li>
<code>min</code>: specifies the minimum value allowed</li>
  <li>
<code>step</code>: specifies the number intervals as you move the slider</li>
  <li>
<code>value</code>: Specifies the default value</li>
</ul>

<p>The <code>id</code>s supplied for both the label and the input are important since they provide the reference for our d3.js script. </p>

<p>The first portion of our JavaScript is fairly routine if you’ve been following along with the rest of the book.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code>
 
<code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>    
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code> 

<code class="c1">// draw the circle</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cx"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"cy"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code> 
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>   
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code> 
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="mi">120</code><code class="p">);</code>
</pre></div>

</figure>

<p>We append an SVG element to the <code>body</code> of our page and then we append a circle with some particular styling to the SVG element.</p>

<p>Then things start to get more interesting…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nRadius"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">update</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>We select our input using the <code>id</code> that we had declared earlier in the html (<code>nRadius</code>). Then we use the <code>.on</code> operator which adds what is called an ‘<a href="https://github.com/d3/d3-selection/blob/master/README.md#handling-events">event listener</a>’ to the element so that when there is a change in the element (in this case an adjustment of the slider of the input) a function is called (<code>function()</code>) that in turn calls the <code>update</code> function with the value from the input (<code>+this.value</code>). We haven’t seen the <code>update</code> function yet, but never fear, it’s coming.</p>

<p>We also call the update function with a specific value in the next line;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">update</code><code class="p">(</code><code class="mi">120</code><code class="p">);</code>
</pre></div>

</figure>

<p>This might seem slightly redundant, but unless the function gets a value, the text associated with the range input doesn’t get a reading and remains on ‘…’ until the slider is moved.</p>

<p>Lastly we have our <code>update</code> function;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">nRadius</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nRadius-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nRadius</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nRadius"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nRadius</code><code class="p">);</code>

  <code class="c1">// update the circle radius</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"circle"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"r"</code><code class="p">,</code> <code class="nx">nRadius</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The first part of the function selects the <code>label</code> associated with our input (with the <code>id</code>, <code>nRadius-value</code>) and applies the value that has been passed into the function (<code>nRadius</code>). The next line selects the input itself and applies the value to it (this would be the equivalent of having <code>value="&lt;number here&gt;"</code> as a property in the html).</p>

<p>Lastly, we select the circle element and apply the new radius value based on our input value <code>nRadius</code> (<code>.attr("r", nRadius)</code>). </p>

<p>And there we have it, a fully adjustable radius for our circle controlled with an HTML input.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/input-03.png" alt="Maximum radius for our circle">
  <figcaption>Maximum radius for our circle</figcaption>
</figure>


<div class="page-break"></div>
<h4 id="leanpub-auto-using-more-than-one-input">Using more than one input</h4>

<p>In this example we will use two separate inputs (range type) to adjust the height and width of a rectangle.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/input-04.png" alt="Dual inputs">
  <figcaption>Dual inputs</figcaption>
</figure>


<p>This is not too much of a stretch from the previous single input example with the radius of a circle, but it may be useful to reinforce the concept and illustrate something slightly different.</p>

<h5 id="leanpub-auto-the-code-4">The code</h5>

<p>The following is the full code for the example. A live version is available online at <a href="http://bl.ocks.org/d3noob/aee9277a3664850501f3d1d0fc731c86">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/aee9277a3664850501f3d1d0fc731c86">GitHub</a>. It is also available as the file ‘input-double.html’ as a separate download with D3 Tips and Tricks v4.x. A copy of the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/d3-t-and-t-v4">download the book from Leanpub</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Double Input Test<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nHeight"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         height = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nHeight-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"1"</code> <code class="na">max</code><code class="o">=</code><code class="s">"280"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nHeight"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nWidth"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         width = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nWidth-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"1"</code> <code class="na">max</code><code class="o">=</code><code class="s">"400"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nWidth"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code>
 
<code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>    
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code> 

<code class="c1">// draw a rectangle</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">300</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="s2">"blue"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">150</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>

<code class="c1">// read a change in the height input</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nHeight"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">updateHeight</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>

<code class="c1">// read a change in the width input</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nWidth"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">updateWidth</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>

<code class="c1">// update the values</code>
<code class="nx">updateHeight</code><code class="p">(</code><code class="mi">150</code><code class="p">);</code>
<code class="nx">updateWidth</code><code class="p">(</code><code class="mi">100</code><code class="p">);</code>

<code class="c1">// Update the height attributes</code>
<code class="kd">function</code> <code class="nx">updateHeight</code><code class="p">(</code><code class="nx">nHeight</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nHeight-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nHeight</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nHeight"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nHeight</code><code class="p">);</code>

  <code class="c1">// update the rectangle height</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">150</code><code class="o">-</code><code class="p">(</code><code class="nx">nHeight</code><code class="o">/</code><code class="mi">2</code><code class="p">))</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">nHeight</code><code class="p">);</code> 
<code class="p">}</code>

<code class="c1">// Update the width attributes</code>
<code class="kd">function</code> <code class="nx">updateWidth</code><code class="p">(</code><code class="nx">nWidth</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nWidth-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nWidth</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nWidth"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nWidth</code><code class="p">);</code>

  <code class="c1">// update the rectangle width</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">300</code><code class="o">-</code><code class="p">(</code><code class="nx">nWidth</code><code class="o">/</code><code class="mi">2</code><code class="p">))</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">nWidth</code><code class="p">);</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-the-explanation-1">The explanation</h5>

<p>For the sake of brevity, this explanation will simply concentrate on the differences between the previous single input example and this one.</p>

<p>The declarations for the inputs in the HTML at the start of the code are simply duplicates of each other in terms of function;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nHeight"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         height = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nHeight-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"1"</code> <code class="na">max</code><code class="o">=</code><code class="s">"280"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nHeight"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nWidth"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         width = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nWidth-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"1"</code> <code class="na">max</code><code class="o">=</code><code class="s">"400"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nWidth"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>The only significant difference is the declaration of the <code>id</code>’s for each input and their respective labels.</p>

<p>The JavaScript selection of the inputs is more duplication;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nHeight"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">updateHeight</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>

<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nWidth"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">updateWidth</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>Again the only substantive difference is the use of the appropriate <code>id</code> values.</p>

<p>The updating of the width and height is done via two different functions;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">updateHeight</code><code class="p">(</code><code class="nx">nHeight</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nHeight-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nHeight</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nHeight"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nHeight</code><code class="p">);</code>

  <code class="c1">// update the rectangle height</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">150</code><code class="o">-</code><code class="p">(</code><code class="nx">nHeight</code><code class="o">/</code><code class="mi">2</code><code class="p">))</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">nHeight</code><code class="p">);</code> 
<code class="p">}</code>

<code class="c1">// Update the width attributes</code>
<code class="kd">function</code> <code class="nx">updateWidth</code><code class="p">(</code><code class="nx">nWidth</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nWidth-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nWidth</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nWidth"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nWidth</code><code class="p">);</code>

  <code class="c1">// update the rectangle width</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">300</code><code class="o">-</code><code class="p">(</code><code class="nx">nWidth</code><code class="o">/</code><code class="mi">2</code><code class="p">))</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">nWidth</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>The rectangle is selected using a common <code>rect</code> designator, so multiple rectangles could be controlled. But each function controls only a specific attribute (height or width).</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-rotate-text-with-an-input">Rotate text with an input</h4>

<p>This example is really just a derivative of the adjustment of a single attribute of an element.</p>

<p>I happen to think it’s just a little bit ‘neater’ because it includes text, but in reality, it’s just another attribute that can be adjusted.</p>

<p>Here we let our range input adjust the rotation of a piece of text.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/input-05.png" alt="Text rotation with an input">
  <figcaption>Text rotation with an input</figcaption>
</figure>


<h5 id="leanpub-auto-the-explanation-2">The explanation</h5>

<p>We’ll dispense with the full code listing since it’s just a regurgitation of the adjusting of the radius of the circle example, but the code for the example is available online at <a href="http://bl.ocks.org/d3noob/d072f01abe615478633f39eb7c383dee">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/d072f01abe615478633f39eb7c383dee">GitHub</a>. It is also available as the file ‘input-text-rotate.html’ as a separate download with D3 Tips and Tricks v4.x. A copy of the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/leanpub.com/d3-t-and-t-v4">download the book from Leanpub</a>.</p>

<p>The only, thing of even a slight difference (other than some naming conventions) is the initial drawing of the text…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"56px"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,150) rotate(0)"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"d3noob.org"</code><code class="p">);</code>
</pre></div>

</figure>

<p>… and the update function;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">nAngle</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// adjust the text on the range slider</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nAngle</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nAngle</code><code class="p">);</code>

  <code class="c1">// rotate the text</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,150) rotate("</code><code class="o">+</code><code class="nx">nAngle</code><code class="o">+</code><code class="s2">")"</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<div class="page-break"></div>
<h4 id="leanpub-auto-use-a-number-input-with-d3js">Use a <code>number</code> input with d3.js</h4>

<p>There are obviously different inputs types that can be implemented. The following example still rotates our text, but uses a <code>number</code> type of input to do it;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nValue"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         angle = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nValue-value"</code><code class="p">&gt;&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"number"</code> <code class="na">min</code><code class="o">=</code><code class="s">"0"</code> <code class="na">max</code><code class="o">=</code><code class="s">"360"</code> <code class="na">step</code><code class="o">=</code><code class="s">"5"</code> <code class="na">value</code><code class="o">=</code><code class="s">"0"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nValue"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>We have set the <code>step</code> value to speed things up a bit when rotating, but it’s completely optional.</p>

<p>The input itself can be adjusted up or down using a mouse click or have a number typed into the input box.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/input-06.png" alt="Text rotation with a number input">
  <figcaption>Text rotation with a number input</figcaption>
</figure>


<p>This type of input is slightly different from the range type since it isn’t fully supported under Firefox and as a result when I was testing it the arrow keys for going up and down weren’t present.</p>

<p>The full code for the example is available online at <a href="http://bl.ocks.org/d3noob/365ab1f8708d245b0ef82ba8afe18370">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/365ab1f8708d245b0ef82ba8afe18370">GitHub</a>. It is also available as the file ‘input-number-text.html’ as a separate download with D3 Tips and Tricks v4.x. A copy of the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/d3-t-and-t-v4">download the book from Leanpub</a>.</p>

<div class="page-break"></div>
<h4 id="leanpub-auto-change-more-than-one-element-with-an-input">Change more than one element with an input</h4>

<p>The final example looking at using HTML inputs with d3.js incorporates a single input acting or two different elements. This might seem self evident, but if you’re as unfamiliar with HTML as I am (it’s embarrassing I know, but what can you do?) it may be of assistance.</p>

<p>The end result is to produce a single slider as a <code>range</code> input that rotates two separate text objects in different directions simultaneously.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/input-07.png" alt="Dual text rotation">
  <figcaption>Dual text rotation</figcaption>
</figure>


<h5 id="leanpub-auto-the-code-5">The code</h5>

<p>The following is the full code for the example. A live version is available online at <a href="http://bl.ocks.org/d3noob/b901b4c8242e5c2de95d0b6b1656cc33">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/b901b4c8242e5c2de95d0b6b1656cc33">GitHub</a>. It is also available as the file ‘input-text-rotate-2.html’ as a separate download with D3 Tips and Tricks v4.x. A copy of the files that appear in the book can be downloaded (in a zip file) when you <a href="https://leanpub.com/d3-t-and-t-v4">download the book from Leanpub</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>Input test<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"nAngle"</code> 
         <code class="na">style</code><code class="o">=</code><code class="s">"display: inline-block; width: 240px; text-align: right"</code><code class="p">&gt;</code>
         angle = <code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"nAngle-value"</code><code class="p">&gt;</code>…<code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"range"</code> <code class="na">min</code><code class="o">=</code><code class="s">"0"</code> <code class="na">max</code><code class="o">=</code><code class="s">"360"</code> <code class="na">id</code><code class="o">=</code><code class="s">"nAngle"</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code><code class="p">;</code>
 
<code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>    
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code> 

<code class="c1">// draw d3.js text</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"d3js"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"56px"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,55) rotate(0)"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"d3.js"</code><code class="p">);</code>

<code class="c1">// draw d3noob.org text</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"d3noob"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"56px"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,130) rotate(0)"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"d3noob.org"</code><code class="p">);</code>

<code class="c1">// when the input range changes update the rectangle </code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle"</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"input"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">update</code><code class="p">(</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>

<code class="c1">// Initial starting height of the rectangle </code>
<code class="nx">update</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code>

<code class="c1">// update the elements</code>
<code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">nAngle</code><code class="p">)</code> <code class="p">{</code>

<code class="c1">// adjust the range text</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nAngle</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nAngle</code><code class="p">);</code>

  <code class="c1">// adjust d3.js text</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text.d3js"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,55) rotate("</code><code class="o">+</code><code class="nx">nAngle</code><code class="o">+</code><code class="s2">")"</code><code class="p">);</code>

  <code class="c1">// adjust d3noob.org text</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text.d3noob"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,130) rotate("</code><code class="o">+</code><code class="p">(</code><code class="mi">360</code> <code class="o">-</code> <code class="nx">nAngle</code><code class="p">)</code><code class="o">+</code><code class="s2">")"</code><code class="p">);</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
</pre></div>

</figure>

<h5 id="leanpub-auto-the-explanation-3">The explanation</h5>

<p>The explanation for this example differs from the others in the way that the d3.js elements (the two pieces of text) are initially appended and then updated.</p>

<p>When they are initially drawn…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"d3js"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"56px"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,55) rotate(0)"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"d3.js"</code><code class="p">);</code>

<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"d3noob"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"56px"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,130) rotate(0)"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="s2">"d3noob.org"</code><code class="p">);</code>
</pre></div>

</figure>

<p>… both elements are declared with a <code>class</code> attribute that serves as a reference for the future updating. Here, the text ‘d3.js’ is given a <code>class</code> name of <code>d3js</code> and the text ‘d3noob.org’ is given a <code>class</code> name of <code>d3noob</code>.</p>

<p>Then when we call the <code>update</code> function each of the two text elements is adjusted seperatly by selecting each based on the <code>class</code> name that was applied in the initial setup;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">update</code><code class="p">(</code><code class="nx">nAngle</code><code class="p">)</code> <code class="p">{</code>

<code class="c1">// adjust the range text</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle-value"</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">nAngle</code><code class="p">);</code>
  <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#nAngle"</code><code class="p">).</code><code class="nx">property</code><code class="p">(</code><code class="s2">"value"</code><code class="p">,</code> <code class="nx">nAngle</code><code class="p">);</code>

  <code class="c1">// adjust d3.js text</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text.d3js"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,55) rotate("</code><code class="o">+</code><code class="nx">nAngle</code><code class="o">+</code><code class="s2">")"</code><code class="p">);</code>

  <code class="c1">// adjust d3noob.org text</code>
  <code class="nx">holder</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"text.d3noob"</code><code class="p">)</code> 
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(300,130) rotate("</code><code class="o">+</code><code class="p">(</code><code class="mi">360</code> <code class="o">-</code> <code class="nx">nAngle</code><code class="p">)</code><code class="o">+</code><code class="s2">")"</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>So the ‘d3.js’ text is selected using <code>text.d3js</code> and ‘d3noob.org’ is selected using <code>text.d3noob</code>. That’s a pretty neat trick and a good lesson for applying specific transformations to specific objects.</p>

<div class="page-break"></div>

<h3 id="tables">Add an HTML table to your graph</h3>

<p>So graphs and graphics are D3’s bread and butter you’d think. Hmm…</p>

<p>Well yes and no.</p>

<p>Yes D3 has extraordinary powers for presenting and manipulating images in a web page. But if you’ve read through the entirety of the d3.js main site (haven’t we all) you will recall that D3 actually stands for Data Driven Documents. It’s not necessarily about the pretty pictures and the swirling cascade of colour. It’s about generating something in a web browser based on data.</p>

<p>This transitions nicely into consideration of adding a table of information that can accompany your graph (it could just as easily (or easier) be stand alone, but for the sake of continuity, we’ll use the graph).</p>

<p>What we’ll do is add the data that we’ve used to make our simple graph under the graph itself. To make sure that it’s all nicely aligned, we’ll place it in a table.</p>

<p>It should end up looking a little like this (and this has been cropped slightly at the bottom to avoid expanding the page with rows of numbers / dates).</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/table01.png" alt="Basic graph with a table of data">
  <figcaption>Basic graph with a table of data</figcaption>
</figure>


<p>The code was drawn from an example provided by <a href="http://jsfiddle.net/7WQjr/">Shawn Allen</a> on <a href="http://stackoverflow.com/questions/9268645/d3-creating-a-table-linked-to-a-csv-file">Google Groups</a>. In fact, the post itself is an excellent one if you are considering creating a table straight from a csv file.</p>

<h4 id="leanpub-auto-html-tables">HTML Tables</h4>

<aside class="information blurb">
    <p>I’m walking a fine line here since I have a remarkably small amount of knowledge on HTML tables. So I’ll try to provide a brief overview as I understand it and as I see it represented in the code below, but for a far fuller explanation, take a look at some great work by <a href="http://prcweb.co.uk/lab/selection/">Peter Cook here</a> or let Google be your friend.</p>

</aside>

<p>Tables are made up of rows, columns and data (that goes in each cell). All you need to do to successfully place a table on a web page is to lay out the rows and columns in a logical sequence using the appropriate HTML tags and you’re away.</p>

<p>For example here’s the total HTML code for a web page to display a simple table;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">table</code> <code class="na">border</code><code class="o">=</code><code class="s">"1"</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Header 1<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">th</code><code class="p">&gt;</code>Header 2<code class="p">&lt;/</code><code class="nt">th</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">td</code><code class="p">&gt;</code>row 1, cell 1<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">td</code><code class="p">&gt;</code>row 1, cell 2<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">td</code><code class="p">&gt;</code>row 2, cell 1<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">td</code><code class="p">&gt;</code>row 2, cell 2<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">table</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>This will result in a table that looks a little like this in a web browser;</p>

<table>
  <tbody>
    <tr>
      <td><strong>Header 1</strong></td>
      <td><strong>Header 2</strong></td>
    </tr>
  </tbody>
  <tfoot>
    <tr>
      <td>row 1, cell 1</td>
      <td>row 1, cell 2</td>
    </tr>
    <tr>
      <td>row 2, cell 1</td>
      <td>row 2, cell 2</td>
    </tr>
  </tfoot>

</table>

<p>The entire table itself is enclosed in <code>&lt;table&gt;</code> tags. Each row is enclosed in <code>&lt;tr&gt;</code>  tags. Each row has two items which equate to the two columns. Each piece of data for each cell is enclosed in a <code>&lt;td&gt;</code>  tag except for the first row, which is a header and therefore has a special tag <code>&lt;th&gt;</code> that denotes it as a header making it bold and centred. For the sake of ease of viewing we have told the table to place a border around each cell and we do this in the first <code>&lt;table&gt;</code> tag with the <code>border="1"</code> statement (although in this book view it may be absent).</p>

<aside class="information blurb">
    <p>The good news is that you don’t need to fully understand all this, but it will help with the explanation of what we’re doing in the code below.</p>

</aside>

<p>There are three main things you need to do to the basic line graph to get your table to display.</p>

<ol class="numeric">
  <li>Add some CSS</li>
  <li>Add some table building d3.js code</li>
  <li>Make a small but cunning change…</li>
</ol>

<p>There is a copy of the code and the data file for this example at <a href="https://gist.github.com/d3noob/3e5138a14cfc1822eedee2963c493399">github</a> and in the code samples bundled with this book (simple-graph-plus-table.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/3e5138a14cfc1822eedee2963c493399">bl.ocks.org</a>.</p>

<h4 id="leanpub-auto-first-the-css">First the CSS</h4>

<p>This just helps the table with formatting and making sure the individual cells are spaced appropriately;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">td</code><code class="o">,</code> <code class="nt">th</code> <code class="p">{</code>
  <code class="nb">padding</code><code class="o">:</code> <code class="m">1px</code> <code class="m">4px</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>This sets a padding of 1 px around each cell and 4 px between each column.</p>

<aside class="tip blurb">
    <p>Feel free to play with the figures to suit your application, I’ve just set them there because I thought they looked appropriate.</p>

</aside>

<p>I’ve placed this portion of CSS at the end of our <code>&lt;style&gt;</code> section.</p>

<h4 id="leanpub-auto-now-the-d3js-code">Now the d3.js code</h4>

<p>Oki doki… Hopefully you have a loose understanding of the html layout of a table as explained above, but if not you can always go with the ‘it just works’ approach.</p>

<p>Here’s what we should add into our simple graph example;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// The table generation function</code>
<code class="kd">function</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">columns</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">table</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"table"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"margin-left: 400px"</code><code class="p">),</code>
        <code class="nx">thead</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"thead"</code><code class="p">),</code>
        <code class="nx">tbody</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tbody"</code><code class="p">);</code>

    <code class="c1">// append the header row</code>
    <code class="nx">thead</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tr"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"th"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">columns</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"th"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">column</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">column</code><code class="p">;</code> <code class="p">});</code>

    <code class="c1">// create a row for each object in the data</code>
    <code class="kd">var</code> <code class="nx">rows</code> <code class="o">=</code> <code class="nx">tbody</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"tr"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tr"</code><code class="p">);</code>

    <code class="c1">// create a cell in each row for each column</code>
    <code class="kd">var</code> <code class="nx">cells</code> <code class="o">=</code> <code class="nx">rows</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"td"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">row</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="nx">columns</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">column</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">return</code> <code class="p">{</code><code class="nx">column</code><code class="o">:</code> <code class="nx">column</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="nx">row</code><code class="p">[</code><code class="nx">column</code><code class="p">]};</code>
            <code class="p">});</code>
        <code class="p">})</code>
        <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"td"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"font-family: Courier"</code><code class="p">)</code> <code class="c1">// sets the font style</code>
            <code class="p">.</code><code class="nx">html</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">});</code>
    
    <code class="k">return</code> <code class="nx">table</code><code class="p">;</code>
<code class="p">}</code>

<code class="c1">// render the table</code>
 <code class="kd">var</code> <code class="nx">peopleTable</code> <code class="o">=</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="p">[</code><code class="s2">"date"</code><code class="p">,</code> <code class="s2">"close"</code><code class="p">]);</code>
</pre></div>

</figure>

<p>And we should take care to add it into the code at the end of the portion where we’ve finished drawing the graph, but before the enclosing curly and regular brackets that complete the portion of the graph that has loaded our data.csv file. This is because we want our new piece of code to have access to that data and if we place it after those brackets it won’t know what data to display.</p>

<p>So, right about here;</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="c1">// Add the Y Axis</code>
        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"y axis"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">yAxis</code><code class="p">);</code>
                                 <code class="c1">// &lt;= Add the code right here!</code>
<code class="p">});</code>
</pre></div>

</figure>

<p>Now, we’re going to break with tradition a bit here and examine what our current state of code produces. Then we’re going to explain something different. <em>THEN</em> we’re going to come back and explain the code… </p>

<p>Check it out…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/table02.png" alt="Woah! What happened to the date?">
  <figcaption>Woah! What happened to the date?</figcaption>
</figure>


<p>Not quite as we has originally envisaged?</p>

<p>Indeed, the date has taken it upon itself to expand from a relatively modest format of day-abbreviated month-two digit year (30-Apr-12) to a behemoth of a thing (Mon Apr 30 2012 00:00:00 GMT+1200 (New Zealand Standard Time)) that we certainly didn’t intend, let alone have in our data.csv file.</p>

<p>What’s going on here?</p>

<p>I’m no expert, but this is what I tell myself is happening. The JavaScript code recognises and deals with the ‘date’ variable as being a date/time (not a string of numbers, letters and characters). Therefore, when we proceed to display the variable on the screen, the browser says, “this is a date / time value, therefore in lieu of any other instructions, I will format it in the following way”. This is perfectly valid and we could work through a method of re-formatting the code to display in a specific way, but there is a simpler way to solve the problem. Hence the third small but cunning change to our original code.</p>

<h4 id="leanpub-auto-a-small-but-cunning-change">A small but cunning change…</h4>

<p>Our table has decided to develop a mind of it’s own and format the date time as it sees fit. Well fair enough (I for one welcome our web time formatting overlords). How do we convince it to display the values in their natural form?</p>

<p>Well, one solution that we could employ is to not tell the JavaScript that our <code>date</code> value in the data is actually time. In that condition, the code should treat the values as an ordinary string and print it directly as it appears.</p>

<p>The good news is that this is pretty easy to do. Where originally we had a block of data that consisted of <code>date</code> and <code>close</code>, all at different times, we will now add a new variable called <code>date1</code> which will be the variable that we convert to a time and draw the graph with. Leaving <code>date</code> to be the text string that will be printed in our table.</p>

<p>How to do it?</p>

<p>It’s actually remarkably easy. Just change the following lines in the basic line graph code to amend <code>date</code> to <code>date1</code> and you’re good to go.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date1</code><code class="p">);</code> <code class="p">})</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code>      <code class="nx">d</code><code class="p">.</code><code class="nx">date1</code> <code class="o">=</code> <code class="nx">parseTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
</pre></div>

</figure>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date1</code><code class="p">;</code> <code class="p">}));</code>
</pre></div>

</figure>
<p>The middle line is probably the most significant, since this is the point where we declare <code>date1</code>, assign a time format and bring a new column of data into being. The others simply refer to the data.</p>

<p>So we’ll make those small changes and now we can return to explain the d3.js code…</p>

<h4 id="leanpub-auto-explaining-the-d3js-code-reloaded">Explaining the d3.js code (reloaded).</h4>

<p>So back we come to explain what is going on in the d3.js code that we presented a page or two back. Obviously it’s a fairly large chunk, and we can break it down into two chunks.</p>

<p>The first chunk we’ll look at is in fact the last part of the code that look like this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// render the table</code>
 <code class="kd">var</code> <code class="nx">peopleTable</code> <code class="o">=</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="p">[</code><code class="s2">"date"</code><code class="p">,</code> <code class="s2">"close"</code><code class="p">]);</code>
</pre></div>

</figure>

<p>This portion simply calls the <code>tabulate</code> function using the <code>date</code> and <code>close</code> columns of our <code>data</code> array. Simply add or remove whichever columns you want to appear in your table (so long as they are in your data.csv file) and they will be in your table. The tabulate function makes up all of the other part of the added code.</p>

<p>So we come to the first block of the tabulate function;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// The table generation function</code>
<code class="kd">function</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">columns</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">table</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"table"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"margin-left: 400px"</code><code class="p">),</code>
        <code class="nx">thead</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"thead"</code><code class="p">),</code>
        <code class="nx">tbody</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tbody"</code><code class="p">);</code>
</pre></div>

</figure>

<p>Here the tabulate function is declared (<code>function tabulate</code>) and the variables that the function will be using are specified (<code>(data, columns)</code>). In our case <code>data</code> is of course our <code>data</code> array and <code>columns</code> refers to <code>["date", "close"]</code>.</p>

<p>The next line appends the table to the <code>body</code> of the web page (so it will occur just under the graph in this case). Then we do something slightly sneaky. The line <code>.attr("style", "margin-left: 400px"),</code> is actually not the code that was used to produce the table with the huge date/ time formatted info on. I deliberately used <code>.attr("style", "margin-left: 0px"),</code> for the huge date / time table since it’s job is to indent the table by a specified amount from the left hand side of the page. And since the huge date time values would have pushed the table severely to the right, I cheated and used <code>0</code> instead of <code>400</code>. For the purposes of the final example where the date / time values are formatted as expected, <code>400</code> is a good value.</p>

<p>The next two lines declare the functions we will use to add in the header cells (since they use the <code>&lt;th&gt;</code> tags for content) and the cells for the main body of the table (they use <code>&lt;td&gt;</code>).</p>

<p>The next block of code adds in the header row;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="c1">// append the header row</code>
    <code class="nx">thead</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tr"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"th"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">columns</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"th"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">column</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">column</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>Here we first append a row tag (<code>&lt;tr&gt;</code>), then we gather all the <code>columns</code> that we have in our function (remember they were <code>["date", "close"]</code>) and add them to our row using header tags (<code>&lt;th&gt;</code>).</p>

<p>The next block of code assigns the <code>row</code> variable to return (append) a row tag (<code>&lt;tr&gt;</code>) whenever it’s called …</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="c1">// create a row for each object in the data</code>
    <code class="kd">var</code> <code class="nx">rows</code> <code class="o">=</code> <code class="nx">tbody</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"tr"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tr"</code><code class="p">);</code>
</pre></div>

</figure>

<p>… and it is in the following block of code…</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="c1">// create a cell in each row for each column</code>
    <code class="kd">var</code> <code class="nx">cells</code> <code class="o">=</code> <code class="nx">rows</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"td"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">data</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">row</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="nx">columns</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">column</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">return</code> <code class="p">{</code><code class="nx">column</code><code class="o">:</code> <code class="nx">column</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="nx">row</code><code class="p">[</code><code class="nx">column</code><code class="p">]};</code>
            <code class="p">});</code>
        <code class="p">})</code>
        <code class="p">.</code><code class="nx">enter</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"td"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"font-family: Courier"</code><code class="p">)</code> <code class="c1">// sets the font style</code>
            <code class="p">.</code><code class="nx">html</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code> <code class="p">});</code>
</pre></div>

</figure>

<p>… where we select each row that we’ve added (<code>var cells = rows.selectAll("td")</code>). Then the following five lines works out from the intersection of the row and column which piece of data we’re looking at for each cell.</p>

<p>The last four lines take that piece of data (<code>d.value</code>) and wrap it in table data tags (<code>&lt;td&gt;</code>) and place it in the correct cell as HTML.</p>

<p>It’s a very neat piece of code and I struggle to get my head around it, but that doesn’t mean that I can’t appreciate the cleverness of it :-).</p>

<h4 id="leanpub-auto-wrap-up-1">Wrap up</h4>

<p>So there we have it. Hopefully enough to explain what is going on and perhaps also enough to convince ourselves that D3 is indeed more than just pretty pictures. It’s all about the Data Driven Documents.</p>

<p>As mentioned earlier, there is a copy of the code and the data file for this example at <a href="https://gist.github.com/d3noob/3e5138a14cfc1822eedee2963c493399">github</a> and in the code samples bundled with this book (simple-graph-plus-table.html and data.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/3e5138a14cfc1822eedee2963c493399">bl.ocks.org</a>.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-more-table-madness-sorting-prettifying-and-adding-columns">More table madness: sorting, prettifying and adding columns</h3>

<p>When we last left our tables they were happily producing a faithful list of the data points that we had in our graph.</p>

<p>But what if we wanted more?</p>

<p>From the original contributors that bought you tables (<a href="http://jsfiddle.net/7WQjr/">Shawn Allen</a> on <a href="http://stackoverflow.com/questions/9268645/d3-creating-a-table-linked-to-a-csv-file">Google Groups</a>) and some neat additions from <a href="http://christopheviau.com/d3_tutorial/">Christophe Viau</a> comes extra coolness that I didn’t include in the <a href="#tables">previous example</a> :-).</p>

<p>There is a copy of the code and the data file for this example at <a href="https://gist.github.com/d3noob/6f41685b1cd675d2d3de4f8a14777774">github</a> and in the code samples bundled with this book (simple-graph-plus-table-plus-addins.html and data2.csv). A live example can be found on <a href="http://bl.ocks.org/d3noob/6f41685b1cd675d2d3de4f8a14777774">bl.ocks.org</a>.</p>

<h4 id="leanpub-auto-add-another-column-of-information">Add another column of information:</h4>

<p>Firstly, lets add another column of data to our table. To do this we want to have something extra in our csv file to use, so let’s resurrect our old friend data2.csv that we used for the graph with two lines previously. All we have to do to make this a reality is change the reference that loads <code>data.csv</code> to <code>data2.csv</code> here;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"data2.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<aside class="tip blurb">
    <p>This makes the assumption that you still have the data2.csv file in place. If not, rush away and get it from the download of code samples from Leanpub.</p>

</aside>

<p>From here (and as promised in the previous chapter), it’s just a matter of adding in the extra column you want (in this case it’s the <code>open</code> column) like so;</p>

<figure class="code">
<div class="highlight"><pre><code></code> <code class="kd">var</code> <code class="nx">peopleTable</code> <code class="o">=</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="p">[</code><code class="s2">"date"</code><code class="p">,</code> <code class="s2">"close"</code><code class="p">,</code> <code class="s2">"open"</code><code class="p">]);</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/table03.png" alt="Table with extra column">
  <figcaption>Table with extra column</figcaption>
</figure>


<aside class="information blurb">
    <p>Yes, if you’re wondering, I have cheated slightly and changed the table indent to make it look slightly prettier.</p>

</aside>

<p>So can we go further?</p>

<p>You know we can…</p>

<p>In the section where we format our data, lets add another column to our array in the form of a difference between the <code>close</code> value and the <code>open</code> value (and we’ll call it <code>diff</code>).</p>

<figure class="code">
<div class="highlight"><pre><code></code>  <code class="c1">// format the data</code>
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">date1</code> <code class="o">=</code> <code class="nx">parseTime</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">close</code><code class="p">;</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">open</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">open</code><code class="p">;</code>  <code class="c1">//  &lt;= added this for tidy house keeping</code>
      <code class="nx">d</code><code class="p">.</code><code class="nx">diff</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">round</code><code class="p">((</code> <code class="nx">d</code><code class="p">.</code><code class="nx">close</code> <code class="o">-</code> <code class="nx">d</code><code class="p">.</code><code class="nx">open</code> <code class="p">)</code> <code class="o">*</code> <code class="mi">100</code> <code class="p">)</code> <code class="o">/</code> <code class="mi">100</code><code class="p">;</code>
  <code class="p">});</code>
</pre></div>

</figure>

<p>(the <code>Math.round</code> function is to make sure we get a reasonable figure to display, otherwise it tends to get carried away with decimal places)</p>

<p>So now we add in our new column (<code>diff</code>) to be tabulated;</p>

<figure class="code">
<div class="highlight"><pre><code></code> <code class="kd">var</code> <code class="nx">peopleTable</code> <code class="o">=</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="p">[</code><code class="s2">"date"</code><code class="p">,</code> <code class="s2">"close"</code><code class="p">,</code> <code class="s2">"open"</code><code class="p">,</code> <code class="s2">"diff"</code><code class="p">]);</code>
</pre></div>

</figure>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/table04.png" alt="Table with extra extra column">
  <figcaption>Table with extra extra column</figcaption>
</figure>


<aside class="information blurb">
    <p>And yes, I changed the table indent again. I am a serial offender and will continue to change it to suit.</p>

</aside>

<h4 id="leanpub-auto-sorting-on-a-column">Sorting on a column</h4>

<p>So now with our four columns of awesome data, it turns out that we’re really interested in the ones that have the highest <code>close</code> values. So we can sort on the <code>close</code> column by adding the following lines directly after the line where we declare the <code>peopleTable</code> function (which I will include in the code snipped below for reference).</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="c1">// render the table</code>
<code class="kd">var</code> <code class="nx">peopleTable</code> <code class="o">=</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="p">[</code><code class="s2">"date"</code><code class="p">,</code> <code class="s2">"close"</code><code class="p">,</code> <code class="s2">"open"</code><code class="p">,</code> <code class="s2">"diff"</code><code class="p">]);</code>

<code class="nx">peopleTable</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"tbody tr"</code><code class="p">)</code> 
           <code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code>
             <code class="k">return</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">descending</code><code class="p">(</code><code class="nx">a</code><code class="p">.</code><code class="nx">close</code><code class="p">,</code> <code class="nx">b</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code>
           <code class="p">});</code>
</pre></div>

</figure>

<p>Which works magnificently;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/table05.png" alt="Table sorted descending on 'close'">
  <figcaption>Table sorted descending on ‘close’</figcaption>
</figure>


<h4 id="leanpub-auto-prettifying-actually-just-capitalising-the-header-for-each-column">Prettifying (actually just capitalising the header for each column)</h4>

<p>Just a little snippet that capitalises the headers for each row to make them look slightly more authoritative.</p>

<p>Add the following lines of code directly below the block that you just added for sorting the table;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">peopleTable</code><code class="p">.</code><code class="nx">selectAll</code><code class="p">(</code><code class="s2">"thead th"</code><code class="p">)</code>
           <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">column</code><code class="p">)</code> <code class="p">{</code>
             <code class="k">return</code> <code class="nx">column</code><code class="p">.</code><code class="nx">charAt</code><code class="p">(</code><code class="mi">0</code><code class="p">).</code><code class="nx">toUpperCase</code><code class="p">()</code> <code class="o">+</code> <code class="nx">column</code><code class="p">.</code><code class="nx">substr</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>
           <code class="p">});</code>
</pre></div>

</figure>

<p>This is quite a tidy little piece of script. You can see it selecting the headers (<code>selectAll("thead th")</code>), then the first character in each header (<code>column.charAt(0)</code>), changing it to upper-case (<code>.toUpperCase()</code>) and adding it back to the rest of the string (<code>+ column.substr(1)</code>).</p>

<p>With the ultimate result…</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/table06.png" alt="Table with capitalised first characters in headers">
  <figcaption>Table with capitalised first characters in headers</figcaption>
</figure>


<h4 id="leanpub-auto-add-borders">Add borders</h4>

<p>Sure our table looks nice and neatly arranged, but would a border look better? </p>

<p>Well, here’s one way to do it;</p>

<p>All we need to do is add a border style to our table by adding in this line here;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">columns</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">table</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"table"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"margin-left: 200px"</code><code class="p">)</code> <code class="c1">// &lt;= Remove the comma</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"border"</code><code class="p">,</code> <code class="s2">"2px black solid"</code><code class="p">),</code> <code class="c1">// &lt;= Add this line in</code>
        <code class="nx">thead</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"thead"</code><code class="p">),</code>
        <code class="nx">tbody</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tbody"</code><code class="p">);</code>
</pre></div>

</figure>

<p>(don’t forget to move the comma from the end of the <code>margin-left</code> line)</p>

<p>And the result is a tidy black border.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/table07.png" alt="Table with a border">
  <figcaption>Table with a border</figcaption>
</figure>


<p>OK, so what about the individual cells?</p>

<p>No problem.</p>

<p>If we remember back to our CSS that we added in, we’ll just tell each cell that we want a 1 pixel border buy amending the CSS for our table to this;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nt">td</code><code class="o">,</code> <code class="nt">th</code> <code class="p">{</code>
    <code class="nb">padding</code><code class="o">:</code> <code class="m">1px</code> <code class="m">4px</code><code class="p">;</code>
    <code class="nb">border</code><code class="o">:</code> <code class="m">1px</code> <code class="nb">black</code> <code class="nb">solid</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>So now each cell has a slightly more subtle border like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/table08.png" alt="Table with cells with individual borders">
  <figcaption>Table with cells with individual borders</figcaption>
</figure>


<p>Yikes! Not quite as subtle as I would have expected. I suppose it’s another example of the code actually doing what you asked it to do. No problem, <code>border-collapse</code> to the rescue. Add the following line into here;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">function</code> <code class="nx">tabulate</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">columns</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">table</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="s2">"table"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"style"</code><code class="p">,</code> <code class="s2">"margin-left: 200px"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"border-collapse"</code><code class="p">,</code> <code class="s2">"collapse"</code><code class="p">)</code>   <code class="c1">// &lt;= Add this line in.</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"border"</code><code class="p">,</code> <code class="s2">"2px black solid"</code><code class="p">),</code>
        <code class="nx">thead</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"thead"</code><code class="p">),</code>
        <code class="nx">tbody</code> <code class="o">=</code> <code class="nx">table</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"tbody"</code><code class="p">);</code>
</pre></div>

</figure>

<p>How does that look?</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/table09.png" alt="Table with cells with collapsed borders">
  <figcaption>Table with cells with collapsed borders</figcaption>
</figure>


<p>Ahh…. Much more refined.</p>

<aside class="information blurb">
    <p>The <code>border-collapse</code> style tells the table to overlap each cell’s borders, rather than treat them as discrete entities. So in this case it looks a bit better.</p>

</aside>

<div class="page-break"></div>

<h3 id="leanpub-auto-adding-web-links-to-d3js-objects">Adding web links to d3.js objects</h3>

<p>The idea with this tip / trick is to be able to add a ‘link’ to an object so that when you click on it, it takes you to a web page that we will pre-define.</p>

<p>We are going to generate a simple rectangle with some text and look at linking from the rectangle and the text separately and with some fanciness at the end :-).</p>

<p>The end result will be something that looks a little like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/xlink-01.png" alt="Objects with links">
  <figcaption>Objects with links</figcaption>
</figure>


<p>(Notice the little pointing finger at the bottom that would indicate that there actually <em>is</em> a link there.)</p>

<p>The code that we will use as a starting point is this simple example that draws a green rectangle and overlays some text on it;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>	
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>
 
<code class="kd">var</code> <code class="nx">width</code> <code class="o">=</code> <code class="mi">449</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">height</code> <code class="o">=</code> <code class="mi">249</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">word</code> <code class="o">=</code> <code class="s2">"gongoozler"</code><code class="p">;</code>
 
<code class="kd">var</code> <code class="nx">holder</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code><code class="p">)</code>    
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code><code class="p">);</code> 

<code class="c1">// draw a rectangle</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>  
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"lightgreen"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>

<code class="c1">// draw text on the screen</code>
<code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"20px"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">word</code><code class="p">);</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<p>There’s nothing too spectacular about the file. There’s a little bit of styling and tweaking of attributes, but nothing too extreme. The only slightly ‘odd’ part would be defining the word that is printed out as a variable (<code>var word = "gongoozler";</code>) and then adding it as a variable (<code>.text(word);</code>) instead of just putting the word directly in there (which we could do like this <code>.text("gongoozler");</code>). We’re going to do this deliberately to explore additional options for making our links a little more dynamic.</p>

<h4 id="leanpub-auto-its-all-about-the-a-and-the-xlink">It’s all about the ‘a’ and the ‘xlink’</h4>

<p>The <code>&lt;a&gt;</code> tag in an HTML file defines a <a href="http://www.w3schools.com/html/html_links.asp">hyperlink</a>. Items bounded by an <code>&lt;a&gt;</code> tag will become a link to another web address. So what we will do is create an <code>&lt;a&gt;</code> tag and then append our d3.js, svg object to it.</p>

<p>Of course, as well as including a link, we need to tell it where to go. We do this by setting the <code>xlink:href</code> attribute for our tag to point to a specific page. Xlink is short for XML Linking Language and it is used to create hyperlinks in XML documents. In our case we will be defining the link that we will want our user to go to.</p>

<h4 id="leanpub-auto-adding-in-the-links">Adding in the links</h4>

<p>The following is the adjusted code for our rectangle that adds in the <code>&lt;a&gt;</code> tag with the <code>xlink:href</code> attribute.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"a"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"xlink:href"</code><code class="p">,</code> <code class="s2">"http://en.wikipedia.org"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"rect"</code><code class="p">)</code>  
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">50</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"lightgreen"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"rx"</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"ry"</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
</pre></div>

</figure>

<p>It’s important to append the link before the object (otherwise it won’t work) but other than that, it’s a pretty simple job.</p>

<p>The only fly in the ointment is that while we now have a rectangle that links to Wikipedia, if we hover our mouse over the text, we lose our link (since we haven’t told the text to link anywhere).</p>

<p>We can remedy that by doing exactly the same thing with the text element;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"a"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"xlink:href"</code><code class="p">,</code> <code class="s2">"http://en.wikipedia.org/wiki/"</code><code class="o">+</code><code class="nx">word</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"20px"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">word</code><code class="p">);</code>
</pre></div>

</figure>

<p>The only slight difference here is that we have used the address for Wikipedia as our base and added the variable for our word to the end of it so that the resulting web address takes us to Wikipedia and the specific page for the word ‘gongoozler’. Hopefully this will indicate that if we had a set of variables in an array we would make our links a little more dynamic.</p>

<h4 id="leanpub-auto-making-the-mouse-pointer-ignore-an-object">Making the mouse pointer ignore an object</h4>

<p>So in theory we’re done, but in practice this has been a slightly crude method for adding what should be a <em>single</em> link to two objects when we should be able to accomplish it by defining the link once. </p>

<p>What we could do as an alternative to linking both the rectangle and the text using two separate links is to make the mouse ignore the text and have it rely solely on the rectangle. We can do this using the <code>pointer-events</code> style when drawing our text. By setting it to <code>none</code> we are instructing our mouse to ignore any potential interaction with the text when it hovers over it and instead the pointer will register the link on the rectangle below it.</p>

<p>The code for the text therefore becomes…</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="nx">holder</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="s2">"black"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"font-size"</code><code class="p">,</code> <code class="s2">"20px"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"dy"</code><code class="p">,</code> <code class="s2">".35em"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"text-anchor"</code><code class="p">,</code> <code class="s2">"middle"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"pointer-events"</code><code class="p">,</code> <code class="s2">"none"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">word</code><code class="p">);</code>
</pre></div>

</figure>

<p>And as you can see from the image below, the pointer will happily ignore the text while reading the link from the rectangle.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/xlink-02.png" alt="Objects with links">
  <figcaption>Objects with links</figcaption>
</figure>


<p>The complete code for this example is available in the appendices and a live version can be found on <a href="http://bl.ocks.org/d3noob/87d9880fd5ae41b8fb5e309b59031002">bl.ocks.org</a> and <a href="https://gist.github.com/d3noob/87d9880fd5ae41b8fb5e309b59031002">GitHub</a>. The code is also in the downloadable files available from Leanpub with the book in a file called ‘xlink-rect-pointer-events.html’.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-using-the-yahoo-query-language-yql-to-get-data">Using the Yahoo Query Language (YQL) to get data.</h3>

<p>One of the things that I find frustrating is difficulty getting data to play with. Often I will find myself thinking “It would be neat to see if this technique works” but then I spend a couple of hours looking for data that will be appropriate.</p>

<p>Another difficulty is that access to dynamic data is also problematic. D3.js really shines when displaying information that is changing and interactive. Finding data that is changing and which you can interact with is not easy.</p>

<p>Then, when you do come across a web site that has an interesting data set, accessing that data becomes programmatically difficult because of restrictions in accessing information that crosses domains. A solution to this problem (and there are a few) is to have a data set that is in a domain that permits <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">Cross-Origin Resource Sharing</a> (CORS). These are not as common as you might hope as it presents security concerns that need to be addressed.</p>

<p>One resource that I have come across is particularly useful for solving the problems outlined above is the <a href="http://developer.yahoo.com/yql/">Yahoo! Developer Network</a> which operates a service where you can write a query in an SQL type fashion that will return data as formatted <a href="#json">JSON</a> (or others). This query can be formed into an http request so that you can simply paste a generated URL directly into your browsers URL bar and it will return the requested data. Better than that, because it supports CORS (and because d3.js can manage a CORS request without breaking a sweat) all you need to do is put the URL into you code (as a <code>d3.json</code> call for example) and you will be up and running.</p>

<h4 id="leanpub-auto-yql-by-example">YQL by example</h4>

<p>I will use an example of looking for current weather information for Wellington New Zealand from the <a href="http://www.wunderground.com/">Weather Underground</a> (wunderground).</p>

<p>In this example, we’re interested in retrieving a JSON ‘blob’ that contains data on the weather conditions (temperature, wind speed / direction, humidity etc) for a specific location.</p>

<p>Start at the page for the console (<a href="http://developer.yahoo.com/yql/console/">http://developer.yahoo.com/yql/console/</a>). On the left there is a range of data ‘topics that you can choose from. We will want to access one of the community tables, so select ‘Show Community Tables’ and scroll down the list until you find ‘wunderground’ and ‘wunderground.currentobservation’ </p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/yql-01.png" alt="Select Community Tables and wunderground.currentobservation">
  <figcaption>Select Community Tables and wunderground.currentobservation</figcaption>
</figure>


<p>This will bring up a query in the console that is looking for the current weather from San Francisco International airport.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/yql-02.png" alt="Query for weather from San Francisco">
  <figcaption>Query for weather from San Francisco</figcaption>
</figure>


<p>For our example we want to be a bit more specific, so we replace the ‘SFO’ ‘location’ with ‘Wellington, New Zealand’.</p>

<p>If you then click on the ‘Test’ button the query will run and results will be presented in the box below it;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/yql-03.png" alt="JSON weather from San Francisco">
  <figcaption>JSON weather from San Francisco</figcaption>
</figure>


<p>If that looks like the results you were expecting, fantastic!</p>

<p>The next gem from YQL is the <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">REST</a> query that is automatically generated at the bottom of the page;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/yql-04.png" alt="REST Query">
  <figcaption>REST Query</figcaption>
</figure>


<p>If you select this query and past it in your URL bar, you will have the JSON data returned into your browser.</p>

<p>At this point it might seem a bit confusing, and if you’re unfamiliar with how JSON based data sets are structured it will DEFINITELY be confusing (You will need to do some research to get up to speed there). My advice is to first understand a bit about JSON and then examine the output from the REST query in the developer console on your browser (this is a fairly long topic in itself, so I will not cover it here sorry). Additionally check out the ‘Examples’ chapter for real world usage.</p>

<p>If you are comfortable with understanding how the data can be encoded, it is then just a matter of including the REST query in your call when selecting data using <code>d3.json</code> and you will be away. </p>

<p>Please check out the examples I will include in the ‘Examples’ chapter for a deeper look at the use of the data with d3.js (This will also help with understanding the JSON structure). </p>

<div class="page-break"></div>

<h3 id="leanpub-auto-export-an-image-from-a-d3js-page-as-a-svg-or-bitmap">Export an image from a d3.js page as a SVG or bitmap</h3>

<p>At some point you will want to take your lovingly crafted D3 graphical masterpiece and put it in a 
(close your eyes if you’re squeamish) Power Point presentation or Word document or export it for sharing in some other way.</p>

<p>There could be many reasons for wanting to do this and some may be more complicated than I will be willing to explore, but for the occasional conversion of images I have found what I regard as a fairly easy process.</p>

<p>Before we begin our exporting odyssey, let’s cover a little bit of housekeeping and describe the difference between a vector graphic (in this case specifically Scalable Vector Graphics) and a bitmap. Please skip ahead if you’re comfortable with the terms.</p>

<h4 id="leanpub-auto-bitmaps">Bitmaps</h4>

<p>A bitmap (or raster) image is one that is composed of lots of discrete individual dots (let’s call them pixels) which, when joined together (and zoomed out a bit) give the impression of an image.
If we use the force layout example we developed, and look at a screen shot (and it’s important to remember that this is a screen shot) of the image we see a picture that looks fairly benign.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/prezoom.png" alt="A bitmap at a normal zoom level">
  <figcaption>A bitmap at a normal zoom level</figcaption>
</figure>


<p>However, as we enlarge the image by doubling its size (x 2) we begin to see some rough edges appear.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/prezoomx2.png" alt="A bitmap at 200%">
  <figcaption>A bitmap at 200%</figcaption>
</figure>


<p>And if we enlarge it by doubling again (x 4) , it starts to look decidedly rough.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/prezoomx4.png" alt="A bitmap at 400%">
  <figcaption>A bitmap at 400%</figcaption>
</figure>


<p>Doubling again (x 8), starts to show the pixels pretty clearly.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/prezoomx8.png" alt="A bitmap at 800%">
  <figcaption>A bitmap at 800%</figcaption>
</figure>


<p>Doubling again for the last time (x 16) and the pixels are plainly evident.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/prezoomx16.png" alt="A bitmap at 1600%">
  <figcaption>A bitmap at 1600%</figcaption>
</figure>


<p>Bitmaps can be saved in a wide range of formats depending on the users requirements including compression, colour depth, transparency and a host of other attributes. Typically they can be identified by the file suffix .jpg, .png or .bmp (and there are an equally large number of other suffixes).</p>

<p>This will be the type of format that most people will be familiar with for images and their ubiquity with the advent of digital cameras almost makes it redundant to describe them.</p>

<p>However, there is another type of image and it is even more important to d3.js users.</p>

<h4 id="svg">Vector Graphics (Specifically SVG)</h4>

<p>Scalable Vector Graphics (SVG) use a technique of drawing an image that relies more on a description of an image than the final representation that a user sees. Instead of arranging individual pixels, an image is created by describing the way the image is created. </p>

<p>For instance, drawing a line would be accomplished by defining two sets of coordinates and specifying a line of a particular width and colour be drawn between the points.</p>

<p>This might sound a little long winded, and it does create a sense of abstraction, but it is a far more powerful mechanism for drawing as there is no loss of detail with increasing scale. Changes to the image can be simply carried out by adjusting the coordinates, colour description, line width or curve diameter. If this all sounds a little familiar, you have <em>definitely</em> been paying attention, because this is the heart of the way that d3.js draws images in a browser. It uses a combination of coordinates, shapes and attributes to create vector images in a web page.</p>

<p>As a demonstration of the difference, here is the same original picture which I have saved as a SVG image.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/svgzoom.png" alt="A SVG image at a normal zoom level">
  <figcaption>A SVG image at a normal zoom level</figcaption>
</figure>


<p>Enlarged by doubling its size (x 2) everything looks smooth.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/svgzoomx2.png" alt="A SVG at 200%">
  <figcaption>A SVG at 200%</figcaption>
</figure>


<p>If we enlarge it by doubling again (x 4) , it still looks good.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/svgzoomx4.png" alt="A SVG at 400%">
  <figcaption>A SVG at 400%</figcaption>
</figure>


<p>Doubling again (x 8) and we can see that the text ‘James’ is actually composed of a fill colour and a border.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/svgzoomx8.png" alt="A SVG at 800%">
  <figcaption>A SVG at 800%</figcaption>
</figure>


<p>Doubling again for the last time (x 16) everything still retains its clear sharp edges.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/svgzoomx16.png" alt="A SVG at 1600%">
  <figcaption>A SVG at 1600%</figcaption>
</figure>


<h4 id="leanpub-auto-lets-get-exporting">Let’s get exporting!</h4>

<p>We’ll use a three stage process for exporting our image (assuming the desired end result is a bitmap) and usefully, the first stage will result in us having a vector image as well!</p>

<p>The sequence will go as follows:</p>

<ol class="numeric">
  <li>Copy the image from the web page and save it as a SVG file</li>
  <li>Open the SVG image in a program designed to use vector images and edit it if required.</li>
  <li>Export that image as a bitmap</li>
</ol>

<h5 id="leanpub-auto-copying-the-image-off-the-web-page">Copying the image off the web page</h5>

<p>Getting the image out of a web page is made easy by using ‘<a href="http://nytimes.github.io/svg-crowbar/">SVG Crowbar</a>’. This is a “<em>A Chrome-specific bookmarklet that extracts SVG nodes and accompanying styles from an HTML document and downloads them as an SVG file</em>”. What that means is that once you drag the bookmarklet from the web page to your bookmarks (You need to be using Google Chrome, and I’m told that about 60% of the people who visit d3noob.org do) you’re ready to go. </p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/svgcrowbar.png" alt="Drag the 'SVG Crowbar' Object from the web page to your bookmarks bar">
  <figcaption>Drag the ‘SVG Crowbar’ Object from the web page to your bookmarks bar</figcaption>
</figure>


<p>Now when you have a web page open that’s displaying a D3 creation, all you need to do is click on the SVG Crowbar bookmark and you will be prompted for a location to save a svg image.</p>

<p>Really. It’s that simple.</p>

<h5 id="leanpub-auto-open-the-svg-image-and-edit">Open the SVG Image and Edit</h5>

<p>Obviously now that you have a SVG image, you need to be able to do something with it. My preferred software for this is <a href="http://inkscape.org/">Inkscape</a>. </p>

<p>Inkscape is “<em>An Open Source vector graphics editor, with capabilities similar to Illustrator, CorelDraw, or Xara X, using the W3C standard Scalable Vector Graphics (SVG) file format</em>”. </p>

<p>It really is an extremely capable drawing program and it is capable of a lot more than the job we’re going to use it for, so you may find it has other uses that may be valuable.</p>

<p>Once installed, you can open the saved file directly into Inkscape.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/inkscape.png" alt="Inkscape with our force diagram">
  <figcaption>Inkscape with our force diagram</figcaption>
</figure>


<p>While here you can edit the drawing to your hearts delight. I particularly recommend ungrouping the diagram and removing or adjusting individual elements if required.</p>

<p>Once you have finished editing, you are ready for the final step.</p>

<h5 id="leanpub-auto-saving-as-a-bitmap">Saving as a bitmap</h5>

<p>While still in Inkscape, go to the ‘File’, ‘Export Bitmap…’ menu.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/inkscape-export.png" alt="Inkscape Export Bitmap menu">
  <figcaption>Inkscape Export Bitmap menu</figcaption>
</figure>


<p>This will open a dialog box where you can select an appropriate resolution and location for your bitmap and then press the export button.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/inkscape-export-dialog.png" alt="Inkscape Export Bitmap dialog">
  <figcaption>Inkscape Export Bitmap dialog</figcaption>
</figure>


<p>There you go. </p>

<p>It is worth knowing that the default settings here will export the diagram with a transparent background (using *.png) which will fit in nicely with a wide range of graphical end uses.</p>

<div class="page-break"></div>

<h3 id="json">Understanding JavaScript Object Notation (JSON)</h3>

<p>One of the most useful things you might want to learn when understanding how to present your data with D3 is how to <em>structure</em> your data so that it is easy to use.</p>

<p>As explained earlier in the book, there are several different types of data that can be requested by D3 including text, Extensible Markup Language (XML), HyperText Markup Language (HTML), Comma Separated Values (CSV), Tab Separated Values (TSV) and JavaScript Object Notation (JSON).</p>

<p>Comma separated values and tab separated values are fairly well understood forms of data. They are expressed as rows and columns of information that are separated using a known character. While these forms of data are simple to understand, it is not easy to incorporate a hierarchy structure to the data, and when you try, it isn’t natural and makes managing the data difficult.</p>

<p>JavaScript Object Notation (JSON) presents a different mechanism for storing data. A light weight description could read “<em>JSON is a text-based open standard designed to present human-readable data. It is derived from the JavaScript scripting language, but it is language and platform independent.</em>”</p>

<p>Unfortunately, when I first started using JSON, I struggled with the concept of how it was structured, in spite of some fine descriptions on the web (start with <a href="http://www.json.org/">http://www.json.org/</a> in my humble opinion). So the following is how I came to think of and understand JSON.</p>

<aside class="warning blurb">
    <p><strong>Fair Warning:</strong> This advice is no substitute for the correct explanation of the topic of data structures that I’m sure you could receive from a reputable educational site or institution. It’s just the way I like to think of it :-). It’s also just the way that I <em>started</em> to understand JSON. There is plenty to learn and understand once you grasp the basics. So this isn’t a complete guide. Just the beginnings.</p>

</aside>

<p>In the following steps we’ll go through a process that (hopefully) demonstrates that we can transform identifiers that would represent the closing price for a stock of 58.3 on 2013-03-14 into more traditional x,y coordinates.</p>

<p>I think of data as having an identifier and a value.</p>

<figure class="code">
<div class="highlight"><pre><code></code>identifier: value
</pre></div>

</figure>

<p>If a point on a graph is located at the x,y coordinates 150,25 then the identifier ‘x’ has a value 150. </p>

<figure class="code">
<div class="highlight"><pre><code></code>"x": 150
</pre></div>

</figure>

<p>If the x axis was a time-line, the true value for ‘x’ could be “2013-03-14”. </p>

<figure class="code">
<div class="highlight"><pre><code></code>"x": "2013-03-14"
</pre></div>

</figure>

<p>This example might look similar to those seen by users of d3.js, since if we’re using date / time format we can let D3 sort out the messy parts like what coordinates to provide for the screen.</p>

<p>And there’s no reason why we couldn’t give the ‘x’ identifier a more human readable label such as “date”. So our data would look like;</p>

<figure class="code">
<div class="highlight"><pre><code></code>"date": "2013-03-14"
</pre></div>

</figure>

<p>This is only one part of our original x,y = 150,25 data set. The same way that the x value represented a position on the x axis that was really a date, the y value represents a position on the y axis that is really another number. It only gets converted to 25 when we need to plot a position on a graph at 150,25. If the ‘y’ component represents the closing price of a stock we could take the same principles used to transform… </p>

<figure class="code">
<div class="highlight"><pre><code></code>"x": 150
</pre></div>

</figure>

<p>… into …</p>

<figure class="code">
<div class="highlight"><pre><code></code>"date": "2013-03-14"
</pre></div>

</figure>

<p>… to change ….</p>

<figure class="code">
<div class="highlight"><pre><code></code>"y": 25
</pre></div>

</figure>

<p>… into …</p>

<figure class="code">
<div class="highlight"><pre><code></code>"close": 58.3
</pre></div>

</figure>

<p>This might sound slightly confusing, so try to think of it this way. We want to plot a point on a graph at 150,25, but the data that this position is derived from is really “2013-03-14”, 58.3. D3 can look after all the scaling and determination of the range so that the point gets plotted at 150,25 and our originating data can now be represented as;</p>

<figure class="code">
<div class="highlight"><pre><code></code>"date": "2013-03-14", "close": 58.3
</pre></div>

</figure>

<p>This represents two separate pieces of data. Each of which has an identifier (“date” or “close”) and a value (“2013-03-14” and 58.3)</p>

<p>If we wanted to have a series of these data points that represented several days of closing prices, we would store them as an array of identifiers and values similar to this;</p>

<figure class="code">
<div class="highlight"><pre><code></code>{ "date": "2013-03-14", close: 58.13 },
{ "date": "2013-03-15", close: 53.98 },
{ "date": "2013-03-16", close: 67.00 },
{ "date": "2013-03-17", close: 89.70 },
{ "date": "2013-03-18", close: 99.00 }
</pre></div>

</figure>

<p>Each of the individual elements of the array is enclosed in curly brackets and separated by commas.</p>

<aside class="warning blurb">
    <p>I am making the assumption that you are familiar with the concept of what an ‘array’ is. If this is an unfamiliar word, in the context of data, then I strongly recommend that you do some Goggling to build up some familiarity with the principle.</p>

</aside>

<p>Now that we have an array, we can apply the same rules to it as we did the the item that had a single value. We can give it an identifier all of its own. In this case we will call it “data”. Now we can use our identifier: value analogy to use “data” as the identifier and the array as the value.</p>

<figure class="code">
<div class="highlight"><pre><code></code>{ "data": [
  { "date": "2013-03-14", close: 58.13 },
  { "date": "2013-03-15", close: 53.98 },
  { "date": "2013-03-16", close: 67.00 },
  { "date": "2013-03-17", close: 89.70 },
  { "date": "2013-03-18", close: 99.00 }
] }
</pre></div>

</figure>

<p>The array has been enclosed in square brackets to designate it as an array and the entire identifier: value sequence has been encapsulated with curly braces (much the same way that the subset “date”, “close” values were enclosed with curly braces.</p>

<p>If we try to convey the same principle in a more graphical format, we could show our initial identifier and value for the x component like so;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/iv-01.png" alt="Single identifier and value">
  <figcaption>Single identifier and value</figcaption>
</figure>


<p>The we can add our additional component for the y value;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/iv-02.png" alt="Single identifier and value">
  <figcaption>Single identifier and value</figcaption>
</figure>


<p>We can then add several of these combinations together in an array;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/iv-03.png" alt="Single identifier and value">
  <figcaption>Single identifier and value</figcaption>
</figure>


<p>Then the array becomes a value for another identifier “data”;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/iv-04.png" alt="Single identifier and value">
  <figcaption>Single identifier and value</figcaption>
</figure>


<p>More complex JSON files will have multiple levels of identifiers and values arranged in complex hierarchies which can be difficult to interpret. However, laying out the data in a logical way in a text file is an excellent way to start to make sense of the data. </p>

<div class="page-break"></div>

<h2 id="leanpub-auto-d3js-examples-explained">D3.js Examples Explained</h2>

<p>I’ve decided to include an examples chapter because I have occasionally come across things that I wanted to do with data or a technique that didn’t necessarily fall into a specific category or where I had something that I wanted to do that went beyond an exercise that I would want to turn into a simple description.</p>

<p>In other words I think that this will be a place where I can put random graphics that I have made up that don’t necessarily fall into a logical category but which I think would be worth recording.</p>

<p>In many cases these examples will combine a range of techniques that have been explained in the book and in some cases they may include new material that perhaps I would have struggled to explain without putting the technique into better context.</p>

<p>Whatever the case, I will try to explain the examples as best I can and to include a full code listing for each and a link to an electronic version wherever possible.</p>

<div class="page-break"></div>

<h3 id="leanpub-auto-multi-line-graph-with-automatic-legend-and-toggling-show--hide-lines">Multi-line graph with automatic legend and toggling show / hide lines.</h3>

<h4 id="leanpub-auto-purpose">Purpose</h4>

<p>Creating a multi-line graph is a pretty handy thing to be able to do and we worked through an example earlier in the book as an extension of our simple graph. In that example we used a csv file that had the data arranged with each lines values in a separate column.</p>

<figure class="code">
<div class="highlight"><pre><code></code>date,close,open
1-May-12,68.13,34.12
30-Apr-12,63.98,45.56
27-Apr-12,67.00,67.89
26-Apr-12,89.70,78.54
25-Apr-12,99.00,89.23
24-Apr-12,130.28,99.23
23-Apr-12,166.70,101.34
</pre></div>

</figure>

<p>This is a common way to have data stored, but if you are retrieving information from a database, you may not have the luxury of having it laid out in columns. It may be presented in a more linear fashion where each lines values are stores on a unique row with the identifier for the line on the same row. For instance, the data above could just as easily be presented as follows;</p>

<figure class="code">
<div class="highlight"><pre><code></code>price,date,value
close,1-May-12,68.13
close,30-Apr-12,63.98
close,27-Apr-12,67.00
close,26-Apr-12,89.70
close,25-Apr-12,99.00
close,24-Apr-12,130.28
close,23-Apr-12,166.70
open,1-May-12,34.12
open,30-Apr-12,45.56
open,27-Apr-12,67.89
open,26-Apr-12,78.54
open,25-Apr-12,89.23
open,24-Apr-12,99.23
open,23-Apr-12,101.34
</pre></div>

</figure>

<p>In this case, we would need to ‘pivot’ the data to produce the same multi-column representation as the original format. This is not always easy, but it can be achieved using the d3 <a href="#nest"><code>nest</code></a> function which we will examine.</p>

<p>As well as this we will want to automatically encode the lines to make them different colours and to add a legend with the line name and the colour of the appropriate line.</p>

<p>Finally, because we will build a graph script that can cope with any number of lines (within reason), we will need to be able to show / hide the individual lines to try and clarify the graph if it gets too cluttered.</p>

<p>All of these features have been covered individually in the book, so what we’re going to do is combine them in a way that presents us with an elegant multi-line graph that looks a bit like this;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/super-01.png" alt="Multi-line graph with legend">
  <figcaption>Multi-line graph with legend</figcaption>
</figure>


<h4 id="leanpub-auto-the-code-6">The Code</h4>

<p>The following is the code for the initial example which is a slight derivative of the original simple graph. A live version is available online at <a href="http://bl.ocks.org/d3noob/755a069aafbe66f3fd8497b9498df643">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/755a069aafbe66f3fd8497b9498df643">GitHub</a>. It is also available as the files ‘super-multi-lines.html’ and ‘stocks.csv’ as a download with the book D3 Tips and Tricks (in a zip file) when you <a href="https://leanpub.com/d3-t-and-t-v4">download the book from Leanpub</a>.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">meta</code> <code class="na">charset</code><code class="o">=</code><code class="s">"utf-8"</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code> <code class="c">/* set the CSS */</code>

<code class="nt">body</code> <code class="p">{</code> <code class="nb">font</code><code class="o">:</code> <code class="m">12px</code> <code class="n">Arial</code><code class="p">;}</code>

<code class="nt">path</code> <code class="p">{</code> 
    <code class="n">stroke</code><code class="o">:</code> <code class="nb">steelblue</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">2</code><code class="p">;</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>

<code class="nc">.axis</code> <code class="nt">path</code><code class="o">,</code>
<code class="nc">.axis</code> <code class="nt">line</code> <code class="p">{</code>
    <code class="n">fill</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">:</code> <code class="n">grey</code><code class="p">;</code>
    <code class="n">stroke</code><code class="o">-</code><code class="nb">width</code><code class="o">:</code> <code class="m">1</code><code class="p">;</code>
    <code class="n">shape</code><code class="o">-</code><code class="n">rendering</code><code class="o">:</code> <code class="n">crispEdges</code><code class="p">;</code>
<code class="p">}</code>

<code class="p">&lt;/</code><code class="nt">style</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>

<code class="c">&lt;!-- load the d3.js library --&gt;</code>    
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://d3js.org/d3.v4.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code>

<code class="c1">// Set the dimensions of the canvas / graph</code>
<code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">270</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>

<code class="c1">// Parse the date / time</code>
<code class="kd">var</code> <code class="nx">parseDate</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">timeParse</code><code class="p">(</code><code class="s2">"%b %Y"</code><code class="p">);</code>

<code class="c1">// Set the ranges</code>
<code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleTime</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">width</code><code class="p">]);</code>  
<code class="kd">var</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleLinear</code><code class="p">().</code><code class="nx">range</code><code class="p">([</code><code class="nx">height</code><code class="p">,</code> <code class="mi">0</code><code class="p">]);</code>

<code class="c1">// Define the line</code>
<code class="kd">var</code> <code class="nx">priceline</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">line</code><code class="p">()</code>    
    <code class="p">.</code><code class="nx">x</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">y</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">y</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">price</code><code class="p">);</code> <code class="p">});</code>
    
<code class="c1">// Adds the svg canvas</code>
<code class="kd">var</code> <code class="nx">svg</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"body"</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"svg"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"width"</code><code class="p">,</code> <code class="nx">width</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"height"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> 
              <code class="s2">"translate("</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">+</code> <code class="s2">","</code> <code class="o">+</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">);</code>

<code class="c1">// Get the data</code>
<code class="nx">d3</code><code class="p">.</code><code class="nx">csv</code><code class="p">(</code><code class="s2">"stocks.csv"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">date</code> <code class="o">=</code> <code class="nx">parseDate</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">);</code>
        <code class="nx">d</code><code class="p">.</code><code class="nx">price</code> <code class="o">=</code> <code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">price</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="c1">// Scale the range of the data</code>
    <code class="nx">x</code><code class="p">.</code><code class="nx">domain</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">extent</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">date</code><code class="p">;</code> <code class="p">}));</code>
    <code class="nx">y</code><code class="p">.</code><code class="nx">domain</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">price</code><code class="p">;</code> <code class="p">})]);</code>

    <code class="c1">// Nest the entries by symbol</code>
    <code class="kd">var</code> <code class="nx">dataNest</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">symbol</code><code class="p">;})</code>
        <code class="p">.</code><code class="nx">entries</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>

    <code class="c1">// Loop through each symbol / key</code>
    <code class="nx">dataNest</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 

        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">priceline</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">));</code>

    <code class="p">});</code>

    <code class="c1">// Add the X Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"transform"</code><code class="p">,</code> <code class="s2">"translate(0,"</code> <code class="o">+</code> <code class="nx">height</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisBottom</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>

    <code class="c1">// Add the Y Axis</code>
    <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"g"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"axis"</code><code class="p">)</code>
      <code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">axisLeft</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>

<code class="p">});</code>

<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
</pre></div>

</figure>

<h4 id="leanpub-auto-description">Description</h4>

<h5 id="leanpub-auto-nesting-the-data">Nesting the data</h5>

<p>The example code above differs from the simple graph in two main ways.</p>

<p>Firstly, the script loads the file <code>stocks.csv</code> which was used by Mike Bostock in his <a href="http://bl.ocks.org/mbostock/1157787">small multiples example</a>. This means that the variable names used are different (<code>price</code> for the value of the stocks, <code>symbol</code> for the name of the stock and good old <code>date</code> for the date) and we have to adjust the <code>parseDate</code> function to parse a modified date value.</p>

<p>Secondly we add the code blocks to take the <code>stocks.csv</code> information that we load as <code>data</code> and we apply the <code>d3.nest</code> function to it and draw each line.</p>

<p>The following code nest’s the data</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="kd">var</code> <code class="nx">dataNest</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">symbol</code><code class="p">;})</code>
        <code class="p">.</code><code class="nx">entries</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
</pre></div>

</figure>

<p>We declare our new array’s name as <code>dataNest</code> and we initiate the <code>nest</code> function;</p>

<figure class="code">
<div class="highlight"><pre><code></code>	<code class="kd">var</code> <code class="nx">dataNest</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">nest</code><code class="p">()</code>
</pre></div>

</figure>

<p>We assign the <code>key</code> for our new array as <code>symbol</code>. A ‘key’ is like a way of saying “<em>This is the thing we will be grouping on</em>”. In other words our resultant array will have a single entry for each unique <code>symbol</code> or stock which will itself be an array of dates and values.</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code><code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">symbol</code><code class="p">;})</code>
</pre></div>

</figure>

<p>Then we tell the nest function which data array we will be using for our source of data.</p>

<figure class="code">
<div class="highlight"><pre><code></code>		<code class="p">}).</code><code class="nx">entries</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
</pre></div>

</figure>

<p>Then we use the nested data to loop through our stocks and draw the lines</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">dataNest</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code>

        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">priceline</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">));</code>

    <code class="p">});</code>
</pre></div>

</figure>

<p>The <code>forEach</code> function being applied to <code>dataNest</code> means that it will take each of the keys that we have just declared with the <code>d3.nest</code> (each stock) and use the values for each stock to append a line using its values.</p>

<p>The end result looks like the following;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/super-02.png" alt="A very plain multi-line graph">
  <figcaption>A very plain multi-line graph</figcaption>
</figure>


<p>You would be justified in thinking that this is more than a little confusing. Clearly while we have been successful in making each stock draw a corresponding line, unless we can tell them apart, the graph is pretty useless.</p>

<h5 id="leanpub-auto-applying-the-colours">Applying the colours</h5>

<p>Making sure that the colours that are applied to our lines (and ultimately our legend text) is unique from line to line is actually pretty easy.</p>

<p>The code that we will implement for this change is available online at <a href="http://bl.ocks.org/d3noob/ae9786c26d6a821eefeabe60dec350a9">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/ae9786c26d6a821eefeabe60dec350a9">GitHub</a>. It is also available as the files ‘super-multi-colours.html’ and ‘stocks.csv’ as a download with the book D3 Tips and Tricks v4 (in a zip file) when you <a href="https://leanpub.com/d3-t-and-t-v4">download the book from Leanpub</a>.</p>

<p>The changes that we will make to our code are captured in the following code snippet.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="c1">// set the colour scale</code>
    <code class="kd">var</code> <code class="nx">color</code> <code class="o">=</code> <code class="nx">d3</code><code class="p">.</code><code class="nx">scaleOrdinal</code><code class="p">(</code><code class="nx">d3</code><code class="p">.</code><code class="nx">schemeCategory10</code><code class="p">);</code>

    <code class="c1">// Loop through each symbol / key</code>
    <code class="nx">dataNest</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">)</code> <code class="p">{</code> 

        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="c1">// Add the colours dynamically</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">priceline</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">));</code>

    <code class="p">});</code>
</pre></div>

</figure>

<p>Firstly we  need to declare an <a href="https://github.com/d3/d3/blob/master/API.md#ordinal-scales">ordinal scale</a> for our colours with <code>var color = d3.scaleOrdinal(d3.schemeCategory10);</code>. This is a set of categorical colours (10 of them in this case) that can be invoked which are a nice mix of difference from each other and pleasant on the eye.</p>

<p>We then use the colour scale to assign a unique stroke (line colour) for each unique key (symbol) in our dataset.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
</pre></div>

</figure>

<p>It seems easy when it’s implemented, but in all reality, it is the product of some very clever thinking behind the scenes when designing d3.js and even picking the colours that are used. The end result is a far more usable graph of the stock prices.</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/super-03.png" alt="Multi-line graph with unique colours">
  <figcaption>Multi-line graph with unique colours</figcaption>
</figure>


<p>Of course now we’re faced with the problem of not knowing which line represents which stock price. Time for a legend.</p>

<h5 id="leanpub-auto-adding-the-legend">Adding the legend</h5>

<p>If we think about the process of adding a legend to our graph, what we’re trying to achieve is to take every unique data series we have (stock) and add a relevant label showing which colour relates to which stock. At the same time, we need to arrange the labels in such a way that they are presented in a manner that is not offensive to the eye. In the example I will go through I have chosen to arrange them neatly spaced along the bottom of the graph. so that the final result looks like the following;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/super-01.png" alt="Multi-line graph with legend">
  <figcaption>Multi-line graph with legend</figcaption>
</figure>


<p>Bear in mind that the end result will align the legend completely automatically. If there are three stocks it will be equally spaced, if it is six stocks they will be equally spaced. The following is a reasonable mechanism to facilitate this, but if the labels for the data values are of radically different lengths, the final result will looks ‘odd’ likewise, if there are a LOT of data values, the legend will start to get crowded.</p>

<p>The code that we will implement for this change is available online at <a href="http://bl.ocks.org/d3noob/f8b7f107ba25c21971851728520224cb">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/f8b7f107ba25c21971851728520224cb">GitHub</a>. It is also available as the files ‘super-multi-legend.html’ and ‘stocks.csv’ as a download with the book D3 Tips and Tricks v4 (in a zip file) when you <a href="https://leanpub.com/d3-t-and-t-v4">download the book from Leanpub</a>.</p>

<p>There are three broad categories of changes that we will want to make to our current code;</p>

<ol class="numeric">
  <li>Declare a style for the legend font</li>
  <li>Change the area and margins for the graph to accommodate the additional text</li>
  <li>Add the text</li>
</ol>

<p>Declaring the style for the legend text is as easy as making an appropriate entry in the <code>&lt;style&gt;</code> section of the code. For this example we can choose the following;</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="p">.</code><code class="nx">legend</code> <code class="p">{</code>
    <code class="nx">font</code><code class="o">-</code><code class="nx">size</code><code class="o">:</code> <code class="mi">16</code><code class="nx">px</code><code class="p">;</code>
    <code class="nx">font</code><code class="o">-</code><code class="nx">weight</code><code class="o">:</code> <code class="nx">bold</code><code class="p">;</code>
    <code class="nx">text</code><code class="o">-</code><code class="nx">anchor</code><code class="o">:</code> <code class="nx">middle</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</figure>

<p>To change the area and margins of the graph we can make the following small changes to the code.</p>

<figure class="code">
<div class="highlight"><pre><code></code><code class="kd">var</code> <code class="nx">margin</code> <code class="o">=</code> <code class="p">{</code><code class="nx">top</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">right</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">bottom</code><code class="o">:</code> <code class="mi">70</code><code class="p">,</code> <code class="nx">left</code><code class="o">:</code> <code class="mi">50</code><code class="p">},</code>
    <code class="nx">width</code> <code class="o">=</code> <code class="mi">600</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">left</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">right</code><code class="p">,</code>
    <code class="nx">height</code> <code class="o">=</code> <code class="mi">300</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">top</code> <code class="o">-</code> <code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="p">;</code>
</pre></div>

</figure>

<p>The bottom margin is now 70 pixels high and the overall space for the area that the graph (including the margins) covers is increased to 300 pixels.</p>

<p>To add the legend text is slightly more work, but only slightly more. The following code incorporates the changes and there are commented out asterisks to the end of the lines that have been added</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">legendSpace</code> <code class="o">=</code> <code class="nx">width</code><code class="o">/</code><code class="nx">dataNest</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code> <code class="c1">// spacing for legend // ******</code>

    <code class="c1">// Loop through each symbol / key</code>
    <code class="nx">dataNest</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code class="nx">i</code><code class="p">)</code> <code class="p">{</code>                           <code class="c1">// ******</code>

        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="c1">// Add the colours dynamically</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">priceline</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">));</code>

        <code class="c1">// Add the Legend</code>
        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>                                    <code class="c1">// *******</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">legendSpace</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code><code class="nx">i</code><code class="o">*</code><code class="nx">legendSpace</code><code class="p">)</code> <code class="c1">// spacing // ****</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code> <code class="mi">5</code><code class="p">)</code>         <code class="c1">// *******</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"legend"</code><code class="p">)</code>    <code class="c1">// style the legend   // *******</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="c1">// dynamic colours    // *******</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>             <code class="c1">// *******</code>
            <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code>                                     <code class="c1">// *******</code>

    <code class="p">});</code>
</pre></div>

</figure>

<p>The first added line finds the spacing between each legend label by dividing the width of the graph area by the number of symbols (<code>key</code>’s or stocks).</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">legendSpace</code> <code class="o">=</code> <code class="nx">width</code><code class="o">/</code><code class="nx">dataNest</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code>
</pre></div>

</figure>

<p>Then there is a small and subtle change that might other wise go unnoticed, but is nonetheless significant. We add an <code>i</code> to the <code>forEach</code> function;</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">dataNest</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code class="nx">i</code><code class="p">)</code> <code class="p">{</code>
</pre></div>

</figure>

<p>This might not seem like much of a big deal, but declaring <code>i</code> allows us to access the index of the returned data. This means that each unique <code>key</code> (stock or symbol) has a unique number. In our example those numbers would be from 0 to 3 (MSFT = 0, AMZN = 1, IBM = 2 and AAPL = 3 (this is the order in which the stocks appear in our csv file)).</p>

<p>Now we get to adding our text. Again, this is a fairly simple exercise which is following the route that we have taken several times already in the book but using some of our prepared values.</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">legendSpace</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code><code class="nx">i</code><code class="o">*</code><code class="nx">legendSpace</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code> <code class="mi">5</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"legend"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
            <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code>
</pre></div>

</figure>

<p>The horizontal spacing for the labels is achieved by setting each label to the position set by the index associated with the label and the space available on the graph. To make it work out nicely we add half a <code>legendSpace</code> at the start (<code>legendSpace/2</code>) and then add the product of the index (<code>i</code>) and <code>legendSpace</code> (<code>i*legendSpace</code>).</p>

<p>We position the legend vertically so that it is in the middle of the bottom margin (<code>height + (margin.bottom/2)+ 5</code>).</p>

<p>And we apply the same colour function to the text as we did to the lines earlier;</p>

<figure class="code">
<div class="highlight"><pre><code></code>            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
</pre></div>

</figure>

<p>The final result is a neat and tidy legend at the bottom of the graph;</p>


<figure class="image center">
  <img src="/site_images/d3-t-and-t-v4/super-01.png" alt="Multi-line graph with legend">
  <figcaption>Multi-line graph with legend</figcaption>
</figure>


<p>If you’re looking for an exercise to test your skills you could adapt the code to show the legend to the right of the graph. And if you wanted to go one better, you could arrange the order of the legend to reflect the final numeric value on the right of the graph (I.e in this case AAPL would be on the top and MSFT on the bottom).</p>

<h5 id="leanpub-auto-making-it-interactive">Making it interactive</h5>

<p>The last step we’ll take in this example is to provide ourselves with a bit of control over how the graph looks. Even with the multiple colours, the graph could still be said to be ‘busy’. To clean it up or at least to provide the ability to more clearly display the data that a user wants to see we will add code that will allow us to click on a legend label and this will toggle the corresponding graph line on or off.</p>

<p>This is a progression from the example of how to show / hide an element by clicking on another element that was introduced in he ‘Assorted tips and tricks’ chapter.</p>

<p>The only changes to our code that need to be implemented are in the <code>forEach</code> section below. I have left some comments with asterisks in the code below to illustrate lines that are added.</p>

<figure class="code">
<div class="highlight"><pre><code></code>    <code class="nx">dataNest</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">d</code><code class="p">,</code><code class="nx">i</code><code class="p">)</code> <code class="p">{</code>

        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"path"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"line"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"stroke"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s1">'tag'</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\s+/g</code><code class="p">,</code> <code class="s1">''</code><code class="p">))</code> <code class="c1">// assign ID **</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"d"</code><code class="p">,</code> <code class="nx">priceline</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">values</code><code class="p">));</code>

        <code class="c1">// Add the Legend</code>
        <code class="nx">svg</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"text"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"x"</code><code class="p">,</code> <code class="p">(</code><code class="nx">legendSpace</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code><code class="nx">i</code><code class="o">*</code><code class="nx">legendSpace</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"y"</code><code class="p">,</code> <code class="nx">height</code> <code class="o">+</code> <code class="p">(</code><code class="nx">margin</code><code class="p">.</code><code class="nx">bottom</code><code class="o">/</code><code class="mi">2</code><code class="p">)</code><code class="o">+</code> <code class="mi">5</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"class"</code><code class="p">,</code> <code class="s2">"legend"</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"fill"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">d</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code> <code class="p">})</code>
            <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(){</code>                     <code class="c1">// ************</code>
                <code class="c1">// Determine if current line is visible</code>
                <code class="kd">var</code> <code class="nx">active</code>   <code class="o">=</code> <code class="nx">d</code><code class="p">.</code><code class="nx">active</code> <code class="o">?</code> <code class="kc">false</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>  <code class="c1">// ************</code>
                <code class="nx">newOpacity</code> <code class="o">=</code> <code class="nx">active</code> <code class="o">?</code> <code class="mi">0</code> <code class="o">:</code> <code class="mi">1</code><code class="p">;</code>             <code class="c1">// ************</code>
                <code class="c1">// Hide or show the elements based on the ID</code>
                <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#tag"</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\s+/g</code><code class="p">,</code> <code class="s1">''</code><code class="p">))</code> <code class="c1">// *********</code>
                    <code class="p">.</code><code class="nx">transition</code><code class="p">().</code><code class="nx">duration</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>          <code class="c1">// ************</code>
                    <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="nx">newOpacity</code><code class="p">);</code>       <code class="c1">// ************</code>
                <code class="c1">// Update whether or not the elements are active</code>
                <code class="nx">d</code><code class="p">.</code><code class="nx">active</code> <code class="o">=</code> <code class="nx">active</code><code class="p">;</code>                       <code class="c1">// ************</code>
                <code class="p">})</code>                                       <code class="c1">// ************</code>
            <code class="p">.</code><code class="nx">text</code><code class="p">(</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">);</code>

    <code class="p">});</code>
</pre></div>

</figure>

<p>The full code for the complete working example is available online at <a href="http://bl.ocks.org/d3noob/08af723fe615c08f9536f656b55755b4">bl.ocks.org</a> or <a href="https://gist.github.com/d3noob/08af723fe615c08f9536f656b55755b4">GitHub</a>. It is also available as the files ‘super-multi.html’ and ‘stocks.csv’ as a download with the book D3 Tips and Tricks v4 (in a zip file) when you <a href="https://leanpub.com/d3-t-and-t-v4">download the book from Leanpub</a>.</p>

<p>The first piece of code that we need to add assign an <code>id</code> to each legend text label.</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s1">'tag'</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\s+/g</code><code class="p">,</code> <code class="s1">''</code><code class="p">))</code>
</pre></div>

</figure>

<p>Being able to use our <code>key</code> value as the id means that each label will have a unique identifier. “<em>What’s with adding the <code>'tag'</code> piece of text to the <code>id</code>?</em>” I hear you ask. Good question. If our key starts with a number we could strike trouble (in fact I’m sure there are plenty of other ways we could strike trouble too, but this was one I came across). As well as that we include a little regular expression goodness to strip any spaces out of the key with <code>.replace(/\s+/g, '')</code>.</p>

<aside class="information blurb">
    <p>The <code>.replace</code> calls the regular expression action on our <code>key</code>. <code>\s</code> is the regex for “whitespace”, and <code>g</code> is the “global” flag, meaning match ALL <code>\s</code> (whitespaces). The <code>+</code> allows for any <em>contiguous</em> string of space characters to being replaced with the empty string (<code>''</code>). This was a late addition to the example and kudos go to the participants in the <a href="http://stackoverflow.com/questions/5963182/how-to-remove-spaces-from-a-string-using-javascript">Stack Overflow question here</a>.</p>

</aside>

<p>Then we use the <code>.on("click", function(){</code> call carry out some actions on the label if it is clicked on. We toggle the <code>.active</code> descriptor for our element with <code>var active = d.active ? false : true,</code>. Then we set the value of <code>newOpacity</code> to either <code>0</code> or <code>1</code> depending on whether <code>active</code> is false or true.</p>

<p>From here we can select our label using its unique id and adjust it’s opacity to either <code>0</code> (transparent) or <code>1</code> (opaque);</p>

<figure class="code">
<div class="highlight"><pre><code></code>        <code class="nx">d3</code><code class="p">.</code><code class="nx">select</code><code class="p">(</code><code class="s2">"#tag"</code><code class="o">+</code><code class="nx">d</code><code class="p">.</code><code class="nx">key</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\s+/g</code><code class="p">,</code> <code class="s1">''</code><code class="p">))</code>
            <code class="p">.</code><code class="nx">transition</code><code class="p">().</code><code class="nx">duration</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">style</code><code class="p">(</code><code class="s2">"opacity"</code><code class="p">,</code> <code class="nx">newOpacity</code><code class="p">);</code>
</pre></div>

</figure>

<p>Just because we can, we also add in a <code>transition</code> statement so that the change in transparency doesn’t occur in a flash (100 milli seconds in fact (<code>.duration(100)</code>)).</p>

<p>Lastly we update our <code>d.active</code> variable to whatever the active state is so that it can toggle correctly the next time it is clicked on.</p>

<p>Since it’s kind of difficult to represent interactivity in a book, head on over to the <a href="http://bl.ocks.org/d3noob/e99a762017060ce81c76">live example on bl.ocks.org</a> to see the toggling awesomeness that could be yours!</p>

<div class="page-break"></div>
</div>


</section>
</div>

</div>
<div id='react-modal'></div>

<footer class='footer'>
<div class='container--medium'>
<h1 class='footer-logo'>
<a href="https://leanpub.com/"><img src="/assets/logos/logo-white-96-67-2x-191f20cfade7f1e0d1d48eddedb250ba.png" alt="Logo white 96 67 2x" />
</a></h1>
<div class='footer-links'>
<ul class='footer-list'>
<li>
<h5 class='footer-list-title'>About</h5>
</li>
<li><a href="/about">About Leanpub</a></li>
<li><a href="https://medium.com/@leanpub">Blog</a></li>
<li><a href="/team">Team</a></li>
<li><a href="https://itunes.apple.com/ca/podcast/leanpub-podcast/id517117137" target="_blank">Podcast</a></li>
<li><a href="/contact">Contact</a></li>
<li><a href="/press">Press</a></li>
</ul>
<ul class='footer-list'>
<li>
<h5 class='footer-list-title'>Authors</h5>
</li>
<li><a href="/authors">Why Leanpub</a></li>
<li><a href="/pricing">Pricing</a></li>
<li><a href="/manifesto">Manifesto</a></li>
<li><a href="/romance">Romance Authors</a></li>
</ul>
<ul class='footer-list'>
<li>
<h5 class='footer-list-title'>Author Support</h5>
</li>
<li><a href="http://help.leanpub.com/author-help">Author Help</a></li>
<li><a href="/help">Getting Started</a></li>
<li><a href="/help/manual">Manual</a></li>
<li><a href="/help/api">API Docs</a></li>
</ul>
<ul class='footer-list'>
<li>
<h5 class='footer-list-title'>More</h5>
</li>
<li><a href="http://help.leanpub.com/reader-help">Reader Help</a></li>
<li><a href="/p">Publishers</a></li>
<li><a href="/causes">Causes</a></li>
</ul>
<ul class='footer-list'>
<li>
<h5 class='footer-list-title'>Legal</h5>
</li>
<li><a href="/terms">Terms of Service</a></li>
<li><a href="/takedown">Copyright Policy</a></li>
<li><a href="/privacy">Privacy Policy</a></li>
</ul>
</div>
<p class='footer-copyright'>
Leanpub is copyright &copy; 2010-2018 <a href="http://ruboss.com">Ruboss Technology Corp.</a> All rights reserved.
</p>
</div>
</footer>


<script src="/assets/application-60994b3fac793c8e729d59ed1f7130eb.js"></script>
<!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window,document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
 fbq('init', '210960779347704');
fbq('track', 'PageView');
</script>
<noscript>
 <img height="1" width="1"
src="https://www.facebook.com/tr?id=210960779347704&ev=PageView
&noscript=1"/>
</noscript>
<!-- End Facebook Pixel Code -->

<!-- Twitter universal website tag code -->
<script>
!function(e,t,n,s,u,a){e.twq||(s=e.twq=function(){s.exe?s.exe.apply(s,arguments):s.queue.push(arguments);
},s.version='1.1',s.queue=[],u=t.createElement(n),u.async=!0,u.src='//static.ads-twitter.com/uwt.js',
a=t.getElementsByTagName(n)[0],a.parentNode.insertBefore(u,a))}(window,document,'script');
// Insert Twitter Pixel ID and Standard Event data below
twq('init','nw0pa');
twq('track','PageView');
</script>
<!-- End Twitter universal website tag code -->

<script type="text/javascript">  var _gaq = _gaq || [];
  _gaq.push(['account2._setAccount', 'UA-37389271-9']);
  _gaq.push(['account2._setDomainName', 'leanpub.com']);
  _gaq.push(['account2._trackPageview']);
</script>

</body></html>
